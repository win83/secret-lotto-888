<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>539 å°ˆæ¥­å›æ¸¬ç³»çµ± - 2026 ä¿®æ­£ç‰ˆ</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <style>
        :root { --bg: #d1e7d1; --blue-t: #2196F3; --red-box: #f44336; --gold: #ffc107; }
        body { background-color: var(--bg); font-family: "Microsoft JhengHei", sans-serif; font-size: 13px; margin: 15px; }
        .main-layout { display: flex; flex-direction: column; gap: 10px; }
        .guide-box { background: #fffde7; border: 1px solid #ddd; border-left: 5px solid var(--gold); padding: 8px 15px; margin-bottom: 5px; border-radius: 4px; min-height: 24px; display: flex; align-items: center; }
        .filter-panel { border: 2px solid var(--red-box); background: #fff; padding: 15px; display: grid; grid-template-columns: 80px 1fr; gap: 8px; border-radius: 8px; }
        .f-label { background: #fdf2f2; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 1px solid #ccc; height: 35px; border-radius: 4px; }
        .f-btns { display: flex; flex-wrap: wrap; gap: 6px; align-content: center; }
        .f-item { padding: 4px 12px; border: 1px solid #ccc; cursor: pointer; background: #fff; border-radius: 4px; position: relative; transition: all 0.2s; }
        .f-item:hover { background: #f0f0f0; }
        .f-item.active { background: var(--blue-t); color: white; border-color: #0d47a1; }
        .f-item.active::after { content: attr(data-order); position: absolute; top: -8px; right: -5px; background: #333; color: #fff; border-radius: 50%; width: 16px; height: 16px; font-size: 10px; display: flex; align-items: center; justify-content: center; border: 1px solid white; }
        .action-bar { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; padding: 10px 0; }
        .yellow-btn { background: #ffff00; border: 1px solid #000; padding: 8px 18px; font-weight: bold; cursor: pointer; border-radius: 4px; }
        .yellow-btn.active { background: #ff9800 !important; color: white; }
        .add-btn { background: #4CAF50; color: white; border: 1px solid #000; padding: 8px 25px; font-weight: bold; cursor: pointer; border-radius: 4px; }
        .view-container { background: white; border: 2px solid var(--blue-t); padding: 10px; border-radius: 8px; min-height: 500px; }
        .scroll-area { overflow: auto; max-height: 600px; }
        table { border-collapse: collapse; width: 100%; white-space: nowrap; }
        th, td { border: 1px solid #ccc; padding: 5px; text-align: center; }
        #thr th { position: sticky; top: 0; background: #eee; z-index: 10; }
        .num-cell { width: 25px; height: 25px; }
        .report-card { border: 2px solid #333; background: #fff; margin-bottom: 25px; border-radius: 4px; overflow: hidden; }
        .report-title { background: #7da7d8; padding: 12px; font-weight: bold; display: flex; justify-content: space-between; align-items: center; color: white; }
        .top-hit { background-color: #ffff00 !important; font-weight: bold; color: #d32f2f; }
        .hidden { display: none; }
    </style>
</head>
<body>

<div class="main-layout">
    <div id="page-dist" class="view-container">
        <div id="modeGuide" class="guide-box">ğŸ’¡ æ¨¡å¼å°å¼•ï¼šæ­·å²æ¨¡å¼çœ‹æ©Ÿç‡ï¼Œæ‹–ç‰Œ/å°ç¢°éœ€é¸2å€‹é …ç›®èˆ‡è™Ÿç¢¼ã€‚</div>
        <div class="filter-panel">
            <div class="f-label">å¹´ä»½</div><div class="f-btns" id="yearList" data-type="year"></div>
            <div class="f-label">é€±</div><div class="f-btns" data-type="week"></div>
            <div class="f-label">å¤©å¹²</div><div class="f-btns" data-type="tian"></div>
            <div class="f-label">åœ°æ”¯</div><div class="f-btns" data-type="di"></div>
            <div class="f-label">ç¯€ (T)</div><div class="f-btns" id="solarT" data-type="solar"></div>
            <div class="f-label">æ°£ (S)</div><div class="f-btns" id="solarS" data-type="solar"></div>
            <div class="f-label" style="color:blue">è™Ÿç¢¼</div><div class="f-btns" data-type="nums"></div>
            <div class="f-label" style="background:#e3f2fd">è¡¨æ ¼æœŸæ•¸</div>
            <div class="f-btns">
                <input type="number" id="limitRows" value="20" min="0" onchange="applyFilter()" style="width: 80px; padding: 6px;">
                <span style="color: #666; font-size: 11px; margin-left:10px;">(é–‹å•Ÿé è¨­20æœŸï¼Œ0ä»£è¡¨å…¨éƒ¨)</span>
            </div>
            <div class="f-label" style="background:#e8f5e9">çµ±è¨ˆ N æœŸ</div>
            <div class="f-btns">
                <input type="number" id="recentN" value="0" min="0" style="width: 80px; padding: 6px;">
            </div>
        </div>
        <div class="action-bar">
            <button class="yellow-btn btn-mode-h active" onclick="setMode('history')">æ­·å²çµ±è¨ˆ</button>
            <button class="yellow-btn btn-mode-t" onclick="setMode('tuopai')">æ‹–ç‰Œæ¨¡å¼</button>
            <button class="yellow-btn btn-mode-d_curr" onclick="setMode('duipeng_curr')">ç•¶æœŸå°ç¢°</button>
            <button class="yellow-btn btn-mode-d" onclick="setMode('duipeng')">ä¸‹æœŸå°ç¢°</button>
            <button class="add-btn" onclick="generateBatchReport()">åŠ å…¥å ±è¡¨</button>
            <button onclick="clearFilters()" style="padding: 8px 15px; cursor:pointer;">æ¸…ç©ºç¯©é¸å™¨</button>
            <button onclick="switchPage('repo')" style="background:#607d8b; color:white; border-radius:4px; padding: 8px 15px; border:none; cursor:pointer;">åˆ‡æ›å ±è¡¨</button>
            <span id="fileMsg" style="margin-left:auto; font-weight:bold; color:red;">é€£ç·šä¸­...</span>
        </div>
        <div class="scroll-area">
            <table>
                <thead><tr id="thr"><th>æœŸè™Ÿ</th><th>æ—¥æœŸ</th><th>é€±</th><th>å¤©å¹²</th><th>åœ°æ”¯</th><th>ç¯€æ°£</th><th>çƒ1</th><th>çƒ2</th><th>çƒ3</th><th>çƒ4</th><th>çƒ5</th></tr></thead>
                <tbody id="gridBody"></tbody>
            </table>
        </div>
    </div>
    <div id="page-repo" class="view-container hidden">
        <div style="margin-bottom:10px;">
            <button onclick="switchPage('dist')" style="padding: 5px 15px; cursor:pointer;">â† è¿”å›åˆ†æ</button>
            <button onclick="clearAllReports()" style="background:#f44336; color:white; border:none; border-radius:4px; padding: 5px 15px; cursor:pointer; margin-left:10px;">æ¸…ç©ºæ‰€æœ‰å ±è¡¨</button>
        </div>
        <div id="repo-list"></div>
    </div>
</div>

<script>
    const GSHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTuGa3v-rwH8Qh-JXF9MfxwUwT0A-iJooRI6ypJTErCsxN9qCjZQrgr70f16ZoehQ/pub?output=csv";
    let db = [];
    let currentMode = 'history';
    let filters = { year:[], week:[], tian:[], di:[], solar:[], nums:[] };
    let savedReports = JSON.parse(localStorage.getItem('539_reports') || "[]");

    function formatDate(val) {
        if (!val) return "";
        let d = val;
        if (!isNaN(val) && typeof val !== 'string') d = new Date((val - 25569) * 86400 * 1000);
        else if (typeof val === 'string' && !val.includes('/')) {
            let n = parseFloat(val); if (!isNaN(n)) d = new Date((n - 25569) * 86400 * 1000);
        }
        if (d instanceof Date && !isNaN(d)) {
            let y = d.getFullYear(), m = ("0" + (d.getMonth() + 1)).slice(-2), day = ("0" + d.getDate()).slice(-2);
            return `${y}/${m}/${day}`;
        }
        return String(val).trim().replace(/-/g, '/');
    }

    async function loadCloudData() {
        try {
            const response = await fetch(GSHEET_CSV_URL);
            const blob = await response.blob();
            const reader = new FileReader();
            reader.onload = function(e) {
                // å¼·åˆ¶ UTF-8 è§£ç¢¼é˜²æ­¢äº‚ç¢¼
                const decoder = new TextDecoder('utf-8');
                const csvString = decoder.decode(e.target.result);
                const workbook = XLSX.read(csvString, { type: 'string' });
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                let rawData = XLSX.utils.sheet_to_json(sheet, { header: 1 });

                db = rawData.filter(row => row[0] && row[0] !== "æœŸè™Ÿ" && !isNaN(row[0])).map(row => {
                    row[1] = formatDate(row[1]);
                    for(let i = 2; i <= 5; i++) row[i] = row[i] ? String(row[i]).trim() : "";
                    return row;
                });

                initYearBtns(); 
                renderGrid();
                document.getElementById('fileMsg').innerText = `æ•¸æ“šï¼š${db.length} æœŸ`;
            };
            reader.readAsArrayBuffer(blob);
        } catch (e) { console.error(e); }
    }

    function renderGrid() { 
        const body = document.getElementById('gridBody'); body.innerHTML = ''; 
        db.forEach((row, idx) => { 
            const tr = document.createElement('tr'); tr.id = `row-${idx}`; 
            for(let i=0; i<11; i++) tr.innerHTML += `<td>${row[i]||''}</td>`; 
            for(let n=1; n<=39; n++) tr.innerHTML += `<td class="num-cell" data-n="${n}"></td>`;
            body.appendChild(tr); 
        }); 
        applyFilter();
    }

    function applyFilter() { 
        if(!db.length) return; 
        const limit = parseInt(document.getElementById('limitRows').value) || 0;
        let counts = Array(40).fill(0); let visibleIdx = 0;
        
        for (let i = db.length - 1; i >= 0; i--) {
            const data = db[i];
            const tr = document.getElementById(`row-${i}`);
            let ok = true; 
            if(filters.year.length) ok &= filters.year.some(y => String(data[1]).startsWith(y));
            if(filters.week.length) ok &= filters.week.some(v => String(data[2]).includes(v));
            if(filters.tian.length) ok &= filters.tian.some(v => String(data[3]).includes(v));
            if(filters.di.length) ok &= filters.di.some(v => String(data[4]).includes(v));
            if(filters.solar.length) ok &= filters.solar.some(v => String(data[5]).includes(v));

            const win = data.slice(6, 11).map(Number);
            if(filters.nums.length) ok &= filters.nums.every(n => win.includes(Number(n))); 

            const show = ok && (limit === 0 || visibleIdx < limit);
            tr.style.display = show ? '' : 'none';
            if(show) {
                visibleIdx++;
                win.forEach(n => { if(n>0) counts[n]++; });
                tr.querySelectorAll('.num-cell').forEach(td => { 
                    const n = parseInt(td.dataset.n);
                    td.innerText = win.includes(n) ? (n < 10 ? '0'+n : n) : '';
                });
            }
        }
        for(let i=1; i<=39; i++) {
            const s = document.getElementById(`s-${i}`);
            s.innerText = counts[i]; s.style.color = counts[i]>0 ? 'red' : 'blue';
        }
    }

    function handleItem(el, type, val) {
        const arr = filters[type]; const idx = arr.indexOf(val);
        if(idx > -1) {
            arr.splice(idx, 1); el.classList.remove('active'); el.removeAttribute('data-order');
        } else {
            // æ‹–ç‰Œ/å°ç¢°æ¨¡å¼é™åˆ¶ï¼šæ¯å€‹æ–‡å­—é¡åˆ¥æœ€å¤šé»é¸ 2 å€‹
            if(['tuopai','duipeng_curr','duipeng'].includes(currentMode) && ['week','tian','di','solar'].includes(type) && arr.length >= 2) {
                alert("æ­¤æ¨¡å¼ä¸‹è©²é …ç›®æœ€å¤šé¸2å€‹"); return;
            }
            arr.push(val); el.classList.add('active');
            if(type !== 'nums' && type !== 'year') el.setAttribute('data-order', arr.length);
        }
        applyFilter();
    }

    function generateBatchReport() {
        if(!db.length) return;
        const results = [];
        const nLimit = parseInt(document.getElementById('recentN').value) || 0;
        let targetData = (nLimit > 0) ? db.slice(-nLimit) : db;
        const conditionText = getFilterLabel();

        // æ‹–ç‰Œé‚è¼¯é©—è­‰ï¼šæ¯å€‹é»é¸çš„é …ç›®ï¼ˆé€±ã€å¤©å¹²ã€åœ°æ”¯ã€ç¯€æ°£ï¼‰å¿…é ˆé»é¸ 2 å€‹æ‰æœƒæˆç«‹
        if (currentMode !== 'history') {
            const cats = ['week', 'tian', 'di', 'solar'];
            const invalidCat = cats.find(cat => filters[cat].length > 0 && filters[cat].length !== 2);
            if (invalidCat) {
                alert(`æ‹–ç‰Œé‚è¼¯ï¼š${invalidCat} é¡åˆ¥å¿…é ˆé»é¸ 2 å€‹æ‰æœƒæˆç«‹ï¼`);
                return;
            }
            if (filters.nums.length === 0) {
                alert("è«‹è‡³å°‘é¸æ“‡ä¸€å€‹è™Ÿç¢¼é€²è¡Œæ‹–ç‰Œ"); return;
            }
        }

        if (currentMode === 'history') {
            ['week','tian','di','solar'].forEach(cat => {
                filters[cat].forEach(val => {
                    let s = Array(40).fill(0), c = 0, col = ['week','tian','di','solar'].indexOf(cat)+2;
                    targetData.forEach(row => {
                        if(String(row[col]).includes(val)) {
                            row.slice(6,11).map(Number).forEach(n => { if(n>0) s[n]++; }); c++;
                        }
                    });
                    if(c > 0) results.push({ label: `${val}`, data: s, matches: c });
                });
            });
        } else {
            const isNext = (currentMode === 'duipeng' || currentMode === 'tuopai');
            filters.nums.forEach(num => {
                let s = Array(40).fill(0), c = 0;
                for(let i = 0; i < targetData.length - (isNext?1:0); i++) {
                    const win1 = targetData[i].slice(6,11).map(Number);
                    if(win1.includes(Number(num))) {
                        // æª¢æŸ¥å…¶ä»–æ–‡å­—éæ¿¾æ¢ä»¶
                        let matchText = true;
                        if(filters.week.length) matchText &= filters.week.some(v => String(targetData[i][2]).includes(v));
                        if(filters.tian.length) matchText &= filters.tian.some(v => String(targetData[i][3]).includes(v));
                        if(filters.di.length) matchText &= filters.di.some(v => String(targetData[i][4]).includes(v));
                        if(filters.solar.length) matchText &= filters.solar.some(v => String(targetData[i][5]).includes(v));
                        
                        if(matchText) {
                            const win2 = isNext ? targetData[i+1].slice(6,11).map(Number) : win1;
                            win2.forEach(n => { if(n>0) s[n]++; }); c++;
                        }
                    }
                }
                if(c > 0) results.push({ label: `è™Ÿç¢¼ ${num}`, data: s, matches: c });
            });
        }

        if(results.length) {
            saveAndRender(`${currentMode} - ${conditionText}`, results);
            switchPage('repo');
        } else { alert("æŸ¥ç„¡è³‡æ–™"); }
    }

    function initYearBtns() {
        const years = [...new Set(db.map(r => r[1].substring(0,4)))].sort((a,b)=>b-a);
        const container = document.getElementById('yearList'); container.innerHTML = '';
        years.forEach(y => {
            if(!y) return;
            const div = document.createElement('div'); div.className = 'f-item'; div.innerText = y;
            div.onclick = () => handleItem(div, 'year', y); container.appendChild(div);
        });
    }

    function getFilterLabel() {
        let l = [];
        if (filters.year.length) l.push("å¹´:"+filters.year);
        if (filters.week.length) l.push("é€±:"+filters.week);
        if (filters.nums.length) l.push("è™Ÿ:"+filters.nums);
        return l.join('|') || "å…¨åŸŸ";
    }

    function saveAndRender(title, rows) {
        savedReports.unshift({ title, rows, id: Date.now() });
        localStorage.setItem('539_reports', JSON.stringify(savedReports));
        updateReportUI();
    }

    function updateReportUI() {
        const list = document.getElementById('repo-list'); list.innerHTML = '';
        savedReports.forEach(report => {
            const card = document.createElement('div'); card.className = 'report-card';
            let h = `<div class="report-title"><span>${report.title}</span><button onclick="deleteReport(${report.id})">åˆªé™¤</button></div>`;
            h += `<div class="scroll-area"><table><thead><tr><td>é …ç›®(æœŸ)</td>`;
            for(let i=1; i<=39; i++) h += `<td>${i}</td>`;
            h += `</tr></thead><tbody>`;
            report.rows.forEach(r => {
                const top3 = getTop3Indices(r.data);
                h += `<tr><td>${r.label}(${r.matches})</td>`;
                for(let i=1; i<=39; i++) {
                    const v = r.data[i] || 0;
                    h += `<td class="${top3.includes(i)?'top-hit':''}">${v||''}</td>`;
                }
                h += `</tr>`;
            });
            h += `</tbody></table></div>`;
            card.innerHTML = h; list.appendChild(card);
        });
    }

    function getTop3Indices(data) {
        const sorted = data.slice(1).map((v, i) => ({v, i: i+1})).sort((a, b) => b.v - a.v);
        const vals = [...new Set(sorted.map(x => x.v))].filter(v => v > 0).slice(0, 3);
        return sorted.filter(x => x.v > 0 && vals.includes(x.v)).map(x => x.i);
    }

    function setMode(m) { 
        currentMode = m; 
        document.querySelectorAll('.yellow-btn').forEach(b => b.classList.remove('active'));
        const btnClass = { history:'.btn-mode-h', tuopai:'.btn-mode-t', duipeng_curr:'.btn-mode-d_curr', duipeng:'.btn-mode-d' };
        document.querySelector(btnClass[m]).classList.add('active');
        clearFilters(); 
    }

    function clearFilters() { filters = { year:[], week:[], tian:[], di:[], solar:[], nums:[] }; document.querySelectorAll('.f-item').forEach(el => {el.classList.remove('active'); el.removeAttribute('data-order');}); applyFilter(); }
    function switchPage(p) { document.getElementById('page-dist').classList.toggle('hidden', p !== 'dist'); document.getElementById('page-repo').classList.toggle('hidden', p !== 'repo'); }
    function deleteReport(id) { savedReports = savedReports.filter(r => r.id !== id); localStorage.setItem('539_reports', JSON.stringify(savedReports)); updateReportUI(); }
    function clearAllReports() { if(confirm("ç¢ºå®šæ¸…ç©ºï¼Ÿ")) { savedReports=[]; localStorage.removeItem('539_reports'); updateReportUI(); } }

    function initUI() {
        const build = (type, list, containerId) => {
            const container = containerId ? document.getElementById(containerId) : document.querySelector(`[data-type="${type}"]`);
            list.forEach(v => {
                const div = document.createElement('div'); div.className = 'f-item'; div.innerText = v;
                div.onclick = () => handleItem(div, type, v); container.appendChild(div);
            });
        };
        build('week', ['ä¸€','äºŒ','ä¸‰','å››','äº”','å…­','æ—¥']);
        build('tian', ['ç”²','ä¹™','ä¸™','ä¸','æˆŠ','å·±','åºš','è¾›','å£¬','ç™¸']);
        build('di', ['å­','ä¸‘','å¯…','å¯','è¾°','å·³','åˆ','æœª','ç”³','é…‰','æˆŒ','äº¥']);
        let tlist = [], slist = []; for(let i=0; i<=15; i++) { tlist.push('T'+i); slist.push('S'+i); }
        build('solar', tlist, 'solarT'); build('solar', slist, 'solarS');
        build('nums', Array.from({length:39}, (_,i)=>i+1));
        for(let i=1; i<=39; i++) {
            const th = document.createElement('th'); th.style.background = '#ffc107';
            th.innerHTML = `${i}<br><span id="s-${i}" style="font-size:10px; color:blue">0</span>`;
            document.getElementById('thr').appendChild(th);
        }
        loadCloudData();
        updateReportUI();
    }

    initUI();
</script>
</body>
</html>
