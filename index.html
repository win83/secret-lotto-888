// ... 前方變數宣告保持不變 ...

function updateStats() {
    if(!cloudData.length) return;
    
    // 1. 收集目前的篩選條件
    const filters = {}; 
    let catCount = 0;
    ["年份", "月份", "日期", "星期", "天干", "地支"].forEach(lbl => {
        const sel = Array.from(document.querySelectorAll(`.chips[data-label="${lbl}"] .chip.on`)).map(c => c.textContent);
        if(sel.length > 0) { filters[lbl] = sel; catCount++; }
    });
    const selNums = Array.from(document.querySelectorAll(`.chips[data-label="號碼"] .chip.on`)).map(c => parseInt(c.textContent));
    const counts = Array(maxNum + 1).fill(0);

    // 2. 進行數據過濾 (Excel 篩選邏輯)
    const validRows = cloudData.filter(row => {
        // [修正] 爸模式過濾：C(2), D(3), E(4), F(5) 不可為空
        if (currentUser === "dad") {
            const hasEmptyCell = !row[2] || !row[3] || !row[4] || !row[5] || 
                                 row[2].trim() === "" || row[3].trim() === "" || 
                                 row[4].trim() === "" || row[5].trim() === "";
            if (hasEmptyCell) return false;
        }
        return true; 
    });

    // 3. 執行統計運算
    validRows.forEach((row, idx) => {
        const dateParts = (row[1] || "").split('/');
        const rd = { 
            "年份": dateParts[0], 
            "月份": (dateParts[1] || "").replace(/^0/, ''), // 去除前導0
            "日期": (dateParts[2] || "").replace(/^0/, ''), 
            "星期": dateParts[3] ? dateParts[3].replace('週','') : "", 
            "天干": row[2], 
            "地支": row[3] 
        };
        
        // 號碼從 G 欄 (索引 6) 開始，抓取 6 個號碼 (539為5個, Lotto為6個)
        const rowNums = row.slice(6, 13).map(n => parseInt(n)).filter(n => !isNaN(n) && n > 0);
        
        // 檢查是否符合所有標籤條件 (AND 邏輯)
        let isMatch = true;
        for(let k in filters) {
            if(!filters[k].includes(rd[k])) { isMatch = false; break; }
        }
        if(!isMatch) return;

        // 根據模式進行計數
        if (currentMode === "歷史模式") {
            rowNums.forEach(n => { if(n <= maxNum) counts[n]++; });
        } else if (currentMode === "拖牌模式" || currentMode === "下期對碰") {
            if (selNums.length > 0 && selNums.some(sn => rowNums.includes(sn))) {
                const nxt = validRows[idx+1]; // 抓取「有效資料」的下一期
                if(nxt) {
                    const nxtNums = nxt.slice(6, 13).map(n => parseInt(n)).filter(n => !isNaN(n));
                    nxtNums.forEach(n => { if(n <= maxNum) counts[n]++; });
                }
            }
        } else if (currentMode === "當期對碰") {
            if (selNums.length > 0 && selNums.every(sn => rowNums.includes(sn))) {
                rowNums.forEach(n => { if(n <= maxNum) counts[n]++; });
            }
        }
    });

    // 4. 更新介面 (計算 TOP5 與 未出期數)
    renderStatsUI(counts, validRows);
}

function renderStatsUI(counts, validRows) {
    const sorted = [...counts].sort((a,b)=>b-a);
    const threshold = sorted[4] > 0 ? sorted[4] : 999;

    document.getElementById('filterCounter').textContent = `模式:${currentMode} | 參與統計總期數:${validRows.length}`;

    for(let i=1; i<=maxNum; i++){
        const td1 = document.getElementById(`val1-${i}`);
        if(td1) {
            td1.textContent = counts[i] || 0;
            td1.className = (counts[i] >= threshold && counts[i] > 0) ? "top5" : "";
        }
        
        // 全域未出期數 (基於 validRows 倒查)
        let gap = 0;
        for(let j=validRows.length-1; j>=0; j--){
            const rowNums = validRows[j].slice(6, 13).map(Number);
            if(rowNums.includes(i)) break;
            gap++;
        }
        const td2 = document.getElementById(`val2-${i}`);
        if(td2) td2.textContent = gap;
    }
}
