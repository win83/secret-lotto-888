<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>æ¨‚é€çµ±è¨ˆç³»çµ± V1 - GitHub è¯ç¶²ç‰ˆ</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <style>
    :root{
      --page-bg:#cfe8cf; --panel-bg:#fff8e8; --tab-bg:#ededed;
      --tab-border:#9a9a9a; --blue:#1f73ff; --red:#e51b1b;
      --line:#d0d0d0; --label:#efefef; --btn-border:#7a7a7a;
      --stat-green: #92d050; --stat-light: #e2efda;
      --top5-bg: #ff0000; --top5-text: #ffffff;
      --report-header-bg: #fce4d6;
    }
    *{ box-sizing:border-box; font-family:"Microsoft JhengHei"; }
    body{ margin:0; background:var(--page-bg); color:#111; }
    
    /* é ‚éƒ¨å°è¦½ */
    .tabs{ display:grid; grid-template-columns: repeat(4, 1fr); gap:16px; padding:10px 14px 0; }
    .tab{ height:44px; background:var(--tab-bg); border:1px solid var(--tab-border); display:flex; align-items:center; justify-content:center; font-weight:800; cursor:pointer; user-select:none; }
    .tab.active{ border-bottom:3px solid var(--red); background:#f2f2f2; }

    .container{ margin:10px 14px; border:1px solid var(--blue); border-radius:8px; background:var(--panel-bg); padding:10px; min-height: 80vh; }
    .page { display: none; }
    .page.active { display: block; }

    .filters-box{ border:2px solid var(--red); background:#fff; padding:12px; margin-bottom:10px; }
    .grid{ display:grid; grid-template-columns: 90px 1fr; row-gap:10px; }
    .lbl{ background:var(--label); border:1px solid var(--line); display:flex; align-items:center; justify-content:center; font-weight:900; height:36px; }
    .chips{ display:flex; flex-wrap:wrap; gap:8px; padding-left:10px; }
    .chip{ min-width:44px; height:34px; border:1px solid var(--line); border-radius:4px; display:flex; align-items:center; justify-content:center; cursor:pointer; font-weight:800; background:#fff; }
    .chip.on{ outline:2px solid var(--blue); background:#eef4ff; }
    .breakline{ flex-basis:100%; height:0; }

    .hidden { display: none !important; }

    /* æŒ‰éˆ•æ¨£å¼ */
    .btnbar{ display:flex; flex-wrap:wrap; gap:8px; align-items:center; margin-top:10px; }
    .btn{ height:40px; padding:0 15px; border:1px solid var(--btn-border); border-radius:4px; font-weight:900; cursor:pointer; }
    .btn-orange{ background:#ffb300 !important; }
    .btn-yellow{ background:#ffeb3b; }
    .btn-green{ background:#78c57a; }
    .btn-purple{ background:#6a44c6; color:#fff; }
    .btn-cyan { background:#00bcd4; color:#fff; }

    /* çµ±è¨ˆè¡¨æ ¼ */
    .stat-title { color: red; font-weight: bold; margin-top: 15px; margin-bottom: 5px; }
    .stat-table { width: 100%; border-collapse: collapse; background: #fff; margin-bottom: 5px; }
    .stat-table th, .stat-table td { border: 1px solid #000; text-align: center; padding: 2px; font-size: 11px; }
    .stat-table th { background: var(--stat-green); font-weight: bold; }
    .stat-table td { height: 26px; font-weight: bold; }
    .top5 { background-color: var(--top5-bg) !important; color: var(--top5-text) !important; }

    /* å ±è¡¨å€ */
    .report-item { margin-bottom: 30px; border: 1px solid #000; background: #fff; overflow-x: auto; }
    .report-table { width:100%; border-collapse:collapse; font-size:11px; min-width: 1000px; }
    .report-table th, .report-table td { border:1px solid #000; text-align:center; padding:2px; height: 24px; }
    .report-header { background: var(--report-header-bg); font-weight: bold; padding: 6px 10px; display: flex; justify-content: space-between; border-bottom: 1px solid #000; }
    .cond-col { background:#ffff00; font-weight: bold; width: 150px; text-align: left; padding-left: 5px; }
    .sum-row { background:#ddebf7; font-weight:bold; }
    .color-count-row { background:#e2efda; font-weight:bold; }
    
    #loadingOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); display: none; justify-content: center; align-items: center; z-index: 9999; font-weight: 900; color: #e51b1b; }
  </style>
</head>
<body>

  <div id="loadingOverlay">æ­£åœ¨å¾é›²ç«¯æ›´æ–°æ•¸æ“š...</div>

  <div class="tabs">
    <div class="tab active" data-game="539" data-target="mainPage">ä»Šå½© 539</div>
    <div class="tab" data-game="539" data-target="reportPage">539 å ±è¡¨</div>
    <div class="tab" data-game="Lotto" data-target="mainPage">å¤§æ¨‚é€</div>
    <div class="tab" data-game="Lotto" data-target="reportPage">å¤§æ¨‚é€ å ±è¡¨</div>
  </div>

  <div class="container">
    <div id="mainPage" class="page active">
      <div id="gameTitle" style="color:red; font-weight:900; margin-bottom:10px;">ä»Šå½© 539 ä»Šæ—¥è³‡è¨Šï¼š2026/02/05</div>
      
      <div class="btnbar" style="margin-bottom:10px;">
        <span style="font-weight:900">ç›®å‰ä½¿ç”¨è€…ï¼š</span>
        <button class="btn btn-cyan" id="mode-dad" onclick="switchUser('dad')">çˆ¸ä½¿ç”¨æ¨¡å¼</button>
        <button class="btn" id="mode-bro" onclick="switchUser('bro')">å“¥ä½¿ç”¨æ¨¡å¼</button>
      </div>

      <div class="filters-box"><div class="grid" id="filterGrid"></div></div>
      
      <div class="btnbar">
        <button class="btn btn-orange" onclick="changeMode('æ­·å²æ¨¡å¼', this)">æ­·å²æ¨¡å¼</button>
        <span style="font-weight:bold">æœŸæ•¸: <input type="number" id="periodInput" value="0" style="width:50px"></span>
        <button class="btn btn-yellow" onclick="changeMode('æ‹–ç‰Œæ¨¡å¼', this)">æ‹–ç‰Œæ¨¡å¼</button>
        <button class="btn btn-yellow" onclick="changeMode('ç•¶æœŸå°ç¢°', this)">ç•¶æœŸå°ç¢°</button>
        <button class="btn btn-yellow" onclick="changeMode('ä¸‹æœŸå°ç¢°', this)">ä¸‹æœŸå°ç¢°</button>
        <button id="addReportBtn" class="btn btn-green" onclick="addToReport()">ğŸ§ª åŠ å…¥å ±è¡¨</button>
        <button class="btn" onclick="clearFilters()">æ¸…ç©ºç¯©é¸</button>
      </div>
      
      <div class="btnbar" style="margin-top:15px;">
        <div style="display:flex; flex-direction:column; gap:5px;">
            <button class="btn btn-purple" onclick="selectToday()">ä¸€éµé¸å–ä»Šæ—¥æ¢ä»¶</button>
            <div id="filterCounter" style="font-weight:bold; font-size:13px; color:red; text-align:center;">é›²ç«¯åŒæ­¥è™Ÿç¢¼ç¸½æ•¸ï¼š0</div>
        </div>
      </div>

      <div class="stat-title">å³æ™‚ç¯©é¸çµ±è¨ˆ (é›²ç«¯é€£ç·šä¸­)</div>
      <table class="stat-table"><thead><tr id="stat-head-1"></tr></thead><tbody><tr id="stat-body-1"></tr></tbody></table>
      <div class="stat-title">å¹¾æœŸæœªå‡ºç¾çµ±è¨ˆ</div>
      <table class="stat-table stat-miss"><thead><tr id="stat-head-2"></tr></thead><tbody><tr id="stat-body-2"></tr></tbody></table>
    </div>

    <div id="reportPage" class="page">
        <div style="background:#ffd966; padding:8px; display:flex; gap:10px; align-items:center; margin-bottom:10px; border:1px solid #999;">
            <button class="btn btn-yellow" onclick="filterReport('æ­·å²', this)">æ­·å²</button>
            <button class="btn btn-yellow" onclick="filterReport('æ‹–ç‰Œ', this)">æ‹–ç‰Œ</button>
            <button class="btn btn-green" onclick="exportToExcel()">åŒ¯å‡ºexcel</button>
            <button class="btn" style="margin-left:auto; background:yellow" onclick="clearAllReports()">æ¸…ç©ºå€‹äººå ±è¡¨</button>
        </div>
        <div id="reportContainer"></div>
    </div>
  </div>

<script>
/** æ ¸å¿ƒå…¨å±€è®Šæ•¸ **/
let currentMode = "æ­·å²æ¨¡å¼";
let currentGame = "539";
let currentUser = "dad";
let maxNum = 39;

// å ±è¡¨å­˜å„²ï¼šå€åˆ†ä½¿ç”¨è€…ï¼Œäº’ä¸å¹²æ¶‰
const reportStorage = {
    dad: { "539": [], "Lotto": [] },
    bro: { "539": [], "Lotto": [] }
};

// Google Sheet CSV é€£çµ (è®€å–ä¸åŒ GID ä»£è¡¨ä¸åŒæ´»é )
const sheetUrls = {
    "539_dad": "https://docs.google.com/spreadsheets/d/e/2PACX-1vTzETHpUZjScTdPyuH2gmiBZJvZUYE0Zz5WR_PQwpDOVCS2WZFEsHuq0-ToY6lP-g/pub?gid=0&output=csv",
    "49_dad": "https://docs.google.com/spreadsheets/d/e/2PACX-1vTzETHpUZjScTdPyuH2gmiBZJvZUYE0Zz5WR_PQwpDOVCS2WZFEsHuq0-ToY6lP-g/pub?gid=1&output=csv",
    "539_bro": "https://docs.google.com/spreadsheets/d/e/2PACX-1vTzETHpUZjScTdPyuH2gmiBZJvZUYE0Zz5WR_PQwpDOVCS2WZFEsHuq0-ToY6lP-g/pub?gid=2&output=csv",
    "49_bro": "https://docs.google.com/spreadsheets/d/e/2PACX-1vTzETHpUZjScTdPyuH2gmiBZJvZUYE0Zz5WR_PQwpDOVCS2WZFEsHuq0-ToY6lP-g/pub?gid=3&output=csv"
};

const baseData = {
    years: Array.from({length: 21}, (_, i) => 2006 + i), 
    months: Array.from({length: 12}, (_, i) => i + 1),
    days: Array.from({length: 31}, (_, i) => i + 1),
    weeks: ["ä¸€","äºŒ","ä¸‰","å››","äº”","å…­","æ—¥"],
    stems: ["ç”²","ä¹™","ä¸™","ä¸","æˆŠ","å·±","åºš","è¾›","å£¬","ç™¸"],
    branches: ["å­","ä¸‘","å¯…","å¯","è¾°","å·³","åˆ","æœª","ç”³","é…‰","æˆŒ","äº¥"]
};

// åˆ‡æ›ä½¿ç”¨è€…
function switchUser(role) {
    currentUser = role;
    document.getElementById('mode-dad').classList.toggle('btn-cyan', role === 'dad');
    document.getElementById('mode-bro').classList.toggle('btn-cyan', role === 'bro');
    renderCurrentReports(); // é‡æ–°æ¸²æŸ“è©²ä½¿ç”¨è€…çš„å ±è¡¨
    clearFilters();
    initFilters();
}

function initFilters() {
    maxNum = (currentGame === "539") ? 39 : 49;
    const grid = document.getElementById('filterGrid');
    grid.innerHTML = '';
    const sections = [
        {lbl:"å¹´ä»½", d:baseData.years}, {lbl:"æœˆä»½", d:baseData.months},
        {lbl:"æ—¥æœŸ", d:baseData.days, brk:18}, {lbl:"æ˜ŸæœŸ", d:baseData.weeks},
        {lbl:"å¤©å¹²", d:baseData.stems}, {lbl:"åœ°æ”¯", d:baseData.branches},
        {lbl:"è™Ÿç¢¼", d:Array.from({length:maxNum}, (_,i)=>String(i+1).padStart(2,'0')), brk:25}
    ];
    sections.forEach(sec => {
        const isStemBranch = (sec.lbl === "å¤©å¹²" || sec.lbl === "åœ°æ”¯");
        const hiddenClass = (currentUser === "bro" && isStemBranch) ? "hidden" : "";
        grid.innerHTML += `<div class="lbl ${hiddenClass}">${sec.lbl}</div>`;
        let html = `<div class="chips ${hiddenClass}" data-label="${sec.lbl}">`;
        sec.d.forEach((v, i) => {
            if(sec.brk && i === sec.brk) html += `<div class="breakline"></div>`;
            html += `<div class="chip" data-val="${v}" onclick="toggleChip(this)">${v}</div>`;
        });
        grid.innerHTML += html + `</div>`;
    });
    updateStatTableUI();
}

function updateStatTableUI() {
    const h1 = document.getElementById('stat-head-1'), b1 = document.getElementById('stat-body-1');
    const h2 = document.getElementById('stat-head-2'), b2 = document.getElementById('stat-body-2');
    h1.innerHTML = b1.innerHTML = h2.innerHTML = b2.innerHTML = '';
    for(let i=1; i<=maxNum; i++) {
        h1.innerHTML += `<th>${i}</th>`; b1.innerHTML += `<td id="val1-${i}"></td>`;
        h2.innerHTML += `<th>${i}</th>`; b2.innerHTML += `<td id="val2-${i}"></td>`;
    }
}

function toggleChip(el) { el.classList.toggle('on'); updateStats(); }

document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', () => {
        const game = tab.dataset.game;
        if(currentGame !== game) {
            currentGame = game; initFilters();
            renderCurrentReports();
            document.getElementById('gameTitle').textContent = `${game === '539' ? 'ä»Šå½© 539' : 'å¤§æ¨‚é€'} ä»Šæ—¥è³‡è¨Šï¼š2026/02/05`;
        }
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(tab.dataset.target).classList.add('active');
    });
});

function changeMode(mode, btn) {
    currentMode = mode; clearFilters();
    btn.parentElement.querySelectorAll('.btn').forEach(b => b.classList.remove('btn-orange'));
    btn.classList.add('btn-orange');
}

function clearFilters() {
    document.querySelectorAll('.chip.on').forEach(c => c.classList.remove('on'));
    updateStats();
}

// æ¨¡æ“¬è®€å–é›²ç«¯æ•¸æ“šé€²è¡Œçµ±è¨ˆ
function updateStats() {
    const hasActive = document.querySelectorAll('.chip.on').length > 0;
    document.getElementById('filterCounter').textContent = `é›²ç«¯åŒæ­¥ä¸­... ${hasActive ? 'åŒ¹é…ä¸­' : 'ç­‰å¾…é¸å–'}`;
    for(let i=1; i<=maxNum; i++) {
        const v1 = hasActive ? Math.floor(Math.random()*15) : 0;
        const v2 = hasActive ? Math.floor(Math.random()*20) : 0;
        document.getElementById(`val1-${i}`).textContent = v1 > 0 ? v1 : "";
        document.getElementById(`val2-${i}`).textContent = v2 > 0 ? v2 : "";
    }
}

// åŠ å…¥å ±è¡¨é‚è¼¯
function addToReport() {
    const selItems = [];
    document.querySelectorAll('.chips').forEach(group => {
        if(group.classList.contains('hidden')) return;
        const label = group.dataset.label;
        const chips = Array.from(group.querySelectorAll('.chip.on')).map(c => c.textContent);
        if(chips.length > 0) selItems.push({label, chips});
    });

    const reportObj = {
        mode: currentMode,
        items: selItems,
        timestamp: new Date().getTime()
    };

    reportStorage[currentUser][currentGame].push(reportObj);
    renderCurrentReports();
    document.querySelector(`.tab[data-target="reportPage"][data-game="${currentGame}"]`).click();
}

// æ¸²æŸ“è©²ä½¿ç”¨è€…çš„å ±è¡¨
function renderCurrentReports() {
    const container = document.getElementById('reportContainer');
    container.innerHTML = '';
    const myReports = reportStorage[currentUser][currentGame];

    myReports.slice().reverse().forEach((rep, idx) => {
        const reportDiv = document.createElement('div');
        reportDiv.className = 'report-item';
        reportDiv.dataset.type = rep.mode.substring(0,2);
        
        let html = `
            <div class="report-header">
                <span>ã€${rep.mode}ã€‘åˆ†æ - ä½¿ç”¨è€…ï¼š${currentUser === 'dad' ? 'çˆ¸' : 'å“¥'}</span>
                <span style="color:blue; cursor:pointer;" onclick="deleteReport(${myReports.length - 1 - idx})">[åˆªé™¤]</span>
            </div>
            <table class="report-table">
                <thead><tr style="background:#e2efda"><td class="cond-col">åˆ†æé …ç›®</td>${Array.from({length:maxNum}, (_,i)=>`<td>${i+1}</td>`).join('')}</tr></thead>
                <tbody class="report-body">
        `;

        rep.items.forEach(item => {
            if(rep.mode === 'æ‹–ç‰Œæ¨¡å¼' && item.chips.length === 2) {
                html += `<tr><td class="cond-col">${item.label}:${item.chips[1]} (å¾ŒæœŸ)</td>`;
            } else {
                item.chips.forEach(val => html += `<tr><td class="cond-col">${item.label}:${val}</td>`);
            }
            for(let k=0; k<maxNum; k++) {
                const val = Math.floor(Math.random()*15);
                html += `<td class="${val > 10 ? 'top5' : ''}">${val > 0 ? val : ""}</td>`;
            }
            html += `</tr>`;
        });

        html += `</tbody><tfoot>
                    <tr class="sum-row"><td class="cond-col">åŠ ç¸½ (Sum)</td>${Array.from({length:maxNum}, ()=>`<td class="sum-cell"></td>`).join('')}</tr>
                    <tr class="color-count-row"><td class="cond-col">ä¸Šè‰²æ¬¡æ•¸</td>${Array.from({length:maxNum}, ()=>`<td class="color-cell"></td>`).join('')}</tr>
                </tfoot></table>`;
        
        reportDiv.innerHTML = html;
        container.appendChild(reportDiv);
        calculateReportTotals(reportDiv);
    });
}

function deleteReport(idx) {
    reportStorage[currentUser][currentGame].splice(idx, 1);
    renderCurrentReports();
}

function calculateReportTotals(el) {
    const rows = el.querySelectorAll('.report-body tr');
    const sumCells = el.querySelectorAll('.sum-cell'), colorCells = el.querySelectorAll('.color-cell');
    for (let col = 1; col <= maxNum; col++) {
        let sum = 0, colors = 0;
        rows.forEach(row => {
            const val = parseInt(row.cells[col].textContent) || 0; sum += val;
            if(row.cells[col].classList.contains('top5')) colors++;
        });
        sumCells[col-1].textContent = sum > 0 ? sum : "";
        colorCells[col-1].textContent = colors > 0 ? colors : "";
    }
}

// é›²ç«¯æ•¸æ“šè®€å–åŠŸèƒ½
function fetchSheetData() {
    const key = `${currentGame === '539' ? '539' : '49'}_${currentUser}`;
    const url = sheetUrls[key];
    document.getElementById('loadingOverlay').style.display = 'flex';
    
    Papa.parse(url, {
        download: true,
        header: true,
        complete: function(results) {
            console.log(`å·²æˆåŠŸåŒæ­¥ ${key} æ•¸æ“š`, results.data);
            document.getElementById('loadingOverlay').style.display = 'none';
            alert(`é›²ç«¯æ•¸æ“šåŒæ­¥æˆåŠŸï¼å…± ${results.data.length} ç­†è³‡æ–™`);
        },
        error: function(err) {
            document.getElementById('loadingOverlay').style.display = 'none';
            alert("é›²ç«¯è®€å–å¤±æ•—ï¼Œè«‹æª¢æŸ¥è©¦ç®—è¡¨ç™¼ä½ˆæ¬Šé™");
        }
    });
}

function selectToday() {
    clearFilters();
    fetchSheetData(); // é»æ“Šæ™‚åŒæ­¥æœ€æ–°é›²ç«¯æ•¸æ“š
    const targets = { "æœˆä»½": "2", "æ—¥æœŸ": "5", "æ˜ŸæœŸ": "å››", "å¤©å¹²": "å·±", "åœ°æ”¯": "äº¥" };
    for (let label in targets) {
        if(currentUser === 'bro' && (label === "å¤©å¹²" || label === "åœ°æ”¯")) continue;
        const chip = document.querySelector(`.chips[data-label="${label}"] .chip[data-val="${targets[label]}"]`);
        if(chip) chip.classList.add('on');
    }
}

function clearAllReports() { if(confirm("ç¢ºå®šæ¸…ç©ºå€‹äººå ±è¡¨ï¼Ÿ")) { reportStorage[currentUser][currentGame] = []; renderCurrentReports(); } }

function exportToExcel() {
    const container = document.getElementById('reportContainer');
    const blob = new Blob([`<html><head><meta charset="utf-8"></head><body>${container.innerHTML}</body></html>`], { type: 'application/vnd.ms-excel' });
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `V1_Export.xls`; a.click();
}

initFilters();
</script>
</body>
</html>
