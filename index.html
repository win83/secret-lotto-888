<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>å°ˆæ¥­æ¨‚é€çµ±è¨ˆç³»çµ± V2.2 - å ±è¡¨è‡ªå‹•æ‹†åˆ†ç‰ˆ</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <style>
    :root{
      --page-bg:#cfe8cf; --panel-bg:#fff8e8; --tab-bg:#ededed;
      --tab-border:#9a9a9a; --blue:#1f73ff; --red:#e51b1b;
      --line:#d0d0d0; --label:#efefef; --btn-border:#7a7a7a;
      --stat-green: #92d050; --stat-light: #e2efda;
      --top5-bg: #ff0000; --top5-text: #ffffff;
      --report-header-bg: #fce4d6;
    }
    *{ box-sizing:border-box; font-family:"Microsoft JhengHei"; }
    body{ margin:0; background:var(--page-bg); color:#111; }
    .tabs{ display:grid; grid-template-columns: repeat(4, 1fr); gap:16px; padding:10px 14px 0; }
    .tab{ height:44px; background:var(--tab-bg); border:1px solid var(--tab-border); display:flex; align-items:center; justify-content:center; font-weight:800; cursor:pointer; }
    .tab.active{ border-bottom:3px solid var(--red); background:#f2f2f2; }
    .container{ margin:10px 14px; border:1px solid var(--blue); border-radius:8px; background:var(--panel-bg); padding:10px; min-height: 80vh; }
    .page { display: none; }
    .page.active { display: block; }
    .filters-box{ border:2px solid var(--red); background:#fff; padding:12px; margin-bottom:10px; }
    .grid{ display:grid; grid-template-columns: 90px 1fr; row-gap:10px; }
    .lbl{ background:var(--label); border:1px solid var(--line); display:flex; align-items:center; justify-content:center; font-weight:900; height:36px; }
    .chips{ display:flex; flex-wrap:wrap; gap:8px; padding-left:10px; align-items:center; }
    .chip{ min-width:44px; height:34px; border:1px solid var(--line); border-radius:4px; display:flex; align-items:center; justify-content:center; cursor:pointer; font-weight:800; background:#fff; }
    .chip.on{ outline:3px solid var(--blue); background:#eef4ff; }
    .breakline{ flex-basis: 100%; height: 0; }
    .btnbar{ display:flex; flex-wrap:wrap; gap:8px; align-items:center; margin-top:10px; }
    .btn{ height:40px; padding:0 15px; border:1px solid var(--btn-border); border-radius:4px; font-weight:900; cursor:pointer; }
    .btn-orange{ background:#ffb300 !important; color:#000; }
    .btn-yellow{ background:#ffeb3b; }
    .btn-green{ background:#78c57a; }
    .btn-purple{ background:#6a44c6; color:#fff; }
    .btn-cyan { background:#00bcd4; color:#fff; }
    .btn-red{ background:#ff3b30; color:#fff; border-color:#b21b12; }

    .stat-title { color: red; font-weight: bold; margin-top: 15px; margin-bottom: 5px; }
    .stat-table { width: 100%; border-collapse: collapse; background: #fff; min-width: 800px; }
    .stat-table th, .stat-table td { border: 1px solid #000; text-align: center; padding: 2px; font-size: 11px; font-weight: bold; }
    .stat-table th { background: var(--stat-green); }
    .top5 { background-color: var(--top5-bg) !important; color: var(--top5-text) !important; }

    .report-item { margin-bottom: 30px; border: 1px solid #000; background: #fff; overflow-x: auto; }
    .report-header { background: var(--report-header-bg); padding: 8px; font-weight: bold; border-bottom: 1px solid #000; display:flex; gap:10px; align-items:center; }
    .report-header .title { flex:1; }
    .report-table { width:100%; border-collapse:collapse; font-size:11px; min-width: 1000px; }
    .report-table td { border:1px solid #000; text-align:center; padding:2px; }
    .cond-col { background:#ffff00; font-weight: bold; width: 220px; text-align: left; padding-left: 6px; }
    .sum-row { background:#ddebf7; font-weight:bold; }
    .hidden { display: none !important; }

    #loadingOverlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); display:none; justify-content:center; align-items:center; z-index:9999; font-weight:900; color:red; }
  </style>
</head>
<body>

<div id="loadingOverlay">é›²ç«¯å¤§æ•¸æ“šé‹ç®—ä¸­...</div>

<div class="tabs">
  <div class="tab active" data-game="539" data-target="mainPage">ä»Šå½© 539</div>
  <div class="tab" data-game="539" data-target="reportPage">539 å ±è¡¨</div>
  <div class="tab" data-game="Lotto" data-target="mainPage">å¤§æ¨‚é€</div>
  <div class="tab" data-game="Lotto" data-target="reportPage">å¤§æ¨‚é€ å ±è¡¨</div>
</div>

<div class="container">
  <div id="mainPage" class="page active">
    <div id="gameTitle" style="color:red; font-weight:900; margin-bottom:10px;">ç›®å‰æ¨¡å¼ï¼šä»Šå½© 539</div>

    <div class="btnbar" style="margin-bottom:10px;">
      <button class="btn btn-cyan" id="mode-dad" onclick="switchUser('dad')">çˆ¸ä½¿ç”¨æ¨¡å¼</button>
      <button class="btn" id="mode-bro" onclick="switchUser('bro')">å“¥ä½¿ç”¨æ¨¡å¼</button>
    </div>

    <div class="filters-box"><div class="grid" id="filterGrid"></div></div>

    <div class="btnbar">
      <button class="btn btn-orange mode-btn" onclick="changeMode('æ­·å²æ¨¡å¼', this)">æ­·å²æ¨¡å¼</button>
      <button class="btn btn-yellow mode-btn" onclick="changeMode('æ‹–ç‰Œæ¨¡å¼', this)">æ‹–ç‰Œæ¨¡å¼</button>
      <button class="btn btn-yellow mode-btn" onclick="changeMode('ç•¶æœŸå°ç¢°', this)">ç•¶æœŸå°ç¢°</button>
      <button class="btn btn-yellow mode-btn" onclick="changeMode('ä¸‹æœŸå°ç¢°', this)">ä¸‹æœŸå°ç¢°</button>
      <button class="btn btn-green" onclick="addToReport()">ğŸ§ª åŠ å…¥å ±è¡¨</button>
      <button class="btn" onclick="clearFilters()">æ¸…ç©ºç¯©é¸</button>
    </div>

    <div class="btnbar" style="margin-top:15px; flex-direction: column; align-items: flex-start;">
      <button class="btn btn-purple" onclick="selectToday()">ä¸€éµé¸å–ä»Šæ—¥æ¢ä»¶ & åŒæ­¥é›²ç«¯</button>
      <div id="filterCounter" style="font-weight:bold; font-size:14px; color:red; margin-top:5px; border:1px dashed red; padding:5px; background: #fff;">ç­‰å¾…æ¢ä»¶ä¸­...</div>
    </div>

    <div class="stat-title">å³æ™‚é‹ç®—çµ±è¨ˆ</div>
    <div style="overflow-x:auto">
      <table class="stat-table">
        <thead><tr id="stat-head-1"></tr></thead>
        <tbody><tr id="stat-body-1"></tr></tbody>
      </table>
    </div>

    <div class="stat-title">å…¨åŸŸæœªå‡ºæœŸæ•¸</div>
    <div style="overflow-x:auto">
      <table class="stat-table">
        <thead><tr id="stat-head-2"></tr></thead>
        <tbody><tr id="stat-body-2"></tr></tbody>
      </table>
    </div>
  </div>

  <div id="reportPage" class="page">
    <div id="reportControl" style="background:#ffd966; padding:8px; display:flex; flex-wrap:wrap; gap:10px; align-items:center; margin-bottom:10px; border:1px solid #999;">
      <button class="btn btn-green" onclick="exportToExcel()">åŒ¯å‡º Excel</button>

      <div style="display:flex; gap:5px; border-left: 2px solid #888; padding-left: 10px;">
        <button class="btn btn-yellow rpt-mode-btn" onclick="changeMode('æ­·å²æ¨¡å¼', this)">æ­·å²</button>
        <button class="btn btn-yellow rpt-mode-btn" onclick="changeMode('æ‹–ç‰Œæ¨¡å¼', this)">æ‹–ç‰Œ</button>
        <button class="btn btn-yellow rpt-mode-btn" onclick="changeMode('ç•¶æœŸå°ç¢°', this)">ç•¶æœŸå°ç¢°</button>
        <button class="btn btn-yellow rpt-mode-btn" onclick="changeMode('ä¸‹æœŸå°ç¢°', this)">ä¸‹æœŸå°ç¢°</button>
      </div>

      <button class="btn" style="margin-left:auto; background:yellow" onclick="clearAllReports()">æ¸…ç©ºå ±è¡¨</button>
    </div>
    <div id="reportContainer"></div>
  </div>
</div>

<script>
let currentMode = "æ­·å²æ¨¡å¼", currentGame = "539", currentUser = "dad", maxNum = 39, cloudData = [];

const reportStorage = { dad: { "539": [], "Lotto": [] }, bro: { "539": [], "Lotto": [] } };

const sheetUrls = {
  "539": "https://docs.google.com/spreadsheets/d/e/2PACX-1vRhDtkfS1lZWSOtI58BCPr1Auwgsv-2SkuWNh9OWY6QnrwlMoNZwJcvs9voSH9wf1EkK53MyRVwNZPd/pub?gid=1316642624&single=true&output=csv",
  "Lotto": "https://docs.google.com/spreadsheets/d/e/2PACX-1vRhDtkfS1lZWSOtI58BCPr1Auwgsv-2SkuWNh9OWY6QnrwlMoNZwJcvs9voSH9wf1EkK53MyRVwNZPd/pub?gid=213544897&single=true&output=csv"
};

/* =========================
   æ—¥æœŸ / æ˜ŸæœŸ / æ—¥å¹²æ”¯
   ========================= */
function parseYMD(dateCell){
  const s = String(dateCell || "").trim();
  if(!s) return {y:"", m:"", d:""};

  const m1 = s.match(/^(\d{4})[\/\-\.](\d{1,2})[\/\-\.](\d{1,2})/);
  if(!m1) return {y:"", m:"", d:""};

  return {
    y: String(parseInt(m1[1],10)),
    m: String(parseInt(m1[2],10)),
    d: String(parseInt(m1[3],10))
  };
}

function ymdKey(y,m,d){
  if(!y||!m||!d) return NaN;
  const yy = parseInt(y,10), mm = parseInt(m,10), dd = parseInt(d,10);
  if(!Number.isFinite(yy)||!Number.isFinite(mm)||!Number.isFinite(dd)) return NaN;
  return yy*10000 + mm*100 + dd;
}
function calcWeekday(y,m,d){
  if(!y||!m||!d) return "";
  const dt = new Date(parseInt(y,10), parseInt(m,10)-1, parseInt(d,10));
  if(Number.isNaN(dt.getTime())) return "";
  const map = ["æ—¥","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­"];
  return map[dt.getDay()];
}

const STEMS = ["ç”²","ä¹™","ä¸™","ä¸","æˆŠ","å·±","åºš","è¾›","å£¬","ç™¸"];
const BRANCHES = ["å­","ä¸‘","å¯…","å¯","è¾°","å·³","åˆ","æœª","ç”³","é…‰","æˆŒ","äº¥"];

function jdnFromYMD(y,m,d){
  const Y = parseInt(y,10), M = parseInt(m,10), D = parseInt(d,10);
  if(!Number.isFinite(Y)||!Number.isFinite(M)||!Number.isFinite(D)) return NaN;
  const a = Math.floor((14 - M)/12);
  const yy = Y + 4800 - a;
  const mm = M + 12*a - 3;
  return D + Math.floor((153*mm + 2)/5) + 365*yy + Math.floor(yy/4) - Math.floor(yy/100) + Math.floor(yy/400) - 32045;
}
const BASE_JDN = jdnFromYMD("1984","2","2");
function ganzhiOfDay(y,m,d){
  const jdn = jdnFromYMD(y,m,d);
  if(!Number.isFinite(jdn) || !Number.isFinite(BASE_JDN)) return {stem:"", branch:""};
  let idx = (jdn - BASE_JDN) % 60; if(idx < 0) idx += 60;
  return { stem: STEMS[idx % 10], branch: BRANCHES[idx % 12] };
}

function extractJieqiFromRow(row){
  if(currentUser !== "dad") return "";
  const re = /^(S|T)(?:[0-9]|1[0-5])$/i;
  for(let i=2;i<=5;i++){
    const v = String(row[i] ?? "").trim();
    if(re.test(v)) return v.toUpperCase();
  }
  return "";
}
function buildJieqiOptions(){
  const S = Array.from({length:16},(_,i)=>`S${i}`);
  const T = Array.from({length:16},(_,i)=>`T${i}`);
  return [...S, ...T];
}

function startKeyByUser(){ return (currentUser === "dad") ? 20200101 : 20060101; }
function startYearByUser(){ return (currentUser === "dad") ? 2020 : 2006; }

/* =========================
   çƒè™Ÿæ¬„ä½è®€å–èˆ‡é©—è­‰
   ========================= */
function requiredBallCount(){
  return (currentGame === "539") ? 5 : 6; 
}

function rowBalls(row){
  let limit = (currentGame === "539") ? 39 : 49;
  let endIdx = (currentGame === "539") ? 11 : 13;
  return row
    .slice(6, endIdx)
    .map(v => parseInt(String(v).trim(), 10))
    .filter(n => !isNaN(n) && n > 0 && n <= limit);
}

function hasEnoughBalls(row){
  const balls = rowBalls(row);
  return balls.length >= requiredBallCount();
}

function getValidRows(){
  const sk = startKeyByUser();
  return cloudData.filter(row => {
    if (!row || row.length < 7) return false; 
    const {y,m,d} = parseYMD(row[1]);
    let k = ymdKey(y,m,d);
    if(isNaN(k)) {
        const alt = parseYMD(row[0]);
        k = ymdKey(alt.y, alt.m, alt.d);
    }
    if(!Number.isFinite(k) || k < sk) return false;
    if(!hasEnoughBalls(row)) return false;
    return true;
  });
}

function newGroup(mode, title){
  const gLimit = (currentGame === "539") ? 39 : 49;
  return {
    id: `${Date.now()}_${Math.random().toString(16).slice(2)}`,
    mode,
    title,
    limit: gLimit,
    rows: [],
    sum: Array(gLimit + 1).fill(0)
  };
}
function addRowToGroup(group, label, dataArr){
  group.rows.push({ label, data: dataArr });
  for(let i=1;i<=group.limit;i++){
    group.sum[i] += (dataArr[i] || 0);
  }
}

function getSelectedFilters(){
  const filters = {};
  const keys = (currentUser === "dad")
    ? ["å¹´ä»½","æœˆä»½","æ—¥æœŸ","æ˜ŸæœŸ","å¤©å¹²","åœ°æ”¯","ç¯€æ°£"]
    : ["å¹´ä»½","æœˆä»½","æ—¥æœŸ","æ˜ŸæœŸ","å¤©å¹²","åœ°æ”¯"];

  keys.forEach(lbl => {
    const sel = Array.from(document.querySelectorAll(`.chips[data-label="${lbl}"] .chip.on`))
      .map(c => String(c.textContent).trim());
    if(sel.length) filters[lbl] = sel;
  });
  return filters;
}
function getSelectedNums(){
  return Array.from(document.querySelectorAll(`.chips[data-label="è™Ÿç¢¼"] .chip.on`))
    .map(c => parseInt(c.textContent,10))
    .filter(n => Number.isFinite(n));
}
function fmtFilters(filters){
  return Object.entries(filters).map(([k,v])=>`${k}:${v.join(',')}`).join(' + ') || "ç„¡æ¢ä»¶";
}
function rowMetaFromRow(row){
  let {y,m,d} = parseYMD(row[1]);
  if(!y) { const alt = parseYMD(row[0]); y=alt.y; m=alt.m; d=alt.d; }
  const w = calcWeekday(y,m,d);
  const gz = ganzhiOfDay(y,m,d);
  const jq = extractJieqiFromRow(row);
  return { y,m,d,w, stem:gz.stem, branch:gz.branch, jieqi: jq };
}
function buildRd(meta){
  const rd = {
    "å¹´ä»½": meta.y,
    "æœˆä»½": meta.m,
    "æ—¥æœŸ": meta.d,
    "æ˜ŸæœŸ": meta.w,
    "å¤©å¹²": meta.stem,
    "åœ°æ”¯": meta.branch
  };
  if(currentUser === "dad") rd["ç¯€æ°£"] = meta.jieqi;
  return rd;
}
function matchFilters(rd, filters){
  for(const k in filters){
    if(!filters[k].includes(rd[k])) return false;
  }
  return true;
}

function switchUser(role) {
  currentUser = role;
  document.getElementById('mode-dad').classList.toggle('btn-cyan', role==='dad');
  document.getElementById('mode-bro').classList.toggle('btn-cyan', role==='bro');
  initFilters();
  updateStats();
}

function initFilters() {
  maxNum = (currentGame === "539") ? 39 : 49;
  document.getElementById('gameTitle').textContent = `ç›®å‰æ¨¡å¼ï¼š${currentGame} - ${currentMode}`;
  const grid = document.getElementById('filterGrid'); grid.innerHTML = '';
  const yStart = startYearByUser();
  const yEnd = 2026;
  const years = Array.from({length: yEnd - yStart + 1}, (_, i) => yStart + i);
  const sections = [
    {lbl:"å¹´ä»½", d: years},
    {lbl:"æœˆä»½", d:Array.from({length: 12}, (_, i) => i + 1)},
    {lbl:"æ—¥æœŸ", d:Array.from({length: 31}, (_, i) => i + 1), brk:18},
    {lbl:"æ˜ŸæœŸ", d: ["ä¸€","äºŒ","ä¸‰","å››","äº”","å…­","æ—¥"]},
    {lbl:"å¤©å¹²", d: STEMS},
    {lbl:"åœ°æ”¯", d: BRANCHES},
    {lbl:"ç¯€æ°£", d: buildJieqiOptions(), brk:16},
    {lbl:"è™Ÿç¢¼", d: Array.from({length:maxNum}, (_,i)=>String(i+1).padStart(2,'0')), brk:25}
  ];
  sections.forEach(sec => {
    const isSB = (sec.lbl === "å¤©å¹²" || sec.lbl === "åœ°æ”¯");
    const isJQ = (sec.lbl === "ç¯€æ°£");
    const hidden = (currentUser === "bro" && (isSB || isJQ)) ? "hidden" : "";
    grid.innerHTML += `<div class="lbl ${hidden}">${sec.lbl}</div>`;
    let html = `<div class="chips ${hidden}" data-label="${sec.lbl}">`;
    sec.d.forEach((v, i) => {
      if(sec.brk && i === sec.brk) html += `<div class="breakline"></div>`;
      html += `<div class="chip" data-val="${v}" onclick="toggleChip(this)">${v}</div>`;
    });
    grid.innerHTML += html + `</div>`;
  });
  updateStatTableUI();
  syncModeButtons();
}

function updateStatTableUI() {
  const h1 = document.getElementById('stat-head-1'), b1 = document.getElementById('stat-body-1');
  const h2 = document.getElementById('stat-head-2'), b2 = document.getElementById('stat-body-2');
  h1.innerHTML = b1.innerHTML = h2.innerHTML = b2.innerHTML = '';
  for(let i=1; i<=maxNum; i++) {
    h1.innerHTML += `<th>${i}</th>`; b1.innerHTML += `<td id="val1-${i}">0</td>`;
    h2.innerHTML += `<th>${i}</th>`; b2.innerHTML += `<td id="val2-${i}">0</td>`;
  }
}

function toggleChip(el) { el.classList.toggle('on'); updateStats(); }

function fetchSheetData(callback) {
  document.getElementById('loadingOverlay').style.display = 'flex';
  Papa.parse(sheetUrls[currentGame] + "&t=" + Date.now(), {
    download: true, header: false, skipEmptyLines: true,
    complete: function(results) {
      document.getElementById('loadingOverlay').style.display = 'none';
      cloudData = results.data.slice(1);
      if(callback) callback(results.data[results.data.length - 1]);
      updateStats();
    }
  });
}

function updateStats() {
  if(!cloudData.length) return;
  const filters = getSelectedFilters();
  const catCount = Object.keys(filters).length;
  const selNums = getSelectedNums();
  const counts = Array(maxNum + 1).fill(0);
  const validRows = getValidRows();
  validRows.forEach((row, idx) => {
    const meta = rowMetaFromRow(row);
    const rd = buildRd(meta);
    if(!matchFilters(rd, filters)) return;
    const nums = rowBalls(row);
    if (currentMode === "æ­·å²æ¨¡å¼") {
      nums.forEach(n => { if(n <= maxNum) counts[n]++; });
    } else if (currentMode === "æ‹–ç‰Œæ¨¡å¼" || currentMode === "ä¸‹æœŸå°ç¢°") {
      if (selNums.length > 0 && selNums.some(sn => nums.includes(sn))) {
        const nxt = validRows[idx+1];
        if(nxt) rowBalls(nxt).forEach(n => { if(n <= maxNum) counts[n]++; });
      }
    } else if (currentMode === "ç•¶æœŸå°ç¢°") {
      if (selNums.length > 0 && selNums.every(sn => nums.includes(sn))) {
        nums.forEach(n => { if(n <= maxNum) counts[n]++; });
      }
    }
  });
  const sorted = [...counts].sort((a,b)=>b-a);
  const threshold = sorted[4] > 0 ? sorted[4] : 999;
  const sk = startKeyByUser();
  const skStr = `${String(Math.floor(sk/10000))}/${String(Math.floor((sk%10000)/100)).padStart(2,'0')}/${String(sk%100).padStart(2,'0')}`;
  document.getElementById('filterCounter').textContent =
    `æ¨¡å¼:${currentMode} | æ¢ä»¶æ•¸:${catCount} | åƒèˆ‡çµ±è¨ˆæœŸæ•¸:${validRows.length} | èµ·ç®—æ—¥:${skStr}`;
  for(let i=1; i<=maxNum; i++){
    const td = document.getElementById(`val1-${i}`);
    td.textContent = counts[i] || 0;
    td.className = (counts[i] >= threshold && counts[i] > 0) ? "top5" : "";
    let gap = 0;
    for(let j=validRows.length-1; j>=0; j--){
      if(rowBalls(validRows[j]).includes(i)) break;
      gap++;
    }
    document.getElementById(`val2-${i}`).textContent = gap;
  }
}

/* =========================
   ä¿®æ­£æ ¸å¿ƒï¼šå ±è¡¨ç”Ÿæˆé‚è¼¯ (é‡å°å ±è¡¨æ‹†åˆ†èˆ‡è™Ÿç¢¼æ‹†åˆ†)
   ========================= */
function addToReport() {
  if (!cloudData.length) return alert("å°šæœªè¼‰å…¥è³‡æ–™");
  const validRows = getValidRows();
  if (!validRows.length) return alert("ç„¡æœ‰æ•ˆè³‡æ–™åˆ—");
  
  const filters = getSelectedFilters();
  const selNums = getSelectedNums();
  const gameMax = (currentGame === "539") ? 39 : 49;

  // å»ºç«‹å ±è¡¨ä¸»é«”ç‰©ä»¶
  const group = newGroup(currentMode, `ã€${currentMode}ã€‘${fmtFilters(filters)}`);

  // --- é‚è¼¯ 1: è™•ç†æ¨™ç±¤æ‹†åˆ† (å¦‚æ—¥æœŸ 5,6,7) ---
  Object.entries(filters).forEach(([cat, vals]) => {
    vals.forEach(val => {
      const counts = Array(gameMax + 1).fill(0);
      const singleFilter = {}; singleFilter[cat] = [val];

      validRows.forEach((row, idx) => {
        const meta = rowMetaFromRow(row);
        const rd = buildRd(meta);
        if (singleFilter[cat].includes(rd[cat])) {
          const balls = rowBalls(row);
          if (currentMode === "æ­·å²æ¨¡å¼") {
            balls.forEach(n => { if(n <= gameMax) counts[n]++; });
          } else if (currentMode === "æ‹–ç‰Œæ¨¡å¼" || currentMode === "ä¸‹æœŸå°ç¢°") {
            if (selNums.some(sn => balls.includes(sn)) && validRows[idx+1]) {
              rowBalls(validRows[idx+1]).forEach(n => { if(n <= gameMax) counts[n]++; });
            }
          } else if (currentMode === "ç•¶æœŸå°ç¢°") {
            if (selNums.every(sn => balls.includes(sn))) {
              balls.forEach(n => { if(n <= gameMax) counts[n]++; });
            }
          }
        }
      });
      addRowToGroup(group, `${cat}: ${val}`, counts);
    });
  });

  // --- é‚è¼¯ 2: è™•ç†è™Ÿç¢¼æ‹†åˆ† (é‡å°æ‹–ç‰Œ/å°ç¢°ï¼Œè™Ÿç¢¼åˆ†é–‹å‘ˆç¾) ---
  if (currentMode !== "æ­·å²æ¨¡å¼" && selNums.length > 0) {
    selNums.forEach(num => {
      const counts = Array(gameMax + 1).fill(0);
      validRows.forEach((row, idx) => {
        const meta = rowMetaFromRow(row);
        const rd = buildRd(meta);
        // ç¬¦åˆç¸½é«”æ¨™ç±¤ç¯©é¸
        if (!matchFilters(rd, filters)) return;

        const balls = rowBalls(row);
        if (balls.includes(num)) {
          if ((currentMode === "æ‹–ç‰Œæ¨¡å¼" || currentMode === "ä¸‹æœŸå°ç¢°") && validRows[idx+1]) {
            rowBalls(validRows[idx+1]).forEach(n => { if(n <= gameMax) counts[n]++; });
          } else if (currentMode === "ç•¶æœŸå°ç¢°") {
            balls.forEach(n => { if(n <= gameMax && n !== num) counts[n]++; });
          }
        }
      });
      addRowToGroup(group, `è™Ÿç¢¼: ${num}`, counts);
    });
  }

  // å„²å­˜ä¸¦åˆ‡æ›
  reportStorage[currentUser][currentGame].push(group);
  renderCurrentReports();
  const targetTab = document.querySelector(`.tab[data-target="reportPage"][data-game="${currentGame}"]`);
  if(targetTab) targetTab.click();
}

function deleteReport(groupId){
  const list = reportStorage[currentUser][currentGame];
  const idx = list.findIndex(g => g.id === groupId);
  if(idx < 0) return;
  if(!confirm("ç¢ºå®šåˆªé™¤é€™å¼µå ±è¡¨ï¼Ÿ")) return;
  list.splice(idx, 1);
  renderCurrentReports();
}

function renderCurrentReports() {
  const cont = document.getElementById('reportContainer');
  cont.innerHTML = '';
  const groups = reportStorage[currentUser][currentGame];
  if(!groups.length) return;
  
  let html = '';
  groups.forEach((g, gi) => {
    const gLimit = g.limit;
    html += `<div class="report-item"><div class="report-header"><div class="title">ã€ç¬¬ ${gi+1} å¼µã€‘${g.title}</div><button class="btn btn-red" onclick="deleteReport('${g.id}')">åˆªé™¤æ­¤å ±è¡¨</button></div><table class="report-table"><thead><tr><td class="cond-col">çµ±è¨ˆæ˜ç´°</td>${Array.from({length:gLimit},(_,i)=>`<td>${i+1}</td>`).join('')}</tr></thead><tbody class="report-body">`;
    
    g.rows.forEach(r=>{
      const sorted = [...r.data].slice(1).sort((a,b)=>b-a);
      const threshold = (sorted[4] > 0) ? sorted[4] : 999;
      html += `<tr><td class="cond-col">${r.label}</td>${r.data.slice(1).map(v => {
        const vv = v||0; const cls = (vv >= threshold && vv > 0) ? 'top5' : '';
        return `<td class="${cls}">${vv ? vv : ''}</td>`;
      }).join('')}</tr>`;
    });
    
    const sumSorted = [...g.sum].slice(1).sort((a,b)=>b-a);
    const sumTh = (sumSorted[4] > 0) ? sumSorted[4] : 999;
    html += `</tbody><tfoot><tr class="sum-row"><td class="cond-col">åŠ ç¸½ (Sum)</td>${g.sum.slice(1).map(v=>{
      const vv = v||0; const cls = (vv >= sumTh && vv > 0) ? 'top5' : '';
      return `<td class="${cls}">${vv ? vv : ''}</td>`;
    }).join('')}</tr></tfoot></table></div>`;
  });
  cont.innerHTML = html;
}

function changeMode(mode, btn) {
  currentMode = (mode.includes('æ¨¡å¼')) ? mode : mode + 'æ¨¡å¼';
  syncModeButtons();
  if(document.getElementById('mainPage').classList.contains('active')) { updateStats(); } else { renderCurrentReports(); }
}

function syncModeButtons() {
  document.querySelectorAll('.mode-btn').forEach(b => { b.classList.toggle('btn-orange', b.textContent === currentMode); });
  document.querySelectorAll('.rpt-mode-btn').forEach(b => {
    const simpleMode = currentMode.replace('æ¨¡å¼', '');
    b.classList.toggle('btn-orange', b.textContent === simpleMode);
  });
}

function selectToday() {
  clearFilters();
  fetchSheetData((lastRow) => {
    const meta = rowMetaFromRow(lastRow);
    if(meta.m) autoClick('æœˆä»½', meta.m);
    if(meta.d) autoClick('æ—¥æœŸ', meta.d);
    if(meta.w) autoClick('æ˜ŸæœŸ', meta.w);
    if(currentUser === 'dad'){
      if(meta.stem) autoClick('å¤©å¹²', meta.stem);
      if(meta.branch) autoClick('åœ°æ”¯', meta.branch);
      if(meta.jieqi) autoClick('ç¯€æ°£', meta.jieqi);
    }
    updateStats();
  });
}

function autoClick(label, val) {
  const vv = String(val).trim();
  const c = document.querySelector(`.chips[data-label="${label}"] .chip[data-val="${vv}"]`);
  if(c) c.classList.add('on');
}

function exportToExcel() {
  let table = document.querySelector(".report-table");
  if(!table) return alert("ç„¡è³‡æ–™");
  let url = 'data:application/vnd.ms-excel,' + encodeURIComponent(table.outerHTML);
  let link = document.createElement("a"); link.download = `åˆ†æ_${Date.now()}.xls`; link.href = url; link.click();
}

function clearFilters() { document.querySelectorAll('.chip.on').forEach(c => c.classList.remove('on')); updateStats(); }
function clearAllReports() {
  if(confirm("ç¢ºå®šæ¸…ç©ºï¼Ÿ")) { reportStorage[currentUser][currentGame] = []; renderCurrentReports(); }
}

document.querySelectorAll('.tab').forEach(tab => {
  tab.addEventListener('click', () => {
    currentGame = tab.dataset.game;
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active')); tab.classList.add('active');
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById(tab.dataset.target).classList.add('active');
    if(tab.dataset.target === 'mainPage') { initFilters(); fetchSheetData(); } else { renderCurrentReports(); syncModeButtons(); }
  });
});

initFilters();
fetchSheetData();
</script>
</body>
</html>
