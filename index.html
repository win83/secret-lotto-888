<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>539 專業回測系統 - 報表加總版</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <style>
        :root { --bg: #d1e7d1; --blue-t: #2196F3; --red-box: #f44336; --gold: #ffc107; }
        body { background-color: var(--bg); font-family: "Microsoft JhengHei", sans-serif; font-size: 13px; margin: 15px; }
        .main-layout { display: flex; flex-direction: column; gap: 10px; }
        .filter-panel { border: 2px solid var(--red-box); background: #fff; padding: 15px; display: grid; grid-template-columns: 60px 1fr; gap: 8px; border-radius: 8px; }
        .f-label { background: #eee; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 1px solid #ccc; }
        .f-btns { display: flex; flex-wrap: wrap; gap: 4px; }
        .f-item { padding: 4px 12px; border: 1px solid #ccc; cursor: pointer; background: #fff; border-radius: 4px; position: relative; }
        .f-item.active { background: var(--blue-t); color: white; }
        .action-bar { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; background: rgba(255,255,255,0.5); padding: 10px; border-radius: 8px; }
        .yellow-btn { background: #ffff00; border: 1px solid #000; padding: 8px 15px; font-weight: bold; cursor: pointer; border-radius: 4px; }
        .yellow-btn.active { background: #ff9800 !important; color: white; }
        .add-btn { background: #4CAF50; color: white; border: 1px solid #000; padding: 8px 20px; font-weight: bold; cursor: pointer; border-radius: 4px; }
        .view-container { background: white; border: 2px solid var(--blue-t); padding: 10px; border-radius: 8px; min-height: 500px; }
        .scroll-area { overflow: auto; max-height: 550px; }
        table { border-collapse: collapse; width: 100%; white-space: nowrap; }
        th, td { border: 1px solid #ccc; padding: 5px; text-align: center; }
        .num-cell { width: 25px; }
        .report-card { border: 2px solid #333; background: #fff; margin-bottom: 25px; border-radius: 4px; }
        .report-title { background: #7da7d8; padding: 10px; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        .top-hit { background-color: #ffff00 !important; font-weight: bold; color: #d32f2f; }
        .total-row { background-color: #fce4ec; font-weight: bold; color: #c2185b; }
        .hidden { display: none; }
    </style>
</head>
<body>

<div class="main-layout">
    <div style="display:flex; gap:5px;">
        <button onclick="switchPage('dist')" style="flex:1; padding:12px; font-weight:bold; cursor:pointer;">數據分佈圖</button>
        <button onclick="switchPage('repo')" style="flex:1; padding:12px; font-weight:bold; cursor:pointer;">匯總報表</button>
    </div>

    <div id="page-dist" class="view-container">
        <div class="filter-panel">
            <div class="f-label">年份</div><div class="f-btns" data-type="year"></div>
            <div class="f-label">週</div><div class="f-btns" data-type="week"></div>
            <div class="f-label">天干</div><div class="f-btns" data-type="tian"></div>
            <div class="f-label">地支</div><div class="f-btns" data-type="di"></div>
            <div class="f-label">節氣</div><div class="f-btns" data-type="solar"></div>
            <div class="f-label" style="color:blue">號碼</div><div class="f-btns" data-type="nums"></div>
        </div>
        <div class="action-bar">
            <button class="yellow-btn btn-mode-h" onclick="setMode('history')">歷史統計</button>
            <button class="yellow-btn btn-mode-t" onclick="setMode('tuopai')">拖牌模式</button>
            <button class="add-btn" onclick="generateBatchReport()">加入報表</button>
            <button onclick="clearFilters()">清空篩選</button>
            <span id="fileMsg" style="margin-left:auto; font-weight:bold; color:red;">讀取中...</span>
        </div>
        <div class="scroll-area">
            <table>
                <thead><tr id="thr"><th>期號</th><th>開獎日期</th><th>週</th><th>天干</th><th>地支</th><th>節氣</th><th>球1</th><th>球2</th><th>球3</th><th>球4</th><th>球5</th></tr></thead>
                <tbody id="gridBody"></tbody>
            </table>
        </div>
    </div>

    <div id="page-repo" class="view-container hidden">
        <div id="repo-list"></div>
    </div>
</div>

<script>
    const GSHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTuGa3v-rwH8Qh-JXF9MfxwUwT0A-iJooRI6ypJTErCsxN9qCjZQrgr70f16ZoehQ/pub?output=csv";
    let db = [];
    let filters = { year:[], week:[], tian:[], di:[], solar:[], nums:[] };
    let currentMode = 'history';
    let savedReports = JSON.parse(localStorage.getItem('539_reports') || "[]");

    async function init() {
        build('week', ['週一','週二','週三','週四','週五','週六']);
        build('tian', ['甲','乙','丙','丁','戊','己','庚','辛','壬','癸']);
        build('di', ['子','丑','寅','卯','辰','巳','午','未','申','酉','戌','亥']);
        let slist = []; for(let i=0; i<=13; i++) { slist.push('T'+i); slist.push('S'+i); }
        build('solar', slist);
        build('nums', Array.from({length:39}, (_,i)=>i+1));
        
        for(let i=1; i<=39; i++) {
            const th = document.createElement('th'); th.style.background = '#ffc107';
            th.innerHTML = `${i}<br><span id="s-${i}" style="font-size:10px; color:blue">0</span>`;
            document.getElementById('thr').appendChild(th);
        }

        try {
            const resp = await fetch(GSHEET_CSV_URL);
            const text = await resp.text();
            const wb = XLSX.read(text, { type: 'string' });
            db = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { header: 1 })
                 .filter(row => row[0] && !isNaN(row[0].toString().substring(0,3)));

            const years = [...new Set(db.map(row => row[1].toString().split('/')[0]))].sort((a,b)=>b-a);
            build('year', years);

            renderGrid();
            document.getElementById('fileMsg').innerText = `數據：${db.length} 期`;
            setMode('history');
            updateReportUI();
        } catch (e) { console.error(e); }
    }

    function build(type, list) {
        const box = document.querySelector(`[data-type="${type}"]`);
        box.innerHTML = '';
        list.forEach(v => {
            const div = document.createElement('div');
            div.className = 'f-item'; div.innerText = v;
            div.onclick = () => {
                const idx = filters[type].indexOf(v);
                if(idx>-1) { filters[type].splice(idx,1); div.classList.remove('active'); }
                else { filters[type].push(v); div.classList.add('active'); }
                applyFilter();
            };
            box.appendChild(div);
        });
    }

    function renderGrid() {
        const body = document.getElementById('gridBody');
        body.innerHTML = '';
        db.forEach((row, idx) => {
            const tr = document.createElement('tr');
            tr.id = `row-${idx}`;
            for(let i=0; i<11; i++) {
                const td = document.createElement('td');
                td.innerText = row[i] || '';
                tr.appendChild(td);
            }
            for(let n=1; n<=39; n++) {
                const td = document.createElement('td');
                td.className = 'num-cell';
                td.setAttribute('data-n', n);
                tr.appendChild(td);
            }
            body.appendChild(tr);
        });
        applyFilter();
    }

    function applyFilter() {
        const rows = document.querySelectorAll('#gridBody tr');
        let counts = Array(40).fill(0);
        rows.forEach(tr => {
            const data = db[tr.id.split('-')[1]];
            let ok = true;
            if(filters.year.length > 0) ok &= filters.year.includes(data[1].toString().split('/')[0]);
            ['week','tian','di','solar'].forEach((cat, i) => {
                if(filters[cat].length > 0) ok &= filters[cat].some(v => data[i+2].toString().includes(v));
            });
            const winNums = data.slice(6,11).map(Number);
            if(filters.nums.length > 0) ok &= filters.nums.every(n => winNums.includes(Number(n)));

            tr.style.display = ok ? '' : 'none';
            if(ok) {
                const cells = tr.querySelectorAll('.num-cell');
                cells.forEach(td => {
                    const n = parseInt(td.getAttribute('data-n'));
                    if(winNums.includes(n)) { td.innerText = n; td.style.color = 'red'; td.style.fontWeight='bold'; counts[n]++; }
                    else { td.innerText = ''; }
                });
            }
        });
        for(let i=1; i<=39; i++) document.getElementById(`s-${i}`).innerText = counts[i];
    }

    function generateBatchReport() {
        const results = [];
        const catNames = { year:'年份', week:'週', tian:'天干', di:'地支', solar:'節氣' };
        
        if(currentMode === 'history') {
            ['year','week','tian','di','solar'].forEach(cat => {
                filters[cat].forEach(val => {
                    let s = Array(40).fill(0), c = 0;
                    db.forEach(row => {
                        let rowVal = (cat === 'year') ? row[1].toString().split('/')[0] : row[['week','tian','di','solar'].indexOf(cat)+2].toString();
                        if(rowVal.includes(val)) {
                            row.slice(6,11).map(Number).forEach(n => { if(n>0) s[n]++; });
                            c++;
                        }
                    });
                    if(c > 0) results.push({ label: `${catNames[cat]}:${val}`, data: s, matches: c });
                });
            });
            saveAndRender("歷史統計報表", results);
        } 
        else if (currentMode === 'tuopai') {
            ['week','tian','di','solar'].forEach(cat => {
                if(filters[cat].length === 2) {
                    const [v1, v2] = filters[cat];
                    const col = ['week','tian','di','solar'].indexOf(cat)+2;
                    let s = Array(40).fill(0), c = 0;
                    for(let i=1; i<db.length; i++) {
                        if(db[i-1][col].toString().includes(v1) && db[i][col].toString().includes(v2)) {
                            db[i].slice(6,11).map(Number).forEach(n => { if(n>0) s[n]++; });
                            c++;
                        }
                    }
                    if(c > 0) results.push({ label: `拖牌:${v1}→${v2}`, data: s, matches: c });
                }
            });
            saveAndRender("拖牌分析報表", results);
        }
        switchPage('repo');
    }

    function saveAndRender(title, rows) {
        savedReports.unshift({ title, rows, id: Date.now() });
        localStorage.setItem('539_reports', JSON.stringify(savedReports));
        updateReportUI();
    }

    function updateReportUI() {
        const list = document.getElementById('repo-list');
        list.innerHTML = '';
        savedReports.forEach(report => {
            const card = document.createElement('div');
            card.className = 'report-card';
            let h = `<div class="report-title"><span>${report.title}</span><button onclick="deleteRepo(${report.id})">刪除</button></div>`;
            h += `<div class="scroll-area"><table><thead><tr><th>項目</th>`;
            for(let i=1; i<=39; i++) h += `<th>${i}</th>`;
            h += `</tr></thead><tbody>`;

            // 計算加總用的陣列
            let totals = Array(40).fill(0);

            report.rows.forEach(r => {
                h += `<tr><td>${r.label}(${r.matches}期)</td>`;
                for(let i=1; i<=39; i++) {
                    let val = r.data[i] || 0;
                    h += `<td>${val || ''}</td>`;
                    totals[i] += val; // 累加至總計
                }
                h += `</tr>`;
            });

            // 新增：最後一列加總列
            h += `<tr class="total-row"><td>加總次數</td>`;
            for(let i=1; i<=39; i++) {
                h += `<td>${totals[i] || ''}</td>`;
            }
            h += `</tr>`;

            h += `</tbody></table></div>`;
            card.innerHTML = h;
            list.appendChild(card);
        });
    }

    function deleteRepo(id) {
        savedReports = savedReports.filter(r => r.id !== id);
        localStorage.setItem('539_reports', JSON.stringify(savedReports));
        updateReportUI();
    }

    function setMode(m) {
        currentMode = m;
        document.querySelectorAll('.yellow-btn').forEach(b => b.classList.remove('active'));
        if(m==='history') document.querySelector('.btn-mode-h').classList.add('active');
        if(m==='tuopai') document.querySelector('.btn-mode-t').classList.add('active');
    }

    function switchPage(p) {
        document.getElementById('page-dist').classList.toggle('hidden', p !== 'dist');
        document.getElementById('page-repo').classList.toggle('hidden', p !== 'repo');
    }

    function clearFilters() {
        filters = { year:[], week:[], tian:[], di:[], solar:[], nums:[] };
        document.querySelectorAll('.f-item').forEach(el => el.classList.remove('active'));
        applyFilter();
    }

    init();
</script>
</body>
</html>
