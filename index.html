<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>Lotto System Pro - Final Stable Version</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        :root {
            --label-bg: #e9ecef;
            --btn-border: #dee2e6;
            --active-blue: #3498db;
            --active-yellow: #fbc02d;
            --active-green: #2ecc71;
            --report-blue: #0056b3;
        }

        body { font-family: "Microsoft JhengHei", sans-serif; background: #f4f7f9; margin: 0; padding: 20px; }
        .hidden { display: none !important; }
        .main-container { background: #fff; border: 1px solid #ddd; padding: 20px; border-radius: 4px; max-width: 1550px; margin: 0 auto; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }

        .row { display: flex; align-items: flex-start; gap: 8px; margin-bottom: 12px; }
        .label { 
            background: var(--label-bg); min-width: 85px; height: 38px; 
            display: flex; align-items: center; justify-content: center; 
            border-radius: 6px; font-size: 14px; font-weight: bold; border: 1px solid #ddd; flex-shrink: 0;
        }
        .btn-group { display: flex; flex-wrap: wrap; gap: 6px; align-items: center; }
        .btn {
            background: #fff; border: 1px solid var(--btn-border);
            padding: 8px 12px; border-radius: 6px; cursor: pointer;
            font-size: 14px; transition: all 0.1s; outline: none;
        }
        .btn.active-blue { background: var(--active-blue) !important; color: white; border-color: #2980b9; }
        
        .btn.active-yellow { background: var(--active-yellow) !important; color: #000; border-color: #f9a825; font-weight: bold; }
        .btn.active-green { background: var(--active-green) !important; color: white !important; border-color: #27ae60; font-weight: bold; }
        
        .btn.drag-pre-active { background: var(--active-yellow) !important; color: #000; font-weight: bold; border-color: #f9a825; }
        .btn.drag-post-active { background: var(--active-green) !important; color: white; font-weight: bold; border-color: #27ae60; }

        /* å…¨é¸æŒ‰éˆ•æ¨£å¼ */
        .select-all-btn { background: #f1f2f6; border: 1px solid #ced4da; color: #2f3542; font-weight: bold; padding: 8px 10px; }
        .select-all-btn:hover { background: #dfe4ea; }

        #toast-msg { margin-left: 15px; color: #27ae60; font-weight: bold; opacity: 0; transition: opacity 0.3s; }

        /* å ±è¡¨é¡¯ç¤ºæ¨£å¼ */
        .report-section { margin-bottom: 30px; border: 1px solid var(--report-blue); border-radius: 4px; overflow: hidden; background: #fff; }
        .report-banner { background: var(--report-blue); color: white; padding: 8px 15px; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        
        /* è¡¨é ­å›ºå®šèˆ‡æ»¾å‹•å®¹å™¨ */
        .table-container { max-height: 550px; overflow-y: auto; }
        .report-table { width: 100%; border-collapse: collapse; font-size: 12px; table-layout: fixed; }
        .report-table th, .report-table td { border: 1px solid #ccc; text-align: center; padding: 5px 0; }
        .report-table th { background: #f8f9fa; position: sticky; top: 0; z-index: 5; box-shadow: 0 1px 1px rgba(0,0,0,0.1); }
        .report-table th:first-child { min-width: 140px; z-index: 6; left: 0; }
        
        .top5-cell { background: #fbc02d !important; font-weight: bold; }
        .total-row { background: #fbc02d; font-weight: bold; }
        .total-top5 { border: 2px solid red !important; }
        .accum-row { background: #95e895; font-weight: bold; }

        /* å‹•æ…‹ç¯©é¸åˆ— & å°ç¢°å¿«ç¯©åˆ— */
        #dynamic-filter-bar { background: #f8f9fa; padding: 10px; border-radius: 6px; margin-bottom: 15px; border: 1px dashed #ccc; display: flex; gap: 6px; flex-wrap: wrap; }
        .quick-filter-area { background: #ecf0f1; padding: 8px 15px; border-bottom: 1px solid #bdc3c7; display: flex; gap: 4px; flex-wrap: wrap; align-items: center; }
        .quick-btn { padding: 4px 8px; font-size: 12px; border-radius: 4px; }
        
        /* ä¸‹æ¨NæœŸè¼¸å…¥æ¡† */
        #push-n-container { display: inline-flex; align-items: center; background: #fff3cd; padding: 5px 10px; border-radius: 4px; border: 1px solid #ffeeba; margin-left: 10px; font-weight: bold; color: #856404; }
        #pushN { border: 1px solid #ced4da; padding: 4px; border-radius: 3px; text-align: center; font-weight: bold; margin: 0 5px; }

        /* ç•¶æœŸ/ä¸‹æœŸå°ç¢°çµ„åˆå¾½ç«  */
        .pair-badge { display: inline-block; background: #fff; border: 1px solid #b2bec3; padding: 3px 8px; border-radius: 4px; margin: 3px; font-size: 13px; color: #2d3436; font-weight:bold; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }

        /* ç™»å…¥é˜²è­·ç•«é¢æ¨£å¼ */
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #2c3e50; display: flex; flex-direction: column;
            align-items: center; justify-content: center; z-index: 99999;
            color: white; font-family: "Microsoft JhengHei", sans-serif;
        }
        #login-screen h2 { margin-bottom: 10px; font-size: 28px; letter-spacing: 2px; }
        #login-msg { margin-bottom: 25px; color: #bdc3c7; font-size: 16px; font-weight: bold; text-align: center; line-height: 1.5; }
        #login-screen input { 
            padding: 12px; font-size: 20px; border-radius: 6px; border: 2px solid #34495e; 
            text-align: center; margin-bottom: 20px; outline: none; background: #ecf0f1;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1); width: 200px; transition: border 0.3s;
        }
        #login-screen input:focus { border-color: #3498db; background: #fff; }
        #login-screen button { 
            padding: 12px 40px; font-size: 18px; border-radius: 6px; border: none; 
            background: #27ae60; color: white; cursor: pointer; font-weight: bold; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.2); transition: background 0.2s, transform 0.1s;
        }
        #login-screen button:hover { background: #219150; transform: translateY(-2px); }
        #login-screen button:active { transform: translateY(0); box-shadow: 0 2px 3px rgba(0,0,0,0.2); }
        
        #app-content { display: none; }
    </style>
</head>

<body>

<div id="login-screen">
    <h2>ğŸ”’ Lotto System Pro</h2>
    <div id="login-msg">æ©Ÿå¯†åˆ†æç³»çµ± ï½œ è«‹è¼¸å…¥é€šè¡Œå¯†ç¢¼</div>
    <input type="password" id="pwd-input" placeholder="â€¢â€¢â€¢â€¢" autocomplete="off">
    <button id="login-btn" onclick="checkPassword()">ç™»å…¥ç³»çµ±</button>
</div>
<div id="app-content">
    <div id="main-ui" class="main-container">
        <div class="row" style="align-items: center;">
            <div class="label">æ“ä½œè€…</div>
            <div class="btn-group">
                <button class="btn active-blue" onclick="switchUser(this, 'çˆ¸')">çˆ¸ä½¿ç”¨æ¨¡å¼</button>
                <button class="btn" onclick="switchUser(this, 'å“¥')">å“¥ä½¿ç”¨æ¨¡å¼</button>
            </div>
            <div style="width:1px; height:25px; background:#ddd; margin:0 10px;"></div>
            <div class="label">è³‡æ–™é¡åˆ¥</div>
            <div class="btn-group" id="cat-btns-main">
                <button class="btn active-blue" onclick="switchCat('539')">539</button>
                <button class="btn" onclick="switchCat('539å ±è¡¨')">539å ±è¡¨</button>
                <button class="btn" onclick="switchCat('49')">49</button>
                <button class="btn" onclick="switchCat('49å ±è¡¨')">49å ±è¡¨</button>
                <button class="btn" style="background: #d32f2f; color: white; margin-left:10px;" onclick="clearReports()">æ¸…ç©ºå ±è¡¨</button>
                <span id="conn-status" style="margin-left:15px; font-size:13px; font-weight:bold; color:#7f8c8d;">ğŸ“¡ GitHub è³‡æ–™è¼‰å…¥ä¸­...</span>
                
                <div id="latest-update-info" style="margin-left:auto; font-weight:bold; color:#d35400; font-size:14px; background:#fbeee6; padding:6px 15px; border-radius:6px; border:1px solid #e67e22; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                    ğŸ“… æœ€æ–°é–‹çæ—¥ - 539ï¼š<span id="date-539" style="color:#c0392b;">è®€å–ä¸­</span> ï½œ 49ï¼š<span id="date-49" style="color:#c0392b;">è®€å–ä¸­</span>
                </div>
            </div>
        </div>

<div id="map-container" class="main-container hidden" style="height: 80vh; padding: 0; overflow: hidden;">
    <div style="background: #3498db; color: white; padding: 10px; display: flex; justify-content: space-between; align-items: center;">
        <span style="font-weight: bold; margin-left: 10px;">ğŸ—ºï¸ ä½ç½®åœ–å…§åµŒæ¨¡å¼</span>
        <button class="btn" style="background: #fff; color: #333; margin-right: 10px;" onclick="toggleMap()">é—œé–‰åœ–è¡¨</button>
    </div>
    <iframe id="map-frame" src="" style="width: 100%; height: calc(100% - 45px); border: none;"></iframe>
</div>

        <div class="row" style="background: #fffdf2; padding: 10px; border: 1px solid #ffe082; border-radius: 8px; margin-top: 10px;">
            <div class="label">çµ±è¨ˆæ¨¡å¼</div>
            <div class="btn-group" id="mode-btns-group">
                <button class="btn mode-btn active-yellow" id="btn-history" onclick="switchMode(this, 'æ­·å²æ¨¡å¼')">æ­·å²æ¨¡å¼</button>
                <button class="btn mode-btn" id="btn-drag-pre" onclick="switchMode(this, 'æ‹–ç‰Œå‰æœŸ')">æ‹–ç‰Œå‰æœŸ</button>
                <button class="btn mode-btn" id="btn-drag-post" onclick="switchMode(this, 'æ‹–ç‰Œå¾ŒæœŸ')">æ‹–ç‰Œå¾ŒæœŸ</button>
                <button class="btn mode-btn" id="btn-drag-n" onclick="switchMode(this, 'æ‹–ç‰Œä¸‹æ¨')">æ‹–ç‰Œä¸‹æ¨NæœŸ</button>
                
                <div id="push-n-container" class="hidden">
                    ä¸‹æ¨ <input type="number" id="pushN" value="5" min="1" max="20" style="width: 50px;"> æœŸ
                </div>

                <button class="btn mode-btn" onclick="switchMode(this, 'ç•¶æœŸå°ç¢°')">ç•¶æœŸå°ç¢°</button>
                <button class="btn mode-btn" onclick="switchMode(this, 'ä¸‹æœŸå°ç¢°')">ä¸‹æœŸå°ç¢°</button>
                <button class="btn mode-btn" id="btn-main-body" onclick="switchMode(this, 'ä¸»é«”')">ä¸»é«”</button>
                <button class="btn mode-btn" id="btn-sub-body" onclick="switchMode(this, 'å‰¯é«”')">å‰¯é«”</button>
                <button class="btn active-green" style="margin-left: 20px; font-weight:bold;" onclick="addToReport()">ğŸš€ åŠ å…¥å ±è¡¨ (ENTER)</button>
                <button class="btn" onclick="resetFilters()">æ¸…ç©ºç¯©é¸ (ESC)</button>
				<button class="btn" style="background: #3498db; color: white; font-weight:bold; margin-left: 10px;" onclick="toggleMap()">ğŸ—ºï¸ ä½ç½®åœ–</button>
                <span id="toast-msg">âœ… å·²æˆåŠŸåŠ å…¥å ±è¡¨</span>
            </div>
        </div>

        <div style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px;">
            <div class="row" data-type="å¹´ä»½"><div class="label">å¹´ä»½</div><button class="btn select-all-btn" onclick="toggleSelectRow(this)">å…¨é¸</button><div class="btn-group" id="year-btns"></div></div>
            <div class="row" data-type="æœˆä»½"><div class="label">æœˆä»½</div><button class="btn select-all-btn" onclick="toggleSelectRow(this)">å…¨é¸</button><div class="btn-group" id="month-btns"></div></div>
            <div class="row" data-type="æ—¥æœŸ"><div class="label">æ—¥æœŸ</div><button class="btn select-all-btn" onclick="toggleSelectRow(this)">å…¨é¸</button><div class="btn-group" id="day-btns"></div></div>
            <div class="row" data-type="æ˜ŸæœŸ"><div class="label">æ˜ŸæœŸ</div><button class="btn select-all-btn" onclick="toggleSelectRow(this)">å…¨é¸</button><div class="btn-group" id="week-btns"></div></div>
            <div class="row filter-extra" data-type="å¤©å¹²"><div class="label">å¤©å¹²</div><button class="btn select-all-btn" onclick="toggleSelectRow(this)">å…¨é¸</button><div class="btn-group" id="tian-gan"></div></div>
            <div class="row filter-extra" data-type="åœ°æ”¯"><div class="label">åœ°æ”¯</div><button class="btn select-all-btn" onclick="toggleSelectRow(this)">å…¨é¸</button><div class="btn-group" id="di-zhi"></div></div>
            <div class="row filter-extra" data-type="ç¯€æ°£"><div class="label">ç¯€æ°£/è¡“èª</div><button class="btn select-all-btn" onclick="toggleSelectRow(this)">å…¨é¸</button>
                <div class="btn-group" style="flex-direction: column; align-items: flex-start;">
                    <div id="s-row" class="btn-group" style="margin-bottom: 5px;"></div>
                    <div id="t-row" class="btn-group"></div>
                </div>
            </div>
            <div class="row" data-type="è™Ÿç¢¼"><div class="label">è™Ÿç¢¼</div><button class="btn select-all-btn" onclick="toggleSelectRow(this)">å…¨é¸</button><div class="btn-group" id="num-btns"></div></div>
        </div>
    </div>
	
	<div id="report-ui" class="main-container hidden" style="max-width: 1650px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <div style="display: flex; gap: 10px; align-items: center;">
                <div class="label" style="background:#000; color:#fff; min-width:120px;">å ±è¡¨ç®¡ç†ç³»çµ±</div>
                <span id="report-user-label" style="font-weight:bold; color:var(--report-blue); font-size:16px;">[ç•¶å‰æ“ä½œè€…ï¼šçˆ¸]</span>
                <div class="btn-group" id="cat-btns-report" style="margin-left:15px;">
                    <button class="btn" onclick="switchCat('539')">539</button>
                    <button class="btn active-blue" onclick="switchCat('539å ±è¡¨')">539å ±è¡¨</button>
                    <button class="btn" onclick="switchCat('49')">49</button>
                    <button class="btn" onclick="switchCat('49å ±è¡¨')">49å ±è¡¨</button>
                    <button class="btn" style="background: #d32f2f; color: white;" onclick="clearReports()">æ¸…ç©ºå ±è¡¨</button>
                    <button class="btn" style="background: #27ae60; color: white; font-weight:bold; margin-left: 10px;" onclick="exportToExcel()">ğŸ“Š åŒ¯å‡ºExcel</button>
                    <button class="btn" style="background: #8e44ad; color: white; font-weight:bold; margin-left: 10px;" onclick="analyzeBestCombinations()">ğŸ’¡ åˆ†æå ±è¡¨è™Ÿç¢¼</button>
                    <button class="btn" style="background: #e67e22; color: white; font-weight:bold; margin-left: 10px;" onclick="analyzeOverlaps()">ğŸ” æœŸæ•¸äº¤å‰åˆ†æ</button>
                </div>
            </div>
        </div>
        <div class="row" style="margin-bottom:10px;">
            <div class="label">é¡¯ç¤ºæ¨¡å¼</div>
            <div class="btn-group" id="mode-filter-bar">
                <button class="btn active-blue" onclick="filterByMode('å…¨éƒ¨', this)">å…¨éƒ¨</button>
                <button class="btn" onclick="filterByMode('æ­·å²æ¨¡å¼', this)">æ­·å²</button>
                <button class="btn" onclick="filterByMode('æ‹–ç‰Œ', this)">æ‹–ç‰Œ</button>
                <button class="btn" onclick="filterByMode('æ‹–ç‰Œä¸‹æ¨', this)">ä¸‹æ¨NæœŸ</button>
                <button class="btn" onclick="filterByMode('ç•¶æœŸå°ç¢°', this)">ç•¶æœŸå°ç¢°</button>
                <button class="btn" onclick="filterByMode('ä¸‹æœŸå°ç¢°', this)">ä¸‹æœŸå°ç¢°</button>
                <button class="btn" onclick="filterByMode('ä¸»é«”', this)">ä¸»é«”</button>
            </div>
        </div>
        <div id="dynamic-filter-bar"></div>
        <div id="overlap-analysis-area" style="margin-bottom: 20px;"></div>
        <div id="analysis-result-area" style="margin-bottom: 20px;"></div>
        <div id="report-display-area"></div>
    </div>
</div>

<script>
    // ==========================================
    // ====== ç™»å…¥é˜²è­·ã€é˜²å³éµèˆ‡ 3 æ¬¡éŒ¯é– IP æ©Ÿåˆ¶ ======
    // ==========================================
    
    // é˜²å³éµã€é˜² F12 åŠå„ç¨®é–‹ç™¼è€…å·¥å…·ç†±éµ
    document.addEventListener('contextmenu', e => e.preventDefault());
    document.addEventListener('keydown', e => {
        if (e.key === 'F12') e.preventDefault();
        if (e.ctrlKey && e.shiftKey && (e.key === 'I' || e.key === 'i' || e.key === 'J' || e.key === 'j' || e.key === 'C' || e.key === 'c')) e.preventDefault();
        if (e.ctrlKey && (e.key === 'U' || e.key === 'u')) e.preventDefault();
    });

    // å–å¾—å¤–éƒ¨ IP (å‘¼å«å…è²» API)
    async function getUserIP() {
        try {
            let response = await fetch('https://api.ipify.org?format=json');
            let data = await response.json();
            return data.ip;
        } catch (e) {
            return 'æœªçŸ¥IP (ç¶²è·¯é™åˆ¶)';
        }
    }

    // æª¢æŸ¥å°é–ç‹€æ…‹
    function checkBanStatus() {
        let banUntil = localStorage.getItem('lotto_ban_until');
        if (banUntil) {
            if (Date.now() < parseInt(banUntil)) {
                let ip = localStorage.getItem('lotto_banned_ip') || 'æœªçŸ¥';
                showBannedScreen(banUntil, ip);
                return true;
            } else {
                // å°é–æ™‚é–“å·²éï¼Œè§£é™¤å°é–
                localStorage.removeItem('lotto_ban_until');
                localStorage.removeItem('lotto_banned_ip');
                localStorage.removeItem('lotto_failed_attempts');
            }
        }
        return false;
    }

    // é¡¯ç¤ºå°é–ç•«é¢
    function showBannedScreen(banUntil, ip) {
        let date = new Date(parseInt(banUntil)).toLocaleString('zh-TW');
        document.getElementById('pwd-input').style.display = 'none';
        document.getElementById('login-btn').style.display = 'none';
        document.getElementById('login-msg').innerHTML = `<span style="color:#e74c3c; font-size: 18px;">â›” ç³»çµ±æ‹’çµ•å­˜å–ï¼</span><br>æ‚¨çš„ IP (${ip}) å·²è¢«å°é–ã€‚<br>è§£é–æ™‚é–“ï¼š${date}`;
    }

    // é©—è­‰å¯†ç¢¼é‚è¼¯
    async function checkPassword() {
        if (checkBanStatus()) return;

        const pwdInput = document.getElementById('pwd-input');
        const pwd = pwdInput.value;
        const msgEl = document.getElementById('login-msg');

        if (pwd === '8586') {
            localStorage.setItem('lottoAuth_8586', 'true');
            localStorage.removeItem('lotto_failed_attempts');
            unlockApp();
        } else {
            let attempts = parseInt(localStorage.getItem('lotto_failed_attempts') || '0');
            attempts++;
            localStorage.setItem('lotto_failed_attempts', attempts);

            if (attempts >= 3) {
                pwdInput.disabled = true;
                msgEl.innerHTML = '<span style="color:#e74c3c;">åµæ¸¬åˆ°ç•°å¸¸å­˜å–ï¼Œæ­£åœ¨é–å®šä¾†æº...</span>';
                
                let ip = await getUserIP();
                let banTime = Date.now() + (1 * 24 * 60 * 60 * 1000); 
                
                localStorage.setItem('lotto_ban_until', banTime);
                localStorage.setItem('lotto_banned_ip', ip);
                
                showBannedScreen(banTime, ip);
            } else {
                let left = 3 - attempts;
                msgEl.innerHTML = `<span style="color:#f39c12;">å¯†ç¢¼éŒ¯èª¤ï¼æ‚¨é‚„æœ‰ ${left} æ¬¡å˜—è©¦æ©Ÿæœƒã€‚</span>`;
                pwdInput.value = '';
            }
        }
    }

    // è§£é–æ‡‰ç”¨ç¨‹å¼
    function unlockApp() {
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('app-content').style.display = 'block';
        init(); 
    }

    // æ”¯æ´ Enter éµç™»å…¥
    document.getElementById('pwd-input').addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            e.stopPropagation();
            checkPassword();
        }
    });

    window.onload = function() {
        if (localStorage.getItem('lottoAuth_8586') === 'true') {
            unlockApp(); 
        } else {
            let isBanned = checkBanStatus();
            if (!isBanned) {
                document.getElementById('pwd-input').focus();
            }
        }
    };
	
	// ==========================================
    // ====== ç³»çµ±ä¸»ç¨‹å¼æ¼”ç®—æ³• (å®Œå…¨ä¿ç•™ä¸è®Š) ======
    // ==========================================

    let currentConfig = { user: 'çˆ¸', cat: '539', mode: 'æ­·å²æ¨¡å¼' };
    let reportsData = JSON.parse(localStorage.getItem('lottoReports_v14')) || []; 
    let dragData = { step: 0, preConds: [], preNums: [] }; 
    let mainSubData = { step: 0, mainConds: [] }; 

    let activeModeFilter = 'å…¨éƒ¨';
    let activeCondFilter = 'å…¨éƒ¨';

    const DATA_URLS = {
        '539': 'https://raw.githubusercontent.com/win83/secret-lotto-888/main/fine/539.csv',
        '49': 'https://raw.githubusercontent.com/win83/secret-lotto-888/main/fine/49.csv'
    };
    
    let globalLottoData = { '539': [], '49': [] };
    let loadedCounts = { '539': 0, '49': 0 };
    let latestDates = { '539': '', '49': '' };

    function updateLatestDateUI() {
        const el539 = document.getElementById('date-539');
        const el49 = document.getElementById('date-49');
        if (el539) el539.innerText = latestDates['539'] || 'ç„¡è³‡æ–™';
        if (el49) el49.innerText = latestDates['49'] || 'ç„¡è³‡æ–™';
    }

    function init() {
        renderBtns('month-btns', ["01","02","03","04","05","06","07","08","09","10","11","12"]);
        renderBtns('day-btns', Array.from({length: 31}, (_, i) => (i+1).toString().padStart(2, '0')));
        renderBtns('week-btns', ["é€±ä¸€","é€±äºŒ","é€±ä¸‰","é€±å››","é€±äº”","é€±å…­","é€±æ—¥"]);
        renderBtns('tian-gan', ["ç”²","ä¹™","ä¸™","ä¸","æˆŠ","å·±","åºš","è¾›","å£¬","ç™¸"]);
        renderBtns('di-zhi', ["å­","ä¸‘","å¯…","å¯","è¾°","å·³","åˆ","æœª","ç”³","é…‰","æˆŒ","äº¥"]);
        renderBtns('s-row', Array.from({length: 16}, (_, i) => `S${i}`));
        renderBtns('t-row', Array.from({length: 16}, (_, i) => `T${i}`));
        
        updateDynamicUI(); 
        fetchGithubData(); 
    }

    function fetchGithubData() {
        ['539', '49'].forEach(cat => {
            fetch(DATA_URLS[cat] + '?t=' + new Date().getTime())
                .then(res => res.arrayBuffer())
                .then(buffer => {
                    let text = new TextDecoder('utf-8').decode(buffer);
                    if (text.includes('') || (!text.includes('ç”²') && !text.includes('å­') && !text.includes('æœŸ'))) {
                        try { text = new TextDecoder('big5').decode(buffer); } catch(e) {}
                    }
                    Papa.parse(text, {
                        header: false,
                        skipEmptyLines: true,
                        complete: function(results) {
                            try {
                                const maxCols = cat === '539' ? 10 : 11; 
                                let cleanData = results.data.map((row) => {
                                    let rowData = row.slice(0, maxCols).map(c => c ? c.toString().replace(/[\s\uFEFF\xA0'"]/g, '') : ''); 
                                    let dateStr = rowData[1];
                                    
                                    if (!dateStr || !dateStr.match(/[-/]/)) return null;
                                    let parts = dateStr.split(/[-/]/);
                                    if (parts.length < 3) return null;

                                    let y = parseInt(parts[0], 10);
                                    let m = parseInt(parts[1], 10) - 1;
                                    let d = parseInt(parts[2], 10);
                                    
                                    if (y < 1911) y += 1911; 
                                    if (isNaN(y) || isNaN(m) || isNaN(d)) return null;

                                    let dateObj = new Date(y, m, d);
                                    const weekMap = ["é€±æ—¥", "é€±ä¸€", "é€±äºŒ", "é€±ä¸‰", "é€±å››", "é€±äº”", "é€±å…­"];

                                    return {
                                        year: y, month: (m + 1).toString().padStart(2, '0'), day: d.toString().padStart(2, '0'),
                                        weekday: weekMap[dateObj.getDay()], dateObj: dateObj,
                                        tian: rowData[2], zhi: rowData[3], term: rowData[4],
                                        nums: rowData.slice(5, maxCols).map(n => parseInt(n, 10)).filter(n => !isNaN(n))
                                    };
                                }).filter(item => item !== null);

                                cleanData.sort((a, b) => a.dateObj - b.dateObj);
                                globalLottoData[cat] = cleanData;
                                loadedCounts[cat] = cleanData.length;

                                let latestEntry = cleanData.slice().reverse().find(d => d.nums && d.nums.length > 0);
                                if (latestEntry) {
                                    latestDates[cat] = `${latestEntry.year}/${latestEntry.month}/${latestEntry.day}`;
                                }

                                updateConnectionStatus();
                                updateLatestDateUI();

                                if (currentConfig.cat.includes(cat)) {
                                    updateDynamicUI(); 
                                }

                                if (currentConfig.cat.includes('å ±è¡¨') && currentConfig.cat.includes(cat)) {
                                    renderReports();
                                }
                            } catch (err) { updateConnectionStatus(true); }
                        }
                    });
                }).catch(err => { updateConnectionStatus(true); });
        });
    }

    function updateConnectionStatus(isError = false) {
        const el = document.getElementById('conn-status');
        if (!el) return;
        if (isError) {
            el.innerHTML = `ğŸ”´ GitHub é€£ç·šç•°å¸¸`; el.style.color = '#e74c3c';
        } else {
            el.innerHTML = `ğŸŸ¢ å·²é€£ç·šä¸”ç·¨ç¢¼æ­£å¸¸ (539: ${loadedCounts['539']}ç­†, 49: ${loadedCounts['49']}ç­†)`; el.style.color = '#27ae60';
        }
    }

    function renderBtns(id, list) {
        const el = document.getElementById(id);
        if(el) el.innerHTML = list.map(item => `<button class="btn filter-btn" onclick="handleFilterClick(this)">${item}</button>`).join('');
    }
	
	function handleFilterClick(btn) {
        if (currentConfig.mode === 'æ‹–ç‰Œå¾ŒæœŸ' || currentConfig.mode === 'å‰¯é«”') {
            btn.classList.toggle('active-green'); 
            btn.classList.remove('active-yellow');
        } else {
            btn.classList.toggle('active-yellow'); 
            btn.classList.remove('active-green');
        }
    }

    function toggleSelectRow(btn) {
        const row = btn.closest('.row');
        const btns = row.querySelectorAll('.filter-btn');
        const targetClass = (currentConfig.mode === 'æ‹–ç‰Œå¾ŒæœŸ' || currentConfig.mode === 'å‰¯é«”') ? 'active-green' : 'active-yellow';
        const allSelected = Array.from(btns).every(b => b.classList.contains(targetClass));
        btns.forEach(b => {
            b.classList.remove('active-yellow', 'active-green');
            if (!allSelected) b.classList.add(targetClass);
        });
    }

    function updateDynamicUI() {
        const selectedYellows = Array.from(document.querySelectorAll('#year-btns .active-yellow, #num-btns .active-yellow')).map(b => b.innerText);
        const selectedGreens = Array.from(document.querySelectorAll('#year-btns .active-green, #num-btns .active-green')).map(b => b.innerText);
        const yBox = document.getElementById('year-btns');
        const start = (currentConfig.user === "çˆ¸") ? 2020 : 2007;
        const rawCat = currentConfig.cat.replace('å ±è¡¨', '');
        const data = globalLottoData[rawCat] || [];
        let endYear = 2026; 
        if (data.length > 0) {
            const maxDataYear = Math.max(...data.map(d => d.year));
            if (maxDataYear > endYear) endYear = maxDataYear;
        }
        yBox.innerHTML = '';
        for(let y = start; y <= endYear; y++) {
            let ys = y.toString();
            let activeClass = selectedYellows.includes(ys) ? 'active-yellow' : (selectedGreens.includes(ys) ? 'active-green' : '');
            yBox.innerHTML += `<button class="btn filter-btn ${activeClass}" onclick="handleFilterClick(this)">${y}</button>`;
        }
        const nBox = document.getElementById('num-btns');
        const count = currentConfig.cat.includes('539') ? 39 : 49;
        nBox.innerHTML = '';
        for(let i=1; i<=count; i++) {
            let ns = i.toString().padStart(2, '0');
            let activeClass = selectedYellows.includes(ns) ? 'active-yellow' : (selectedGreens.includes(ns) ? 'active-green' : '');
            nBox.innerHTML += `<button class="btn filter-btn ${activeClass}" onclick="handleFilterClick(this)">${ns}</button>`;
        }
        document.querySelectorAll('.filter-extra').forEach(el => {
            currentConfig.user === 'å“¥' ? el.classList.add('hidden') : el.classList.remove('hidden');
        });
    }

    function switchCat(cat) {
        currentConfig.cat = cat;
        const isReport = cat.includes('å ±è¡¨');
        [document.getElementById('cat-btns-main'), document.getElementById('cat-btns-report')].forEach(group => {
            group.querySelectorAll('.btn').forEach(b => b.classList.toggle('active-blue', b.innerText === cat));
        });
        if (isReport) { toggleUI('report'); renderReports(); } else { toggleUI('main'); updateDynamicUI(); }
        document.getElementById('analysis-result-area').innerHTML = '';
        document.getElementById('overlap-analysis-area').innerHTML = '';
    }

    function toggleUI(target) {
        document.getElementById('main-ui').classList.toggle('hidden', target === 'report');
        document.getElementById('report-ui').classList.toggle('hidden', target === 'main');
    }

    function switchUser(el, user) {
        el.parentElement.querySelectorAll('.btn').forEach(b => b.classList.remove('active-blue'));
        el.classList.add('active-blue');
        currentConfig.user = user;
        document.getElementById('report-user-label').innerText = `[ç•¶å‰æ“ä½œè€…ï¼š${user}]`;
        resetFilters();
        dragData = { step: 0, preConds: [], preNums: [] };
        mainSubData = { step: 0, mainConds: [] };
        document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active-yellow', 'drag-pre-active', 'drag-post-active'));
        document.getElementById('btn-history').classList.add('active-yellow');
        currentConfig.mode = 'æ­·å²æ¨¡å¼';
        updateDynamicUI();
        renderReports(); 
    }

    function switchMode(el, mode) {
        document.getElementById('push-n-container').classList.add('hidden');
        if (mode === 'æ‹–ç‰Œå‰æœŸ') {
            dragData = { step: 1, preConds: [], preNums: [] };
            mainSubData = { step: 0, mainConds: [] };
            resetFilters();
            document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active-yellow', 'drag-pre-active', 'drag-post-active'));
            document.getElementById('btn-drag-pre').classList.add('drag-pre-active');
        } 
        else if (mode === 'æ‹–ç‰Œå¾ŒæœŸ') {
            const yellows = document.querySelectorAll('.filter-btn.active-yellow');
            dragData.preConds = Array.from(yellows).filter(b => b.closest('.row').getAttribute('data-type') !== 'è™Ÿç¢¼')
                .map(b => ({ text: b.textContent.replace(/[\s\uFEFF\xA0]/g, ''), type: b.closest('.row').getAttribute('data-type') }));
            dragData.preNums = Array.from(yellows).filter(b => b.closest('.row').getAttribute('data-type') === 'è™Ÿç¢¼')
                .map(b => b.textContent.replace(/[\s\uFEFF\xA0]/g, ''));
            dragData.step = 2;
            document.getElementById('btn-drag-post').classList.add('drag-post-active');
        } 
        else if (mode === 'ä¸»é«”') {
            dragData = { step: 0, preConds: [], preNums: [] };
            mainSubData = { step: 1, mainConds: [] };
            resetFilters();
            document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active-yellow', 'drag-pre-active', 'drag-post-active'));
            document.getElementById('btn-main-body').classList.add('drag-pre-active');
        }
        else if (mode === 'å‰¯é«”') {
            const yellows = document.querySelectorAll('.filter-btn.active-yellow');
            mainSubData.mainConds = Array.from(yellows).map(b => ({
                text: b.textContent.replace(/[\s\uFEFF\xA0]/g, ''), 
                type: b.closest('.row').getAttribute('data-type')
            }));
            mainSubData.step = 2;
            document.getElementById('btn-sub-body').classList.add('drag-post-active');
        }
        else if (mode === 'æ‹–ç‰Œä¸‹æ¨') {
            dragData = { step: 0, preConds: [], preNums: [] };
            mainSubData = { step: 0, mainConds: [] };
            resetFilters();
            document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active-yellow', 'drag-pre-active', 'drag-post-active'));
            document.getElementById('btn-drag-n').classList.add('drag-pre-active');
            document.getElementById('push-n-container').classList.remove('hidden');
        }
        else {
            dragData = { step: 0, preConds: [], preNums: [] };
            mainSubData = { step: 0, mainConds: [] };
            resetFilters();
            document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active-yellow', 'drag-pre-active', 'drag-post-active'));
            if(el) el.classList.add('active-yellow');
        }
        currentConfig.mode = mode;
    }

    function addToReport() {
        const rawCat = currentConfig.cat.replace('å ±è¡¨', '');
        if (currentConfig.mode === 'æ­·å²æ¨¡å¼' || currentConfig.mode === 'ç•¶æœŸå°ç¢°' || currentConfig.mode === 'ä¸‹æœŸå°ç¢°' || currentConfig.mode === 'æ‹–ç‰Œä¸‹æ¨') {
            const yellows = Array.from(document.querySelectorAll('.filter-btn.active-yellow'));
            if (yellows.length === 0) return alert('è«‹è‡³å°‘é¸æ“‡ä¸€å€‹æ¢ä»¶ï¼');
            const condBtns = yellows.filter(b => b.closest('.row').getAttribute('data-type') !== 'è™Ÿç¢¼');
            const numBtns = yellows.filter(b => b.closest('.row').getAttribute('data-type') === 'è™Ÿç¢¼');
            const pushNVal = parseInt(document.getElementById('pushN').value) || 5;
            const generateSingleReport = (condText, condType, numText) => {
                let condsByCat = {}; let labelParts = [];
                if (condText) { condsByCat[condType] = [condText]; labelParts.push(`${condType}:${condText}`); }
                if (numText) { condsByCat['è™Ÿç¢¼'] = [numText]; labelParts.push(`è™Ÿç¢¼:${numText}`); }
                let finalLabel = labelParts.join('+');
                if (currentConfig.mode === 'æ‹–ç‰Œä¸‹æ¨') finalLabel += ` (ä¸‹æ¨${pushNVal}æœŸ)`;
                reportsData.push({
                    id: Date.now() + Math.random(), owner: currentConfig.user, cat: rawCat, 
                    mode: currentConfig.mode, value: finalLabel, pushN: pushNVal, 
                    query: { type: 'history', conds: condsByCat }
                });
            };
            if (condBtns.length > 0) {
                condBtns.forEach(cb => {
                    let cType = cb.closest('.row').getAttribute('data-type'), cText = cb.textContent.replace(/[\s\uFEFF\xA0]/g, '');
                    if (numBtns.length > 0) numBtns.forEach(nb => generateSingleReport(cText, cType, nb.textContent.replace(/[\s\uFEFF\xA0]/g, '')));
                    else generateSingleReport(cText, cType, null);
                });
            } else numBtns.forEach(nb => generateSingleReport(null, null, nb.textContent.replace(/[\s\uFEFF\xA0]/g, '')));
            saveAndRefresh();
        } 
        else if (currentConfig.mode === 'æ‹–ç‰Œå¾ŒæœŸ' && dragData.step === 2) {
            const greens = Array.from(document.querySelectorAll('.filter-btn.active-green'));
            if (greens.length === 0) return alert('è«‹é¸æ“‡å¾ŒæœŸçš„æ¢ä»¶ï¼');
            const postConds = greens.map(b => ({ text: b.textContent.replace(/[\s\uFEFF\xA0]/g, ''), type: b.closest('.row').getAttribute('data-type') }));
            const preByCat = { æ˜ŸæœŸ: [], æ—¥æœŸ: [], å¤©å¹²: [], åœ°æ”¯: [], ç¯€æ°£: [] };
            dragData.preConds.forEach(c => { if (preByCat[c.type]) preByCat[c.type].push(c.text); });
            const postByCat = { æ˜ŸæœŸ: [], æ—¥æœŸ: [], å¤©å¹²: [], åœ°æ”¯: [], ç¯€æ°£: [] };
            postConds.forEach(c => { if (postByCat[c.type]) postByCat[c.type].push(c.text); });
            let results = [];
            if (preByCat.å¤©å¹².length > 0 && preByCat.åœ°æ”¯.length > 0) {
                preByCat.å¤©å¹².forEach((gan, idx) => {
                    const zhi = preByCat.åœ°æ”¯[idx] || preByCat.åœ°æ”¯[0], postGan = postByCat.å¤©å¹²[idx] || postByCat.å¤©å¹²[0] || "", postZhi = postByCat.åœ°æ”¯[idx] || postByCat.åœ°æ”¯[0] || "";
                    if (postGan || postZhi) results.push({ label: `${gan}${zhi} â†’ ${postGan}${postZhi}`, query: { pre: {å¤©å¹²: gan, åœ°æ”¯: zhi}, post: {å¤©å¹²: postGan, åœ°æ”¯: postZhi} } });
                });
            }
            ["å¤©å¹²", "åœ°æ”¯", "æ˜ŸæœŸ", "æ—¥æœŸ", "ç¯€æ°£"].forEach(type => {
                preByCat[type].forEach((preVal, idx) => {
                    const postVal = postByCat[type][idx] || postByCat[type][0];
                    if (postVal) results.push({ label: `${type}:${preVal} â†’ æ¢ä»¶:${postVal}`, query: { pre: {[type]: preVal}, post: {[type]: postVal} } });
                });
            });
            results.forEach(res => {
                if (dragData.preNums.length > 0) dragData.preNums.forEach(num => reportsData.push({ id: Date.now() + Math.random(), owner: currentConfig.user, cat: rawCat, mode: "æ‹–ç‰Œ", value: `${res.label.split(' â†’ ')[0]}+è™Ÿç¢¼:${num} â†’ ${res.label.split(' â†’ ')[1]}`, query: {...res.query, pre: {...res.query.pre, è™Ÿç¢¼: num}} }));
                else reportsData.push({ id: Date.now() + Math.random(), owner: currentConfig.user, cat: rawCat, mode: "æ‹–ç‰Œ", value: res.label, query: res.query });
            });
            saveAndRefresh();
        } 
        else if (currentConfig.mode === 'å‰¯é«”' && mainSubData.step === 2) {
            const greens = Array.from(document.querySelectorAll('.filter-btn.active-green'));
            if (mainSubData.mainConds.length !== 1) return alert('ä¸»é«”è«‹é¸æ“‡å‰›å¥½ 1 å€‹æ¢ä»¶ï¼');
            if (greens.length === 0) return alert('è«‹è‡³å°‘é¸æ“‡ 1 å€‹å‰¯é«”æ¢ä»¶ï¼');
            const mainCond = mainSubData.mainConds[0];
            greens.forEach(b => {
                const sub = { text: b.textContent.replace(/[\s\uFEFF\xA0]/g, ''), type: b.closest('.row').getAttribute('data-type') };
                reportsData.push({ id: Date.now() + Math.random(), owner: currentConfig.user, cat: rawCat, mode: "ä¸»é«”", value: `ä¸»é«”(${mainCond.type}:${mainCond.text}) + å‰¯é«”(${sub.type}:${sub.text})`, query: { type: 'main_sub', main: mainCond, sub: sub } });
            });
            saveAndRefresh();
        } 
    } // <--- æ³¨æ„é€™è£¡ï¼šå‡½æ•¸æ­£ç¢ºçµæŸ
	
	function saveAndRefresh() {
        localStorage.setItem('lottoReports_v14', JSON.stringify(reportsData));
        document.getElementById('toast-msg').style.opacity = "1";
        resetFilters();
        document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('drag-pre-active', 'drag-post-active', 'active-yellow'));
        document.getElementById('btn-history').classList.add('active-yellow');
        document.getElementById('push-n-container').classList.add('hidden');
        currentConfig.mode = 'æ­·å²æ¨¡å¼';
        dragData = { step: 0, preConds: [], preNums: [] };
        mainSubData = { step: 0, mainConds: [] };
        setTimeout(() => { document.getElementById('toast-msg').style.opacity = "0"; }, 2000);
        if (currentConfig.cat.includes('å ±è¡¨')) renderReports();
    }

    function matchSingleCond(draw, cond) {
        if (!cond) return true;
        const typeMap = { 'å¹´ä»½': draw.year.toString(), 'æœˆä»½': draw.month, 'æ—¥æœŸ': draw.day, 'æ˜ŸæœŸ': draw.weekday, 'å¤©å¹²': draw.tian, 'åœ°æ”¯': draw.zhi, 'ç¯€æ°£': draw.term };
        if (cond.type === 'è™Ÿç¢¼') return draw.nums.includes(parseInt(cond.text, 10));
        return typeMap[cond.type] === cond.text;
    }

    function matchDragQuery(draw, queryCat) {
        if (!queryCat || Object.keys(queryCat).length === 0) return true;
        if (queryCat.å¤©å¹² && draw.tian !== queryCat.å¤©å¹²) return false;
        if (queryCat.åœ°æ”¯ && draw.zhi !== queryCat.åœ°æ”¯) return false;
        if (queryCat.ç¯€æ°£ && draw.term !== queryCat.ç¯€æ°£) return false;
        if (queryCat.æ˜ŸæœŸ && draw.weekday !== queryCat.æ˜ŸæœŸ) return false;
        if (queryCat.æ—¥æœŸ && draw.day !== queryCat.æ—¥æœŸ) return false;
        if (queryCat.è™Ÿç¢¼ && !draw.nums.includes(parseInt(queryCat.è™Ÿç¢¼, 10))) return false;
        return true;
    }

    function matchHistoryQuery(draw, condsByCat) {
        if (!condsByCat || Object.keys(condsByCat).length === 0) return true;
        for (let type in condsByCat) {
            let validVals = condsByCat[type]; if (validVals.length === 0) continue;
            if (type === 'è™Ÿç¢¼') { if (!validVals.some(v => draw.nums.includes(parseInt(v, 10)))) return false; }
            else {
                const drawVal = { 'å¹´ä»½': draw.year.toString(), 'æœˆä»½': draw.month, 'æ—¥æœŸ': draw.day, 'æ˜ŸæœŸ': draw.weekday, 'å¤©å¹²': draw.tian, 'åœ°æ”¯': draw.zhi, 'ç¯€æ°£': draw.term }[type];
                if (!validVals.includes(drawVal)) return false;
            }
        }
        return true;
    }

    function updateConditionFilterBar() {
        const area = document.getElementById('dynamic-filter-bar'); if(!area) return;
        const rawCat = currentConfig.cat.replace('å ±è¡¨', '');
        let filtered = reportsData.filter(r => r.owner === currentConfig.user && r.cat === rawCat);
        if (activeModeFilter !== 'å…¨éƒ¨') filtered = filtered.filter(r => r.mode === activeModeFilter);
        const conditions = [...new Set(filtered.map(r => r.value))];
        if (conditions.length === 0) { area.innerHTML = '<span style="color:#7f8c8d; font-size:13px; margin: auto;">ç„¡æ¨™ç±¤</span>'; return; }
        let html = `<button class="btn ${activeCondFilter === 'å…¨éƒ¨' ? 'active-yellow' : ''}" onclick="setCondFilter('å…¨éƒ¨')">å…¨éƒ¨æ¢ä»¶</button>`;
        conditions.forEach(cond => html += `<button class="btn ${activeCondFilter === cond ? 'active-yellow' : ''}" onclick="setCondFilter('${cond}')">${cond}</button>`);
        area.innerHTML = html;
    }

    function setCondFilter(cond) { activeCondFilter = cond; renderReports(); }

    // ====== ä¿®æ­£å¾Œçš„å°ç¢°ç¯©é¸å‡½æ•¸ ======
    function filterPairDisplay(reportId, numStr, btnEl) {
        const section = document.getElementById(`report-sec-${reportId}`);
        if(!section) return;

        section.querySelectorAll('.quick-btn').forEach(b => b.classList.remove('active-blue'));
        btnEl.classList.add('active-blue');

        const rows = section.querySelectorAll('.freq-row');
        rows.forEach(row => {
            const badges = row.querySelectorAll('.pair-badge');
            let hasMatch = false;

            badges.forEach(badge => {
                const n1 = badge.getAttribute('data-n1');
                const n2 = badge.getAttribute('data-n2');

                if (numStr === 'ALL') {
                    badge.style.display = 'inline-block';
                    hasMatch = true;
                } else if (n1 === numStr || n2 === numStr) {
                    badge.style.display = 'inline-block';
                    hasMatch = true;
                } else {
                    badge.style.display = 'none';
                }
            });
            row.style.display = hasMatch ? '' : 'none';
        });

        const tableContainer = section.querySelector('.table-container');
        if (tableContainer) {
            tableContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
    }

    function getCombinations(arr, k) {
        if (k > arr.length || k <= 0) return []; if (k == arr.length) return [arr]; if (k == 1) return arr.map(i => [i]);
        let combs = []; for (let i = 0; i < arr.length - k + 1; i++) getCombinations(arr.slice(i + 1), k - 1).forEach(tc => combs.push([arr[i], ...tc]));
        return combs;
    }

    function analyzeOverlaps() {
        const rawCat = currentConfig.cat.replace('å ±è¡¨', ''), lottoData = globalLottoData[rawCat] || []; if (lottoData.length === 0) return alert('ç„¡è³‡æ–™');
        let filtered = reportsData.filter(r => r.owner === currentConfig.user && r.cat === rawCat);
        if (activeModeFilter !== 'å…¨éƒ¨') filtered = filtered.filter(r => r.mode === activeModeFilter);
        if (filtered.length < 2) return alert('è«‹è‡³å°‘åŠ å…¥å…©å€‹æ¢ä»¶');
        let reportResults = filtered.map(report => {
            let dates = new Set(); for(let i=0; i<lottoData.length; i++) {
                let match = (report.mode === "æ­·å²æ¨¡å¼") ? matchHistoryQuery(lottoData[i], report.query.conds) : (report.mode === "ä¸»é«”") ? (matchSingleCond(lottoData[i], report.query.main) && matchSingleCond(lottoData[i], report.query.sub)) : (report.mode === "æ‹–ç‰Œ" && i < lottoData.length - 1 && matchDragQuery(lottoData[i], report.query.pre) && matchDragQuery(lottoData[i+1], report.query.post));
                if(match) { let t = (report.mode === "æ‹–ç‰Œ") ? lottoData[i+1] : lottoData[i]; dates.add(`${t.year}-${t.month}-${t.day}`); }
            }
            return { label: report.value, dates };
        });
        let allDates = new Set(); reportResults.forEach(r => r.dates.forEach(d => allDates.add(d)));
        let overlaps = []; allDates.forEach(d => { if (reportResults.every(r => r.dates.has(d))) overlaps.push(d); });
        let unique = reportResults.map(r => { let c = 0; r.dates.forEach(d => { if(reportResults.every(o => o === r || !o.dates.has(d))) c++; }); return { label: r.label, count: c }; });
        renderOverlapUI(overlaps, unique, lottoData, rawCat);
    }

    function renderOverlapUI(overlaps, unique, lottoData, rawCat) {
        const area = document.getElementById('overlap-analysis-area'), max = rawCat === '539' ? 39 : 49;
        let counts = new Array(max).fill(0); lottoData.filter(d => overlaps.includes(`${d.year}-${d.month}-${d.day}`)).forEach(d => d.nums.forEach(n => counts[n-1]++));
        let hot = counts.map((v, i) => ({v, n: i+1})).sort((a,b) => b.v - a.v).slice(0, 10).filter(x => x.v > 0);
        area.innerHTML = `<div class="report-section" style="border: 2px solid #e67e22;"><div class="report-banner" style="background:#e67e22;"><span>ğŸ” äº¤å‰åˆ†æ</span><button class="btn" onclick="this.closest('.report-section').remove()">âœ–</button></div>
        <div style="padding:15px; background:#fffaf0;"><strong>ğŸ“ é‡ç–ŠæœŸæ•¸ï¼š${overlaps.length}</strong> <div>${hot.map(x => `<span class="pair-badge" style="background:#fbc02d;">${x.n}(${x.v})</span>`).join('')}</div>
        <div style="border-top:1px dashed #ccc; padding-top:10px;"><strong>ğŸ“ ç¨æœ‰æœŸæ•¸ï¼š</strong>${unique.map(u => `<li>${u.label}: ${u.count}</li>`).join('')}</div></div></div>`;
    }

    function analyzeBestCombinations() {
        const rawCat = currentConfig.cat.replace('å ±è¡¨', ''), lottoData = globalLottoData[rawCat] || [];
        let filtered = reportsData.filter(r => r.owner === currentConfig.user && r.cat === rawCat);
        if (activeModeFilter !== 'å…¨éƒ¨') filtered = filtered.filter(r => r.mode === activeModeFilter);
        if (activeCondFilter !== 'å…¨éƒ¨') filtered = filtered.filter(r => r.value === activeCondFilter);
        const max = rawCat === '539' ? 39 : 49; let counts = new Array(max).fill(0);
        filtered.forEach(data => lottoData.forEach((d, i) => {
            let targets = []; if (data.mode === "æ­·å²æ¨¡å¼" && matchHistoryQuery(d, data.query.conds)) targets.push(d);
            else if (data.mode === "ä¸»é«”" && matchSingleCond(d, data.query.main) && matchSingleCond(d, data.query.sub)) targets.push(d);
            else if (data.mode === "æ‹–ç‰Œ" && i < lottoData.length - 1 && matchDragQuery(d, data.query.pre) && matchDragQuery(lottoData[i+1], data.query.post)) targets.push(lottoData[i+1]);
            else if (data.mode === "æ‹–ç‰Œä¸‹æ¨" && matchHistoryQuery(d, data.query.conds)) for(let k=1; k<=(data.pushN || 5); k++) if(lottoData[i+k]) targets.push(lottoData[i+k]);
            targets.forEach(t => t.nums.forEach(n => { if(n>=1 && n<=max) counts[n-1]++; }));
        }));
        let pool = counts.map((v, i) => ({v, n: i+1})).sort((a,b) => b.v - a.v).slice(0, 12).filter(it => it.v > 0).map(it => it.n);
        if (pool.length < 5) return alert('æ•¸æ“šä¸è¶³');
        const sets = lottoData.map(d => new Set(d.nums));
        const getCombs = (k) => getCombinations(pool, k).map(comb => ({ comb, count: sets.reduce((acc, s) => acc + (comb.every(n => s.has(n)) ? 1 : 0), 0) })).sort((a,b) => b.count - a.count).slice(0, 5);
        renderAnalysisArea(getCombs(2), getCombs(3), getCombs(4), getCombs(5), pool);
    }

    function renderAnalysisArea(b2, b3, b4, b5, pool) {
        const area = document.getElementById('analysis-result-area');
        const build = (data, title) => `<div style="flex:1; min-width:280px; border:2px solid #8e44ad; padding:12px;"><h4>ğŸ† ${title}</h4><table class="report-table"><tbody>${data.map(it => `<tr><td>${it.comb.map(n => `<span class="pair-badge">${n.toString().padStart(2,'0')}</span>`).join('')}</td><td>${it.count}æ¬¡</td></tr>`).join('')}</tbody></table></div>`;
        area.innerHTML = `<div class="report-section" style="border: 2px solid #8e44ad;"><div class="report-banner" style="background:#8e44ad;"><span>ğŸ’¡ æœ€ä½³çµ„åˆ</span><button class="btn" onclick="this.closest('.report-section').remove()">âœ–</button></div>
        <div style="padding:12px;"><strong>ğŸ“Œ æ¯é«”ï¼š</strong> ${pool.join(', ')}</div><div style="display:flex; gap:15px; flex-wrap:wrap;">${build(b2,'2æ˜Ÿ')}${build(b3,'3æ˜Ÿ')}${build(b4,'4æ˜Ÿ')}${build(b5,'5æ˜Ÿ')}</div></div>`;
    }

    function renderReports() {
        const area = document.getElementById('report-display-area'); area.innerHTML = ''; updateConditionFilterBar();
        const rawCat = currentConfig.cat.replace('å ±è¡¨', ''), lottoData = globalLottoData[rawCat] || []; if (lottoData.length === 0) return;
        let filtered = reportsData.filter(r => r.owner === currentConfig.user && r.cat === rawCat);
        if (activeModeFilter !== 'å…¨éƒ¨') filtered = filtered.filter(r => r.mode === activeModeFilter);
        if (activeCondFilter !== 'å…¨éƒ¨') filtered = filtered.filter(r => r.value === activeCondFilter);
        
        filtered.forEach(data => {
            const sec = document.createElement('div'); sec.className = 'report-section'; sec.id = `report-sec-${data.id}`;
            const max = rawCat === '539' ? 39 : 49;
            const years = Array.from({length: 2026 - ((currentConfig.user === "çˆ¸") ? 2020 : 2007) + 1}, (_, i) => ((currentConfig.user === "çˆ¸") ? 2020 : 2007) + i);
            let html = `<div class="report-banner"><span>[${data.mode}] ${data.value}</span><button class="btn" onclick="deleteReport(${data.id})">åˆªé™¤</button></div>`;
            
            if (data.mode === "æ‹–ç‰Œä¸‹æ¨") {
                const pk = data.pushN || 5; let ps = Array.from({length: pk}, () => new Array(max).fill(0)), ts = new Array(max).fill(0), ac = new Array(max).fill(0);
                lottoData.forEach((d, i) => { if (matchHistoryQuery(d, data.query.conds)) for(let k=1; k<=pk; k++) if(lottoData[i+k]) lottoData[i+k].nums.forEach(n => { if(n>=1 && n<=max) { ps[k-1][n-1]++; ts[n-1]++; } }); });
                html += `<div class="table-container"><table class="report-table"><thead><tr><th>æœŸæ•¸</th>${Array.from({length:max},(_,i)=>`<th>${i+1}</th>`).join('')}</tr></thead><tbody>`;
                ps.forEach((r, k) => { let th = [...r].sort((a,b)=>b-a)[4]; html += `<tr><td>ä¸‹æ¨ ${k+1}</td>${r.map((v, i) => { if(v>=th && v>0) ac[i]++; return `<td class="${v>=th && v>0?'top5-cell':''}">${v||''}</td>`; }).join('')}</tr>`; });
                let tth = [...ts].sort((a,b)=>b-a)[4]; html += `<tr class="total-row"><td>ç¸½è¨ˆ</td>${ts.map(v => `<td class="${v>=tth && v>0?'total-top5':''}">${v}</td>`).join('')}</tr><tr class="accum-row"><td>ç´¯ç©</td>${ac.map(v => `<td>${v||''}</td>`).join('')}</tr></tbody></table></div>`;
            } 
            else if (data.mode === "ç•¶æœŸå°ç¢°" || data.mode === "ä¸‹æœŸå°ç¢°") {
                html += `<div class="quick-filter-area"><strong>ğŸ¯ æ‰¾è™Ÿï¼š</strong><button class="btn quick-btn active-blue" onclick="filterPairDisplay(${data.id},'ALL',this)">å…¨éƒ¨</button>${Array.from({length:max},(_,i)=>`<button class="btn quick-btn" onclick="filterPairDisplay(${data.id},'${(i+1).toString().padStart(2,'0')}',this)">${(i+1).toString().padStart(2,'0')}</button>`).join('')}</div>`;
                let pc = {}; for(let i=1; i<=max; i++) for(let j=i+1; j<=max; j++) pc[`${i.toString().padStart(2,'0')}ã€${j.toString().padStart(2,'0')}`] = 0;
                lottoData.forEach((d, i) => { if (matchHistoryQuery(d, data.query.conds)) { let t = data.mode === "ç•¶æœŸå°ç¢°" ? d : lottoData[i+1]; if(t) { let ns = t.nums.sort((a,b)=>a-b); for(let a=0; a<ns.length; a++) for(let b=a+1; b<ns.length; b++) { let p = `${ns[a].toString().padStart(2,'0')}ã€${ns[b].toString().padStart(2,'0')}`; if(pc[p]!==undefined) pc[p]++; } } } });
                let gr = {}; Object.entries(pc).forEach(([p, c]) => { if(!gr[c]) gr[c] = []; gr[c].push(p); });
                // é€™è£¡ä¿®æ­£å¾½ç« å±¬æ€§
                html += `<div class="table-container"><table class="report-table"><tbody>${Object.keys(gr).map(Number).sort((a,b)=>b-a).map(f => `<tr class="freq-row"><td style="font-weight:bold;">${f} æ¬¡</td><td>${gr[f].map(p => { let nums = p.split('ã€'); return `<span class="pair-badge" data-n1="${nums[0]}" data-n2="${nums[1]}">${p}</span>`; }).join(' ')}</td></tr>`).join('')}</tbody></table></div>`;
            } else {
                let ct = new Array(max).fill(0), at = new Array(max).fill(0), ys = {}; years.forEach(y => ys[y] = new Array(max).fill(0));
                lottoData.forEach((d, i) => { let y = d.year; if (years.includes(y)) { let match = (data.mode === "æ­·å²æ¨¡å¼") ? matchHistoryQuery(d, data.query.conds) : (data.mode === "ä¸»é«”") ? (matchSingleCond(d, data.query.main) && matchSingleCond(d, data.query.sub)) : (data.mode === "æ‹–ç‰Œ" && lottoData[i-1] && matchDragQuery(lottoData[i-1], data.query.pre) && matchDragQuery(d, data.query.post)); if(match) d.nums.forEach(n => { if(n>=1 && n<=max) { ys[y][n-1]++; ct[n-1]++; } }); } });
                html += `<div class="table-container"><table class="report-table"><thead><tr><th>å¹´åº¦</th>${Array.from({length:max},(_,i)=>`<th>${i+1}</th>`).join('')}</tr></thead><tbody>`;
                years.forEach(y => { let th = [...ys[y]].sort((a,b)=>b-a)[4]; html += `<tr><td>${y}</td>${ys[y].map((v, i) => { if(v>=th && v>0) at[i]++; return `<td class="${v>=th && v>0?'top5-cell':''}">${v||''}</td>`; }).join('')}</tr>`; });
                let tth = [...ct].sort((a,b)=>b-a)[4]; html += `<tr class="total-row"><td>ç¸½è¨ˆ</td>${ct.map(v => `<td class="${v>=tth && v>0?'total-top5':''}">${v||''}</td>`).join('')}</tr><tr class="accum-row"><td>ç´¯ç©</td>${at.map(v => `<td>${v||''}</td>`).join('')}</tr></tbody></table></div>`;
            }
            sec.innerHTML = html; area.appendChild(sec);
        });
    }

    function filterByMode(mode, btn) { btn.parentElement.querySelectorAll('.btn').forEach(b => b.classList.remove('active-blue')); btn.classList.add('active-blue'); activeModeFilter = mode; activeCondFilter = 'å…¨éƒ¨'; renderReports(); }
    function deleteReport(id) { reportsData = reportsData.filter(r => r.id !== id); saveAndRefresh(); }
    function clearReports() { if(confirm("ç¢ºå®šæ¸…ç©ºï¼Ÿ")) { reportsData = []; localStorage.removeItem('lottoReports_v14'); renderReports(); } }
    function exportToExcel() {
        let area = document.getElementById('report-display-area'); if (!area || area.innerHTML.trim()==='') return alert('ç„¡è³‡æ–™');
        let template = `<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40"><head><meta charset="UTF-8"><style>table { border: 1px solid #000; border-collapse: collapse; } td { border: 1px solid #000; text-align: center; } .top5-cell { background: #fbc02d; }</style></head><body>${area.innerHTML}</body></html>`;
        let blob = new Blob([template], { type: 'application/vnd.ms-excel;charset=utf-8' });
        let link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = `åˆ†æ_${Date.now()}.xls`; link.click();
    }
    function resetFilters() { document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active-yellow', 'active-green')); }

function toggleMap() {
    const mapContainer = document.getElementById('map-container');
    const mapFrame = document.getElementById('map-frame');
    const mainUI = document.getElementById('main-ui');
    const reportUI = document.getElementById('report-ui');
    const targetUrl = 'https://win83.github.io/secret-lotto-888/win83.html';

    if (mapContainer.classList.contains('hidden')) {
        // é¡¯ç¤ºåœ°åœ–ï¼Œéš±è—å…¶ä»– UI (å¯é¸)
        mapContainer.classList.remove('hidden');
        if (mapFrame.src !== targetUrl) {
            mapFrame.src = targetUrl; // åªæœ‰åœ¨ç¬¬ä¸€æ¬¡é–‹å•Ÿæˆ–ç¶²å€ä¸åŒæ™‚è¼‰å…¥
        }
        // å¦‚æœæƒ³è®“åœ°åœ–å‡ºç¾æ™‚éš±è—ä¸»ä»‹é¢ï¼Œå¯å•Ÿç”¨ä¸‹é¢é€™è¡Œ
        // mainUI.classList.add('hidden'); 
    } else {
        // éš±è—åœ°åœ–
        mapContainer.classList.add('hidden');
        // mainUI.classList.remove('hidden');
    }
}
    window.addEventListener('keydown', (e) => { if (document.getElementById('app-content').style.display === 'block') { if(e.key === 'Enter') { e.preventDefault(); addToReport(); } if(e.key === 'Escape') resetFilters(); } });
</script>
</body>
</html>
