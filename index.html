<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>å°ˆæ¥­æ¨‚é€çµ±è¨ˆç³»çµ± V2.1 - é‚è¼¯ä¿®æ­£ç‰ˆ</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <style>
    :root{
      --page-bg:#cfe8cf; --panel-bg:#fff8e8; --tab-bg:#ededed;
      --tab-border:#9a9a9a; --blue:#1f73ff; --red:#e51b1b;
      --line:#d0d0d0; --label:#efefef; --btn-border:#7a7a7a;
      --stat-green: #92d050; --stat-light: #e2efda;
      --top5-bg: #ff0000; --top5-text: #ffffff;
      --report-header-bg: #fce4d6;
    }
    *{ box-sizing:border-box; font-family:"Microsoft JhengHei"; }
    body{ margin:0; background:var(--page-bg); color:#111; }
    .tabs{ display:grid; grid-template-columns: repeat(4, 1fr); gap:16px; padding:10px 14px 0; }
    .tab{ height:44px; background:var(--tab-bg); border:1px solid var(--tab-border); display:flex; align-items:center; justify-content:center; font-weight:800; cursor:pointer; }
    .tab.active{ border-bottom:3px solid var(--red); background:#f2f2f2; }
    .container{ margin:10px 14px; border:1px solid var(--blue); border-radius:8px; background:var(--panel-bg); padding:10px; min-height: 80vh; }
    .page { display: none; }
    .page.active { display: block; }
    .filters-box{ border:2px solid var(--red); background:#fff; padding:12px; margin-bottom:10px; }
    .grid{ display:grid; grid-template-columns: 90px 1fr; row-gap:10px; }
    .lbl{ background:var(--label); border:1px solid var(--line); display:flex; align-items:center; justify-content:center; font-weight:900; height:36px; }
    .chips{ display:flex; flex-wrap:wrap; gap:8px; padding-left:10px; }
    .chip{ min-width:44px; height:34px; border:1px solid var(--line); border-radius:4px; display:flex; align-items:center; justify-content:center; cursor:pointer; font-weight:800; background:#fff; }
    .chip.on{ outline:3px solid var(--blue); background:#eef4ff; }
    .btnbar{ display:flex; flex-wrap:wrap; gap:8px; align-items:center; margin-top:10px; }
    .btn{ height:40px; padding:0 15px; border:1px solid var(--btn-border); border-radius:4px; font-weight:900; cursor:pointer; }
    .btn-orange{ background:#ffb300 !important; color:#000; }
    .btn-yellow{ background:#ffeb3b; } .btn-green{ background:#78c57a; } .btn-purple{ background:#6a44c6; color:#fff; } .btn-cyan { background:#00bcd4; color:#fff; }
    .stat-title { color: red; font-weight: bold; margin-top: 15px; margin-bottom: 5px; }
    .stat-table { width: 100%; border-collapse: collapse; background: #fff; min-width: 800px; }
    .stat-table th, .stat-table td { border: 1px solid #000; text-align: center; padding: 2px; font-size: 11px; font-weight: bold; }
    .stat-table th { background: var(--stat-green); }
    .top5 { background-color: var(--top5-bg) !important; color: var(--top5-text) !important; }
    .report-item { margin-bottom: 30px; border: 1px solid #000; background: #fff; overflow-x: auto; }
    .report-header { background: var(--report-header-bg); padding: 5px; font-weight: bold; border-bottom: 1px solid #000; }
    .report-table { width:100%; border-collapse:collapse; font-size:11px; min-width: 1000px; }
    .report-table td { border:1px solid #000; text-align:center; padding:2px; }
    .cond-col { background:#ffff00; font-weight: bold; width: 150px; text-align: left; padding-left: 5px; }
    .sum-row { background:#ddebf7; font-weight:bold; }
    .hidden { display: none !important; }
    #loadingOverlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); display:none; justify-content:center; align-items:center; z-index:9999; font-weight:900; color:red; }
  </style>
</head>
<body>

<div id="loadingOverlay">é›²ç«¯å¤§æ•¸æ“šé‹ç®—ä¸­...</div>

<div class="tabs">
  <div class="tab active" data-game="539" data-target="mainPage">ä»Šå½© 539</div>
  <div class="tab" data-game="539" data-target="reportPage">539 å ±è¡¨</div>
  <div class="tab" data-game="Lotto" data-target="mainPage">å¤§æ¨‚é€</div>
  <div class="tab" data-game="Lotto" data-target="reportPage">å¤§æ¨‚é€ å ±è¡¨</div>
</div>

<div class="container">
  <div id="mainPage" class="page active">
    <div id="gameTitle" style="color:red; font-weight:900; margin-bottom:10px;">ç›®å‰æ¨¡å¼ï¼šä»Šå½© 539</div>
    <div class="btnbar" style="margin-bottom:10px;">
      <button class="btn btn-cyan" id="mode-dad" onclick="switchUser('dad')">çˆ¸ä½¿ç”¨æ¨¡å¼</button>
      <button class="btn" id="mode-bro" onclick="switchUser('bro')">å“¥ä½¿ç”¨æ¨¡å¼</button>
    </div>
    <div class="filters-box"><div class="grid" id="filterGrid"></div></div>
    <div class="btnbar">
      <button class="btn btn-orange mode-btn" onclick="changeMode('æ­·å²æ¨¡å¼', this)">æ­·å²æ¨¡å¼</button>
      <button class="btn btn-yellow mode-btn" onclick="changeMode('æ‹–ç‰Œæ¨¡å¼', this)">æ‹–ç‰Œæ¨¡å¼</button>
      <button class="btn btn-yellow mode-btn" onclick="changeMode('ç•¶æœŸå°ç¢°', this)">ç•¶æœŸå°ç¢°</button>
      <button class="btn btn-yellow mode-btn" onclick="changeMode('ä¸‹æœŸå°ç¢°', this)">ä¸‹æœŸå°ç¢°</button>
      <button class="btn btn-green" onclick="addToReport()">ğŸ§ª åŠ å…¥å ±è¡¨</button>
      <button class="btn" onclick="clearFilters()">æ¸…ç©ºç¯©é¸</button>
    </div>
    <div class="btnbar" style="margin-top:15px; flex-direction: column; align-items: flex-start;">
      <button class="btn btn-purple" onclick="selectToday()">ä¸€éµé¸å–ä»Šæ—¥æ¢ä»¶ & åŒæ­¥é›²ç«¯</button>
      <div id="filterCounter" style="font-weight:bold; font-size:14px; color:red; margin-top:5px; border:1px dashed red; padding:5px; background: #fff;">ç­‰å¾…æ¢ä»¶ä¸­...</div>
    </div>
    <div class="stat-title">å³æ™‚é‹ç®—çµ±è¨ˆ</div>
    <div style="overflow-x:auto"><table class="stat-table"><thead><tr id="stat-head-1"></tr></thead><tbody><tr id="stat-body-1"></tr></tbody></table></div>
    <div class="stat-title">å…¨åŸŸæœªå‡ºæœŸæ•¸</div>
    <div style="overflow-x:auto"><table class="stat-table"><thead><tr id="stat-head-2"></tr></thead><tbody><tr id="stat-body-2"></tr></tbody></table></div>
  </div>

  <div id="reportPage" class="page">
    <div id="reportControl" style="background:#ffd966; padding:8px; display:flex; flex-wrap:wrap; gap:10px; align-items:center; margin-bottom:10px; border:1px solid #999;">
      <button class="btn btn-green" onclick="exportToExcel()">åŒ¯å‡º Excel</button>
      <div style="display:flex; gap:5px; border-left: 2px solid #888; padding-left: 10px;">
        <button class="btn btn-yellow rpt-mode-btn" onclick="changeMode('æ­·å²æ¨¡å¼', this)">æ­·å²</button>
        <button class="btn btn-yellow rpt-mode-btn" onclick="changeMode('æ‹–ç‰Œæ¨¡å¼', this)">æ‹–ç‰Œ</button>
        <button class="btn btn-yellow rpt-mode-btn" onclick="changeMode('ç•¶æœŸå°ç¢°', this)">ç•¶æœŸå°ç¢°</button>
        <button class="btn btn-yellow rpt-mode-btn" onclick="changeMode('ä¸‹æœŸå°ç¢°', this)">ä¸‹æœŸå°ç¢°</button>
      </div>
      <button class="btn" style="margin-left:auto; background:yellow" onclick="clearAllReports()">æ¸…ç©ºå ±è¡¨</button>
    </div>
    <div id="reportContainer"></div>
  </div>
</div>

<script>
let currentMode = "æ­·å²æ¨¡å¼", currentGame = "539", currentUser = "dad", maxNum = 39, cloudData = [];
const reportStorage = { dad: { "539": [], "Lotto": [] }, bro: { "539": [], "Lotto": [] } };
const sheetUrls = {
    "539": "https://docs.google.com/spreadsheets/d/e/2PACX-1vRhDtkfS1lZWSOtI58BCPr1Auwgsv-2SkuWNh9OWY6QnrwlMoNZwJcvs9voSH9wf1EkK53MyRVwNZPd/pub?gid=1316642624&single=true&output=csv",
    "Lotto": "https://docs.google.com/spreadsheets/d/e/2PACX-1vRhDtkfS1lZWSOtI58BCPr1Auwgsv-2SkuWNh9OWY6QnrwlMoNZwJcvs9voSH9wf1EkK53MyRVwNZPd/pub?gid=213544897&single=true&output=csv"
};

function switchUser(role) {
    currentUser = role;
    document.getElementById('mode-dad').classList.toggle('btn-cyan', role==='dad');
    document.getElementById('mode-bro').classList.toggle('btn-cyan', role==='bro');
    initFilters();
    updateStats();
}

function initFilters() {
    maxNum = (currentGame === "539") ? 39 : 49;
    document.getElementById('gameTitle').textContent = `ç›®å‰æ¨¡å¼ï¼š${currentGame} - ${currentMode}`;
    const grid = document.getElementById('filterGrid'); grid.innerHTML = '';
    const sections = [
        {lbl:"å¹´ä»½", d:Array.from({length: 21}, (_, i) => 2006 + i)}, {lbl:"æœˆä»½", d:Array.from({length: 12}, (_, i) => i + 1)},
        {lbl:"æ—¥æœŸ", d:Array.from({length: 31}, (_, i) => i + 1), brk:18}, {lbl:"æ˜ŸæœŸ", d: ["ä¸€","äºŒ","ä¸‰","å››","äº”","å…­","æ—¥"]},
        {lbl:"å¤©å¹²", d: ["ç”²","ä¹™","ä¸™","ä¸","æˆŠ","å·±","åºš","è¾›","å£¬","ç™¸"]}, {lbl:"åœ°æ”¯", d: ["å­","ä¸‘","å¯…","å¯","è¾°","å·³","åˆ","æœª","ç”³","é…‰","æˆŒ","äº¥"]},
        {lbl:"è™Ÿç¢¼", d: Array.from({length:maxNum}, (_,i)=>String(i+1).padStart(2,'0')), brk:25}
    ];
    sections.forEach(sec => {
        const isSB = (sec.lbl === "å¤©å¹²" || sec.lbl === "åœ°æ”¯");
        const hidden = (currentUser === "bro" && isSB) ? "hidden" : "";
        grid.innerHTML += `<div class="lbl ${hidden}">${sec.lbl}</div>`;
        let html = `<div class="chips ${hidden}" data-label="${sec.lbl}">`;
        sec.d.forEach((v, i) => {
            if(sec.brk && i === sec.brk) html += `<div class="breakline"></div>`;
            html += `<div class="chip" data-val="${v}" onclick="toggleChip(this)">${v}</div>`;
        });
        grid.innerHTML += html + `</div>`;
    });
    updateStatTableUI();
    syncModeButtons();
}

function updateStatTableUI() {
    const h1 = document.getElementById('stat-head-1'), b1 = document.getElementById('stat-body-1');
    const h2 = document.getElementById('stat-head-2'), b2 = document.getElementById('stat-body-2');
    h1.innerHTML = b1.innerHTML = h2.innerHTML = b2.innerHTML = '';
    for(let i=1; i<=maxNum; i++) {
        h1.innerHTML += `<th>${i}</th>`; b1.innerHTML += `<td id="val1-${i}">0</td>`;
        h2.innerHTML += `<th>${i}</th>`; b2.innerHTML += `<td id="val2-${i}">0</td>`;
    }
}

function toggleChip(el) { el.classList.toggle('on'); updateStats(); }

function fetchSheetData(callback) {
    document.getElementById('loadingOverlay').style.display = 'flex';
    Papa.parse(sheetUrls[currentGame] + "&t=" + Date.now(), {
        download: true, header: false, skipEmptyLines: true,
        complete: function(results) {
            document.getElementById('loadingOverlay').style.display = 'none';
            // åŸå§‹æ•¸æ“šä¿ç•™ï¼Œä¸é€²è¡Œé ç¯©é¸
            cloudData = results.data.slice(1); 
            if(callback) callback(results.data[results.data.length - 1]);
            updateStats();
        }
    });
}

function updateStats() {
    if(!cloudData.length) return;
    const filters = {}; let catCount = 0;
    ["å¹´ä»½", "æœˆä»½", "æ—¥æœŸ", "æ˜ŸæœŸ", "å¤©å¹²", "åœ°æ”¯"].forEach(lbl => {
        const sel = Array.from(document.querySelectorAll(`.chips[data-label="${lbl}"] .chip.on`)).map(c => c.textContent);
        if(sel.length > 0) { filters[lbl] = sel; catCount++; }
    });
    const selNums = Array.from(document.querySelectorAll(`.chips[data-label="è™Ÿç¢¼"] .chip.on`)).map(c => parseInt(c.textContent));
    const counts = Array(maxNum + 1).fill(0);

    // éæ¿¾æœ‰æ•ˆè³‡æ–™åˆ—
    const validRows = cloudData.filter(row => {
        // çˆ¸æ¨¡å¼ï¼šæª¢æŸ¥ C(2), D(3), E(4), F(5) æ˜¯å¦ç‚ºç©ºå€¼
        if (currentUser === "dad") {
            if (!row[2] || !row[3] || !row[4] || !row[5]) return false;
        }
        return true;
    });

    validRows.forEach((row, idx) => {
        const dateParts = row[1].split('/');
        const rd = { 
            "å¹´ä»½": dateParts[0], 
            "æœˆä»½": dateParts[1], 
            "æ—¥æœŸ": dateParts[2], 
            "æ˜ŸæœŸ": dateParts[3] ? dateParts[3].replace('é€±','') : "", 
            "å¤©å¹²": row[2], 
            "åœ°æ”¯": row[3] 
        };
        const rowNums = row.slice(6, 12).map(Number).filter(n => n > 0); // è™Ÿç¢¼å¾ç¬¬ G æ¬„(6)é–‹å§‹
        
        let mCond = true;
        for(let k in filters) if(!filters[k].includes(rd[k])) { mCond = false; break; }
        if(!mCond) return;

        if (currentMode === "æ­·å²æ¨¡å¼") {
            rowNums.forEach(n => { if(n <= maxNum) counts[n]++; });
        } else if (currentMode === "æ‹–ç‰Œæ¨¡å¼" || currentMode === "ä¸‹æœŸå°ç¢°") {
            if (selNums.length > 0 && selNums.some(sn => rowNums.includes(sn))) {
                const nxt = validRows[idx+1];
                if(nxt) nxt.slice(6, 12).map(Number).forEach(n => { if(n <= maxNum) counts[n]++; });
            }
        } else if (currentMode === "ç•¶æœŸå°ç¢°") {
            if (selNums.length > 0 && selNums.every(sn => rowNums.includes(sn))) {
                rowNums.forEach(n => { if(n <= maxNum) counts[n]++; });
            }
        }
    });

    const sorted = [...counts].sort((a,b)=>b-a);
    const threshold = sorted[4] > 0 ? sorted[4] : 999;

    document.getElementById('filterCounter').textContent = `æ¨¡å¼:${currentMode} | æ¢ä»¶æ•¸:${catCount} | åƒèˆ‡çµ±è¨ˆæœŸæ•¸:${validRows.length}`;
    
    for(let i=1; i<=maxNum; i++){
        const td = document.getElementById(`val1-${i}`);
        td.textContent = counts[i] || 0;
        td.className = (counts[i] >= threshold && counts[i] > 0) ? "top5" : "";
        
        let gap = 0;
        for(let j=validRows.length-1; j>=0; j--){
            if(validRows[j].slice(6, 12).map(Number).includes(i)) break;
            gap++;
        }
        document.getElementById(`val2-${i}`).textContent = gap;
    }
}

function addToReport() {
    const filters = {}; let catCount = 0;
    ["å¹´ä»½", "æœˆä»½", "æ—¥æœŸ", "æ˜ŸæœŸ", "å¤©å¹²", "åœ°æ”¯"].forEach(lbl => {
        const sel = Array.from(document.querySelectorAll(`.chips[data-label="${lbl}"] .chip.on`)).map(c => c.textContent);
        if(sel.length > 0) { filters[lbl] = sel; catCount++; }
    });
    const selNums = Array.from(document.querySelectorAll(`.chips[data-label="è™Ÿç¢¼"] .chip.on`)).map(c => parseInt(c.textContent));
    const condTxt = Object.entries(filters).map(([k,v])=>`${k}:${v}`).join('+') || "ç„¡æ¢ä»¶";

    const validRows = cloudData.filter(row => {
        if (currentUser === "dad") if (!row[2] || !row[3] || !row[4] || !row[5]) return false;
        return true;
    });

    if (currentMode === "æ‹–ç‰Œæ¨¡å¼" || currentMode === "ä¸‹æœŸå°ç¢°") {
        if (catCount < 2 || selNums.length === 0) return alert("æ‹–ç‰Œæ¨¡å¼éœ€ 2 æ¢ä»¶ + è™Ÿç¢¼");
        selNums.forEach(sn => {
            const counts = Array(maxNum + 1).fill(0);
            validRows.forEach((row, idx) => {
                const dateParts = row[1].split('/');
                const rd = { "å¹´ä»½": dateParts[0], "æœˆä»½": dateParts[1], "æ—¥æœŸ": dateParts[2], "æ˜ŸæœŸ": dateParts[3]?dateParts[3].replace('é€±',''):"", "å¤©å¹²": row[2], "åœ°æ”¯": row[3] };
                let m = true; for(let k in filters) if(!filters[k].includes(rd[k])) { m = false; break; }
                if(m && row.slice(6, 12).map(Number).includes(sn)) {
                    const nxt = validRows[idx+1];
                    if(nxt) nxt.slice(6, 12).map(Number).forEach(n => { if(n <= maxNum) counts[n]++; });
                }
            });
            reportStorage[currentUser][currentGame].push({ mode: currentMode, cond: condTxt, num: sn, data: counts });
        });
    } else {
        const counts = Array(maxNum + 1).fill(0);
        validRows.forEach((row) => {
            const dateParts = row[1].split('/');
            const rd = { "å¹´ä»½": dateParts[0], "æœˆä»½": dateParts[1], "æ—¥æœŸ": dateParts[2], "æ˜ŸæœŸ": dateParts[3]?dateParts[3].replace('é€±',''):"", "å¤©å¹²": row[2], "åœ°æ”¯": row[3] };
            const rowNums = row.slice(6, 12).map(Number);
            let mCond = true; for(let k in filters) if(!filters[k].includes(rd[k])) { mCond = false; break; }
            if(!mCond) return;
            if(currentMode === "æ­·å²æ¨¡å¼") rowNums.forEach(n => { if(n <= maxNum) counts[n]++; });
            else if(currentMode === "ç•¶æœŸå°ç¢°") if(selNums.every(sn => rowNums.includes(sn))) rowNums.forEach(n => { if(n <= maxNum) counts[n]++; });
        });
        reportStorage[currentUser][currentGame].push({ mode: currentMode, cond: condTxt, num: selNums.join(',') || "å…¨é¸", data: counts });
    }
    renderCurrentReports();
    document.querySelector(`.tab[data-target="reportPage"][data-game="${currentGame}"]`).click();
}

function renderCurrentReports() {
    const cont = document.getElementById('reportContainer'); cont.innerHTML = '';
    const list = reportStorage[currentUser][currentGame]; if(!list.length) return;
    let html = `<div class="report-item"><div class="report-header">ã€åˆ†æå ±è¡¨ã€‘æ¨¡å¼ï¼š${currentMode} | ä½¿ç”¨è€…ï¼š${currentUser==='dad'?'çˆ¸':'å“¥'}</div><table class="report-table"><thead><tr><td class="cond-col">åˆ†ææ¢ä»¶+è™Ÿç¢¼</td>${Array.from({length:maxNum},(_,i)=>`<td>${i+1}</td>`).join('')}</tr></thead><tbody class="report-body">`;
    list.forEach(item => {
        const sorted = [...item.data].sort((a,b)=>b-a);
        const threshold = sorted[4] > 0 ? sorted[4] : 999;
        html += `<tr><td class="cond-col">${item.cond}<br>${item.num}</td>${item.data.slice(1).map(v => `<td class="${v >= threshold && v > 0 ? 'top5' : ''}">${v||''}</td>`).join('')}</tr>`;
    });
    html += `</tbody><tfoot><tr class="sum-row"><td class="cond-col">åŠ ç¸½ (Sum)</td>${Array.from({length:maxNum},(_,i)=>`<td class="sum-cell">0</td>`).join('')}</tr></tfoot></table></div>`;
    cont.innerHTML = html;
    const rows = cont.querySelectorAll('.report-body tr');
    cont.querySelectorAll('.sum-cell').forEach((cell, idx) => {
        let s = 0; rows.forEach(r => s += parseInt(r.cells[idx+1].textContent)||0);
        cell.textContent = s || '';
    });
}

function changeMode(mode, btn) {
    currentMode = (mode.includes('æ¨¡å¼')) ? mode : mode + 'æ¨¡å¼';
    syncModeButtons();
    if(document.getElementById('mainPage').classList.contains('active')) {
        updateStats();
    } else {
        renderCurrentReports();
    }
}

function syncModeButtons() {
    document.querySelectorAll('.mode-btn').forEach(b => {
        b.classList.toggle('btn-orange', b.textContent === currentMode);
    });
    document.querySelectorAll('.rpt-mode-btn').forEach(b => {
        const simpleMode = currentMode.replace('æ¨¡å¼', '');
        b.classList.toggle('btn-orange', b.textContent === simpleMode);
    });
}

function selectToday() {
    clearFilters();
    fetchSheetData((lastRow) => {
        const p = lastRow[1].split('/');
        autoClick('æœˆä»½', p[1]); autoClick('æ—¥æœŸ', p[2]);
        if(p[3]) autoClick('æ˜ŸæœŸ', p[3].replace('é€±',''));
        if(currentUser === 'dad') { autoClick('å¤©å¹²', lastRow[2]); autoClick('åœ°æ”¯', lastRow[3]); }
        updateStats();
    });
}

function autoClick(label, val) {
    if(!val) return;
    const c = document.querySelector(`.chips[data-label="${label}"] .chip[data-val="${val.trim().replace(/^0/, '')}"]`);
    if(c) c.classList.add('on');
}

function exportToExcel() {
    let table = document.querySelector(".report-table");
    if(!table) return alert("ç„¡è³‡æ–™");
    let url = 'data:application/vnd.ms-excel,' + encodeURIComponent(table.outerHTML);
    let link = document.createElement("a"); link.download = `åˆ†æ_${Date.now()}.xls`; link.href = url; link.click();
}

function clearFilters() { document.querySelectorAll('.chip.on').forEach(c => c.classList.remove('on')); updateStats(); }
function clearAllReports() { if(confirm("ç¢ºå®šæ¸…ç©ºï¼Ÿ")) { reportStorage[currentUser][currentGame] = []; renderCurrentReports(); } }

document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', () => {
        currentGame = tab.dataset.game;
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active')); tab.classList.add('active');
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(tab.dataset.target).classList.add('active');
        if(tab.dataset.target === 'mainPage') {
            initFilters();
            updateStats();
        } else {
            renderCurrentReports();
            syncModeButtons();
        }
    });
});

initFilters();
fetchSheetData();
</script>
</body>
</html>
