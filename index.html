<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>539 å°ˆæ¥­å›æ¸¬ - ä¿®æ­£ç‰ˆ</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <style>
        :root { --bg: #d1e7d1; --blue-t: #2196F3; --red-box: #f44336; --gold: #ffc107; }
        body { background-color: var(--bg); font-family: "Microsoft JhengHei", sans-serif; font-size: 13px; margin: 15px; }
        .main-layout { display: flex; flex-direction: column; gap: 10px; }
        .filter-panel { border: 2px solid var(--red-box); background: #fff; padding: 15px; display: grid; grid-template-columns: 80px 1fr; gap: 8px; border-radius: 8px; }
        .f-label { background: #eee; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 1px solid #ccc; }
        .f-btns { display: flex; flex-wrap: wrap; gap: 4px; }
        .f-item { padding: 4px 10px; border: 1px solid #ccc; cursor: pointer; background: #fff; border-radius: 4px; position: relative; }
        .f-item.active { background: var(--blue-t); color: white; }
        .action-bar { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; background: rgba(255,255,255,0.7); padding: 12px; border-radius: 8px; }
        .yellow-btn { background: #ffff00; border: 1px solid #000; padding: 8px 15px; font-weight: bold; cursor: pointer; border-radius: 4px; }
        .yellow-btn.active { background: #ff9800 !important; color: white; }
        .view-container { background: white; border: 2px solid var(--blue-t); padding: 10px; border-radius: 8px; }
        .scroll-area { overflow: auto; max-height: 450px; }
        table { border-collapse: collapse; width: 100%; white-space: nowrap; }
        th, td { border: 1px solid #ccc; padding: 5px; text-align: center; }
        .hidden { display: none; }
        .num-cell { width: 25px; font-weight: bold; }
        .top-hit { background-color: #ffff00 !important; color: red; }
    </style>
</head>
<body>

<div class="main-layout">
    <div style="display:flex; gap:5px;">
        <button onclick="switchPage('dist')" style="flex:1; padding:12px; font-weight:bold;">ğŸ“Š åˆ†ä½ˆåœ–</button>
        <button onclick="switchPage('repo')" style="flex:1; padding:12px; font-weight:bold;">ğŸ“‘ å ±è¡¨</button>
    </div>

    <div id="page-dist" class="view-container">
        <div class="filter-panel">
            <div class="f-label">å¹´ä»½</div><div class="f-btns" data-type="year"></div>
            <div class="f-label">é€±</div><div class="f-btns" data-type="week"></div>
            <div class="f-label">å¤©å¹²</div><div class="f-btns" data-type="tian"></div>
            <div class="f-label">åœ°æ”¯</div><div class="f-btns" data-type="di"></div>
            <div class="f-label" style="background:#e3f2fd">å¹²æ”¯çµ„åˆ</div><div class="f-btns" data-type="ganzhi"></div>
            <div class="f-label">ç¯€æ°£</div><div class="f-btns" data-type="solar"></div>
            <div class="f-label" style="color:blue">è™Ÿç¢¼</div><div class="f-btns" data-type="nums"></div>
        </div>

        <div class="action-bar">
            <span>æœ€è¿‘ <input type="number" id="limitCount" value="0" style="width:60px" onchange="applyFilter()"> æœŸ (0=å…¨)</span>
            <button class="yellow-btn btn-mode-h" onclick="setMode('history')">æ­·å²çµ±è¨ˆ</button>
            <button class="yellow-btn btn-mode-t" onclick="setMode('tuopai')">æ‹–ç‰Œæ¨¡å¼</button>
            <button class="yellow-btn btn-mode-d" onclick="setMode('duipeng')">ä¸‹æœŸå°ç¢°</button>
            <button onclick="generateBatchReport()" style="background:#4CAF50; color:white; padding:8px 15px; font-weight:bold; cursor:pointer;">åŠ å…¥å ±è¡¨</button>
            <button onclick="clearFilters()">æ¸…ç©º</button>
            <span id="fileMsg" style="margin-left:auto; font-weight:bold;">è¼‰å…¥ä¸­...</span>
        </div>

        <div class="scroll-area">
            <table>
                <thead id="thr">
                    <tr><th>æœŸè™Ÿ</th><th>æ—¥æœŸ</th><th>é€±</th><th>å¤©å¹²</th><th>åœ°æ”¯</th><th>å¹²æ”¯</th><th>ç¯€æ°£</th><th colspan="5">é–‹ç</th></tr>
                </thead>
                <tbody id="gridBody"></tbody>
            </table>
        </div>
    </div>

    <div id="page-repo" class="view-container hidden">
        <div id="repo-list"></div>
    </div>
</div>

<script>
    const GSHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTuGa3v-rwH8Qh-JXF9MfxwUwT0A-iJooRI6ypJTErCsxN9qCjZQrgr70f16ZoehQ/pub?output=csv";
    let rawDb = [];
    let filters = { year:[], week:[], tian:[], di:[], ganzhi:[], solar:[], nums:[] };
    let currentMode = 'history';

    async function init() {
        try {
            const res = await fetch(GSHEET_URL);
            const csv = await res.text();
            const data = XLSX.utils.sheet_to_json(XLSX.read(csv, {type:'string'}).Sheets[XLSX.read(csv, {type:'string'}).SheetNames[0]], {header:1});
            
            rawDb = data.filter(r => r[0] && !isNaN(r[0])).map(r => {
                const date = String(r[1]);
                const yr = date.includes('/') ? date.split('/')[0] : date.substring(0,4);
                return {
                    id: r[0], date: r[1], week: r[2], tian: r[3], di: r[4], 
                    ganzhi: String(r[3])+String(r[4]), 
                    solar: r[5], 
                    nums: [Number(r[6]), Number(r[7]), Number(r[8]), Number(r[9]), Number(r[10])],
                    year: yr
                };
            });

            setupFilterBtns();
            renderGrid();
            document.getElementById('fileMsg').innerText = `å·²è¼‰å…¥ ${rawDb.length} æœŸ`;
        } catch(e) { document.getElementById('fileMsg').innerText = "è¼‰å…¥å¤±æ•—"; }
    }

    function setupFilterBtns() {
        const create = (type, list) => {
            const box = document.querySelector(`[data-type="${type}"]`);
            box.innerHTML = '';
            list.forEach(v => {
                const btn = document.createElement('div');
                btn.className = 'f-item'; btn.innerText = v;
                btn.onclick = () => {
                    const idx = filters[type].indexOf(v);
                    if(idx>-1) { filters[type].splice(idx,1); btn.classList.remove('active'); }
                    else { filters[type].push(v); btn.classList.add('active'); }
                    applyFilter();
                };
                box.appendChild(btn);
            });
        };

        create('year', [...new Set(rawDb.map(r => r.year))].sort().reverse());
        create('week', ['ä¸€','äºŒ','ä¸‰','å››','äº”','å…­','æ—¥']);
        create('tian', ['ç”²','ä¹™','ä¸™','ä¸','æˆŠ','å·±','åºš','è¾›','å£¬','ç™¸']);
        create('di', ['å­','ä¸‘','å¯…','å¯','è¾°','å·³','åˆ','æœª','ç”³','é…‰','æˆŒ','äº¥']);
        create('ganzhi', [...new Set(rawDb.map(r => r.ganzhi))].sort());
        create('solar', [...new Set(rawDb.map(r => r.solar))].sort());
        create('nums', Array.from({length:39}, (_,i)=>i+1));
        
        const thrRow = document.querySelector('#thr tr');
        for(let i=1; i<=39; i++) {
            const th = document.createElement('th');
            th.innerHTML = `${i}<br><span id="s-${i}" style="font-size:9px;color:blue">0</span>`;
            thrRow.appendChild(th);
        }
    }

    function applyFilter() {
        const limit = parseInt(document.getElementById('limitCount').value) || 0;
        const startIdx = limit > 0 ? Math.max(0, rawDb.length - limit) : 0;
        let counts = Array(40).fill(0);

        rawDb.forEach((r, i) => {
            const el = document.getElementById(`row-${i}`);
            if(!el) return;

            let ok = (i >= startIdx);
            if(ok) {
                if(filters.year.length) ok &= filters.year.includes(r.year);
                if(filters.week.length) ok &= filters.week.includes(String(r.week));
                if(filters.tian.length) ok &= filters.tian.includes(String(r.tian));
                if(filters.di.length) ok &= filters.di.includes(String(r.di));
                if(filters.ganzhi.length) ok &= filters.ganzhi.includes(r.ganzhi);
                if(filters.solar.length) ok &= filters.solar.includes(String(r.solar));
                if(filters.nums.length) ok &= filters.nums.every(n => r.nums.includes(n));
            }

            el.style.display = ok ? '' : 'none';
            if(ok) {
                r.nums.forEach(n => counts[n]++);
                const cells = el.querySelectorAll('.num-hit');
                cells.forEach(c => {
                    const n = Number(c.dataset.n);
                    c.innerText = r.nums.includes(n) ? (n<10?'0'+n:n) : '';
                });
            }
        });
        for(let i=1; i<=39; i++) document.getElementById(`s-${i}`).innerText = counts[i];
    }

    function renderGrid() {
        const body = document.getElementById('gridBody');
        body.innerHTML = rawDb.map((r, i) => `
            <tr id="row-${i}">
                <td>${r.id}</td><td>${r.date}</td><td>${r.week}</td><td>${r.tian}</td><td>${r.di}</td><td>${r.ganzhi}</td><td>${r.solar}</td>
                <td colspan="5" style="background:#eee">${r.nums.join(',')}</td>
                ${Array.from({length:39}, (_, n)=>`<td class="num-cell num-hit" data-n="${n+1}"></td>`).join('')}
            </tr>
        `).join('');
        applyFilter();
    }

    function setMode(m) {
        currentMode = m;
        document.querySelectorAll('.yellow-btn').forEach(b => b.classList.remove('active'));
        if(m==='history') document.querySelector('.btn-mode-h').classList.add('active');
        if(m==='tuopai') document.querySelector('.btn-mode-t').classList.add('active');
        if(m==='duipeng') document.querySelector('.btn-mode-d').classList.add('active');
        applyFilter();
    }

    function switchPage(p) {
        document.getElementById('page-dist').classList.toggle('hidden', p==='repo');
        document.getElementById('page-repo').classList.toggle('hidden', p==='dist');
    }

    function clearFilters() {
        filters = { year:[], week:[], tian:[], di:[], ganzhi:[], solar:[], nums:[] };
        document.querySelectorAll('.f-item').forEach(e => e.classList.remove('active'));
        applyFilter();
    }

    init();
</script>
</body>
</html>
