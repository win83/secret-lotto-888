<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>å°ˆæ¥­æ¨‚é€çµ±è¨ˆç³»çµ± V2.1 - å ±è¡¨é€ç­†+Sum+å‰å¾ŒæœŸæ‹–ç‰Œ+Top3æœªå‡º</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <style>
    :root{
      --page-bg:#cfe8cf; --panel-bg:#fff8e8; --tab-bg:#ededed;
      --tab-border:#9a9a9a; --blue:#1f73ff; --red:#e51b1b;
      --line:#d0d0d0; --label:#efefef; --btn-border:#7a7a7a;
      --stat-green: #92d050; --stat-light: #e2efda;
      --top-bg: #ff0000; --top-text: #ffffff;
      --report-header-bg: #fce4d6;
    }
    *{ box-sizing:border-box; font-family:"Microsoft JhengHei"; }
    body{ margin:0; background:var(--page-bg); color:#111; }
    .tabs{ display:grid; grid-template-columns: repeat(4, 1fr); gap:16px; padding:10px 14px 0; }
    .tab{ height:44px; background:var(--tab-bg); border:1px solid var(--tab-border); display:flex; align-items:center; justify-content:center; font-weight:800; cursor:pointer; }
    .tab.active{ border-bottom:3px solid var(--red); background:#f2f2f2; }
    .container{ margin:10px 14px; border:1px solid var(--blue); border-radius:8px; background:var(--panel-bg); padding:10px; min-height: 80vh; }
    .page { display: none; }
    .page.active { display: block; }
    .filters-box{ border:2px solid var(--red); background:#fff; padding:12px; margin-bottom:10px; }
    .grid{ display:grid; grid-template-columns: 90px 1fr; row-gap:10px; }
    .lbl{ background:var(--label); border:1px solid var(--line); display:flex; align-items:center; justify-content:center; font-weight:900; height:36px; }
    .chips{ display:flex; flex-wrap:wrap; gap:8px; padding-left:10px; }
    .chip{ min-width:44px; height:34px; border:1px solid var(--line); border-radius:4px; display:flex; align-items:center; justify-content:center; cursor:pointer; font-weight:800; background:#fff; user-select:none; }
    .chip.on{ outline:3px solid var(--blue); background:#eef4ff; }
    .btnbar{ display:flex; flex-wrap:wrap; gap:8px; align-items:center; margin-top:10px; }
    .btn{ height:40px; padding:0 15px; border:1px solid var(--btn-border); border-radius:4px; font-weight:900; cursor:pointer; }
    .btn-orange{ background:#ffb300 !important; color:#000; }
    .btn-yellow{ background:#ffeb3b; } .btn-green{ background:#78c57a; } .btn-purple{ background:#6a44c6; color:#fff; } .btn-cyan { background:#00bcd4; color:#fff; }
    .btn-red{ background:#ff3b30; color:#fff; border-color:#b21b12; }
    .stat-title { color: red; font-weight: bold; margin-top: 15px; margin-bottom: 5px; }
    .stat-table { width: 100%; border-collapse: collapse; background: #fff; min-width: 800px; }
    .stat-table th, .stat-table td { border: 1px solid #000; text-align: center; padding: 2px; font-size: 11px; font-weight: bold; }
    .stat-table th { background: var(--stat-green); }
    .topcell { background-color: var(--top-bg) !important; color: var(--top-text) !important; }
    .report-item { margin-bottom: 30px; border: 1px solid #000; background: #fff; overflow-x: auto; }
    .report-header { background: var(--report-header-bg); padding: 8px; font-weight: bold; border-bottom: 1px solid #000; display:flex; gap:10px; align-items:center; }
    .report-header .title{ flex:1; }
    .report-table { width:100%; border-collapse:collapse; font-size:11px; min-width: 1000px; }
    .report-table td { border:1px solid #000; text-align:center; padding:2px; }
    .cond-col { background:#ffff00; font-weight: bold; width: 280px; text-align: left; padding-left: 6px; white-space:normal; }
    .sum-row { background:#ddebf7; font-weight:bold; }
    .hidden { display: none !important; }
    #loadingOverlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); display:none; justify-content:center; align-items:center; z-index:9999; font-weight:900; color:red; }
    .miniTag{ display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border:1px solid #999; background:#fff; border-radius:6px; font-weight:900; }
    .miniBtn{ height:32px; padding:0 10px; border:1px solid #666; border-radius:6px; font-weight:900; cursor:pointer; background:#fff; }
    .miniBtn.on{ outline:3px solid var(--blue); }
  </style>
</head>
<body>

<div id="loadingOverlay">é›²ç«¯å¤§æ•¸æ“šé‹ç®—ä¸­...</div>

<div class="tabs">
  <div class="tab active" data-game="539" data-target="mainPage">ä»Šå½© 539</div>
  <div class="tab" data-game="539" data-target="reportPage">539 å ±è¡¨</div>
  <div class="tab" data-game="Lotto" data-target="mainPage">å¤§æ¨‚é€</div>
  <div class="tab" data-game="Lotto" data-target="reportPage">å¤§æ¨‚é€ å ±è¡¨</div>
</div>

<div class="container">
  <div id="mainPage" class="page active">
    <div id="gameTitle" style="color:red; font-weight:900; margin-bottom:10px;">ç›®å‰æ¨¡å¼ï¼šä»Šå½© 539</div>

    <div class="btnbar" style="margin-bottom:10px;">
      <button class="btn btn-cyan" id="mode-dad" onclick="switchUser('dad')">çˆ¸ä½¿ç”¨æ¨¡å¼</button>
      <button class="btn" id="mode-bro" onclick="switchUser('bro')">å“¥ä½¿ç”¨æ¨¡å¼</button>

      <span class="miniTag" title="æ‹–ç‰Œ/ä¸‹æœŸå°ç¢°æ™‚ï¼šåˆ‡æ›ä½ ç¾åœ¨å‹¾é¸çš„æ¢ä»¶è¦å¯«åˆ°ã€å‰æœŸã€é‚„æ˜¯ã€å¾ŒæœŸã€">
        å‰/å¾ŒæœŸæ¢ä»¶ï¼š
        <button class="miniBtn on" id="btn-pre" onclick="setPhase('pre')">å‰æœŸ</button>
        <button class="miniBtn" id="btn-post" onclick="setPhase('post')">å¾ŒæœŸ</button>
      </span>

      <span class="miniTag" id="phaseHint">ç›®å‰å‹¾é¸æœƒè¨˜åˆ°ï¼šå‰æœŸ</span>
    </div>

    <div class="filters-box"><div class="grid" id="filterGrid"></div></div>

    <div class="btnbar">
      <button class="btn btn-orange mode-btn" onclick="changeMode('æ­·å²æ¨¡å¼', this)">æ­·å²æ¨¡å¼</button>
      <button class="btn btn-yellow mode-btn" onclick="changeMode('æ‹–ç‰Œæ¨¡å¼', this)">æ‹–ç‰Œæ¨¡å¼</button>
      <button class="btn btn-yellow mode-btn" onclick="changeMode('ç•¶æœŸå°ç¢°', this)">ç•¶æœŸå°ç¢°</button>
      <button class="btn btn-yellow mode-btn" onclick="changeMode('ä¸‹æœŸå°ç¢°', this)">ä¸‹æœŸå°ç¢°</button>
      <button class="btn btn-green" onclick="addToReport()">ğŸ§ª åŠ å…¥å ±è¡¨</button>
      <button class="btn" onclick="clearFilters()">æ¸…ç©ºç¯©é¸</button>
    </div>

    <div class="btnbar" style="margin-top:15px; flex-direction: column; align-items: flex-start;">
      <button class="btn btn-purple" onclick="selectToday()">ä¸€éµé¸å–ä»Šæ—¥æ¢ä»¶ & åŒæ­¥é›²ç«¯</button>
      <div id="filterCounter" style="font-weight:bold; font-size:14px; color:red; margin-top:5px; border:1px dashed red; padding:5px; background: #fff;">ç­‰å¾…æ¢ä»¶ä¸­...</div>
    </div>

    <div class="stat-title">å³æ™‚é‹ç®—çµ±è¨ˆï¼ˆæ‰€æœ‰æ¨¡å¼çš†é¡¯ç¤ºï¼‰</div>
    <div style="overflow-x:auto"><table class="stat-table"><thead><tr id="stat-head-1"></tr></thead><tbody><tr id="stat-body-1"></tr></tbody></table></div>

    <div class="stat-title">å…¨åŸŸæœªå‡ºæœŸæ•¸ï¼ˆTop3 æ¨™ç´…ï¼‰</div>
    <div style="overflow-x:auto"><table class="stat-table"><thead><tr id="stat-head-2"></tr></thead><tbody><tr id="stat-body-2"></tr></tbody></table></div>
  </div>

  <div id="reportPage" class="page">
    <div id="reportControl" style="background:#ffd966; padding:8px; display:flex; flex-wrap:wrap; gap:10px; align-items:center; margin-bottom:10px; border:1px solid #999;">
      <button class="btn btn-green" onclick="exportToExcel()">åŒ¯å‡º Excel</button>
      <div style="display:flex; gap:5px; border-left: 2px solid #888; padding-left: 10px;">
        <button class="btn btn-yellow rpt-mode-btn" onclick="changeMode('æ­·å²æ¨¡å¼', this)">æ­·å²</button>
        <button class="btn btn-yellow rpt-mode-btn" onclick="changeMode('æ‹–ç‰Œæ¨¡å¼', this)">æ‹–ç‰Œ</button>
        <button class="btn btn-yellow rpt-mode-btn" onclick="changeMode('ç•¶æœŸå°ç¢°', this)">ç•¶æœŸå°ç¢°</button>
        <button class="btn btn-yellow rpt-mode-btn" onclick="changeMode('ä¸‹æœŸå°ç¢°', this)">ä¸‹æœŸå°ç¢°</button>
      </div>
      <button class="btn" style="margin-left:auto; background:yellow" onclick="clearAllReports()">æ¸…ç©ºå ±è¡¨</button>
    </div>
    <div id="reportContainer"></div>
  </div>
</div>

<script>
let currentMode = "æ­·å²æ¨¡å¼", currentGame = "539", currentUser = "dad", maxNum = 39, cloudData = [];
let phase = "pre"; // æ‹–ç‰Œ/ä¸‹æœŸå°ç¢°ï¼šç›®å‰å‹¾é¸å¯«å…¥å‰æœŸ or å¾ŒæœŸ

// å…©å¥—æ¢ä»¶ï¼ˆå‰æœŸ / å¾ŒæœŸï¼‰åˆ†é–‹å­˜
let preFilters = {};
let postFilters = {};

const reportStorage = { dad: { "539": [], "Lotto": [] }, bro: { "539": [], "Lotto": [] } };

const sheetUrls = {
  "539": "https://docs.google.com/spreadsheets/d/e/2PACX-1vRhDtkfS1lZWSOtI58BCPr1Auwgsv-2SkuWNh9OWY6QnrwlMoNZwJcvs9voSH9wf1EkK53MyRVwNZPd/pub?gid=1316642624&single=true&output=csv",
  "Lotto": "https://docs.google.com/spreadsheets/d/e/2PACX-1vRhDtkfS1lZWSOtI58BCPr1Auwgsv-2SkuWNh9OWY6QnrwlMoNZwJcvs9voSH9wf1EkK53MyRVwNZPd/pub?gid=213544897&single=true&output=csv"
};

/* ===== æ—¥æœŸ/æ˜ŸæœŸ/æ—¥å¹²æ”¯ ===== */
function parseYMD(dateCell){
  const s = String(dateCell || "").trim();
  if(!s) return {y:"", m:"", d:""};
  const parts = s.includes('/') ? s.split('/') : (s.includes('-') ? s.split('-') : []);
  const y = parts[0] ? String(parseInt(parts[0],10)) : "";
  const m = parts[1] ? String(parseInt(parts[1],10)) : "";
  const d = parts[2] ? String(parseInt(parts[2],10)) : "";
  return {y,m,d};
}
function ymdKey(y,m,d){
  const yy = parseInt(y,10), mm = parseInt(m,10), dd = parseInt(d,10);
  if(!Number.isFinite(yy)||!Number.isFinite(mm)||!Number.isFinite(dd)) return NaN;
  return yy*10000 + mm*100 + dd;
}
function calcWeekday(y,m,d){
  const dt = new Date(parseInt(y,10), parseInt(m,10)-1, parseInt(d,10));
  if(Number.isNaN(dt.getTime())) return "";
  const map = ["æ—¥","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­"];
  return map[dt.getDay()];
}
const STEMS = ["ç”²","ä¹™","ä¸™","ä¸","æˆŠ","å·±","åºš","è¾›","å£¬","ç™¸"];
const BRANCHES = ["å­","ä¸‘","å¯…","å¯","è¾°","å·³","åˆ","æœª","ç”³","é…‰","æˆŒ","äº¥"];
function jdnFromYMD(y,m,d){
  const Y = parseInt(y,10), M = parseInt(m,10), D = parseInt(d,10);
  if(!Number.isFinite(Y)||!Number.isFinite(M)||!Number.isFinite(D)) return NaN;
  const a = Math.floor((14 - M)/12);
  const yy = Y + 4800 - a;
  const mm = M + 12*a - 3;
  return D + Math.floor((153*mm + 2)/5) + 365*yy + Math.floor(yy/4) - Math.floor(yy/100) + Math.floor(yy/400) - 32045;
}
const BASE_JDN = jdnFromYMD("1984","2","2"); // ç”²å­æ—¥
function ganzhiOfDay(y,m,d){
  const jdn = jdnFromYMD(y,m,d);
  if(!Number.isFinite(jdn) || !Number.isFinite(BASE_JDN)) return {stem:"", branch:""};
  let idx = (jdn - BASE_JDN) % 60; if(idx < 0) idx += 60;
  return { stem: STEMS[idx % 10], branch: BRANCHES[idx % 12] };
}

/* ===== çˆ¸/å“¥ èµ·ç®— ===== */
function startKeyByUser(){ return (currentUser === "dad") ? 20200101 : 20060101; }
function startYearByUser(){ return (currentUser === "dad") ? 2020 : 2006; }

/* ===== çƒæ¬„ ===== */
function ballSliceEnd(){ return (currentGame === "539") ? 11 : 12; }
function requiredBallCount(){ return (currentGame === "539") ? 5 : 6; }
function rowBalls(row){
  return row.slice(6, ballSliceEnd()).map(v => parseInt(v,10)).filter(n => n > 0);
}
function hasEnoughBalls(row){ return rowBalls(row).length >= requiredBallCount(); }
function getValidRows(){
  const sk = startKeyByUser();
  return cloudData.filter(row => {
    const {y,m,d} = parseYMD(row[1]);
    const k = ymdKey(y,m,d);
    if(!Number.isFinite(k) || k < sk) return false;
    if(!hasEnoughBalls(row)) return false;
    return true;
  });
}

/* ===== row meta/filters ===== */
function rowMetaFromRow(row){
  const {y,m,d} = parseYMD(row[1]);
  const w = calcWeekday(y,m,d);
  const gz = ganzhiOfDay(y,m,d);
  return { y,m,d,w, stem:gz.stem, branch:gz.branch };
}
function buildRd(meta){
  return { "å¹´ä»½": meta.y, "æœˆä»½": meta.m, "æ—¥æœŸ": meta.d, "æ˜ŸæœŸ": meta.w, "å¤©å¹²": meta.stem, "åœ°æ”¯": meta.branch };
}
function matchFilters(rd, filters){
  for(const k in filters){
    if(!filters[k].includes(rd[k])) return false;
  }
  return true;
}
function fmtFilters(filters){
  return Object.entries(filters).map(([k,v])=>`${k}:${v.join(',')}`).join(' + ') || "ç„¡æ¢ä»¶";
}

/* ===== å ±è¡¨ç¾¤çµ„ ===== */
function newGroup(mode, title){
  return { id:`${Date.now()}_${Math.random().toString(16).slice(2)}`, mode, title, rows:[], sum:Array(maxNum+1).fill(0) };
}
function addRowToGroup(group, label, dataArr){
  group.rows.push({ label, data:dataArr });
  for(let i=1;i<=maxNum;i++) group.sum[i] += (dataArr[i] || 0);
}
function deleteReport(groupId){
  const list = reportStorage[currentUser][currentGame];
  const idx = list.findIndex(g => g.id === groupId);
  if(idx < 0) return;
  if(!confirm("ç¢ºå®šåˆªé™¤é€™å¼µå ±è¡¨ï¼Ÿ")) return;
  list.splice(idx,1);
  renderCurrentReports();
}

/* ===== å‰/å¾ŒæœŸåˆ‡æ› ===== */
function setPhase(p){
  phase = p;
  document.getElementById('btn-pre').classList.toggle('on', phase==='pre');
  document.getElementById('btn-post').classList.toggle('on', phase==='post');
  document.getElementById('phaseHint').textContent = `ç›®å‰å‹¾é¸æœƒè¨˜åˆ°ï¼š${phase==='pre'?'å‰æœŸ':'å¾ŒæœŸ'}`;
  // åˆ‡æ›æ™‚ï¼Œè®“ chips é¡¯ç¤ºå°æ‡‰é›†åˆ
  applyFilterSetToUI(phase==='pre' ? preFilters : postFilters);
  updateStats(); // åˆ‡æ›ä¹Ÿå³æ™‚æ›´æ–°
}

function getCurrentFilterSet(){
  return (phase==='pre') ? preFilters : postFilters;
}

function readFiltersFromUI(){
  const filters = {};
  ["å¹´ä»½", "æœˆä»½", "æ—¥æœŸ", "æ˜ŸæœŸ", "å¤©å¹²", "åœ°æ”¯"].forEach(lbl=>{
    const sel = Array.from(document.querySelectorAll(`.chips[data-label="${lbl}"] .chip.on`))
      .map(c=>String(c.textContent).trim());
    if(sel.length) filters[lbl] = sel;
  });
  return filters;
}

function applyFilterSetToUI(filters){
  // æ¸…æ‰ UI é¸å–
  document.querySelectorAll('.chip.on').forEach(c=>c.classList.remove('on'));
  // ä¾ filters æŠŠ chip åŠ å› on
  Object.entries(filters || {}).forEach(([lbl, arr])=>{
    arr.forEach(v=>{
      const vv = String(v).trim();
      const chip = document.querySelector(`.chips[data-label="${lbl}"] .chip[data-val="${vv}"]`);
      if(chip) chip.classList.add('on');
    });
  });
}

/* ===== é¸è™Ÿ ===== */
function getSelectedNums(){
  return Array.from(document.querySelectorAll(`.chips[data-label="è™Ÿç¢¼"] .chip.on`))
    .map(c => parseInt(c.textContent,10)).filter(n => Number.isFinite(n));
}

/* ===== UI init ===== */
function switchUser(role){
  currentUser = role;
  document.getElementById('mode-dad').classList.toggle('btn-cyan', role==='dad');
  document.getElementById('mode-bro').classList.toggle('btn-cyan', role==='bro');

  // åˆ‡æ›ä½¿ç”¨è€…æ™‚ï¼šæ¸…æ‰å‰å¾ŒæœŸæ¢ä»¶
  preFilters = {};
  postFilters = {};
  phase = "pre";
  document.getElementById('btn-pre').classList.add('on');
  document.getElementById('btn-post').classList.remove('on');
  document.getElementById('phaseHint').textContent = `ç›®å‰å‹¾é¸æœƒè¨˜åˆ°ï¼šå‰æœŸ`;

  initFilters();
  updateStats();
}

function initFilters(){
  maxNum = (currentGame === "539") ? 39 : 49;
  document.getElementById('gameTitle').textContent = `ç›®å‰æ¨¡å¼ï¼š${currentGame} - ${currentMode}`;

  const grid = document.getElementById('filterGrid');
  grid.innerHTML = '';

  const yStart = startYearByUser();
  const yEnd = 2026;
  const years = Array.from({length: yEnd - yStart + 1}, (_,i)=>yStart+i);

  const sections = [
    {lbl:"å¹´ä»½", d: years},
    {lbl:"æœˆä»½", d:Array.from({length: 12}, (_, i) => i + 1)},
    {lbl:"æ—¥æœŸ", d:Array.from({length: 31}, (_, i) => i + 1), brk:18},
    {lbl:"æ˜ŸæœŸ", d: ["ä¸€","äºŒ","ä¸‰","å››","äº”","å…­","æ—¥"]},
    {lbl:"å¤©å¹²", d: STEMS},
    {lbl:"åœ°æ”¯", d: BRANCHES},
    {lbl:"è™Ÿç¢¼", d: Array.from({length:maxNum}, (_,i)=>String(i+1).padStart(2,'0')), brk:25}
  ];

  sections.forEach(sec=>{
    const isSB = (sec.lbl==="å¤©å¹²" || sec.lbl==="åœ°æ”¯");
    const hidden = (currentUser==="bro" && isSB) ? "hidden" : "";
    grid.innerHTML += `<div class="lbl ${hidden}">${sec.lbl}</div>`;

    let html = `<div class="chips ${hidden}" data-label="${sec.lbl}">`;
    sec.d.forEach((v,i)=>{
      if(sec.brk && i===sec.brk) html += `<div class="breakline"></div>`;
      html += `<div class="chip" data-val="${v}" onclick="toggleChip(this)">${v}</div>`;
    });
    html += `</div>`;
    grid.innerHTML += html;
  });

  updateStatTableUI();
  syncModeButtons();

  // é è¨­å¥—ç”¨å‰æœŸ filters åˆ° UI
  applyFilterSetToUI(preFilters);
}

function updateStatTableUI(){
  const h1=document.getElementById('stat-head-1'), b1=document.getElementById('stat-body-1');
  const h2=document.getElementById('stat-head-2'), b2=document.getElementById('stat-body-2');
  h1.innerHTML=b1.innerHTML=h2.innerHTML=b2.innerHTML='';
  for(let i=1;i<=maxNum;i++){
    h1.innerHTML += `<th>${i}</th>`; b1.innerHTML += `<td id="val1-${i}">0</td>`;
    h2.innerHTML += `<th>${i}</th>`; b2.innerHTML += `<td id="val2-${i}">0</td>`;
  }
}

function toggleChip(el){
  el.classList.toggle('on');

  // æŠŠ UI ç•¶ä¸‹çš„æ¢ä»¶å¯«å…¥ã€Œç›®å‰ phaseã€çš„ filtersï¼ˆä½†ä¸åŒ…å«è™Ÿç¢¼ï¼Œè™Ÿç¢¼ç”¨ UI å³å¯ï¼‰
  const filters = readFiltersFromUI();
  if(phase==='pre') preFilters = filters;
  else postFilters = filters;

  updateStats();
}

/* ===== è®€é›²ç«¯ ===== */
function fetchSheetData(callback){
  document.getElementById('loadingOverlay').style.display='flex';
  Papa.parse(sheetUrls[currentGame] + "&t=" + Date.now(),{
    download:true, header:false, skipEmptyLines:true,
    complete:(results)=>{
      document.getElementById('loadingOverlay').style.display='none';
      cloudData = results.data.slice(1);
      if(callback) callback(results.data[results.data.length-1]);
      updateStats();
    }
  });
}

/* =========================
   å³æ™‚é‹ç®—çµ±è¨ˆï¼šæ‰€æœ‰æ¨¡å¼éƒ½è¨ˆç®— counts
   - æ­·å²ï¼šç¬¦åˆæ¢ä»¶ â†’ æœ¬æœŸå‡ºç¾æ¬¡æ•¸
   - æ‹–ç‰Œï¼šç¬¦åˆã€Œå‰æœŸæ¢ä»¶ã€ä¸”æœ¬æœŸåŒ…å«ä»»ä¸€é¸è™Ÿ â†’ çµ±è¨ˆä¸‹æœŸå‡ºç¾
   - ç•¶æœŸå°ç¢°ï¼šç¬¦åˆæ¢ä»¶ä¸”æœ¬æœŸåŒ…å«æ‰€æœ‰é¸è™Ÿ â†’ çµ±è¨ˆæœ¬æœŸå‡ºç¾
   - ä¸‹æœŸå°ç¢°ï¼šç¬¦åˆå‰æœŸæ¢ä»¶ä¸”æœ¬æœŸåŒ…å«ä»»ä¸€é¸è™Ÿ â†’ å…ˆæŠ“ä¸‹æœŸæ¨£æœ¬ â†’ çµ±è¨ˆä¸‹æœŸå‡ºç¾ï¼ˆå…ˆè·Ÿæ‹–ç‰ŒåŒè¡¨ç¾ï¼Œä¹‹å¾Œå†åŠ å…©å…©åŒå‡ºè³‡è¨Šï¼‰
   ========================= */
function computeCountsForMode(validRows){
  const counts = Array(maxNum+1).fill(0);
  const selNums = getSelectedNums();

  // ç”¨ç›®å‰ phase é¡¯ç¤ºç”¨çš„æ¢ä»¶ï¼Œä½†å¯¦éš›é‹ç®—è¦çœ‹æ¨¡å¼ï¼š
  const preF = preFilters || {};
  const postF = postFilters || {};
  const singleF = (Object.keys(preF).length ? preF : readFiltersFromUI()); // ä¿åº•

  for(let idx=0; idx<validRows.length; idx++){
    const row = validRows[idx];
    const meta = rowMetaFromRow(row);
    const rd = buildRd(meta);
    const nums = rowBalls(row);

    if(currentMode === "æ­·å²æ¨¡å¼"){
      if(!matchFilters(rd, singleF)) continue;
      nums.forEach(n=>{ if(n<=maxNum) counts[n]++; });
    }

    else if(currentMode === "æ‹–ç‰Œæ¨¡å¼"){
      if(selNums.length===0) continue;
      if(!matchFilters(rd, preF)) continue;
      if(!selNums.some(sn=>nums.includes(sn))) continue;

      const nxt = validRows[idx+1];
      if(!nxt) continue;
      const rd2 = buildRd(rowMetaFromRow(nxt));
      if(!matchFilters(rd2, postF)) continue;

      rowBalls(nxt).forEach(n=>{ if(n<=maxNum) counts[n]++; });
    }

    else if(currentMode === "ç•¶æœŸå°ç¢°"){
      if(selNums.length===0) continue;
      if(!matchFilters(rd, singleF)) continue;
      if(!selNums.every(sn=>nums.includes(sn))) continue;
      nums.forEach(n=>{ if(n<=maxNum) counts[n]++; });
    }

    else if(currentMode === "ä¸‹æœŸå°ç¢°"){
      // å…ˆè·Ÿæ‹–ç‰Œä¸€æ¨£ç¶­æŒã€Œä¸‹æœŸå‡ºç¾æ¬¡æ•¸ã€è®“å³æ™‚çµ±è¨ˆä¸ç‚ºç©º
      if(selNums.length===0) continue;
      if(!matchFilters(rd, preF)) continue;
      if(!selNums.some(sn=>nums.includes(sn))) continue;

      const nxt = validRows[idx+1];
      if(!nxt) continue;
      const rd2 = buildRd(rowMetaFromRow(nxt));
      if(!matchFilters(rd2, postF)) continue;

      rowBalls(nxt).forEach(n=>{ if(n<=maxNum) counts[n]++; });
    }
  }

  return counts;
}

function updateStats(){
  if(!cloudData.length) return;
  const validRows = getValidRows();

  // countsï¼šæ‰€æœ‰æ¨¡å¼éƒ½ç®—
  const counts = computeCountsForMode(validRows);

  // å³æ™‚çµ±è¨ˆ Top5(ç¶­æŒä½ åŸæœ¬çš„ top5 é¡è‰²è¦å‰‡)
  const sorted = [...counts].slice(1).sort((a,b)=>b-a);
  const th = sorted[4] > 0 ? sorted[4] : 999;

  // é¡¯ç¤ºæ–‡å­—ï¼šæ‹–ç‰Œ/ä¸‹æœŸç”¨ã€Œæ–°æè¿°ã€
  const sk = startKeyByUser();
  const skStr = `${Math.floor(sk/10000)}/${String(Math.floor((sk%10000)/100)).padStart(2,'0')}/${String(sk%100).padStart(2,'0')}`;

  let desc = `æ¨¡å¼:${currentMode} | èµ·ç®—æ—¥:${skStr} | åƒèˆ‡çµ±è¨ˆæœŸæ•¸:${validRows.length}`;
  if(currentMode==="æ‹–ç‰Œæ¨¡å¼" || currentMode==="ä¸‹æœŸå°ç¢°"){
    const selNums = getSelectedNums();
    desc += ` | å‰æœŸ:${fmtFilters(preFilters)} | å‰æœŸè™Ÿç¢¼:${selNums.join(',')||'(æœªé¸)'} | å¾ŒæœŸ:${fmtFilters(postFilters)}`;
  }else{
    desc += ` | æ¢ä»¶:${fmtFilters(phase==='pre'?preFilters:postFilters)}`;
  }
  document.getElementById('filterCounter').textContent = desc;

  for(let i=1;i<=maxNum;i++){
    const td = document.getElementById(`val1-${i}`);
    const v = counts[i]||0;
    td.textContent = v;
    td.className = (v>=th && v>0) ? "topcell" : "";
  }

  // æœªå‡ºæœŸæ•¸ + Top3 æ¨™ç´…
  const gaps = Array(maxNum+1).fill(0);
  for(let i=1;i<=maxNum;i++){
    let gap=0;
    for(let j=validRows.length-1; j>=0; j--){
      if(rowBalls(validRows[j]).includes(i)) break;
      gap++;
    }
    gaps[i]=gap;
  }
  const top3 = [...Array(maxNum).keys()].map(k=>k+1)
    .sort((a,b)=>gaps[b]-gaps[a])
    .slice(0,3);

  for(let i=1;i<=maxNum;i++){
    const td2 = document.getElementById(`val2-${i}`);
    td2.textContent = gaps[i];
    td2.className = top3.includes(i) ? "topcell" : "";
  }
}

/* =========================
   åŠ å…¥å ±è¡¨ï¼šæ‰€æœ‰æ¨¡å¼éƒ½ã€Œé€ç­†æ˜ç´°ã€æœ€å¾Œ Sum
   ========================= */
function addToReport(){
  if(!cloudData.length) return alert("å°šæœªè¼‰å…¥è³‡æ–™");
  const validRows = getValidRows();
  if(!validRows.length) return alert("ç„¡æœ‰æ•ˆè³‡æ–™åˆ—");

  const selNums = getSelectedNums();

  // æ­·å²ï¼šä¸€ç­†æ˜ç´° + Sum
  if(currentMode==="æ­·å²æ¨¡å¼"){
    const title = `ã€æ­·å²ã€‘æ¢ä»¶:${fmtFilters(preFilters)}ï¼ˆé€ç­†æ˜ç´°=1ç­†ï¼‰`;
    const g = newGroup(currentMode, title);

    const counts = Array(maxNum+1).fill(0);
    for(const row of validRows){
      const rd = buildRd(rowMetaFromRow(row));
      if(!matchFilters(rd, preFilters)) continue;
      rowBalls(row).forEach(n=>{ if(n<=maxNum) counts[n]++; });
    }
    addRowToGroup(g, `æ¢ä»¶:${fmtFilters(preFilters)}`, counts);

    reportStorage[currentUser][currentGame].push(g);
    renderCurrentReports();
    document.querySelector(`.tab[data-target="reportPage"][data-game="${currentGame}"]`).click();
    return;
  }

  // æ‹–ç‰Œï¼šå‰æœŸ filters + å‰æœŸè™Ÿç¢¼é€ç­†ï¼Œå¾ŒæœŸ filters
  if(currentMode==="æ‹–ç‰Œæ¨¡å¼"){
    if(selNums.length===0) return alert("æ‹–ç‰Œï¼šè«‹é¸å‰æœŸè™Ÿç¢¼ï¼ˆå¯å¤šé¸ï¼‰");
    const title = `ã€æ‹–ç‰Œã€‘å‰æœŸ:${fmtFilters(preFilters)} | å‰æœŸè™Ÿç¢¼:${selNums.join(',')} | å¾ŒæœŸ:${fmtFilters(postFilters)}`;
    const g = newGroup(currentMode, title);

    selNums.forEach(preNum=>{
      const counts = Array(maxNum+1).fill(0);
      for(let idx=0; idx<validRows.length-1; idx++){
        const row = validRows[idx];
        const nxt = validRows[idx+1];

        const rd1 = buildRd(rowMetaFromRow(row));
        const rd2 = buildRd(rowMetaFromRow(nxt));

        if(!matchFilters(rd1, preFilters)) continue;
        if(!matchFilters(rd2, postFilters)) continue;

        const nums1 = rowBalls(row);
        if(!nums1.includes(preNum)) continue;

        rowBalls(nxt).forEach(n=>{ if(n<=maxNum) counts[n]++; });
      }
      addRowToGroup(g, `å‰æœŸ:${fmtFilters(preFilters)} | è™Ÿç¢¼${preNum} â†’ å¾ŒæœŸ:${fmtFilters(postFilters)}`, counts);
    });

    reportStorage[currentUser][currentGame].push(g);
    renderCurrentReports();
    document.querySelector(`.tab[data-target="reportPage"][data-game="${currentGame}"]`).click();
    return;
  }

  // ç•¶æœŸå°ç¢°ï¼šæ¯å€‹ä¸»è™Ÿç¢¼ä¸€ç­†ï¼ˆå…±ç¾ï¼‰
  if(currentMode==="ç•¶æœŸå°ç¢°"){
    if(selNums.length<2) return alert("ç•¶æœŸå°ç¢°ï¼šè«‹è‡³å°‘é¸ 2 å€‹è™Ÿç¢¼");
    const title = `ã€ç•¶æœŸå°ç¢°ã€‘æ¢ä»¶:${fmtFilters(preFilters)} | é¸è™Ÿ:${selNums.join(',')}ï¼ˆæ¯è¡Œ=ä¸»è™Ÿç¢¼å…±ç¾ï¼‰`;
    const g = newGroup(currentMode, title);

    selNums.forEach(mainNum=>{
      const counts = Array(maxNum+1).fill(0);
      for(const row of validRows){
        const rd = buildRd(rowMetaFromRow(row));
        if(!matchFilters(rd, preFilters)) continue;

        const nums = rowBalls(row);
        if(!nums.includes(mainNum)) continue;

        nums.forEach(n=>{
          if(n<=maxNum && n!==mainNum) counts[n]++;
        });
      }
      addRowToGroup(g, `ä¸»è™Ÿç¢¼ ${mainNum}ï¼ˆæ¢ä»¶:${fmtFilters(preFilters)}ï¼‰`, counts);
    });

    reportStorage[currentUser][currentGame].push(g);
    renderCurrentReports();
    document.querySelector(`.tab[data-target="reportPage"][data-game="${currentGame}"]`).click();
    return;
  }

  // ä¸‹æœŸå°ç¢°ï¼šå…ˆé€ç­†ï¼ˆæ¯å€‹å‰æœŸè™Ÿç¢¼ä¸€ç­†ï¼‰â€” å…©å…©åŒå‡ºè³‡è¨Šä¸‹ä¸€æ­¥åŠ 
  if(currentMode==="ä¸‹æœŸå°ç¢°"){
    if(selNums.length===0) return alert("ä¸‹æœŸå°ç¢°ï¼šè«‹é¸å‰æœŸè™Ÿç¢¼ï¼ˆå¯å¤šé¸ï¼‰");
    const title = `ã€ä¸‹æœŸå°ç¢°ã€‘å‰æœŸ:${fmtFilters(preFilters)} | å‰æœŸè™Ÿç¢¼:${selNums.join(',')} | å¾ŒæœŸ:${fmtFilters(postFilters)}ï¼ˆé€ç­†æ˜ç´°ï¼‰`;
    const g = newGroup(currentMode, title);

    selNums.forEach(preNum=>{
      const counts = Array(maxNum+1).fill(0);
      for(let idx=0; idx<validRows.length-1; idx++){
        const row = validRows[idx];
        const nxt = validRows[idx+1];

        const rd1 = buildRd(rowMetaFromRow(row));
        const rd2 = buildRd(rowMetaFromRow(nxt));

        if(!matchFilters(rd1, preFilters)) continue;
        if(!matchFilters(rd2, postFilters)) continue;

        const nums1 = rowBalls(row);
        if(!nums1.includes(preNum)) continue;

        rowBalls(nxt).forEach(n=>{ if(n<=maxNum) counts[n]++; });
      }
      addRowToGroup(g, `å‰æœŸ:${fmtFilters(preFilters)} | è™Ÿç¢¼${preNum} â†’ å¾ŒæœŸ:${fmtFilters(postFilters)}`, counts);
    });

    reportStorage[currentUser][currentGame].push(g);
    renderCurrentReports();
    document.querySelector(`.tab[data-target="reportPage"][data-game="${currentGame}"]`).click();
    return;
  }
}

/* ===== å ±è¡¨æ¸²æŸ“ï¼šé€ç­† rows + Sumï¼Œä¸”å¯å–®å¼µåˆªé™¤ ===== */
function renderCurrentReports(){
  const cont = document.getElementById('reportContainer');
  cont.innerHTML = '';
  const groups = reportStorage[currentUser][currentGame];
  if(!groups.length) return;

  let html = '';
  groups.forEach((g, gi)=>{
    html += `
      <div class="report-item">
        <div class="report-header">
          <div class="title">ã€ç¬¬ ${gi+1} å¼µã€‘${g.title}</div>
          <button class="btn btn-red" onclick="deleteReport('${g.id}')">åˆªé™¤æ­¤å ±è¡¨</button>
        </div>
        <table class="report-table">
          <thead>
            <tr>
              <td class="cond-col">é€ç­†æ˜ç´°ï¼ˆæ¯æ¢ä»¶ä¸€ç­†ï¼‰</td>
              ${Array.from({length:maxNum},(_,i)=>`<td>${i+1}</td>`).join('')}
            </tr>
          </thead>
          <tbody>
    `;

    g.rows.forEach(r=>{
      // é€™åˆ— top5
      const sorted = [...r.data].slice(1).sort((a,b)=>b-a);
      const th = sorted[4] > 0 ? sorted[4] : 999;

      html += `<tr><td class="cond-col">${r.label}</td>` +
        r.data.slice(1).map(v=>{
          const vv=v||0;
          const cls=(vv>=th && vv>0) ? "topcell" : "";
          return `<td class="${cls}">${vv?vv:""}</td>`;
        }).join('') + `</tr>`;
    });

    // Sum row
    const sumSorted = [...g.sum].slice(1).sort((a,b)=>b-a);
    const sumTh = sumSorted[4] > 0 ? sumSorted[4] : 999;

    html += `
          </tbody>
          <tfoot>
            <tr class="sum-row">
              <td class="cond-col">åŠ ç¸½ (Sum)</td>
              ${g.sum.slice(1).map(v=>{
                const vv=v||0;
                const cls=(vv>=sumTh && vv>0) ? "topcell" : "";
                return `<td class="${cls}">${vv?vv:""}</td>`;
              }).join('')}
            </tr>
          </tfoot>
        </table>
      </div>
    `;
  });

  cont.innerHTML = html;
}

/* ===== æ¨¡å¼/æŒ‰éˆ•åŒæ­¥ ===== */
function changeMode(mode, btn){
  currentMode = (mode.includes('æ¨¡å¼')) ? mode : mode + 'æ¨¡å¼';
  syncModeButtons();
  updateStats();           // âœ… ä¸ç®¡å“ªå€‹é é¢ï¼Œåˆ‡æ›æ¨¡å¼ä¹Ÿè¦è®“å³æ™‚çµ±è¨ˆæ›´æ–°
  if(document.getElementById('reportPage').classList.contains('active')) renderCurrentReports();
}

function syncModeButtons(){
  document.querySelectorAll('.mode-btn').forEach(b=>{
    b.classList.toggle('btn-orange', b.textContent === currentMode);
  });
  document.querySelectorAll('.rpt-mode-btn').forEach(b=>{
    const simple = currentMode.replace('æ¨¡å¼','');
    b.classList.toggle('btn-orange', b.textContent === simple);
  });
}

/* ===== ä»Šæ—¥æ¢ä»¶ï¼šè‡ªå‹•å¯«åˆ°ã€Œå‰æœŸã€ä¸¦åŒæ­¥ UI ===== */
function selectToday(){
  clearFiltersAllSets();
  fetchSheetData((lastRow)=>{
    const {y,m,d} = parseYMD(lastRow[1]);
    const w = calcWeekday(y,m,d);
    const gz = ganzhiOfDay(y,m,d);

    preFilters = {};
    if(y) preFilters["å¹´ä»½"] = [y];
    if(m) preFilters["æœˆä»½"] = [m];
    if(d) preFilters["æ—¥æœŸ"] = [d];
    if(w) preFilters["æ˜ŸæœŸ"] = [w];
    if(currentUser==="dad"){
      if(gz.stem) preFilters["å¤©å¹²"] = [gz.stem];
      if(gz.branch) preFilters["åœ°æ”¯"] = [gz.branch];
    }
    phase="pre";
    document.getElementById('btn-pre').classList.add('on');
    document.getElementById('btn-post').classList.remove('on');
    document.getElementById('phaseHint').textContent = "ç›®å‰å‹¾é¸æœƒè¨˜åˆ°ï¼šå‰æœŸ";
    applyFilterSetToUI(preFilters);
    updateStats();
  });
}

function clearFiltersAllSets(){
  preFilters = {};
  postFilters = {};
  document.querySelectorAll('.chip.on').forEach(c=>c.classList.remove('on'));
}

/* ===== æ¸…ç©ºç¯©é¸ï¼šæ¸…ç›®å‰ phase çš„ filters ===== */
function clearFilters(){
  // æ¸… UI
  document.querySelectorAll('.chip.on').forEach(c=>c.classList.remove('on'));
  // æ¸…å°æ‡‰ set
  if(phase==="pre") preFilters = {};
  else postFilters = {};
  updateStats();
}

/* ===== åŒ¯å‡º / æ¸…ç©ºå ±è¡¨ ===== */
function exportToExcel(){
  const table = document.querySelector(".report-table");
  if(!table) return alert("ç„¡è³‡æ–™");
  const url = 'data:application/vnd.ms-excel,' + encodeURIComponent(table.outerHTML);
  const link = document.createElement("a"); link.download = `åˆ†æ_${Date.now()}.xls`; link.href = url; link.click();
}
function clearAllReports(){
  if(confirm("ç¢ºå®šæ¸…ç©ºï¼Ÿ")){
    reportStorage[currentUser][currentGame] = [];
    renderCurrentReports();
  }
}

/* ===== Tabs ===== */
document.querySelectorAll('.tab').forEach(tab=>{
  tab.addEventListener('click', ()=>{
    currentGame = tab.dataset.game;
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    tab.classList.add('active');

    document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
    document.getElementById(tab.dataset.target).classList.add('active');

    initFilters();
    updateStats();
    if(tab.dataset.target === "reportPage"){
      renderCurrentReports();
      syncModeButtons();
    }
  });
});

/* ===== çµ±è¨ˆè¡¨é ­ ===== */
function updateStatTableUI(){ /* å·²åœ¨ä¸Šé¢ */ }

/* ===== è®€æª” ===== */
function fetchSheetData(callback){ /* å·²åœ¨ä¸Šé¢ */ }

/* ===== å•Ÿå‹• ===== */
initFilters();
fetchSheetData();
</script>
</body>
</html>
