<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>539 å°ˆæ¥­å›æ¸¬ç³»çµ± - å®Œæ•´è¡¨æ ¼ç‰ˆ</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <style>
        :root { --bg: #d1e7d1; --blue-t: #2196F3; --red-box: #f44336; --gold: #ffc107; }
        body { background-color: var(--bg); font-family: "Microsoft JhengHei", sans-serif; font-size: 13px; margin: 15px; }
        .main-layout { display: flex; flex-direction: column; gap: 10px; }
        .guide-box { background: #fffde7; border: 1px solid #ddd; border-left: 5px solid var(--gold); padding: 8px 15px; margin-bottom: 5px; line-height: 1.6; border-radius: 4px; min-height: 24px; display: flex; align-items: center; }
        .filter-panel { border: 2px solid var(--red-box); background: #fff; padding: 15px; display: grid; grid-template-columns: 60px 1fr; gap: 8px; border-radius: 8px; }
        .f-label { background: #eee; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 1px solid #ccc; }
        .f-btns { display: flex; flex-wrap: wrap; gap: 4px; }
        .f-item { padding: 4px 12px; border: 1px solid #ccc; cursor: pointer; background: #fff; border-radius: 4px; position: relative; }
        .f-item.active { background: var(--blue-t); color: white; }
        .f-item.active::after { content: attr(data-order); position: absolute; top: -8px; right: -5px; background: #333; color: #fff; border-radius: 50%; width: 16px; height: 16px; font-size: 10px; display: flex; align-items: center; justify-content: center; border: 1px solid white; }
        .action-bar { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; background: rgba(255,255,255,0.5); padding: 10px; border-radius: 8px; }
        .yellow-btn { background: #ffff00; border: 1px solid #000; padding: 8px 15px; font-weight: bold; cursor: pointer; border-radius: 4px; }
        .yellow-btn.active { background: #ff9800 !important; color: white; }
        .add-btn { background: #4CAF50; color: white; border: 1px solid #000; padding: 8px 20px; font-weight: bold; cursor: pointer; border-radius: 4px; }
        #report-alert { border: 2px solid var(--blue-t); background: #e3f2fd; color: #1565c0; padding: 8px 15px; font-weight: bold; border-radius: 4px; display: none; }
        .view-container { background: white; border: 2px solid var(--blue-t); padding: 10px; border-radius: 8px; min-height: 500px; }
        .scroll-area { overflow: auto; max-height: 500px; }
        table { border-collapse: collapse; width: 100%; white-space: nowrap; }
        th, td { border: 1px solid #ccc; padding: 4px; text-align: center; }
        .report-card { border: 2px solid #333; background: #fff; margin-bottom: 25px; border-radius: 4px; }
        .report-title { background: #7da7d8; padding: 10px; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        tfoot tr td { background: #ffff00 !important; color: #f44336 !important; font-weight: bold !important; }
        .top-hit { background-color: #ffff00 !important; font-weight: bold; }
        .hidden { display: none; }
        .cat-tag { background: #333; color: #fff; padding: 1px 4px; border-radius: 3px; font-size: 11px; margin-right: 3px; }
    </style>
</head>
<body>

<div class="main-layout">
    <div style="display:flex; gap:5px;">
        <button onclick="switchPage('dist')" style="flex:1; padding:12px; font-weight:bold; cursor:pointer;">æ•¸æ“šåˆ†ä½ˆåœ–</button>
        <button onclick="switchPage('repo')" style="flex:1; padding:12px; font-weight:bold; cursor:pointer;">åŒ¯ç¸½å ±è¡¨</button>
    </div>

    <div id="page-dist" class="view-container">
        <div id="modeGuide" class="guide-box">ğŸ’¡ æ­£åœ¨é€£ç·šè‡³é›²ç«¯æ•¸æ“š...</div>

        <div class="filter-panel">
            <div class="f-label">é€±</div><div class="f-btns" data-type="week"></div>
            <div class="f-label">å¤©å¹²</div><div class="f-btns" data-type="tian"></div>
            <div class="f-label">åœ°æ”¯</div><div class="f-btns" data-type="di"></div>
            <div class="f-label">ç¯€æ°£</div><div class="f-btns" data-type="solar"></div>
            <div class="f-label" style="color:blue">è™Ÿç¢¼</div><div class="f-btns" data-type="nums"></div>
        </div>

        <div class="action-bar">
            <button class="yellow-btn btn-mode-h" onclick="setMode('history')">æ­·å²çµ±è¨ˆ</button>
            <button class="yellow-btn btn-mode-t" onclick="setMode('tuopai')">æ‹–ç‰Œæ¨¡å¼</button>
            <button class="yellow-btn btn-mode-d_curr" onclick="setMode('duipeng_curr')">ç•¶æœŸå°ç¢°</button>
            <button class="yellow-btn btn-mode-d" onclick="setMode('duipeng')">ä¸‹æœŸå°ç¢°</button>
            <button class="add-btn" onclick="generateBatchReport()">åŠ å…¥å ±è¡¨</button>
            <button onclick="clearFilters()">æ¸…ç©ºç¯©é¸</button>
            <div id="report-alert">ğŸ“¢ å ±è¡¨æœªæ¸…ç©º</div>
            <span id="fileMsg" style="margin-left:auto; font-weight:bold; color:red;">é€£ç·šä¸­...</span>
        </div>

        <div class="scroll-area">
            <table>
                <thead><tr id="thr"><th>æœŸè™Ÿ</th><th>æ—¥æœŸ</th><th>é€±</th><th>å¤©å¹²</th><th>åœ°æ”¯</th><th>ç¯€æ°£</th><th>çƒ1</th><th>çƒ2</th><th>çƒ3</th><th>çƒ4</th><th>çƒ5</th></tr></thead>
                <tbody id="gridBody"></tbody>
            </table>
        </div>
    </div>

    <div id="page-repo" class="view-container hidden">
        <div style="margin-bottom:10px;"><button onclick="clearAllReports()" style="background:#d32f2f; color:white; padding:8px 15px; cursor:pointer; font-weight:bold;">âš ï¸ æ¸…ç©ºæ‰€æœ‰å ±è¡¨ (è—æ¡†å°‡æ¶ˆå¤±)</button></div>
        <div id="repo-list"></div>
    </div>
</div>

<script>
    const GSHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTuGa3v-rwH8Qh-JXF9MfxwUwT0A-iJooRI6ypJTErCsxN9qCjZQrgr70f16ZoehQ/pub?output=csv";
    let db = [];
    let currentMode = 'history';
    let filters = { week:[], tian:[], di:[], solar:[], nums:[] };
    let savedReports = JSON.parse(localStorage.getItem('539_reports') || "[]");

    const guideText = {
        history: "ğŸ’¡ <b>æ¨¡å¼æç¤ºï¼šæ­·å²çµ±è¨ˆ</b> ï¼ ç›´æ¥é»é¸ä¸Šæ–¹æ¢ä»¶ã€‚å ±è¡¨é¡¯ç¤ºå€‹åˆ¥æ¢ä»¶çš„æ­·å²åˆ†ä½ˆã€‚",
        tuopai: "ğŸ’¡ <b>æ¨¡å¼æç¤ºï¼šæ‹–ç‰Œ</b> ï¼ é …ç›®é¸ 2 å€‹ + è™Ÿç¢¼ã€‚é‚è¼¯ï¼šä¸ŠæœŸç¬¦åˆç¬¬ä¸€é …ä¸”æœ‰è©²è™Ÿï¼Œä¸‹æœŸç¬¦åˆç¬¬äºŒé …çš„åˆ†ä½ˆã€‚",
        duipeng_curr: "ğŸ’¡ <b>æ¨¡å¼æç¤ºï¼šç•¶æœŸå°ç¢°</b> ï¼ çµ±è¨ˆç¬¦åˆæ¢ä»¶æœŸæ•¸å…§ï¼Œè™Ÿç¢¼åŒæ™‚å‡ºç¾çš„ç†±åº¦æ’è¡Œã€‚",
        duipeng: "ğŸ’¡ <b>æ¨¡å¼æç¤ºï¼šä¸‹æœŸå°ç¢°</b> ï¼ é …ç›®é¸ 2 å€‹ + è™Ÿç¢¼ã€‚çµ±è¨ˆä¸ŠæœŸç¬¦åˆæ¢ä»¶å¾Œï¼Œä¸‹æœŸè™Ÿç¢¼åŒæ™‚é–‹å‡ºçš„ç†±åº¦ã€‚"
    };

    function setMode(m) {
        currentMode = m;
        document.querySelectorAll('.yellow-btn').forEach(b => b.classList.remove('active'));
        const btnMap = { history:'.btn-mode-h', tuopai:'.btn-mode-t', duipeng_curr:'.btn-mode-d_curr', duipeng:'.btn-mode-d' };
        if(document.querySelector(btnMap[m])) document.querySelector(btnMap[m]).classList.add('active');
        document.getElementById('modeGuide').innerHTML = guideText[m];
        clearFilters();
    }

    async function loadCloudData() {
        try {
            const response = await fetch(GSHEET_CSV_URL);
            const csvText = await response.text();
            db = XLSX.utils.sheet_to_json(XLSX.read(csvText, { type: 'string' }).Sheets[XLSX.read(csvText, { type: 'string' }).SheetNames[0]], { header: 1 })
                 .filter(row => row[0] && !isNaN(row[0]));
            renderGrid();
            document.getElementById('fileMsg').innerText = `é›²ç«¯é€£ç·šæˆåŠŸï¼š${db.length} æœŸ`;
            setMode('history');
            updateReportUI();
        } catch (e) { document.getElementById('fileMsg').innerText = "é›²ç«¯è¼‰å…¥å¤±æ•—"; }
    }

    function initUI() {
        const build = (type, list) => {
            const container = document.querySelector(`[data-type="${type}"]`);
            list.forEach(v => {
                const div = document.createElement('div');
                div.className = 'f-item'; div.innerText = v;
                div.onclick = () => handleItem(div, type, v);
                container.appendChild(div);
            });
        };
        build('week', ['ä¸€','äºŒ','ä¸‰','å››','äº”','å…­','æ—¥']);
        build('tian', ['ç”²','ä¹™','ä¸™','ä¸','æˆŠ','å·±','åºš','è¾›','å£¬','ç™¸']);
        build('di', ['å­','ä¸‘','å¯…','å¯','è¾°','å·³','åˆ','æœª','ç”³','é…‰','æˆŒ','äº¥']);
        let slist = []; for(let i=0; i<=15; i++) { slist.push('T'+i); slist.push('S'+i); }
        build('solar', slist);
        build('nums', Array.from({length:39}, (_,i)=>i+1));
        for(let i=1; i<=39; i++) {
            const th = document.createElement('th'); th.style.background = '#ffc107';
            th.innerHTML = `${i}<br><span id="s-${i}" style="font-size:10px; color:blue">0</span>`;
            document.getElementById('thr').appendChild(th);
        }
        loadCloudData();
    }

    function handleItem(el, type, val) {
        const arr = filters[type]; const idx = arr.indexOf(val);
        if(idx > -1) { arr.splice(idx, 1); el.classList.remove('active'); el.removeAttribute('data-order'); }
        else {
            if((currentMode === 'tuopai' || currentMode === 'duipeng') && type !== 'nums' && arr.length >= 2) return;
            arr.push(val); el.classList.add('active');
            if((currentMode === 'tuopai' || currentMode === 'duipeng') && type !== 'nums') el.setAttribute('data-order', arr.length);
        }
        applyFilter();
    }

    function generateBatchReport() {
        if(!db.length) return;
        const results = [];
        const catNames = { week: 'é€±', tian: 'å¤©å¹²', di: 'åœ°æ”¯', solar: 'ç¯€æ°£', nums: 'è™Ÿç¢¼' };
        
        if (currentMode === 'duipeng_curr' || currentMode === 'duipeng') {
            let matrix = Array.from({length:40}, () => Array(40).fill(0));
            let matchCount = 0;
            let currentLabel = (currentMode === 'duipeng' ? "ä¸‹æœŸå°ç¢°" : "ç•¶æœŸå°ç¢°");

            if (currentMode === 'duipeng') {
                if (filters.nums.length < 1) return alert("ä¸‹æœŸå°ç¢°ï¼šè«‹è‡³å°‘é¸æ“‡ 1 å€‹è™Ÿç¢¼");
                ['week','tian','di','solar'].forEach(cat => {
                    if(filters[cat].length === 2) {
                        const [v1, v2] = filters[cat], col = ['week','tian','di','solar'].indexOf(cat)+2;
                        for(let i=1; i<db.length; i++) {
                            const prevWin = db[i-1].slice(6,11).map(Number);
                            if(String(db[i-1][col]).includes(v1) && String(db[i][col]).includes(v2) && filters.nums.every(n => prevWin.includes(Number(n)))) {
                                matchCount++;
                                const nextWin = db[i].slice(6,11).map(Number);
                                for(let x=0; x<nextWin.length; x++) for(let y=x+1; y<nextWin.length; y++) {
                                    if(nextWin[x]>0 && nextWin[y]>0) { matrix[nextWin[x]][nextWin[y]]++; matrix[nextWin[y]][nextWin[x]]++; }
                                }
                            }
                        }
                        currentLabel += ` (${catNames[cat]}:${v1}â†’${v2})`;
                    }
                });
            } else {
                db.forEach(row => {
                    let ok = true;
                    ['week','tian','di','solar'].forEach(cat => { if(filters[cat].length > 0) ok &= filters[cat].some(v => String(row[['week','tian','di','solar'].indexOf(cat)+2]).includes(v)); });
                    if(ok) {
                        matchCount++; const nums = row.slice(6, 11).map(Number);
                        for(let i=0; i<nums.length; i++) for(let j=i+1; j<nums.length; j++){ if(nums[i]>0 && nums[j]>0){ matrix[nums[i]][nums[j]]++; matrix[nums[j]][nums[i]]++; } }
                    }
                });
            }

            if(matchCount === 0) return alert("æŸ¥ç„¡ç¬¦åˆæœŸæ•¸");
            let tableRows = [];
            for(let i=1; i<=39; i++) {
                let stats = Array(40).fill(0);
                for(let j=1; j<=39; j++) stats[j] = matrix[i][j];
                tableRows.push({ label: `è™Ÿç¢¼ ${i}`, matches: matchCount, data: stats });
            }
            saveAndRender(`${currentLabel} çŸ©é™£åˆ†æ (å…±${matchCount}æœŸ)`, tableRows, 'table');
        } 
        else if (currentMode === 'tuopai') {
            filters.nums.forEach(num => {
                ['week','tian','di','solar'].forEach(cat => {
                    if(filters[cat].length === 2) {
                        const [v1, v2] = filters[cat], col = ['week','tian','di','solar'].indexOf(cat)+2;
                        let stats = Array(40).fill(0), count = 0;
                        for(let i=1; i<db.length; i++) if(String(db[i-1][col]).includes(v1) && String(db[i][col]).includes(v2) && db[i-1].slice(6,11).map(Number).includes(Number(num))){
                            db[i].slice(6,11).map(Number).forEach(n => { if(n>0) stats[n]++; }); count++;
                        }
                        if(count > 0) results.push({ label: `[è™Ÿ:${num}] <span class="cat-tag">${catNames[cat]}</span>${v1}â†’${v2}`, matches: count, data: stats });
                    }
                });
            });
            if(results.length) saveAndRender("æ‹–ç‰Œåˆ†æå ±è¡¨", results, 'table');
            else alert("æ‹–ç‰Œæ¨¡å¼ï¼šè«‹é¸ 2 å€‹é …ç›® + 1 å€‹è™Ÿç¢¼");
        }
        else if (currentMode === 'history') {
            ['week','tian','di','solar'].forEach(cat => {
                filters[cat].forEach(val => {
                    let stats = Array(40).fill(0), count = 0, col = ['week','tian','di','solar'].indexOf(cat)+2;
                    db.forEach(row => { if(String(row[col]).includes(val)) { row.slice(6,11).map(Number).forEach(n => { if(n>0) stats[n]++; }); count++; } });
                    if(count > 0) results.push({ label: `<span class="cat-tag">${catNames[cat]}</span>${val}`, matches: count, data: stats });
                });
            });
            if(results.length) saveAndRender("æ­·å²çµ±è¨ˆå ±è¡¨", results, 'table');
        }
        switchPage('repo');
    }

    function saveAndRender(title, rows, type) {
        savedReports.unshift({ title, rows, type, id: Date.now() });
        localStorage.setItem('539_reports', JSON.stringify(savedReports));
        updateReportUI();
    }

    function updateReportUI() {
        const list = document.getElementById('repo-list');
        list.innerHTML = '';
        document.getElementById('report-alert').style.display = savedReports.length > 0 ? 'block' : 'none';
        savedReports.forEach(report => {
            const card = document.createElement('div');
            card.className = 'report-card';
            let totalStats = Array(40).fill(0);
            let html = `<div class="report-title"><span>ã€${report.title}ã€‘</span><button onclick="deleteReport(${report.id})">åˆªé™¤</button></div>`;
            html += `<div class="scroll-area"><table><thead><tr style="background:#eee"><td>åˆ†æå°è±¡</td>`;
            for(let i=1; i<=39; i++) html += `<td>${i}</td>`;
            html += `</tr></thead><tbody>`;
            report.rows.forEach(r => {
                const top3 = getTop3Indices(r.data);
                html += `<tr><td style="text-align:left; padding-left:8px; background:#f9f9f9; font-weight:bold;">${r.label}</td>`;
                for(let i=1; i<=39; i++) {
                    const val = r.data[i] || 0;
                    totalStats[i] += val;
                    html += `<td class="${top3.includes(i)?'top-hit':''}">${val || ''}</td>`;
                }
                html += `</tr>`;
            });
            html += `</tbody><tfoot><tr><td>æœ€å¾Œä¸€åˆ—åŠ ç¸½</td>`;
            for(let i=1; i<=39; i++) html += `<td>${totalStats[i] || ''}</td>`;
            html += `</tr></tfoot></table></div>`;
            card.innerHTML = html; list.appendChild(card);
        });
    }

    function deleteReport(id) { savedReports = savedReports.filter(r => r.id !== id); localStorage.setItem('539_reports', JSON.stringify(savedReports)); updateReportUI(); }
    function clearAllReports() { if(confirm("ç¢ºå®šæ¸…ç©ºï¼Ÿ")) { savedReports=[]; localStorage.removeItem('539_reports'); updateReportUI(); } }
    function switchPage(p) { document.getElementById('page-dist').className = (p==='dist'?'view-container':'hidden'); document.getElementById('page-repo').className = (p==='repo'?'view-container':'hidden'); }
    function clearFilters() { filters = { week:[], tian:[], di:[], solar:[], nums:[] }; document.querySelectorAll('.f-item').forEach(el => el.classList.remove('active')); applyFilter(); }
    function applyFilter() { 
        if(!db.length) return; 
        const rows = document.querySelectorAll('#gridBody tr'); let counts = Array(40).fill(0); 
        rows.forEach(tr => { 
            const data = db[tr.id.split('-')[1]]; let ok = true; 
            ['week','tian','di','solar'].forEach(cat => { if(filters[cat].length > 0) ok &= filters[cat].some(v => String(data[['week','tian','di','solar'].indexOf(cat)+2]).includes(v)); }); 
            const win = data.slice(6, 11).map(Number); if(filters.nums.length > 0) ok &= filters.nums.some(n => win.includes(Number(n))); 
            tr.style.display = ok ? '' : 'none'; 
            if(ok) { const tds = tr.querySelectorAll('.num-cell'); tds.forEach(td => { const n = parseInt(td.getAttribute('data-n')); if(win.includes(n)) { td.innerText = n < 10 ? '0'+n : n; counts[n]++; } else td.innerText = ''; }); } 
        }); 
        for(let i=1; i<=39; i++) document.getElementById(`s-${i}`).innerText = counts[i]; 
    }
    function renderGrid() { 
        const body = document.getElementById('gridBody'); body.innerHTML = ''; 
        db.forEach((row, idx) => { 
            const tr = document.createElement('tr'); tr.id = `row-${idx}`; 
            for(let i=0; i<11; i++){ const td = document.createElement('td'); td.innerText = row[i] || ''; tr.appendChild(td); } 
            for(let n=1; n<=39; n++){ const td = document.createElement('td'); td.className = 'num-cell'; td.setAttribute('data-n', n); tr.appendChild(td); } 
            body.appendChild(tr); 
        }); 
    }
    function getTop3Indices(data) { const sorted = data.slice(1).map((v, i) => ({v, i: i+1})).sort((a, b) => b.v - a.v); const vals = [...new Set(sorted.map(x => x.v))].filter(v => v > 0).slice(0, 3); return sorted.filter(x => x.v > 0 && vals.includes(x.v)).map(x => x.i); }
    initUI();
</script>
</body>
</html>
