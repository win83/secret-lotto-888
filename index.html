<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>539 å°ˆæ¥­å›æ¸¬ç³»çµ± - ç²¾æº–ç‰ˆ</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <style>
        :root { --bg: #d1e7d1; --blue-t: #2196F3; --red-box: #f44336; --gold: #ffc107; }
        body { background-color: var(--bg); font-family: "Microsoft JhengHei", sans-serif; font-size: 13px; margin: 15px; }
        .main-layout { display: flex; flex-direction: column; gap: 10px; }
        .filter-panel { border: 2px solid var(--red-box); background: #fff; padding: 15px; display: grid; grid-template-columns: 80px 1fr; gap: 8px; border-radius: 8px; }
        .f-label { background: #eee; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 1px solid #ccc; }
        .f-btns { display: flex; flex-wrap: wrap; gap: 4px; }
        .f-item { padding: 4px 10px; border: 1px solid #ccc; cursor: pointer; background: #fff; border-radius: 4px; position: relative; min-width: 25px; text-align: center; }
        .f-item.active { background: var(--blue-t); color: white; }
        /* æ‹–ç‰Œé †åºæ¨™è¨˜ */
        .f-item.active::after { content: attr(data-order); position: absolute; top: -8px; right: -5px; background: #333; color: #fff; border-radius: 50%; width: 16px; height: 16px; font-size: 10px; display: flex; align-items: center; justify-content: center; border: 1px solid white; }
        .action-bar { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; background: rgba(255,255,255,0.7); padding: 10px; border-radius: 8px; }
        .yellow-btn { background: #ffff00; border: 1px solid #000; padding: 8px 15px; font-weight: bold; cursor: pointer; border-radius: 4px; }
        .yellow-btn.active { background: #ff9800 !important; color: white; }
        .view-container { background: white; border: 2px solid var(--blue-t); padding: 10px; border-radius: 8px; }
        .scroll-area { overflow: auto; max-height: 500px; }
        table { border-collapse: collapse; width: 100%; white-space: nowrap; }
        th, td { border: 1px solid #ccc; padding: 5px; text-align: center; }
        .th-count { background: #ffc107; font-weight: bold; }
        .num-hit { font-weight: bold; color: #333; }
        .hidden { display: none; }
    </style>
</head>
<body>

<div class="main-layout">
    <div style="display:flex; gap:5px;">
        <button onclick="switchPage('dist')" style="flex:1; padding:12px; font-weight:bold; cursor:pointer;">ğŸ“Š æ•¸æ“šåˆ†ä½ˆåœ–</button>
        <button onclick="switchPage('repo')" style="flex:1; padding:12px; font-weight:bold; cursor:pointer;">ğŸ“‘ åŒ¯ç¸½å ±è¡¨</button>
    </div>

    <div id="page-dist" class="view-container">
        <div class="filter-panel">
            <div class="f-label">å¹´ä»½</div><div class="f-btns" id="year-btns"></div>
            <div class="f-label">é€±</div><div class="f-btns" data-type="week"></div>
            <div class="f-label">å¤©å¹²</div><div class="f-btns" data-type="tian"></div>
            <div class="f-label">åœ°æ”¯</div><div class="f-btns" data-type="di"></div>
            <div class="f-label">ç¯€æ°£</div>
            <div class="f-btns" style="flex-direction: column;">
                <div class="f-btns" id="solar-t"></div>
                <div class="f-btns" id="solar-s" style="margin-top:4px;"></div>
            </div>
            <div class="f-label" style="color:blue">è™Ÿç¢¼</div><div class="f-btns" data-type="nums"></div>
        </div>

        <div class="action-bar">
            <button class="yellow-btn btn-mode-h" onclick="setMode('history')">æ­·å²çµ±è¨ˆ</button>
            <button class="yellow-btn btn-mode-t" onclick="setMode('tuopai')">æ‹–ç‰Œæ¨¡å¼</button>
            <button class="yellow-btn btn-mode-d_curr" onclick="setMode('duipeng_curr')">ç•¶æœŸå°ç¢°</button>
            <button class="yellow-btn btn-mode-d" onclick="setMode('duipeng')">ä¸‹æœŸå°ç¢°</button>
            <button onclick="generateBatchReport()" style="background:#4CAF50; color:white; padding:8px 20px; font-weight:bold; cursor:pointer; border-radius:4px;">åŠ å…¥å ±è¡¨</button>
            <button onclick="clearFilters()">æ¸…ç©ºç¯©é¸</button>
            <span id="fileMsg" style="margin-left:auto; font-weight:bold; color:red;">é€£ç·šä¸­...</span>
        </div>

        <div class="scroll-area">
            <table>
                <thead>
                    <tr id="thr-header">
                        <th>æœŸè™Ÿ</th><th>æ—¥æœŸ</th><th>é€±</th><th>å¤©å¹²</th><th>åœ°æ”¯</th><th>ç¯€æ°£</th>
                        <th>çƒ1</th><th>çƒ2</th><th>çƒ3</th><th>çƒ4</th><th>çƒ5</th>
                    </tr>
                </thead>
                <tbody id="gridBody"></tbody>
            </table>
        </div>
    </div>

    <div id="page-repo" class="view-container hidden">
        <div id="repo-list"></div>
    </div>
</div>

<script>
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTuGa3v-rwH8Qh-JXF9MfxwUwT0A-iJooRI6ypJTErCsxN9qCjZQrgr70f16ZoehQ/pub?output=csv";
    let db = []; 
    let filters = { year:[], week:[], tian:[], di:[], solar:[], nums:[] };
    let currentMode = 'history';

    async function init() {
        try {
            const res = await fetch(CSV_URL);
            const csv = await res.text();
            const data = XLSX.utils.sheet_to_json(XLSX.read(csv, {type:'string'}).Sheets[XLSX.read(csv, {type:'string'}).SheetNames[0]], {header:1});
            
            // é è™•ç†è³‡æ–™
            db = data.filter(r => r[0] && !isNaN(r[0])).map(r => {
                const dateStr = String(r[1]);
                let yr = dateStr.length > 4 ? dateStr.substring(0,4) : dateStr;
                if(dateStr.includes('/')) yr = dateStr.split('/')[0];
                return { 
                    id:r[0], date:r[1], week:r[2], tian:r[3], di:r[4], solar:r[5], 
                    nums: [Number(r[6]), Number(r[7]), Number(r[8]), Number(r[9]), Number(r[10])],
                    year: yr 
                };
            });

            setupUI();
            renderGrid();
            document.getElementById('fileMsg').innerText = `é€£ç·šæˆåŠŸï¼šå…± ${db.length} æœŸ`;
            setMode('history');
        } catch(e) { document.getElementById('fileMsg').innerText = "é€£ç·šå¤±æ•—"; }
    }

    function setupUI() {
        const build = (type, list, container) => {
            const target = container || document.querySelector(`[data-type="${type}"]`);
            list.forEach(v => {
                const btn = document.createElement('div');
                btn.className = 'f-item'; btn.innerText = v;
                btn.onclick = () => {
                    const idx = filters[type].indexOf(v);
                    if(idx > -1) { filters[type].splice(idx, 1); btn.classList.remove('active'); btn.removeAttribute('data-order'); }
                    else { 
                        if((currentMode==='tuopai'||currentMode==='duipeng') && type!=='nums' && filters[type].length >=2) return;
                        filters[type].push(v); btn.classList.add('active'); 
                        if((currentMode==='tuopai'||currentMode==='duipeng') && type!=='nums') btn.setAttribute('data-order', filters[type].length);
                    }
                    applyFilter();
                };
                target.appendChild(btn);
            });
        };

        // 1. å¹´ä»½ä¾æª”æ¡ˆç”Ÿæˆ
        const years = [...new Set(db.map(r => r.year))].sort().reverse();
        build('year', years, document.getElementById('year-btns'));

        // 2. é€±/å¤©å¹²/åœ°æ”¯
        build('week', ['ä¸€','äºŒ','ä¸‰','å››','äº”','å…­','æ—¥']);
        build('tian', ['ç”²','ä¹™','ä¸™','ä¸','æˆŠ','å·±','åºš','è¾›','å£¬','ç™¸']);
        build('di', ['å­','ä¸‘','å¯…','å¯','è¾°','å·³','åˆ','æœª','ç”³','é…‰','æˆŒ','äº¥']);

        // 3. ç¯€æ°£å…©åˆ—
        const tList = Array.from({length:16}, (_,i)=>'T'+i);
        const sList = Array.from({length:16}, (_,i)=>'S'+i);
        build('solar', tList, document.getElementById('solar-t'));
        build('solar', sList, document.getElementById('solar-s'));

        // 4. è™Ÿç¢¼
        build('nums', Array.from({length:39}, (_,i)=>i+1));

        // 5. çµ±è¨ˆè¡¨é ­
        const thr = document.getElementById('thr-header');
        for(let i=1; i<=39; i++) {
            const th = document.createElement('th');
            th.className = 'th-count';
            th.innerHTML = `${i}<br><span id="count-${i}" style="color:blue; font-size:10px;">0</span>`;
            thr.appendChild(th);
        }
    }

    function applyFilter() {
        let counts = Array(40).fill(0);
        db.forEach((r, idx) => {
            const el = document.getElementById(`row-${idx}`);
            if(!el) return;

            let ok = true;
            if(filters.year.length) ok &= filters.year.includes(r.year);
            if(filters.week.length) ok &= filters.week.includes(String(r.week));
            if(filters.solar.length) ok &= filters.solar.includes(String(r.solar));
            
            // å¤©å¹²åœ°æ”¯çµ„åˆé‚è¼¯ (å¦‚æœå„é¸ä¸€å€‹ï¼Œè¦–ç‚ºçµ„åˆç¯©é¸)
            if(filters.tian.length > 0 && filters.di.length > 0) {
                ok &= (filters.tian.includes(r.tian) && filters.di.includes(r.di));
            } else {
                if(filters.tian.length) ok &= filters.tian.includes(r.tian);
                if(filters.di.length) ok &= filters.di.includes(r.di);
            }

            if(filters.nums.length) ok &= filters.nums.every(n => r.nums.includes(Number(n)));

            el.style.display = ok ? '' : 'none';
            if(ok) {
                r.nums.forEach(n => counts[n]++);
                const cells = el.querySelectorAll('.num-cell');
                cells.forEach(td => {
                    const n = parseInt(td.dataset.n);
                    td.innerText = r.nums.includes(n) ? (n<10?'0'+n:n) : '';
                });
            }
        });

        // æ›´æ–°è¡¨é ­æ¬¡æ•¸
        for(let i=1; i<=39; i++) {
            document.getElementById(`count-${i}`).innerText = counts[i];
        }
    }

    function renderGrid() {
        const body = document.getElementById('gridBody');
        body.innerHTML = db.map((r, i) => `
            <tr id="row-${i}">
                <td>${r.id}</td><td>${r.date}</td><td>${r.week}</td><td>${r.tian}</td><td>${r.di}</td><td>${r.solar}</td>
                <td>${r.nums[0]}</td><td>${r.nums[1]}</td><td>${r.nums[2]}</td><td>${r.nums[3]}</td><td>${r.nums[4]}</td>
                ${Array.from({length:39}, (_, n)=>`<td class="num-cell" data-n="${n+1}"></td>`).join('')}
            </tr>
        `).join('');
    }

    function setMode(m) {
        currentMode = m;
        document.querySelectorAll('.yellow-btn').forEach(b => b.classList.remove('active'));
        const btnMap = { history:'.btn-mode-h', tuopai:'.btn-mode-t', duipeng_curr:'.btn-mode-d_curr', duipeng:'.btn-mode-d' };
        if(document.querySelector(btnMap[m])) document.querySelector(btnMap[m]).classList.add('active');
        clearFilters();
    }

    function clearFilters() {
        filters = { year:[], week:[], tian:[], di:[], solar:[], nums:[] };
        document.querySelectorAll('.f-item').forEach(el => el.classList.remove('active'));
        applyFilter();
    }

    function switchPage(p) {
        document.getElementById('page-dist').classList.toggle('hidden', p==='repo');
        document.getElementById('page-repo').classList.toggle('hidden', p==='dist');
    }

    init();
</script>

</body>
</html>
