<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>539 專業回測系統 - 雲端同步版</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <style>
        :root { --bg: #d1e7d1; --blue-t: #2196F3; --red-box: #f44336; --gold: #ffc107; }
        body { background-color: var(--bg); font-family: "Microsoft JhengHei", sans-serif; font-size: 13px; margin: 15px; }
        .main-layout { display: flex; flex-direction: column; gap: 10px; }
        
        /* 模式指引樣式 */
        .guide-box { background: #fffde7; border-left: 5px solid var(--gold); padding: 12px; margin-bottom: 10px; line-height: 1.6; border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .guide-box b { color: #d32f2f; }

        .filter-panel { border: 2px solid var(--red-box); background: #fff; padding: 15px; display: grid; grid-template-columns: 60px 1fr; gap: 8px; border-radius: 8px; }
        .f-label { background: #eee; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 1px solid #ccc; }
        .f-btns { display: flex; flex-wrap: wrap; gap: 4px; }
        .f-item { padding: 4px 12px; border: 1px solid #ccc; cursor: pointer; background: #fff; border-radius: 4px; position: relative; }
        .f-item.active { background: var(--blue-t); color: white; }
        .f-item.active::after { content: attr(data-order); position: absolute; top: -8px; right: -5px; background: #333; color: #fff; border-radius: 50%; width: 16px; height: 16px; font-size: 10px; display: flex; align-items: center; justify-content: center; border: 1px solid white; }
        
        .action-bar { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; background: rgba(255,255,255,0.5); padding: 10px; border-radius: 8px; }
        .yellow-btn { background: #ffff00; border: 1px solid #000; padding: 8px 15px; font-weight: bold; cursor: pointer; border-radius: 4px; }
        .yellow-btn.active { background: #ff9800 !important; color: white; }
        .add-btn { background: #4CAF50; color: white; border: 1px solid #000; padding: 8px 20px; font-weight: bold; cursor: pointer; border-radius: 4px; }
        
        .view-container { background: white; border: 2px solid var(--blue-t); padding: 10px; border-radius: 8px; min-height: 500px; }
        .scroll-area { overflow: auto; max-height: 500px; }
        table { border-collapse: collapse; width: 100%; white-space: nowrap; }
        th, td { border: 1px solid #ccc; padding: 4px; text-align: center; }
        .num-cell { font-weight: bold; width: 25px; }

        /* 報表樣式 */
        .report-card { border: 2px solid #333; background: #fff; margin-bottom: 25px; border-radius: 4px; }
        .report-title { background: #7da7d8; padding: 10px; font-weight: bold; display: flex; justify-content: space-between; border-bottom: 2px solid #333; }
        tfoot tr { background: #fff5f5; font-weight: bold; color: #f44336; }
        .hit-count { color: #f44336; font-weight: bold; }
        .top-hit { background-color: #ffff00 !important; font-weight: bold; }
        .hidden { display: none; }
    </style>
</head>
<body>

<div class="main-layout">
    <div style="display:flex; gap:5px;">
        <button onclick="switchPage('dist')" style="flex:1; padding:12px; font-weight:bold; cursor:pointer;">數據分佈圖</button>
        <button onclick="switchPage('repo')" style="flex:1; padding:12px; font-weight:bold; cursor:pointer;">匯總報表</button>
    </div>

    <div id="page-dist" class="view-container">
        <div id="modeGuide" class="guide-box">正在連線至 Google 試算表載入最新數據...</div>

        <div class="filter-panel">
            <div class="f-label">週</div><div class="f-btns" data-type="week"></div>
            <div class="f-label">天干</div><div class="f-btns" data-type="tian"></div>
            <div class="f-label">地支</div><div class="f-btns" data-type="di"></div>
            <div class="f-label">節氣</div><div class="f-btns" data-type="solar"></div>
            <div class="f-label" style="color:blue">號碼</div><div class="f-btns" data-type="nums"></div>
        </div>

        <div class="action-bar">
            <button class="yellow-btn btn-mode-h active" onclick="setMode('history')">歷史統計</button>
            <button class="yellow-btn btn-mode-t" onclick="setMode('tuopai')">拖牌模式</button>
            <button class="yellow-btn btn-mode-d_curr" onclick="setMode('duipeng_curr')">當期對碰</button>
            <button class="yellow-btn btn-mode-d" onclick="setMode('duipeng')">下期對碰</button>
            <button class="add-btn" onclick="generateBatchReport()">加入報表</button>
            <button onclick="clearFilters()">清空篩選</button>
            <span id="fileMsg" style="margin-left:auto; font-weight:bold; color:red;">連線中...</span>
        </div>

        <div class="scroll-area">
            <table>
                <thead><tr id="thr"><th>期號</th><th>日期</th><th>週</th><th>天干</th><th>地支</th><th>節氣</th><th>球1</th><th>球2</th><th>球3</th><th>球4</th><th>球5</th></tr></thead>
                <tbody id="gridBody"></tbody>
            </table>
        </div>
    </div>

    <div id="page-repo" class="view-container hidden">
        <div style="margin-bottom:10px;"><button onclick="document.getElementById('repo-list').innerHTML=''" style="background:#333; color:white; padding:8px 15px; cursor:pointer;">清空所有報表</button></div>
        <div id="repo-list"></div>
    </div>
</div>

<script>
    // 您的 Google 試算表 CSV 發佈連結
    const GSHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTuGa3v-rwH8Qh-JXF9MfxwUwT0A-iJooRI6ypJTErCsxN9qCjZQrgr70f16ZoehQ/pub?output=csv";

    let db = [];
    let currentMode = 'history';
    let filters = { week:[], tian:[], di:[], solar:[], nums:[] };

    // 各模式操作指引文字
    const guideText = {
        history: "<b>【歷史統計】指引：</b><br>1. 直接點選左方條件。分佈圖會即時同步顯示符合條件的期數。<br>2. 點擊「加入報表」可統計所有選定條件的出現次數與排名。",
        tuopai: "<b>【拖牌模式】指引：</b><br>1. 每個項目（如週、天干等）<b>必須點選 2 個</b>（代表順序關係）。<br>2. <b>必須點選 1 個號碼</b>。<br>3. 邏輯：當第一期符合條件 A 且開出 X 號，第二期符合條件 B 時，計算第二期號碼分佈。",
        duipeng_curr: "<b>【當期對碰】指引：</b><br>1. 篩選特定條件。系統會計算這些期數中，哪些號碼最常「同時」開出。<br>2. 報表中，<b>次數</b>將以紅字顯示。",
        duipeng: "<b>【下期對碰】指引：</b><br>1. 每個項目<b>必須點選 2 個</b>。<br>2. <b>必須點選 2 個對碰號碼</b>。<br>3. 邏輯：第一期符合條件 A 且同時開出 X,Y 兩號，第二期符合條件 B 時，計算下期分佈。"
    };

    // 自動連線 Google 試算表
    async function loadCloudData() {
        try {
            const response = await fetch(GSHEET_CSV_URL);
            const csvText = await response.text();
            const workbook = XLSX.read(csvText, { type: 'string' });
            const sheetName = workbook.SheetNames[0];
            // 解析數據並過濾無效列
            db = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], { header: 1 })
                 .filter(row => row[0] && !isNaN(row[0])); 
            
            renderGrid();
            document.getElementById('fileMsg').innerText = `雲端同步成功：共 ${db.length} 期`;
            setMode('history'); // 預設歷史統計指引
        } catch (error) {
            console.error(error);
            document.getElementById('fileMsg').innerText = "雲端載入失敗";
            document.getElementById('modeGuide').innerHTML = "<b style='color:red'>錯誤：無法讀取雲端試算表，請確認網路連線。</b>";
        }
    }

    function initUI() {
        const build = (type, list) => {
            const container = document.querySelector(`[data-type="${type}"]`);
            list.forEach(v => {
                const div = document.createElement('div');
                div.className = 'f-item'; div.innerText = v;
                div.onclick = () => handleItem(div, type, v);
                container.appendChild(div);
            });
        };
        build('week', ['一','二','三','四','五','六','日']);
        build('tian', ['甲','乙','丙','丁','戊','己','庚','辛','壬','癸']);
        build('di', ['子','丑','寅','卯','辰','巳','午','未','申','酉','戌','亥']);
        let slist = []; for(let i=0; i<=15; i++) { slist.push('T'+i); slist.push('S'+i); }
        build('solar', slist);
        build('nums', Array.from({length:39}, (_,i)=>i+1));
        
        for(let i=1; i<=39; i++) {
            const th = document.createElement('th'); th.style.background = '#ffc107';
            th.innerHTML = `${i}<br><span id="s-${i}" style="font-size:10px; color:blue">0</span>`;
            document.getElementById('thr').appendChild(th);
        }
        loadCloudData();
    }

    function setMode(m) {
        currentMode = m;
        document.querySelectorAll('.yellow-btn').forEach(b => b.classList.remove('active'));
        const sel = {history:'.btn-mode-h', tuopai:'.btn-mode-t', duipeng_curr:'.btn-mode-d_curr', duipeng:'.btn-mode-d'}[m];
        if(document.querySelector(sel)) document.querySelector(sel).classList.add('active');
        document.getElementById('modeGuide').innerHTML = guideText[m];
        clearFilters();
    }

    function handleItem(el, type, val) {
        const arr = filters[type]; const idx = arr.indexOf(val);
        if(idx > -1) { 
            arr.splice(idx, 1); el.classList.remove('active'); el.removeAttribute('data-order'); 
        } else {
            // 拖牌與下期對碰逻辑：項目限選2個
            if((currentMode === 'tuopai' || currentMode === 'duipeng') && type !== 'nums' && arr.length >= 2) return;
            arr.push(val); el.classList.add('active');
            if((currentMode === 'tuopai' || currentMode === 'duipeng') && type !== 'nums') el.setAttribute('data-order', arr.length);
        }
        applyFilter();
    }

    function applyFilter() {
        if(!db.length) return;
        const rows = document.querySelectorAll('#gridBody tr');
        let counts = Array(40).fill(0);
        rows.forEach(tr => {
            const data = db[tr.id.split('-')[1]];
            let ok = true;
            ['week','tian','di','solar'].forEach(cat => {
                if(filters[cat].length > 0) ok &= filters[cat].some(v => String(data[['week','tian','di','solar'].indexOf(cat)+2]).includes(v));
            });
            const win = data.slice(6, 11).map(Number);
            if(filters.nums.length > 0) ok &= filters.nums.some(n => win.includes(Number(n)));
            tr.style.display = ok ? '' : 'none';
            if(ok) {
                const tds = tr.querySelectorAll('.num-cell');
                tds.forEach(td => {
                    const n = parseInt(td.getAttribute('data-n'));
                    if(win.includes(n)) { td.innerText = n < 10 ? '0'+n : n; counts[n]++; }
                    else { td.innerText = ''; }
                });
            }
        });
        for(let i=1; i<=39; i++) document.getElementById(`s-${i}`).innerText = counts[i];
    }

    function generateBatchReport() {
        if(!db.length) return alert("數據載入中...");
        const list = document.getElementById('repo-list');
        let hasResult = false;
        if (currentMode === 'duipeng_curr') hasResult = reportDuiPengCurr(list);
        else if (currentMode === 'tuopai') hasResult = reportTuoPai(list);
        else if (currentMode === 'duipeng') hasResult = reportDuiPengNext(list);
        else hasResult = reportHistory(list);

        if(hasResult) switchPage('repo');
        else alert("無符合條件之數據，請檢查篩選項目數量是否正確。");
    }

    // 渲染函數：最後一列加總
    function renderTableWithTotal(container, title, rows) {
        const card = document.createElement('div');
        card.className = 'report-card';
        let totalStats = Array(40).fill(0);
        let html = `<div class="report-title"><span>【${title}】</span><button onclick="this.closest('.report-card').remove()">刪除</button></div>`;
        html += `<div class="scroll-area"><table><thead><tr style="background:#eee"><td>分析條件</td>`;
        for(let i=1; i<=39; i++) html += `<td>${i}</td>`;
        html += `</tr></thead><tbody>`;
        rows.forEach(r => {
            const top3 = getTop3Indices(r.data);
            html += `<tr><td style="text-align:left; padding-left:8px;">${r.label} (${r.matches}期)</td>`;
            for(let i=1; i<=39; i++) {
                const val = r.data[i] || 0;
                totalStats[i] += val;
                html += `<td class="${top3.includes(i)?'top-hit':''}">${val || ''}</td>`;
            }
            html += `</tr>`;
        });
        html += `</tbody><tfoot><tr><td>最後一列加總</td>`;
        for(let i=1; i<=39; i++) html += `<td>${totalStats[i] || ''}</td>`;
        html += `</tr></tfoot></table></div>`;
        card.innerHTML = html;
        container.insertBefore(card, container.firstChild);
        return true;
    }

    // 當期對碰
    function reportDuiPengCurr(container) {
        let matrix = Array.from({length:40}, () => Array(40).fill(0));
        let matchCount = 0;
        db.forEach(row => {
            let ok = true;
            ['week','tian','di','solar'].forEach(cat => {
                if(filters[cat].length > 0) ok &= filters[cat].some(v => String(row[['week','tian','di','solar'].indexOf(cat)+2]).includes(v));
            });
            if(ok) {
                matchCount++;
                const nums = row.slice(6, 11).map(Number);
                for(let i=0; i<nums.length; i++) for(let j=i+1; j<nums.length; j++){
                    matrix[nums[i]][nums[j]]++; matrix[nums[j]][nums[i]]++;
                }
            }
        });
        if(matchCount === 0) return false;
        let htmlContent = `<div style="display:grid; grid-template-columns:repeat(auto-fill, minmax(280px, 1fr)); gap:10px; padding:15px;">`;
        for(let i=1; i<=39; i++) {
            let pairs = [];
            for(let j=1; j<=39; j++) if(matrix[i][j] > 0) pairs.push({n:j, v:matrix[i][j]});
            pairs.sort((a,b) => b.v - a.v);
            if(pairs.length > 0) {
                const hits = pairs.slice(0,3).map(p=>`${p.n}(<span class="hit-count">${p.v}次</span>)`);
                htmlContent += `<div style="border-bottom:1px dashed #ccc; padding:5px;">號碼 ${i}：碰 ${hits.join(', ')}</div>`;
            }
        }
        htmlContent += `</div>`;
        const card = document.createElement('div');
        card.className = 'report-card';
        card.innerHTML = `<div class="report-title"><span>【當期對碰排行榜】符合：${matchCount} 期</span><button onclick="this.closest('.report-card').remove()">刪除</button></div>${htmlContent}`;
        container.insertBefore(card, container.firstChild);
        return true;
    }

    // 拖牌邏輯
    function reportTuoPai(container) {
        const results = [];
        filters.nums.forEach(num => {
            ['week','tian','di','solar'].forEach(cat => {
                if(filters[cat].length === 2) {
                    const [v1, v2] = filters[cat], col = ['week','tian','di','solar'].indexOf(cat)+2;
                    let stats = Array(40).fill(0), count = 0;
                    for(let i=1; i<db.length; i++){
                        if(String(db[i-1][col]).includes(v1) && String(db[i][col]).includes(v2) && db[i-1].slice(6,11).map(Number).includes(Number(num))){
                            db[i].slice(6,11).map(Number).forEach(n => { if(n>0) stats[n]++; }); count++;
                        }
                    }
                    if(count > 0) results.push({ label: `[拖號:${num}] ${v1}→${v2}`, matches: count, data: stats });
                }
            });
        });
        return results.length ? renderTableWithTotal(container, "拖牌分析報表", results) : false;
    }

    // 下期對碰
    function reportDuiPengNext(container) {
        const results = [];
        let pairs = [];
        for(let i=0; i<filters.nums.length; i++) for(let j=i+1; j<filters.nums.length; j++) pairs.push([filters.nums[i], filters.nums[j]]);
        ['week','tian','di','solar'].forEach(cat => {
            if(filters[cat].length === 2) {
                const [v1, v2] = filters[cat], col = ['week','tian','di','solar'].indexOf(cat)+2;
                pairs.forEach(p => {
                    let stats = Array(40).fill(0), count = 0;
                    for(let i=1; i<db.length; i++){
                        const prevWin = db[i-1].slice(6,11).map(Number);
                        if(String(db[i-1][col]).includes(v1) && String(db[i][col]).includes(v2) && p.every(n => prevWin.includes(Number(n)))){
                            db[i].slice(6,11).map(Number).forEach(n => { if(n>0) stats[n]++; }); count++;
                        }
                    }
                    if(count > 0) results.push({ label: `[對碰:${p.join(',')}] ${v1}→${v2}`, matches: count, data: stats });
                });
            }
        });
        return results.length ? renderTableWithTotal(container, "下期對碰分析報表", results) : false;
    }

    // 歷史統計
    function reportHistory(container) {
        const results = [];
        ['week','tian','di','solar'].forEach(cat => {
            filters[cat].forEach(val => {
                let stats = Array(40).fill(0), count = 0;
                const col = ['week','tian','di','solar'].indexOf(cat)+2;
                db.forEach(row => {
                    if(String(row[col]).includes(val)) {
                        row.slice(6,11).map(Number).forEach(n => { if(n>0) stats[n]++; }); count++;
                    }
                });
                if(count > 0) results.push({ label: `${val}`, matches: count, data: stats });
            });
        });
        return results.length ? renderTableWithTotal(container, "歷史統計報表", results) : false;
    }

    function getTop3Indices(data) {
        const sorted = data.slice(1).map((v, i) => ({v, i: i+1})).sort((a, b) => b.v - a.v);
        const vals = [...new Set(sorted.map(x => x.v))].filter(v => v > 0).slice(0, 3);
        return sorted.filter(x => x.v > 0 && vals.includes(x.v)).map(x => x.i);
    }

    function switchPage(p) {
        document.getElementById('page-dist').className = (p==='dist'?'view-container':'hidden');
        document.getElementById('page-repo').className = (p==='repo'?'view-container':'hidden');
    }

    function clearFilters() {
        filters = { week:[], tian:[], di:[], solar:[], nums:[] };
        document.querySelectorAll('.f-item').forEach(el => el.classList.remove('active'));
        applyFilter();
    }

    function renderGrid() {
        const body = document.getElementById('gridBody'); body.innerHTML = '';
        db.forEach((row, idx) => {
            const tr = document.createElement('tr'); tr.id = `row-${idx}`;
            for(let i=0; i<11; i++){
                const td = document.createElement('td'); td.innerText = row[i] || '';
                tr.appendChild(td);
            }
            for(let n=1; n<=39; n++){
                const td = document.createElement('td'); td.className = 'num-cell'; td.setAttribute('data-n', n);
                tr.appendChild(td);
            }
            body.appendChild(tr);
        });
        applyFilter();
    }
    initUI();
</script>
</body>
</html>
