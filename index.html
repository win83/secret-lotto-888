<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>Lotto System Pro - Final Stable Version</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        :root {
            --label-bg: #e9ecef;
            --btn-border: #dee2e6;
            --active-blue: #3498db;
            --active-yellow: #fbc02d;
            --active-green: #2ecc71;
            --report-blue: #0056b3;
        }

        body { font-family: "Microsoft JhengHei", sans-serif; background: #f4f7f9; margin: 0; padding: 20px; }
        .hidden { display: none !important; }
        .main-container { background: #fff; border: 1px solid #ddd; padding: 20px; border-radius: 4px; max-width: 1550px; margin: 0 auto; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }

        .row { display: flex; align-items: flex-start; gap: 8px; margin-bottom: 12px; }
        .label { 
            background: var(--label-bg); min-width: 85px; height: 38px; 
            display: flex; align-items: center; justify-content: center; 
            border-radius: 6px; font-size: 14px; font-weight: bold; border: 1px solid #ddd; flex-shrink: 0;
        }
        .btn-group { display: flex; flex-wrap: wrap; gap: 6px; align-items: center; }
        .btn {
            background: #fff; border: 1px solid var(--btn-border);
            padding: 8px 12px; border-radius: 6px; cursor: pointer;
            font-size: 14px; transition: all 0.1s; outline: none;
        }
        .btn.active-blue { background: var(--active-blue) !important; color: white; border-color: #2980b9; }
        
        .btn.active-yellow { background: var(--active-yellow) !important; color: #000; border-color: #f9a825; font-weight: bold; }
        .btn.active-green { background: var(--active-green) !important; color: white !important; border-color: #27ae60; font-weight: bold; }
        
        .btn.drag-pre-active { background: var(--active-yellow) !important; color: #000; font-weight: bold; border-color: #f9a825; }
        .btn.drag-post-active { background: var(--active-green) !important; color: white; font-weight: bold; border-color: #27ae60; }

        /* æ–°å¢å…¨é¸æŒ‰éˆ•æ¨£å¼ */
        .select-all-btn { background: #f1f2f6; border: 1px solid #ced4da; color: #2f3542; font-weight: bold; padding: 8px 10px; }
        .select-all-btn:hover { background: #dfe4ea; }

        #toast-msg { margin-left: 15px; color: #27ae60; font-weight: bold; opacity: 0; transition: opacity 0.3s; }

        /* å ±è¡¨é¡¯ç¤ºæ¨£å¼ */
        .report-section { margin-bottom: 30px; border: 1px solid var(--report-blue); border-radius: 4px; overflow: hidden; background: #fff; }
        .report-banner { background: var(--report-blue); color: white; padding: 8px 15px; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        
        /* è¡¨é ­å›ºå®šèˆ‡æ»¾å‹•å®¹å™¨ */
        .table-container { max-height: 550px; overflow-y: auto; }
        .report-table { width: 100%; border-collapse: collapse; font-size: 12px; table-layout: fixed; }
        .report-table th, .report-table td { border: 1px solid #ccc; text-align: center; padding: 5px 0; }
        .report-table th { background: #f8f9fa; position: sticky; top: 0; z-index: 5; box-shadow: 0 1px 1px rgba(0,0,0,0.1); }
        .report-table th:first-child { min-width: 140px; z-index: 6; left: 0; }
        
        .top5-cell { background: #fbc02d !important; font-weight: bold; }
        .total-row { background: #fbc02d; font-weight: bold; }
        .total-top5 { border: 2px solid red !important; }
        .accum-row { background: #95e895; font-weight: bold; }

        /* å‹•æ…‹ç¯©é¸åˆ— & å°ç¢°å¿«ç¯©åˆ— */
        #dynamic-filter-bar { background: #f8f9fa; padding: 10px; border-radius: 6px; margin-bottom: 15px; border: 1px dashed #ccc; display: flex; gap: 6px; flex-wrap: wrap; }
        .quick-filter-area { background: #ecf0f1; padding: 8px 15px; border-bottom: 1px solid #bdc3c7; display: flex; gap: 4px; flex-wrap: wrap; align-items: center; }
        .quick-btn { padding: 4px 8px; font-size: 12px; border-radius: 4px; }
        
        /* ä¸‹æ¨NæœŸè¼¸å…¥æ¡† */
        #push-n-container { display: inline-flex; align-items: center; background: #fff3cd; padding: 5px 10px; border-radius: 4px; border: 1px solid #ffeeba; margin-left: 10px; font-weight: bold; color: #856404; }
        #pushN { border: 1px solid #ced4da; padding: 4px; border-radius: 3px; text-align: center; font-weight: bold; margin: 0 5px; }

        /* ç•¶æœŸ/ä¸‹æœŸå°ç¢°çµ„åˆå¾½ç«  */
        .pair-badge { display: inline-block; background: #fff; border: 1px solid #b2bec3; padding: 3px 8px; border-radius: 4px; margin: 3px; font-size: 13px; color: #2d3436; font-weight:bold; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }

        /* ====== ç™»å…¥é˜²è­·ç•«é¢æ¨£å¼ ====== */
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #2c3e50; display: flex; flex-direction: column;
            align-items: center; justify-content: center; z-index: 99999;
            color: white; font-family: "Microsoft JhengHei", sans-serif;
        }
        #login-screen h2 { margin-bottom: 10px; font-size: 28px; letter-spacing: 2px; }
        #login-msg { margin-bottom: 25px; color: #bdc3c7; font-size: 16px; font-weight: bold; text-align: center; line-height: 1.5; }
        #login-screen input { 
            padding: 12px; font-size: 20px; border-radius: 6px; border: 2px solid #34495e; 
            text-align: center; margin-bottom: 20px; outline: none; background: #ecf0f1;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1); width: 200px; transition: border 0.3s;
        }
        #login-screen input:focus { border-color: #3498db; background: #fff; }
        #login-screen button { 
            padding: 12px 40px; font-size: 18px; border-radius: 6px; border: none; 
            background: #27ae60; color: white; cursor: pointer; font-weight: bold; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.2); transition: background 0.2s, transform 0.1s;
        }
        #login-screen button:hover { background: #219150; transform: translateY(-2px); }
        #login-screen button:active { transform: translateY(0); box-shadow: 0 2px 3px rgba(0,0,0,0.2); }
        
        #app-content { display: none; }
    </style>
</head>
<body>

<div id="login-screen">
    <h2>ğŸ”’ Lotto System Pro</h2>
    <div id="login-msg">æ©Ÿå¯†åˆ†æç³»çµ± ï½œ è«‹è¼¸å…¥é€šè¡Œå¯†ç¢¼</div>
    <input type="password" id="pwd-input" placeholder="â€¢â€¢â€¢â€¢" autocomplete="off">
    <button id="login-btn" onclick="checkPassword()">ç™»å…¥ç³»çµ±</button>
</div>
<div id="app-content">
    <div id="main-ui" class="main-container">
        <div class="row" style="align-items: center;">
            <div class="label">æ“ä½œè€…</div>
            <div class="btn-group">
                <button class="btn active-blue" onclick="switchUser(this, 'çˆ¸')">çˆ¸ä½¿ç”¨æ¨¡å¼</button>
                <button class="btn" onclick="switchUser(this, 'å“¥')">å“¥ä½¿ç”¨æ¨¡å¼</button>
            </div>
            <div style="width:1px; height:25px; background:#ddd; margin:0 10px;"></div>
            <div class="label">è³‡æ–™é¡åˆ¥</div>
            <div class="btn-group" id="cat-btns-main">
                <button class="btn active-blue" onclick="switchCat('539')">539</button>
                <button class="btn" onclick="switchCat('539å ±è¡¨')">539å ±è¡¨</button>
                <button class="btn" onclick="switchCat('49')">49</button>
                <button class="btn" onclick="switchCat('49å ±è¡¨')">49å ±è¡¨</button>
                <button class="btn" style="background: #d32f2f; color: white; margin-left:10px;" onclick="clearReports()">æ¸…ç©ºå ±è¡¨</button>
                <span id="conn-status" style="margin-left:15px; font-size:13px; font-weight:bold; color:#7f8c8d;">ğŸ“¡ GitHub è³‡æ–™è¼‰å…¥ä¸­...</span>
                
                <div id="latest-update-info" style="margin-left:auto; font-weight:bold; color:#d35400; font-size:14px; background:#fbeee6; padding:6px 15px; border-radius:6px; border:1px solid #e67e22; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                    ğŸ“… æœ€æ–°é–‹çæ—¥ - 539ï¼š<span id="date-539" style="color:#c0392b;">è®€å–ä¸­</span> ï½œ 49ï¼š<span id="date-49" style="color:#c0392b;">è®€å–ä¸­</span>
                </div>
            </div>
        </div>

        <div class="row" style="background: #fffdf2; padding: 10px; border: 1px solid #ffe082; border-radius: 8px; margin-top: 10px;">
            <div class="label">çµ±è¨ˆæ¨¡å¼</div>
            <div class="btn-group" id="mode-btns-group">
                <button class="btn mode-btn active-yellow" id="btn-history" onclick="switchMode(this, 'æ­·å²æ¨¡å¼')">æ­·å²æ¨¡å¼</button>
                <button class="btn mode-btn" id="btn-drag-pre" onclick="switchMode(this, 'æ‹–ç‰Œå‰æœŸ')">æ‹–ç‰Œå‰æœŸ</button>
                <button class="btn mode-btn" id="btn-drag-post" onclick="switchMode(this, 'æ‹–ç‰Œå¾ŒæœŸ')">æ‹–ç‰Œå¾ŒæœŸ</button>
                <button class="btn mode-btn" id="btn-drag-n" onclick="switchMode(this, 'æ‹–ç‰Œä¸‹æ¨')">æ‹–ç‰Œä¸‹æ¨NæœŸ</button>
                
                <div id="push-n-container" class="hidden">
                    ä¸‹æ¨ <input type="number" id="pushN" value="5" min="1" max="20" style="width: 50px;"> æœŸ
                </div>

                <button class="btn mode-btn" onclick="switchMode(this, 'ç•¶æœŸå°ç¢°')">ç•¶æœŸå°ç¢°</button>
                <button class="btn mode-btn" onclick="switchMode(this, 'ä¸‹æœŸå°ç¢°')">ä¸‹æœŸå°ç¢°</button>
                <button class="btn mode-btn" id="btn-main-body" onclick="switchMode(this, 'ä¸»é«”')">ä¸»é«”</button>
                <button class="btn mode-btn" id="btn-sub-body" onclick="switchMode(this, 'å‰¯é«”')">å‰¯é«”</button>
                <button class="btn active-green" style="margin-left: 20px; font-weight:bold;" onclick="addToReport()">ğŸš€ åŠ å…¥å ±è¡¨ (ENTER)</button>
                <button class="btn" onclick="resetFilters()">æ¸…ç©ºç¯©é¸ (ESC)</button>
                <span id="toast-msg">âœ… å·²æˆåŠŸåŠ å…¥å ±è¡¨</span>
            </div>
        </div>

        <div style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px;">
            <div class="row" data-type="å¹´ä»½"><div class="label">å¹´ä»½</div><button class="btn select-all-btn" onclick="toggleSelectRow(this)">å…¨é¸</button><div class="btn-group" id="year-btns"></div></div>
            <div class="row" data-type="æœˆä»½"><div class="label">æœˆä»½</div><button class="btn select-all-btn" onclick="toggleSelectRow(this)">å…¨é¸</button><div class="btn-group" id="month-btns"></div></div>
            <div class="row" data-type="æ—¥æœŸ"><div class="label">æ—¥æœŸ</div><button class="btn select-all-btn" onclick="toggleSelectRow(this)">å…¨é¸</button><div class="btn-group" id="day-btns"></div></div>
            <div class="row" data-type="æ˜ŸæœŸ"><div class="label">æ˜ŸæœŸ</div><button class="btn select-all-btn" onclick="toggleSelectRow(this)">å…¨é¸</button><div class="btn-group" id="week-btns"></div></div>
            <div class="row filter-extra" data-type="å¤©å¹²"><div class="label">å¤©å¹²</div><button class="btn select-all-btn" onclick="toggleSelectRow(this)">å…¨é¸</button><div class="btn-group" id="tian-gan"></div></div>
            <div class="row filter-extra" data-type="åœ°æ”¯"><div class="label">åœ°æ”¯</div><button class="btn select-all-btn" onclick="toggleSelectRow(this)">å…¨é¸</button><div class="btn-group" id="di-zhi"></div></div>
            <div class="row filter-extra" data-type="ç¯€æ°£"><div class="label">ç¯€æ°£/è¡“èª</div><button class="btn select-all-btn" onclick="toggleSelectRow(this)">å…¨é¸</button>
                <div class="btn-group" style="flex-direction: column; align-items: flex-start;">
                    <div id="s-row" class="btn-group" style="margin-bottom: 5px;"></div>
                    <div id="t-row" class="btn-group"></div>
                </div>
            </div>
            <div class="row" data-type="è™Ÿç¢¼"><div class="label">è™Ÿç¢¼</div><button class="btn select-all-btn" onclick="toggleSelectRow(this)">å…¨é¸</button><div class="btn-group" id="num-btns"></div></div>
        </div>
    </div>

    <div id="report-ui" class="main-container hidden" style="max-width: 1650px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <div style="display: flex; gap: 10px; align-items: center;">
                <div class="label" style="background:#000; color:#fff; min-width:120px;">å ±è¡¨ç®¡ç†ç³»çµ±</div>
                <span id="report-user-label" style="font-weight:bold; color:var(--report-blue); font-size:16px;">[ç•¶å‰æ“ä½œè€…ï¼šçˆ¸]</span>
                <div class="btn-group" id="cat-btns-report" style="margin-left:15px;">
                    <button class="btn" onclick="switchCat('539')">539</button>
                    <button class="btn active-blue" onclick="switchCat('539å ±è¡¨')">539å ±è¡¨</button>
                    <button class="btn" onclick="switchCat('49')">49</button>
                    <button class="btn" onclick="switchCat('49å ±è¡¨')">49å ±è¡¨</button>
                    <button class="btn" style="background: #d32f2f; color: white;" onclick="clearReports()">æ¸…ç©ºå ±è¡¨</button>
                    <button class="btn" style="background: #27ae60; color: white; font-weight:bold; margin-left: 10px;" onclick="exportToExcel()">ğŸ“Š åŒ¯å‡ºExcel</button>
                    <button class="btn" style="background: #8e44ad; color: white; font-weight:bold; margin-left: 10px;" onclick="analyzeBestCombinations()">ğŸ’¡ åˆ†æå ±è¡¨è™Ÿç¢¼</button>
                    <button class="btn" style="background: #e67e22; color: white; font-weight:bold; margin-left: 10px;" onclick="analyzeOverlaps()">ğŸ” æœŸæ•¸äº¤å‰åˆ†æ</button>
                </div>
            </div>
        </div>
        <div class="row" style="margin-bottom:10px;">
            <div class="label">é¡¯ç¤ºæ¨¡å¼</div>
            <div class="btn-group" id="mode-filter-bar">
                <button class="btn active-blue" onclick="filterByMode('å…¨éƒ¨', this)">å…¨éƒ¨</button>
                <button class="btn" onclick="filterByMode('æ­·å²æ¨¡å¼', this)">æ­·å²</button>
                <button class="btn" onclick="filterByMode('æ‹–ç‰Œ', this)">æ‹–ç‰Œ</button>
                <button class="btn" onclick="filterByMode('æ‹–ç‰Œä¸‹æ¨', this)">ä¸‹æ¨NæœŸ</button>
                <button class="btn" onclick="filterByMode('ç•¶æœŸå°ç¢°', this)">ç•¶æœŸå°ç¢°</button>
                <button class="btn" onclick="filterByMode('ä¸‹æœŸå°ç¢°', this)">ä¸‹æœŸå°ç¢°</button>
                <button class="btn" onclick="filterByMode('ä¸»é«”', this)">ä¸»é«”</button>
            </div>
        </div>
        <div id="dynamic-filter-bar"></div>
        <div id="overlap-analysis-area" style="margin-bottom: 20px;"></div>
        <div id="analysis-result-area" style="margin-bottom: 20px;"></div>
        <div id="report-display-area"></div>
    </div>
</div>

<script>
    // ==========================================
    // ====== ç™»å…¥é˜²è­·ã€é˜²å³éµèˆ‡ 3 æ¬¡éŒ¯é– IP æ©Ÿåˆ¶ ======
    // ==========================================
    
    // é˜²å³éµã€é˜² F12 åŠå„ç¨®é–‹ç™¼è€…å·¥å…·ç†±éµ
    document.addEventListener('contextmenu', e => e.preventDefault());
    document.addEventListener('keydown', e => {
        if (e.key === 'F12') e.preventDefault();
        if (e.ctrlKey && e.shiftKey && (e.key === 'I' || e.key === 'i' || e.key === 'J' || e.key === 'j' || e.key === 'C' || e.key === 'c')) e.preventDefault();
        if (e.ctrlKey && (e.key === 'U' || e.key === 'u')) e.preventDefault();
    });

    // å–å¾—å¤–éƒ¨ IP (å‘¼å«å…è²» API)
    async function getUserIP() {
        try {
            let response = await fetch('https://api.ipify.org?format=json');
            let data = await response.json();
            return data.ip;
        } catch (e) {
            return 'æœªçŸ¥IP (ç¶²è·¯é™åˆ¶)';
        }
    }

    // æª¢æŸ¥å°é–ç‹€æ…‹
    function checkBanStatus() {
        let banUntil = localStorage.getItem('lotto_ban_until');
        if (banUntil) {
            if (Date.now() < parseInt(banUntil)) {
                let ip = localStorage.getItem('lotto_banned_ip') || 'æœªçŸ¥';
                showBannedScreen(banUntil, ip);
                return true;
            } else {
                // å°é–æ™‚é–“å·²éï¼Œè§£é™¤å°é–
                localStorage.removeItem('lotto_ban_until');
                localStorage.removeItem('lotto_banned_ip');
                localStorage.removeItem('lotto_failed_attempts');
            }
        }
        return false;
    }

    // é¡¯ç¤ºå°é–ç•«é¢
    function showBannedScreen(banUntil, ip) {
        let date = new Date(parseInt(banUntil)).toLocaleString('zh-TW');
        document.getElementById('pwd-input').style.display = 'none';
        document.getElementById('login-btn').style.display = 'none';
        document.getElementById('login-msg').innerHTML = `<span style="color:#e74c3c; font-size: 18px;">â›” ç³»çµ±æ‹’çµ•å­˜å–ï¼</span><br>æ‚¨çš„ IP (${ip}) å·²è¢«å°é–ã€‚<br>è§£é–æ™‚é–“ï¼š${date}`;
    }

    // é©—è­‰å¯†ç¢¼é‚è¼¯
    async function checkPassword() {
        if (checkBanStatus()) return;

        const pwdInput = document.getElementById('pwd-input');
        const pwd = pwdInput.value;
        const msgEl = document.getElementById('login-msg');

        if (pwd === '8586') {
            localStorage.setItem('lottoAuth_8586', 'true');
            localStorage.removeItem('lotto_failed_attempts');
            unlockApp();
        } else {
            let attempts = parseInt(localStorage.getItem('lotto_failed_attempts') || '0');
            attempts++;
            localStorage.setItem('lotto_failed_attempts', attempts);

            if (attempts >= 3) {
                // é–å®š UI é¿å…é‡è¤‡é»æ“Š
                pwdInput.disabled = true;
                msgEl.innerHTML = '<span style="color:#e74c3c;">åµæ¸¬åˆ°ç•°å¸¸å­˜å–ï¼Œæ­£åœ¨é–å®šä¾†æº...</span>';
                
                // å–å¾— IP ä¸¦è¨­å®šå°é– 3 å¤© (3å¤© * 24æ™‚ * 60åˆ† * 60ç§’ * 1000æ¯«ç§’)
                let ip = await getUserIP();
                let banTime = Date.now() + (1 * 24 * 60 * 60 * 1000); 
                
                localStorage.setItem('lotto_ban_until', banTime);
                localStorage.setItem('lotto_banned_ip', ip);
                
                showBannedScreen(banTime, ip);
            } else {
                let left = 3 - attempts;
                msgEl.innerHTML = `<span style="color:#f39c12;">å¯†ç¢¼éŒ¯èª¤ï¼æ‚¨é‚„æœ‰ ${left} æ¬¡å˜—è©¦æ©Ÿæœƒã€‚</span>`;
                pwdInput.value = '';
            }
        }
    }

    // è§£é–æ‡‰ç”¨ç¨‹å¼
    function unlockApp() {
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('app-content').style.display = 'block';
        init(); // å¯†ç¢¼æ­£ç¢ºæ‰æ­£å¼å•Ÿå‹•ç³»çµ±è³‡æ–™
    }

    // æ”¯æ´ Enter éµç™»å…¥
    document.getElementById('pwd-input').addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            e.stopPropagation();
            checkPassword();
        }
    });

    // ç¶²é è¼‰å…¥æ™‚æª¢æŸ¥ç‹€æ…‹
    window.onload = function() {
        if (localStorage.getItem('lottoAuth_8586') === 'true') {
            unlockApp(); // å·²ç¶“ç™»å…¥éï¼Œç›´æ¥è§£é–
        } else {
            let isBanned = checkBanStatus();
            if (!isBanned) {
                document.getElementById('pwd-input').focus();
            }
        }
    };


    // ==========================================
    // ====== ç³»çµ±ä¸»ç¨‹å¼æ¼”ç®—æ³• (å®Œå…¨ä¿ç•™ä¸è®Š) ======
    // ==========================================

    let currentConfig = { user: 'çˆ¸', cat: '539', mode: 'æ­·å²æ¨¡å¼' };
    let reportsData = JSON.parse(localStorage.getItem('lottoReports_v14')) || []; 
    let dragData = { step: 0, preConds: [], preNums: [] }; 
    let mainSubData = { step: 0, mainConds: [] }; 

    let activeModeFilter = 'å…¨éƒ¨';
    let activeCondFilter = 'å…¨éƒ¨';

    const DATA_URLS = {
        '539': 'https://raw.githubusercontent.com/win83/secret-lotto-888/main/fine/539.csv',
        '49': 'https://raw.githubusercontent.com/win83/secret-lotto-888/main/fine/49.csv'
    };
    
    let globalLottoData = { '539': [], '49': [] };
    let loadedCounts = { '539': 0, '49': 0 };
    let latestDates = { '539': '', '49': '' };

    function updateLatestDateUI() {
        const el539 = document.getElementById('date-539');
        const el49 = document.getElementById('date-49');
        if (el539) el539.innerText = latestDates['539'] || 'ç„¡è³‡æ–™';
        if (el49) el49.innerText = latestDates['49'] || 'ç„¡è³‡æ–™';
    }

    function init() {
        renderBtns('month-btns', ["01","02","03","04","05","06","07","08","09","10","11","12"]);
        renderBtns('day-btns', Array.from({length: 31}, (_, i) => (i+1).toString().padStart(2, '0')));
        renderBtns('week-btns', ["é€±ä¸€","é€±äºŒ","é€±ä¸‰","é€±å››","é€±äº”","é€±å…­","é€±æ—¥"]);
        renderBtns('tian-gan', ["ç”²","ä¹™","ä¸™","ä¸","æˆŠ","å·±","åºš","è¾›","å£¬","ç™¸"]);
        renderBtns('di-zhi', ["å­","ä¸‘","å¯…","å¯","è¾°","å·³","åˆ","æœª","ç”³","é…‰","æˆŒ","äº¥"]);
        renderBtns('s-row', Array.from({length: 16}, (_, i) => `S${i}`));
        renderBtns('t-row', Array.from({length: 16}, (_, i) => `T${i}`));
        
        updateDynamicUI(); 
        fetchGithubData(); 
		loadFromCache(); // 1. å…ˆå¾æœ¬åœ°å¿«å–è¼‰å…¥
    }

	// å¾ LocalStorage è¼‰å…¥ä¸Šæ¬¡æˆåŠŸçš„è³‡æ–™
    function loadFromCache() {
        ['539', '49'].forEach(cat => {
            let cached = localStorage.getItem(`lotto_cache_${cat}`);
            if (cached) {
                try {
                    let parsed = JSON.parse(cached);
                    globalLottoData[cat] = parsed.data;
                    latestDates[cat] = parsed.date;
                    updateConnectionStatus(false, true); // æ¨™ç¤ºç‚ºå¿«å–æ¨¡å¼
                } catch(e) { console.error("Cache load error", e); }
            }
        });
        updateLatestDateUI();
    }

    function fetchGithubData() {
        ['539', '49'].forEach(cat => {
            fetch(DATA_URLS[cat] + '?t=' + new Date().getTime())
                .then(res => res.arrayBuffer())
                .then(buffer => {
                    let text = new TextDecoder('utf-8').decode(buffer);
                    if (text.includes('') || (!text.includes('ç”²') && !text.includes('å­') && !text.includes('æœŸ'))) {
                        try { text = new TextDecoder('big5').decode(buffer); } catch(e) {}
                    }
                    Papa.parse(text, {
                        header: false,
                        skipEmptyLines: true,
                        complete: function(results) {
                            try {
                                const maxCols = cat === '539' ? 10 : 11; 
                                let cleanData = results.data.map((row) => {
                                    let rowData = row.slice(0, maxCols).map(c => c ? c.toString().replace(/[\s\uFEFF\xA0'"]/g, '') : ''); 
                                    let dateStr = rowData[1];
                                    
                                    if (!dateStr || !dateStr.match(/[-/]/)) return null;
                                    let parts = dateStr.split(/[-/]/);
                                    if (parts.length < 3) return null;

                                    let y = parseInt(parts[0], 10);
                                    let m = parseInt(parts[1], 10) - 1;
                                    let d = parseInt(parts[2], 10);
                                    
                                    if (y < 1911) y += 1911; 
                                    if (isNaN(y) || isNaN(m) || isNaN(d)) return null;

                                    let dateObj = new Date(y, m, d);
                                    const weekMap = ["é€±æ—¥", "é€±ä¸€", "é€±äºŒ", "é€±ä¸‰", "é€±å››", "é€±äº”", "é€±å…­"];

                                    return {
                                        year: y, month: (m + 1).toString().padStart(2, '0'), day: d.toString().padStart(2, '0'),
                                        weekday: weekMap[dateObj.getDay()], dateObj: dateObj,
                                        tian: rowData[2], zhi: rowData[3], term: rowData[4],
                                        nums: rowData.slice(5, maxCols).map(n => parseInt(n, 10)).filter(n => !isNaN(n))
                                    };
                                }).filter(item => item !== null);

                                cleanData.sort((a, b) => a.dateObj - b.dateObj);
                                globalLottoData[cat] = cleanData;
                                loadedCounts[cat] = cleanData.length;

                                let latestEntry = cleanData.slice().reverse().find(d => d.nums && d.nums.length > 0);
                                if (latestEntry) {
                                    latestDates[cat] = `${latestEntry.year}/${latestEntry.month}/${latestEntry.day}`;
                                }

                                updateConnectionStatus();
                                updateLatestDateUI();

                                if (currentConfig.cat.includes(cat)) {
                                    updateDynamicUI(); 
                                }

                                if (currentConfig.cat.includes('å ±è¡¨') && currentConfig.cat.includes(cat)) {
                                    renderReports();
                                }
                            } catch (err) { updateConnectionStatus(true); }
                        }
                    });
                }).catch(err => { updateConnectionStatus(true); });
        });
    }

    function updateConnectionStatus(isError = false) {
        const el = document.getElementById('conn-status');
        if (!el) return;
        if (isError) {
            el.innerHTML = `ğŸ”´ GitHub é€£ç·šç•°å¸¸`; el.style.color = '#e74c3c';
        } else {
            el.innerHTML = `ğŸŸ¢ å·²é€£ç·šä¸”ç·¨ç¢¼æ­£å¸¸ (539: ${loadedCounts['539']}ç­†, 49: ${loadedCounts['49']}ç­†)`; el.style.color = '#27ae60';
        }
    }

    function renderBtns(id, list) {
        const el = document.getElementById(id);
        if(el) el.innerHTML = list.map(item => `<button class="btn filter-btn" onclick="handleFilterClick(this)">${item}</button>`).join('');
    }

    function handleFilterClick(btn) {
        if (currentConfig.mode === 'æ‹–ç‰Œå¾ŒæœŸ' || currentConfig.mode === 'å‰¯é«”') {
            btn.classList.toggle('active-green'); 
            btn.classList.remove('active-yellow');
        } else {
            btn.classList.toggle('active-yellow'); 
            btn.classList.remove('active-green');
        }
    }

    // æ–°å¢ï¼šä¸€éµå…¨é¸é‚è¼¯
    function toggleSelectRow(btn) {
        const row = btn.closest('.row');
        const btns = row.querySelectorAll('.filter-btn');
        const targetClass = (currentConfig.mode === 'æ‹–ç‰Œå¾ŒæœŸ' || currentConfig.mode === 'å‰¯é«”') ? 'active-green' : 'active-yellow';
        const allSelected = Array.from(btns).every(b => b.classList.contains(targetClass));
        btns.forEach(b => {
            b.classList.remove('active-yellow', 'active-green');
            if (!allSelected) b.classList.add(targetClass);
        });
    }

    function updateDynamicUI() {
        const selectedYellows = Array.from(document.querySelectorAll('#year-btns .active-yellow, #num-btns .active-yellow')).map(b => b.innerText);
        const selectedGreens = Array.from(document.querySelectorAll('#year-btns .active-green, #num-btns .active-green')).map(b => b.innerText);

        const yBox = document.getElementById('year-btns');
        const start = (currentConfig.user === "çˆ¸") ? 2020 : 2007;
        
        const rawCat = currentConfig.cat.replace('å ±è¡¨', '');
        const data = globalLottoData[rawCat] || [];
        let endYear = 2026; 
        if (data.length > 0) {
            const maxDataYear = Math.max(...data.map(d => d.year));
            if (maxDataYear > endYear) endYear = maxDataYear;
        }

        yBox.innerHTML = '';
        for(let y = start; y <= endYear; y++) {
            let ys = y.toString();
            let activeClass = selectedYellows.includes(ys) ? 'active-yellow' : (selectedGreens.includes(ys) ? 'active-green' : '');
            yBox.innerHTML += `<button class="btn filter-btn ${activeClass}" onclick="handleFilterClick(this)">${y}</button>`;
        }
        
        const nBox = document.getElementById('num-btns');
        const count = currentConfig.cat.includes('539') ? 39 : 49;
        nBox.innerHTML = '';
        for(let i=1; i<=count; i++) {
            let ns = i.toString().padStart(2, '0');
            let activeClass = selectedYellows.includes(ns) ? 'active-yellow' : (selectedGreens.includes(ns) ? 'active-green' : '');
            nBox.innerHTML += `<button class="btn filter-btn ${activeClass}" onclick="handleFilterClick(this)">${ns}</button>`;
        }
        
        document.querySelectorAll('.filter-extra').forEach(el => {
            currentConfig.user === 'å“¥' ? el.classList.add('hidden') : el.classList.remove('hidden');
        });
    }

    function switchCat(cat) {
        currentConfig.cat = cat;
        const isReport = cat.includes('å ±è¡¨');
        [document.getElementById('cat-btns-main'), document.getElementById('cat-btns-report')].forEach(group => {
            group.querySelectorAll('.btn').forEach(b => b.classList.toggle('active-blue', b.innerText === cat));
        });
        if (isReport) { toggleUI('report'); renderReports(); } else { toggleUI('main'); updateDynamicUI(); }
        document.getElementById('analysis-result-area').innerHTML = '';
        document.getElementById('overlap-analysis-area').innerHTML = '';
    }

    function toggleUI(target) {
        document.getElementById('main-ui').classList.toggle('hidden', target === 'report');
        document.getElementById('report-ui').classList.toggle('hidden', target === 'main');
    }

    function switchUser(el, user) {
        el.parentElement.querySelectorAll('.btn').forEach(b => b.classList.remove('active-blue'));
        el.classList.add('active-blue');
        currentConfig.user = user;
        document.getElementById('report-user-label').innerText = `[ç•¶å‰æ“ä½œè€…ï¼š${user}]`;
        
        resetFilters();
        dragData = { step: 0, preConds: [], preNums: [] };
        mainSubData = { step: 0, mainConds: [] };
        document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active-yellow', 'drag-pre-active', 'drag-post-active'));
        document.getElementById('btn-history').classList.add('active-yellow');
        currentConfig.mode = 'æ­·å²æ¨¡å¼';

        updateDynamicUI();
        renderReports(); 
        document.getElementById('analysis-result-area').innerHTML = '';
        document.getElementById('overlap-analysis-area').innerHTML = '';
    }

    function switchMode(el, mode) {
        document.getElementById('push-n-container').classList.add('hidden');

        if (mode === 'æ‹–ç‰Œå‰æœŸ') {
            dragData = { step: 1, preConds: [], preNums: [] };
            mainSubData = { step: 0, mainConds: [] };
            resetFilters();
            document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active-yellow', 'drag-pre-active', 'drag-post-active'));
            document.getElementById('btn-drag-pre').classList.add('drag-pre-active');
        } 
        else if (mode === 'æ‹–ç‰Œå¾ŒæœŸ') {
            const yellows = document.querySelectorAll('.filter-btn.active-yellow');
            dragData.preConds = Array.from(yellows).filter(b => b.closest('.row').getAttribute('data-type') !== 'è™Ÿç¢¼')
                .map(b => ({ text: b.textContent.replace(/[\s\uFEFF\xA0]/g, ''), type: b.closest('.row').getAttribute('data-type') }));
            dragData.preNums = Array.from(yellows).filter(b => b.closest('.row').getAttribute('data-type') === 'è™Ÿç¢¼')
                .map(b => b.textContent.replace(/[\s\uFEFF\xA0]/g, ''));
            dragData.step = 2;
            document.getElementById('btn-drag-post').classList.add('drag-post-active');
        } 
        else if (mode === 'ä¸»é«”') {
            dragData = { step: 0, preConds: [], preNums: [] };
            mainSubData = { step: 1, mainConds: [] };
            resetFilters();
            document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active-yellow', 'drag-pre-active', 'drag-post-active'));
            document.getElementById('btn-main-body').classList.add('drag-pre-active');
        }
        else if (mode === 'å‰¯é«”') {
            const yellows = document.querySelectorAll('.filter-btn.active-yellow');
            mainSubData.mainConds = Array.from(yellows).map(b => ({
                text: b.textContent.replace(/[\s\uFEFF\xA0]/g, ''), 
                type: b.closest('.row').getAttribute('data-type')
            }));
            mainSubData.step = 2;
            document.getElementById('btn-sub-body').classList.add('drag-post-active');
        }
        else if (mode === 'æ‹–ç‰Œä¸‹æ¨') {
            dragData = { step: 0, preConds: [], preNums: [] };
            mainSubData = { step: 0, mainConds: [] };
            resetFilters();
            document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active-yellow', 'drag-pre-active', 'drag-post-active'));
            document.getElementById('btn-drag-n').classList.add('drag-pre-active');
            document.getElementById('push-n-container').classList.remove('hidden');
        }
        else {
            dragData = { step: 0, preConds: [], preNums: [] };
            mainSubData = { step: 0, mainConds: [] };
            resetFilters();
            document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active-yellow', 'drag-pre-active', 'drag-post-active'));
            if(el) el.classList.add('active-yellow');
        }
        currentConfig.mode = mode;
    }

    function addToReport() {
        const rawCat = currentConfig.cat.replace('å ±è¡¨', '');

        if (currentConfig.mode === 'æ­·å²æ¨¡å¼' || currentConfig.mode === 'ç•¶æœŸå°ç¢°' || currentConfig.mode === 'ä¸‹æœŸå°ç¢°' || currentConfig.mode === 'æ‹–ç‰Œä¸‹æ¨') {
            const yellows = Array.from(document.querySelectorAll('.filter-btn.active-yellow'));
            if (yellows.length === 0) return alert('è«‹è‡³å°‘é¸æ“‡ä¸€å€‹æ¢ä»¶å†åŠ å…¥å ±è¡¨ï¼');

            const condBtns = yellows.filter(b => b.closest('.row').getAttribute('data-type') !== 'è™Ÿç¢¼');
            const numBtns = yellows.filter(b => b.closest('.row').getAttribute('data-type') === 'è™Ÿç¢¼');
            const pushNVal = parseInt(document.getElementById('pushN').value) || 5;

            const generateSingleReport = (condText, condType, numText) => {
                let condsByCat = {};
                let labelParts = [];

                if (condText) {
                    condsByCat[condType] = [condText];
                    labelParts.push(`${condType}:${condText}`);
                }
                if (numText) {
                    condsByCat['è™Ÿç¢¼'] = [numText];
                    labelParts.push(`è™Ÿç¢¼:${numText}`); 
                }

                let finalLabel = labelParts.join('+');
                if (currentConfig.mode === 'æ‹–ç‰Œä¸‹æ¨') {
                    finalLabel += ` (ä¸‹æ¨${pushNVal}æœŸ)`;
                }

                reportsData.push({
                    id: Date.now() + Math.random(),
                    owner: currentConfig.user,
                    cat: rawCat, 
                    mode: currentConfig.mode, 
                    value: finalLabel,
                    pushN: pushNVal, 
                    query: { type: 'history', conds: condsByCat }
                });
            };

            if (condBtns.length > 0) {
                condBtns.forEach(cb => {
                    let cType = cb.closest('.row').getAttribute('data-type');
                    let cText = cb.textContent.replace(/[\s\uFEFF\xA0]/g, '');
                    
                    if (numBtns.length > 0) {
                        numBtns.forEach(nb => {
                            let nText = nb.textContent.replace(/[\s\uFEFF\xA0]/g, '');
                            generateSingleReport(cText, cType, nText);
                        });
                    } else {
                        generateSingleReport(cText, cType, null);
                    }
                });
            } else {
                numBtns.forEach(nb => {
                    let nText = nb.textContent.replace(/[\s\uFEFF\xA0]/g, '');
                    generateSingleReport(null, null, nText);
                });
            }
            saveAndRefresh();
        } 
        else if (currentConfig.mode === 'æ‹–ç‰Œå¾ŒæœŸ' && dragData.step === 2) {
            const greens = Array.from(document.querySelectorAll('.filter-btn.active-green'));
            if (greens.length === 0) return alert('è«‹é¸æ“‡å¾ŒæœŸçš„æ¢ä»¶ï¼');

            const postConds = greens.map(b => ({ text: b.textContent.replace(/[\s\uFEFF\xA0]/g, ''), type: b.closest('.row').getAttribute('data-type') }));
            const preByCat = { æ˜ŸæœŸ: [], æ—¥æœŸ: [], å¤©å¹²: [], åœ°æ”¯: [], ç¯€æ°£: [] };
            dragData.preConds.forEach(c => { if (preByCat[c.type]) preByCat[c.type].push(c.text); });
            const postByCat = { æ˜ŸæœŸ: [], æ—¥æœŸ: [], å¤©å¹²: [], åœ°æ”¯: [], ç¯€æ°£: [] };
            postConds.forEach(c => { if (postByCat[c.type]) postByCat[c.type].push(c.text); });

            let results = [];
            if (preByCat.å¤©å¹².length > 0 && preByCat.åœ°æ”¯.length > 0) {
                preByCat.å¤©å¹².forEach((gan, idx) => {
                    const zhi = preByCat.åœ°æ”¯[idx] || preByCat.åœ°æ”¯[0]; 
                    const postGan = postByCat.å¤©å¹²[idx] || postByCat.å¤©å¹²[0] || "";
                    const postZhi = postByCat.åœ°æ”¯[idx] || postByCat.åœ°æ”¯[0] || "";
                    if (postGan || postZhi) {
                        results.push({ label: `${gan}${zhi} â†’ ${postGan}${postZhi}`, query: { pre: {å¤©å¹²: gan, åœ°æ”¯: zhi}, post: {å¤©å¹²: postGan, åœ°æ”¯: postZhi} } });
                    }
                });
            }

            ["å¤©å¹²", "åœ°æ”¯", "æ˜ŸæœŸ", "æ—¥æœŸ", "ç¯€æ°£"].forEach(type => {
                preByCat[type].forEach((preVal, idx) => {
                    const postVal = postByCat[type][idx] || postByCat[type][0];
                    if (postVal) {
                        let qPre = {}; qPre[type] = preVal;
                        let qPost = {}; qPost[type] = postVal;
                        results.push({ label: `${type}:${preVal} â†’ æ¢ä»¶:${postVal}`, query: { pre: qPre, post: qPost } });
                    }
                });
            });

            results.forEach(res => {
                if (dragData.preNums.length > 0) {
                    dragData.preNums.forEach(num => {
                        let newQuery = JSON.parse(JSON.stringify(res.query));
                        newQuery.pre.è™Ÿç¢¼ = num; 
                        reportsData.push({ id: Date.now() + Math.random(), owner: currentConfig.user, cat: rawCat, mode: "æ‹–ç‰Œ", value: `${res.label.split(' â†’ ')[0]}+è™Ÿç¢¼:${num} â†’ ${res.label.split(' â†’ ')[1]}`, query: newQuery });
                    });
                } else {
                    reportsData.push({ id: Date.now() + Math.random(), owner: currentConfig.user, cat: rawCat, mode: "æ‹–ç‰Œ", value: res.label, query: res.query });
                }
            });
            saveAndRefresh();
        } 
        else if (currentConfig.mode === 'å‰¯é«”' && mainSubData.step === 2) {
            const greens = Array.from(document.querySelectorAll('.filter-btn.active-green'));
            if (mainSubData.mainConds.length !== 1) return alert('ä¸»é«”è«‹é¸æ“‡ã€Œå‰›å¥½ 1 å€‹ã€æ¢ä»¶å†åˆ‡æ›è‡³å‰¯é«”ï¼');
            if (greens.length === 0) return alert('è«‹è‡³å°‘é¸æ“‡ 1 å€‹ä»¥ä¸Šçš„å‰¯é«”æ¢ä»¶ï¼');

            const mainCond = mainSubData.mainConds[0];
            const subConds = greens.map(b => ({
                text: b.textContent.replace(/[\s\uFEFF\xA0]/g, ''),
                type: b.closest('.row').getAttribute('data-type')
            }));

            subConds.forEach(sub => {
                let valueLabel = `ä¸»é«”(${mainCond.type}:${mainCond.text}) + å‰¯é«”(${sub.type}:${sub.text})`; 
                reportsData.push({
                    id: Date.now() + Math.random(),
                    owner: currentConfig.user,
                    cat: rawCat, 
                    mode: "ä¸»é«”", 
                    value: valueLabel,
                    query: { type: 'main_sub', main: mainCond, sub: sub }
                });
            });
            saveAndRefresh();
        } 
        else {
            alert('è«‹ç¢ºèªæ¢ä»¶å·²é¸å–ï¼Œè‹¥ç‚ºæ‹–ç‰Œ/å‰¯é«”æ¨¡å¼ï¼Œè«‹ä¾åºå®Œæˆå…©éšæ®µï¼');
        }
    }

    function saveAndRefresh() {
        localStorage.setItem('lottoReports_v14', JSON.stringify(reportsData));
        document.getElementById('toast-msg').style.opacity = "1";
        resetFilters();
        document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('drag-pre-active', 'drag-post-active', 'active-yellow'));
        document.getElementById('btn-history').classList.add('active-yellow');
        document.getElementById('push-n-container').classList.add('hidden');
        currentConfig.mode = 'æ­·å²æ¨¡å¼';
        dragData = { step: 0, preConds: [], preNums: [] };
        mainSubData = { step: 0, mainConds: [] };
        setTimeout(() => { document.getElementById('toast-msg').style.opacity = "0"; }, 2000);
        if (currentConfig.cat.includes('å ±è¡¨')) renderReports();
    }

    function matchSingleCond(draw, cond) {
        if (!cond) return true;
        if (cond.type === 'å¹´ä»½') return draw.year.toString() === cond.text;
        if (cond.type === 'æœˆä»½') return draw.month === cond.text;
        if (cond.type === 'æ—¥æœŸ') return draw.day === cond.text;
        if (cond.type === 'æ˜ŸæœŸ') return draw.weekday === cond.text;
        if (cond.type === 'å¤©å¹²') return draw.tian === cond.text;
        if (cond.type === 'åœ°æ”¯') return draw.zhi === cond.text;
        if (cond.type === 'ç¯€æ°£') return draw.term === cond.text;
        if (cond.type === 'è™Ÿç¢¼') return draw.nums.includes(parseInt(cond.text, 10));
        return false;
    }

    function matchDragQuery(draw, queryCat) {
        if (!queryCat || Object.keys(queryCat).length === 0) return true;
        if (queryCat.å¤©å¹² && draw.tian !== queryCat.å¤©å¹²) return false;
        if (queryCat.åœ°æ”¯ && draw.zhi !== queryCat.åœ°æ”¯) return false;
        if (queryCat.ç¯€æ°£ && draw.term !== queryCat.ç¯€æ°£) return false;
        if (queryCat.æ˜ŸæœŸ && draw.weekday !== queryCat.æ˜ŸæœŸ) return false;
        if (queryCat.æ—¥æœŸ && draw.day !== queryCat.æ—¥æœŸ) return false;
        if (queryCat.è™Ÿç¢¼ && !draw.nums.includes(parseInt(queryCat.è™Ÿç¢¼, 10))) return false;
        return true;
    }

    function matchHistoryQuery(draw, condsByCat) {
        if (!condsByCat || Object.keys(condsByCat).length === 0) return true;
        for (let type in condsByCat) {
            let validVals = condsByCat[type];
            if (validVals.length === 0) continue;

            if (type === 'å¹´ä»½' && !validVals.includes(draw.year.toString())) return false;
            if (type === 'æœˆä»½' && !validVals.includes(draw.month)) return false;
            if (type === 'æ—¥æœŸ' && !validVals.includes(draw.day)) return false;
            if (type === 'æ˜ŸæœŸ' && !validVals.includes(draw.weekday)) return false;
            if (type === 'å¤©å¹²' && !validVals.includes(draw.tian)) return false;
            if (type === 'åœ°æ”¯' && !validVals.includes(draw.zhi)) return false;
            if (type === 'ç¯€æ°£' && !validVals.includes(draw.term)) return false;
            if (type === 'è™Ÿç¢¼') {
                let hasNum = validVals.some(v => draw.nums.includes(parseInt(v, 10)));
                if (!hasNum) return false;
            }
        }
        return true;
    }

    function updateConditionFilterBar() {
        const area = document.getElementById('dynamic-filter-bar');
        if(!area) return;
        
        const rawCat = currentConfig.cat.replace('å ±è¡¨', '');
        let filtered = reportsData.filter(r => r.owner === currentConfig.user && r.cat === rawCat);
        if (activeModeFilter !== 'å…¨éƒ¨') {
            filtered = filtered.filter(r => r.mode === activeModeFilter);
        }

        const conditions = [...new Set(filtered.map(r => r.value))];
        if (conditions.length === 0) {
            area.innerHTML = '<span style="color:#7f8c8d; font-size:13px; margin: auto;">æ­¤æ¨¡å¼ä¸‹ç›®å‰ç„¡å°æ‡‰çš„æ¢ä»¶æ¨™ç±¤</span>';
            return;
        }

        let html = `<button class="btn ${activeCondFilter === 'å…¨éƒ¨' ? 'active-yellow' : ''}" onclick="setCondFilter('å…¨éƒ¨')">å…¨éƒ¨æ¢ä»¶</button>`;
        conditions.forEach(cond => {
            const isActive = activeCondFilter === cond ? 'active-yellow' : '';
            html += `<button class="btn ${isActive}" onclick="setCondFilter('${cond}')">${cond}</button>`;
        });
        area.innerHTML = html;
    }

    function setCondFilter(cond) {
        activeCondFilter = cond;
        renderReports();
    }

    function filterPairDisplay(reportId, numStr, btnEl) {
        const section = document.getElementById(`report-sec-${reportId}`);
        if(!section) return;

        const allBtns = section.querySelectorAll('.quick-btn');
        allBtns.forEach(b => b.classList.remove('active-blue'));
        btnEl.classList.add('active-blue');

        const rows = section.querySelectorAll('.freq-row');
        rows.forEach(row => {
            let badges = row.querySelectorAll('.pair-badge');
            let visibleCount = 0;
            badges.forEach(badge => {
                if (numStr === 'ALL') {
                    badge.style.display = 'inline-block';
                    visibleCount++;
                } else {
                    let n1 = badge.getAttribute('data-n1');
                    let n2 = badge.getAttribute('data-n2');
                    if (n1 === numStr || n2 === numStr) {
                        badge.style.display = 'inline-block';
                        visibleCount++;
                    } else {
                        badge.style.display = 'none';
                    }
                }
            });
            row.style.display = visibleCount > 0 ? '' : 'none';
        });
    }

    function getCombinations(arr, k) {
        let i, j, combs, head, tailcombs;
        if (k > arr.length || k <= 0) return [];
        if (k == arr.length) return [arr];
        if (k == 1) {
            combs = [];
            for (i = 0; i < arr.length; i++) combs.push([arr[i]]);
            return combs;
        }
        combs = [];
        for (i = 0; i < arr.length - k + 1; i++) {
            head = arr.slice(i, i + 1);
            tailcombs = getCombinations(arr.slice(i + 1), k - 1);
            for (j = 0; j < tailcombs.length; j++) {
                combs.push(head.concat(tailcombs[j]));
            }
        }
        return combs;
    }

    // æ–°å¢ï¼šæœŸæ•¸äº¤å‰åˆ†æé‚è¼¯
    function analyzeOverlaps() {
        const rawCat = currentConfig.cat.replace('å ±è¡¨', '');
        const lottoData = globalLottoData[rawCat] || [];
        if (lottoData.length === 0) return alert('å°šæœªè¼‰å…¥è³‡æ–™');

        let filtered = reportsData.filter(r => r.owner === currentConfig.user && r.cat === rawCat);
        if (activeModeFilter !== 'å…¨éƒ¨') filtered = filtered.filter(r => r.mode === activeModeFilter);
        if (filtered.length < 2) return alert('è«‹è‡³å°‘åŠ å…¥å…©å€‹å ±è¡¨æ¢ä»¶é€²è¡Œäº¤å‰åˆ†æ');

        let reportResults = filtered.map(report => {
            let dates = new Set();
            for(let i=0; i<lottoData.length; i++) {
                let isMatch = false;
                if (report.mode === "æ­·å²æ¨¡å¼") isMatch = matchHistoryQuery(lottoData[i], report.query.conds);
                else if (report.mode === "ä¸»é«”") isMatch = matchSingleCond(lottoData[i], report.query.main) && matchSingleCond(lottoData[i], report.query.sub);
                else if (report.mode === "æ‹–ç‰Œ" && i < lottoData.length - 1) isMatch = matchDragQuery(lottoData[i], report.query.pre) && matchDragQuery(lottoData[i+1], report.query.post);
                
                if(isMatch) {
                    let target = (report.mode === "æ‹–ç‰Œ") ? lottoData[i+1] : lottoData[i];
                    dates.add(`${target.year}-${target.month}-${target.day}`);
                }
            }
            return { label: report.value, dates: dates };
        });

        let allDates = new Set();
        reportResults.forEach(r => r.dates.forEach(d => allDates.add(d)));
        
        let overlapDates = [];
        allDates.forEach(date => {
            if (reportResults.every(r => r.dates.has(date))) overlapDates.push(date);
        });

        let uniqueDetails = reportResults.map(r => {
            let unique = [];
            r.dates.forEach(d => {
                let isUnique = reportResults.every(other => (other === r || !other.dates.has(d)));
                if(isUnique) unique.push(d);
            });
            return { label: r.label, count: unique.length };
        });

        renderOverlapUI(overlapDates, uniqueDetails, lottoData, rawCat);
    }

    function renderOverlapUI(overlapDates, uniqueDetails, lottoData, rawCat) {
        const area = document.getElementById('overlap-analysis-area');
        const max = rawCat === '539' ? 39 : 49;
        let counts = new Array(max).fill(0);

        lottoData.filter(d => overlapDates.includes(`${d.year}-${d.month}-${d.day}`))
                 .forEach(d => d.nums.forEach(n => counts[n-1]++));

        let hotNums = counts.map((v, i) => ({v, n: i+1})).sort((a,b) => b.v - a.v).slice(0, 10).filter(x => x.v > 0);

        let html = `
        <div class="report-section" style="border: 2px solid #e67e22;">
            <div class="report-banner" style="background:#e67e22;">
                <span>ğŸ” å ±è¡¨æœŸæ•¸äº¤å‰åˆ†æ</span>
                <button class="btn" style="padding:2px 10px; font-size:12px; background:#fff; color:#000;" onclick="document.getElementById('overlap-analysis-area').innerHTML=''">âœ– é—œé–‰</button>
            </div>
            <div style="padding:15px; background:#fffaf0;">
                <div style="margin-bottom:15px;">
                    <strong style="color:#d35400;">ğŸ“ é‡ç–ŠæœŸæ•¸ (æ‰€æœ‰æ¢ä»¶çš†ç¬¦åˆ)ï¼š</strong> 
                    <span style="font-size:18px; color:#c0392b;">${overlapDates.length}</span> æœŸ
                    <div style="margin-top:5px;">
                        ${hotNums.map(x => `<span class="pair-badge" style="background:#fbc02d;">${x.n.toString().padStart(2,'0')} (${x.v}æ¬¡)</span>`).join('')}
                    </div>
                </div>
                <div style="border-top:1px dashed #ccc; padding-top:10px;">
                    <strong style="color:#2980b9;">ğŸ“ å„å ±è¡¨ç¨æœ‰æœŸæ•¸ (ä¸é‡ç–Š)ï¼š</strong>
                    <ul style="margin:5px 0; font-size:13px;">
                        ${uniqueDetails.map(u => `<li>${u.label}: ç¨æœ‰ ${u.count} æœŸ</li>`).join('')}
                    </ul>
                </div>
            </div>
        </div>`;
        area.innerHTML = html;
        area.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    function analyzeBestCombinations() {
        const rawCat = currentConfig.cat.replace('å ±è¡¨', '');
        const lottoData = globalLottoData[rawCat] || [];
        if (lottoData.length === 0) return alert('å°šæœªè¼‰å…¥æ­·å²è³‡æ–™ï¼Œè«‹ç¨å¾Œå†è©¦ï¼');

        let filtered = reportsData.filter(r => r.owner === currentConfig.user && r.cat === rawCat);
        if (activeModeFilter !== 'å…¨éƒ¨') filtered = filtered.filter(r => r.mode === activeModeFilter);
        if (activeCondFilter !== 'å…¨éƒ¨') filtered = filtered.filter(r => r.value === activeCondFilter);

        if (filtered.length === 0) return alert('ç•¶å‰ç•«é¢æ²’æœ‰å ±è¡¨å¯ä»¥åˆ†æï¼è«‹å…ˆåŠ å…¥æ¢ä»¶ã€‚');

        const max = rawCat === '539' ? 39 : 49;
        let overallCounts = new Array(max).fill(0);

        filtered.forEach(data => {
            for(let i = 0; i < lottoData.length; i++) {
                let targets = [];
                if (data.mode === "æ­·å²æ¨¡å¼") {
                    if(matchHistoryQuery(lottoData[i], data.query.conds)) targets.push(lottoData[i]);
                } else if (data.mode === "ä¸»é«”") {
                    if(matchSingleCond(lottoData[i], data.query.main) && matchSingleCond(lottoData[i], data.query.sub)) targets.push(lottoData[i]);
                } else if (data.mode === "æ‹–ç‰Œ" && i < lottoData.length - 1) {
                    if(matchDragQuery(lottoData[i], data.query.pre) && matchDragQuery(lottoData[i+1], data.query.post)) targets.push(lottoData[i+1]);
                } else if (data.mode === "æ‹–ç‰Œä¸‹æ¨") {
                    if(matchHistoryQuery(lottoData[i], data.query.conds)) {
                        for(let k=1; k<=(data.pushN || 5); k++) {
                            if(i+k < lottoData.length) targets.push(lottoData[i+k]);
                        }
                    }
                } else if (data.mode === "ç•¶æœŸå°ç¢°" || data.mode === "ä¸‹æœŸå°ç¢°") {
                    if(matchHistoryQuery(lottoData[i], data.query.conds)) {
                        if(data.mode === "ç•¶æœŸå°ç¢°") targets.push(lottoData[i]);
                        else if(i < lottoData.length - 1) targets.push(lottoData[i+1]);
                    }
                }
                
                targets.forEach(draw => {
                    draw.nums.forEach(n => {
                        if(n>=1 && n<=max) overallCounts[n-1]++;
                    });
                });
            }
        });

        let pool = overallCounts.map((v, i) => ({v, num: i+1}))
                                .sort((a,b) => b.v - a.v)
                                .slice(0, 12)
                                .filter(item => item.v > 0)
                                .map(item => item.num);
        
        if (pool.length < 5) return alert('å ±è¡¨æ¶µè“‹çš„é–‹å‡ºæ•¸æ“šéå°‘ï¼Œç„¡æ³•ç”¢ç”Ÿæœ‰æ•ˆçš„ 5 æ˜Ÿçµ„åˆï¼');

        const historySets = lottoData.map(d => new Set(d.nums));
        const totalDraws = lottoData.length;

        function getBestCombs(kSize) {
            let combs = getCombinations(pool, kSize);
            let results = combs.map(comb => {
                let count = 0;
                for(let i=0; i<historySets.length; i++) {
                    let match = true;
                    for(let j=0; j<comb.length; j++) {
                        if(!historySets[i].has(comb[j])) { match = false; break; }
                    }
                    if(match) count++;
                }
                return { comb, count, rate: ((count / totalDraws) * 100).toFixed(2) };
            });
            results.sort((a,b) => b.count - a.count);
            return results.slice(0, 5); 
        }

        renderAnalysisArea(getBestCombs(2), getBestCombs(3), getBestCombs(4), getBestCombs(5), pool);
    }

    function renderAnalysisArea(b2, b3, b4, b5, pool) {
        const area = document.getElementById('analysis-result-area');
        
        let buildTable = (data, title) => {
            let html = `<div style="flex: 1; min-width: 280px; background:#fdfefe; border:2px solid #8e44ad; border-radius:8px; padding:12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
                <h4 style="margin-top:0; color:#8e44ad; border-bottom:2px dashed #8e44ad; padding-bottom:8px; text-align:center; font-size:16px;">ğŸ† ${title} æœ€ä½³ 5 çµ„</h4>
                <table class="report-table" style="background:#fff;">
                    <thead><tr><th style="width:55%;">çµ„åˆè™Ÿç¢¼</th><th>æ­·å²æ¬¡æ•¸</th><th>æ­·å²å‹ç‡</th></tr></thead>
                    <tbody>`;
            data.forEach(item => {
                let badges = item.comb.map(n => `<span class="pair-badge">${n.toString().padStart(2,'0')}</span>`).join('');
                html += `<tr><td>${badges}</td><td style="color:#c0392b; font-weight:bold; font-size:14px;">${item.count} æ¬¡</td><td>${item.rate}%</td></tr>`;
            });
            html += `</tbody></table></div>`;
            return html;
        };

        let poolBadges = pool.map(n => `<span class="pair-badge" style="background:#fbc02d; border-color:#f39c12;">${n.toString().padStart(2,'0')}</span>`).join(' ');

        let html = `
        <div class="report-section" id="analysis-box" style="border: 2px solid #8e44ad;">
            <div class="report-banner" style="background:#8e44ad;">
                <span>ğŸ’¡ æœ€ä½³çµ„åˆåˆ†æ (å–ç•¶å‰å ±è¡¨ä¸­æœ€ç†±é–€çš„å‰ ${pool.length} ç¢¼ç”¢ç”Ÿ)</span>
                <button class="btn" style="padding:2px 10px; font-size:12px; background:#fff; color:#000;" onclick="document.getElementById('analysis-result-area').innerHTML=''">âœ– é—œé–‰åˆ†æ</button>
            </div>
            <div style="padding: 12px 15px; background: #fdf2e9; border-bottom: 1px dashed #d35400; font-size:14px;">
                <strong style="color:#d35400;">ğŸ“Œ èƒå–æ¯é«” (ç†±é–€å‰ ${pool.length} ç¢¼)ï¼š</strong> ${poolBadges}
            </div>
            <div style="padding: 15px; display: flex; gap: 15px; flex-wrap: wrap; background:#fafafa;">
                ${buildTable(b2, '2ç¢¼ (2æ˜Ÿ)')}
                ${buildTable(b3, '3ç¢¼ (3æ˜Ÿ)')}
                ${buildTable(b4, '4ç¢¼ (4æ˜Ÿ)')}
                ${buildTable(b5, '5ç¢¼ (5æ˜Ÿ)')}
            </div>
        </div>`;

        area.innerHTML = html;
        area.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    function renderReports() {
        const area = document.getElementById('report-display-area');
        area.innerHTML = '';
        
        updateConditionFilterBar();

        const rawCat = currentConfig.cat.replace('å ±è¡¨', '');
        const lottoData = globalLottoData[rawCat] || [];
        
        if (lottoData.length === 0) {
            area.innerHTML = '<div style="padding:20px; text-align:center; color:#666;">è³‡æ–™è®€å–ä¸­... è‹¥é•·æ™‚é–“ç„¡åæ‡‰è«‹æª¢æŸ¥é€£ç·šç‹€æ…‹æˆ–é‡æ–°æ•´ç†</div>';
            return;
        }

        let filtered = reportsData.filter(r => r.owner === currentConfig.user && r.cat === rawCat);
        if (activeModeFilter !== 'å…¨éƒ¨') filtered = filtered.filter(r => r.mode === activeModeFilter);
        if (activeCondFilter !== 'å…¨éƒ¨') filtered = filtered.filter(r => r.value === activeCondFilter);
        
        filtered.forEach(data => {
            const sec = document.createElement('div');
            sec.className = 'report-section';
            sec.id = `report-sec-${data.id}`;
            const max = rawCat === '539' ? 39 : 49;
            
            const startYear = (currentConfig.user === "çˆ¸") ? 2020 : 2007;
            let endYear = 2026;
            if (lottoData.length > 0) {
                const maxDataYear = Math.max(...lottoData.map(d => d.year));
                if (maxDataYear > endYear) endYear = maxDataYear;
            }
            const years = [];
            for (let y = startYear; y <= endYear; y++) years.push(y);

            let html = `<div class="report-banner"><span>[${data.mode}] ${data.value}</span><button class="btn delete-btn" style="padding:2px 10px; font-size:12px; background:#fff; color:#000;" onclick="deleteReport(${data.id})">åˆªé™¤</button></div>`;
            
            if (data.mode === "æ‹–ç‰Œä¸‹æ¨") {
                const pushCount = data.pushN || 5;
                html += `<div class="table-container"><table class="report-table"><thead><tr><th style="width:120px;">ä¸‹æ¨æœŸæ•¸</th>${Array.from({length:max}, (_,i)=>`<th>${i+1}</th>`).join('')}</tr></thead><tbody>`;
                
                let periodStats = Array.from({length: pushCount}, () => new Array(max).fill(0));
                let totalSums = new Array(max).fill(0);
                let highLightCounts = new Array(max).fill(0);

                for(let i = 0; i < lottoData.length - pushCount; i++) {
                    let draw = lottoData[i];
                    if (matchHistoryQuery(draw, data.query.conds)) {
                        for(let k=1; k<=pushCount; k++) {
                            let nextDraw = lottoData[i+k];
                            nextDraw.nums.forEach(n => {
                                if(n>=1 && n<=max) {
                                    periodStats[k-1][n-1]++;
                                    totalSums[n-1]++;
                                }
                            });
                        }
                    }
                }

                for(let k=0; k<pushCount; k++) {
                    let rowData = periodStats[k];
                    let sorted = [...rowData].sort((a,b) => b-a);
                    let threshold = sorted[4]; 
                    
                    html += `<tr><td>ä¸‹æ¨ ${k+1} æœŸ</td>`;
                    for(let i=0; i<max; i++) {
                        let val = rowData[i];
                        let isTop = (val >= threshold && val > 0);
                        if(isTop) highLightCounts[i]++;
                        html += `<td class="${isTop ? 'top5-cell' : ''}">${val || ''}</td>`;
                    }
                    html += `</tr>`;
                }

                html += `<tr class="total-row"><td>ç¸½è¨ˆåŠ ç¸½</td>`;
                let sortedTotal = [...totalSums].sort((a,b) => b-a);
                let totalThreshold = sortedTotal[4];
                for(let i=0; i<max; i++) {
                    let isTop = (totalSums[i] >= totalThreshold && totalSums[i] > 0);
                    html += `<td class="${isTop ? 'total-top5' : ''}">${totalSums[i]}</td>`;
                }
                html += `</tr><tr class="accum-row"><td>é«˜äº®ç´¯ç©</td>`;
                for(let i=0; i<max; i++) html += `<td>${highLightCounts[i] || ''}</td>`;
                html += `</tr></tbody></table></div>`;
            }
            else if (data.mode === "ç•¶æœŸå°ç¢°" || data.mode === "ä¸‹æœŸå°ç¢°") {
                html += `<div class="quick-filter-area" data-export-ignore="true">
                            <span style="font-weight:bold; font-size:13px; margin-right:5px;">ğŸ¯ å¿«é€Ÿæ‰¾è™Ÿï¼š</span>
                            <button class="btn quick-btn active-blue" onclick="filterPairDisplay(${data.id}, 'ALL', this)">å…¨éƒ¨</button>`;
                for(let i=1; i<=max; i++) {
                    let ns = i.toString().padStart(2,'0');
                    html += `<button class="btn quick-btn" onclick="filterPairDisplay(${data.id}, '${ns}', this)">${ns}</button>`;
                }
                html += `</div>`;

                let pairCounts = {};
                for(let i=1; i<=max; i++) {
                    for(let j=i+1; j<=max; j++) {
                        let p = `${i.toString().padStart(2,'0')}ã€${j.toString().padStart(2,'0')}`;
                        pairCounts[p] = 0;
                    }
                }

                for(let i = 0; i < lottoData.length; i++) {
                    let draw = lottoData[i];
                    if (matchHistoryQuery(draw, data.query.conds)) {
                        let targetDraw = null;
                        if (data.mode === "ç•¶æœŸå°ç¢°") targetDraw = draw;
                        else if (data.mode === "ä¸‹æœŸå°ç¢°" && i < lottoData.length - 1) targetDraw = lottoData[i+1]; 

                        if (targetDraw) {
                            let nums = targetDraw.nums.sort((a,b)=>a-b);
                            for(let a=0; a<nums.length; a++) {
                                for(let b=a+1; b<nums.length; b++) {
                                    let n1 = nums[a]; let n2 = nums[b];
                                    if (n1>=1 && n1<=max && n2>=1 && n2<=max) {
                                        let p = `${n1.toString().padStart(2,'0')}ã€${n2.toString().padStart(2,'0')}`;
                                        if(pairCounts[p] !== undefined) pairCounts[p]++;
                                    }
                                }
                            }
                        }
                    }
                }

                let freqGroups = {};
                for (let p in pairCounts) {
                    let count = pairCounts[p];
                    if (!freqGroups[count]) freqGroups[count] = [];
                    freqGroups[count].push(p);
                }
                let sortedFreqs = Object.keys(freqGroups).map(Number).sort((a,b)=>b-a);

                html += `<div class="table-container"><table class="report-table">
                            <thead><tr><th style="width:150px; background:#e0e0e0;">çµ±è¨ˆçµæœ</th><th style="background:#e0e0e0;">çµ„åˆåˆ—è¡¨ (å…©ç¢¼åŒé–‹)</th></tr></thead><tbody>`;
                sortedFreqs.forEach(freq => {
                    let isZero = (freq === 0);
                    let label = isZero ? 'æœªå‡ºç¾ (0æ¬¡)' : `å…±å‡ºç¾ ${freq} æ¬¡`;
                    let color = isZero ? '#7f8c8d' : '#c0392b';
                    let pairsHtml = freqGroups[freq].map(pair => {
                        let parts = pair.split('ã€');
                        return `<span class="pair-badge" data-n1="${parts[0]}" data-n2="${parts[1]}">${pair}</span>`;
                    }).join(' ');
                    html += `<tr class="freq-row">
                                <td style="font-weight:bold; color:${color}; font-size:14px;">${label}</td>
                                <td style="text-align:left; padding:10px;">${pairsHtml}</td>
                             </tr>`;
                });
                html += `</tbody></table></div>`;
            } 
            else {
                html += `<div class="table-container"><table class="report-table"><thead><tr><th style="width:120px;">å¹´åº¦</th>${Array.from({length:max}, (_,i)=>`<th>${i+1}</th>`).join('')}</tr></thead><tbody>`;
                
                let columnTotals = new Array(max).fill(0);
                let accumTop5 = new Array(max).fill(0);
                let yearlyStats = {};
                years.forEach(y => yearlyStats[y] = new Array(max).fill(0));

                for(let i = 0; i < lottoData.length; i++) {
                    if (data.mode === "æ­·å²æ¨¡å¼" || data.mode === "ä¸»é«”") {
                        let draw = lottoData[i];
                        let targetYear = draw.year;
                        if (!years.includes(targetYear)) continue;

                        let isMatch = false;
                        if (data.mode === "æ­·å²æ¨¡å¼") isMatch = matchHistoryQuery(draw, data.query.conds);
                        else if (data.mode === "ä¸»é«”") isMatch = matchSingleCond(draw, data.query.main) && matchSingleCond(draw, data.query.sub);

                        if (isMatch) {
                            draw.nums.forEach(n => {
                                if (n >= 1 && n <= max) { yearlyStats[targetYear][n-1]++; columnTotals[n-1]++; }
                            });
                        }
                    } 
                    else if (data.mode === "æ‹–ç‰Œ" && i < lottoData.length - 1) {
                        let preDraw = lottoData[i];
                        let postDraw = lottoData[i+1];
                        let targetYear = postDraw.year;
                        if (!years.includes(targetYear)) continue;

                        if (matchDragQuery(preDraw, data.query.pre) && matchDragQuery(postDraw, data.query.post)) {
                            postDraw.nums.forEach(n => {
                                if (n >= 1 && n <= max) { yearlyStats[targetYear][n-1]++; columnTotals[n-1]++; }
                            });
                        }
                    }
                }

                years.forEach(y => {
                    html += `<tr><td>${y}å¹´</td>`;
                    let rowData = yearlyStats[y];
                    let sorted = [...rowData].sort((a,b) => b-a);
                    let threshold = sorted[4]; 

                    for(let i=0; i<max; i++) {
                        let val = rowData[i];
                        let isTop = (val >= threshold && val > 0);
                        if (isTop) accumTop5[i]++; 
                        html += `<td class="${isTop ? 'top5-cell' : ''}">${val === 0 ? '' : val}</td>`;
                    }
                    html += `</tr>`;
                });

                html += `<tr class="total-row"><td>ç¸½è¨ˆåŠ ç¸½</td>`;
                let sortedTotal = [...columnTotals].sort((a,b) => b-a);
                let totalThreshold = sortedTotal[4];
                for(let i=0; i<max; i++) {
                    let isTop = (columnTotals[i] >= totalThreshold && columnTotals[i] > 0);
                    html += `<td class="${isTop ? 'total-top5' : ''}">${columnTotals[i] === 0 ? '' : columnTotals[i]}</td>`;
                }
                html += `</tr><tr class="accum-row"><td>é«˜äº®ç´¯ç©</td>`;
                for(let i=0; i<max; i++) html += `<td>${accumTop5[i] === 0 ? '' : accumTop5[i]}</td>`;
                html += `</tr></tbody></table></div>`;
            }

            sec.innerHTML = html; 
            area.appendChild(sec);
        });
    }

    function filterByMode(mode, btn) {
        btn.parentElement.querySelectorAll('.btn').forEach(b => b.classList.remove('active-blue'));
        btn.classList.add('active-blue');
        activeModeFilter = mode;
        activeCondFilter = 'å…¨éƒ¨'; 
        renderReports();
    }

    function deleteReport(id) { reportsData = reportsData.filter(r => r.id !== id); saveAndRefresh(); }
    
    function clearReports() { 
        if(confirm("ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰å ±è¡¨ç´€éŒ„å—ï¼Ÿ")) { 
            reportsData = []; 
            localStorage.removeItem('lottoReports_v14'); 
            renderReports(); 
            document.getElementById('analysis-result-area').innerHTML = '';
            document.getElementById('overlap-analysis-area').innerHTML = '';
        } 
    }

    function exportToExcel() {
        let area = document.getElementById('report-display-area');
        if (!area || area.innerHTML.trim() === '') return alert('ç›®å‰æ²’æœ‰å ±è¡¨å¯ä»¥åŒ¯å‡ºï¼');

        let cloneArea = area.cloneNode(true);
        cloneArea.querySelectorAll('.delete-btn').forEach(el => el.remove());
        cloneArea.querySelectorAll('[data-export-ignore="true"]').forEach(el => el.remove());
        cloneArea.querySelectorAll('.pair-badge, .freq-row').forEach(el => {
            if (el.style.display === 'none') el.remove();
        });

        let excelTemplate = `
            <html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40">
            <head>
                <meta charset="UTF-8">
                <style>
                    table { border-collapse: collapse; width: 100%; margin-bottom: 20px; font-family: "Microsoft JhengHei", sans-serif; }
                    th, td { border: 1px solid #000; text-align: center; padding: 5px; font-size: 14px; }
                    th { background-color: #f2f2f2; color: #000000; }
                    .report-banner { background-color: #e0e0e0; color: #000000; font-weight: bold; font-size: 18px; padding: 10px; text-align: left; border: 1px solid #000000; }
                    .top5-cell { background-color: #fbc02d; font-weight: bold; color: #000000; }
                    .total-row td { background-color: #fbc02d; font-weight: bold; border-top: 2px solid #000; color: #000000; }
                    .accum-row td { background-color: #95e895; font-weight: bold; color: #000000; }
                    .pair-badge { font-weight: bold; color: #000000; }
                </style>
            </head>
            <body>${cloneArea.innerHTML}</body>
            </html>
        `;

        let blob = new Blob([excelTemplate], { type: 'application/vnd.ms-excel;charset=utf-8' });
        let link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `åˆ†æå ±è¡¨_${new Date().getTime()}.xls`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    function resetFilters() { document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active-yellow', 'active-green')); }

    window.addEventListener('keydown', (e) => {
        if (document.getElementById('app-content').style.display === 'block') {
            if(e.key === 'Enter') { e.preventDefault(); addToReport(); }
            if(e.key === 'Escape') { resetFilters(); }
        }
    });

</script>
</body>
</html>
