<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>539 專業回測系統 - GitHub 雲端同步版</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <style>
        :root { --bg: #d1e7d1; --blue-t: #2196F3; --red-box: #f44336; --gold: #ffc107; --green-border: #8bc34a; }
        /* 密碼遮罩 */
        #auth-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #2c3e50; z-index: 9999; display: flex; align-items: center; justify-content: center; }
        .auth-box { background: white; padding: 30px; border-radius: 10px; text-align: center; }
        
        body { background-color: var(--bg); font-family: "Microsoft JhengHei", sans-serif; font-size: 13px; margin: 15px; user-select: none; }
        .main-layout { display: flex; flex-direction: column; gap: 10px; }
        .filter-panel { border: 2px solid var(--red-box); background: #fff; padding: 15px; display: grid; grid-template-columns: 60px 1fr; gap: 8px; border-radius: 8px; }
        .f-label { background: #eee; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 1px solid #ccc; }
        .f-btns { display: flex; flex-wrap: wrap; gap: 4px; }
        .f-item { padding: 4px 12px; border: 1px solid #ccc; cursor: pointer; background: #fff; border-radius: 4px; position: relative; }
        .f-item.active { background: var(--blue-t); color: white; }
        .f-item.active::after { content: attr(data-order); position: absolute; top: -8px; right: -5px; background: #333; color: #fff; border-radius: 50%; width: 16px; height: 16px; font-size: 10px; display: flex; align-items: center; justify-content: center; border: 1px solid white; }
        
        .action-bar { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; background: rgba(255,255,255,0.5); padding: 10px; border-radius: 8px; }
        .yellow-btn { background: #ffff00; border: 1px solid #000; padding: 8px 15px; font-weight: bold; cursor: pointer; border-radius: 4px; }
        .yellow-btn.active { background: #ff9800 !important; color: white; }
        .add-btn { background: #4CAF50; color: white; border: 1px solid #000; padding: 8px 20px; font-weight: bold; cursor: pointer; display: none; border-radius: 4px; }
        
        .view-container { background: white; border: 2px solid var(--blue-t); padding: 10px; border-radius: 8px; min-height: 500px; }
        .scroll-area { overflow: auto; max-height: 450px; }
        table { border-collapse: collapse; width: 100%; white-space: nowrap; background: #fff; }
        th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
        .sum-row { background: #fff3e0; font-weight: bold; color: #e65100; }
        .top-hit { background-color: #ffff00 !important; font-weight: bold; }
        .hidden { display: none; }
        .report-card { border: 2px solid #333; margin-bottom: 30px; background: #fff; }
        .report-title { background: #7da7d8; padding: 10px; font-weight: bold; display: flex; justify-content: space-between; }
    </style>
</head>
<body oncontextmenu="return false" onkeydown="return checkForbiddenKeys(event)">

<div id="auth-overlay">
    <div class="auth-box">
        <h3>專業回測系統 - 身分驗證</h3>
        <input type="password" id="pwdInput" placeholder="請輸入密碼" style="padding:10px; margin-bottom:10px;"><br>
        <button onclick="verifyPassword()" style="padding:10px 20px; cursor:pointer;">登入系統</button>
    </div>
</div>

<div id="main-content" class="hidden">
    <div class="main-layout">
        <div style="display:flex; gap:5px;">
            <button onclick="switchPage('dist')" style="padding:10px 30px; cursor:pointer; font-weight:bold;">數據分佈圖</button>
            <button onclick="switchPage('repo')" style="padding:10px 30px; cursor:pointer; font-weight:bold;">匯總報表</button>
            <span id="sync-status" style="margin-left:auto; align-self:center; font-weight:bold; color:blue;">正在同步雲端資料...</span>
        </div>

        <div id="page-dist" class="view-container">
            <div class="filter-panel">
                <div class="f-label">週</div><div class="f-btns" data-type="week"></div>
                <div class="f-label">天干</div><div class="f-btns" data-type="tian"></div>
                <div class="f-label">地支</div><div class="f-btns" data-type="di"></div>
                <div class="f-label">節氣</div><div class="f-btns" data-type="solar"></div>
                <div class="f-label" style="color:blue">號碼</div><div class="f-btns" data-type="nums"></div>
            </div>
            <div class="action-bar">
                <button class="yellow-btn btn-mode-h" onclick="setMode('history')">歷史統計</button>
                <button class="yellow-btn btn-mode-t" onclick="setMode('tuopai')">拖牌模式</button>
                <button class="yellow-btn btn-mode-d_curr" onclick="setMode('duipeng_curr')">當期對碰</button>
                <button class="yellow-btn btn-mode-d" onclick="setMode('duipeng')">下期對碰</button>
                <button class="add-btn" id="btnAddRepo" onclick="generateBatchReport()">加入報表</button>
                <button onclick="clearFilters()">清空篩選</button>
            </div>
            <div class="scroll-area">
                <table>
                    <thead><tr id="thr"><th>期號</th><th>日期</th><th>週</th><th>天干</th><th>地支</th><th>節氣</th><th>球1</th><th>球2</th><th>球3</th><th>球4</th><th>球5</th></tr></thead>
                    <tbody id="gridBody"></tbody>
                </table>
            </div>
        </div>

        <div id="page-repo" class="view-container hidden">
            <div style="display:flex; gap:10px; background:#eee; padding:10px; margin-bottom:10px;">
                <button onclick="clearAllReports()" style="background:red; color:white; border:none; padding:8px 15px; cursor:pointer; font-weight:bold;">清空所有報表</button>
            </div>
            <div id="repo-list"></div>
        </div>
    </div>
</div>

<script>
    let db = [];
    let currentMode = null;
    let filters = { week:[], tian:[], di:[], solar:[], nums:[] };
    const GOOGLE_SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTuGa3v-rwH8Qh-JXF9MfxwUwT0A-iJooRI6ypJTErCsxN9qCjZQrgr70f16ZoehQ/pubhtml';

    // 1. 密碼驗證與防護
    function verifyPassword() {
        if(document.getElementById('pwdInput').value === '0912') {
            document.getElementById('auth-overlay').remove();
            document.getElementById('main-content').classList.remove('hidden');
            fetchCloudData();
        } else {
            alert('密碼錯誤！');
        }
    }

    function checkForbiddenKeys(e) {
        if (e.keyCode === 123 || (e.ctrlKey && (e.keyCode === 85 || e.keyCode === 83 || e.keyCode === 73))) {
            e.preventDefault();
            return false;
        }
    }

    // 2. 雲端資料抓取
    async function fetchCloudData() {
        try {
            const response = await fetch(GOOGLE_SHEET_URL);
            const html = await response.text();
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const table = doc.querySelector('table');
            
            // 轉換 Table 轉 JSON 
            const data = XLSX.utils.sheet_to_json(XLSX.utils.table_to_sheet(table), {header:1});
            
            // 過濾 A~K 欄 (0-10) 並清洗無用行
            db = data.filter(row => row[0] && !isNaN(parseInt(row[0]))).map(row => row.slice(0, 11));
            
            document.getElementById('sync-status').innerText = `✅ 雲端同步成功 (共 ${db.length} 期)`;
            document.getElementById('sync-status').style.color = 'green';
            renderGrid();
        } catch (e) {
            document.getElementById('sync-status').innerText = `❌ 同步失敗，請檢查網址或連線`;
            document.getElementById('sync-status').style.color = 'red';
        }
    }

    // 3. UI 邏輯與原有回測引擎
    function initUI() {
        const build = (type, list) => {
            const container = document.querySelector(`[data-type="${type}"]`);
            list.forEach(v => {
                const div = document.createElement('div'); div.className = 'f-item'; div.innerText = v;
                div.onclick = () => handleItem(div, type, v);
                container.appendChild(div);
            });
        };
        build('week', ['一','二','三','四','五','六','日']);
        build('tian', ['甲','乙','丙','丁','戊','己','庚','辛','壬','癸']);
        build('di', ['子','丑','寅','卯','辰','巳','午','未','申','酉','戌','亥']);
        let slist = []; for(let i=0; i<=15; i++) { slist.push('T'+i); slist.push('S'+i); }
        build('solar', slist);
        build('nums', Array.from({length:39}, (_,i)=>i+1));
        for(let i=1; i<=39; i++) {
            const th = document.createElement('th'); th.style.background = '#ffc107';
            th.innerHTML = `${i}<br><span id="s-${i}" style="font-size:10px; color:blue">0</span>`;
            document.getElementById('thr').appendChild(th);
        }
    }

    function handleItem(el, type, val) {
        if (!currentMode) return alert("請先選擇分析模式");
        const arr = filters[type]; const idx = arr.indexOf(val);
        if(idx > -1) { arr.splice(idx, 1); el.classList.remove('active'); el.removeAttribute('data-order'); }
        else {
            if((currentMode === 'tuopai' || currentMode === 'duipeng') && type !== 'nums' && arr.length >= 2) return alert("限選2個日期項目");
            arr.push(val); el.classList.add('active');
            if((currentMode === 'tuopai' || currentMode === 'duipeng') && type !== 'nums') el.setAttribute('data-order', arr.length);
        }
        applyFilter();
    }

    function applyFilter() {
        if(!db.length) return;
        let counts = Array(40).fill(0);
        document.querySelectorAll('#gridBody tr').forEach(tr => {
            const rowData = db[tr.id.split('-')[1]];
            let ok = true;
            ['week','tian','di','solar'].forEach(cat => {
                if(filters[cat].length > 0) ok &= filters[cat].some(v => String(rowData[['week','tian','di','solar'].indexOf(cat)+2]).includes(v));
            });
            const win = rowData.slice(6, 11).map(Number);
            if(filters.nums.length > 0) ok &= filters.nums.some(n => win.includes(Number(n)));
            tr.style.display = ok ? '' : 'none';
            if(ok) win.forEach(n => { if(n > 0) counts[n]++; });
        });
        for(let i=1; i<=39; i++) document.getElementById(`s-${i}`).innerText = counts[i];
    }

    function renderGrid() {
        const body = document.getElementById('gridBody'); body.innerHTML = '';
        db.forEach((row, idx) => {
            const tr = document.createElement('tr'); tr.id = `row-${idx}`;
            row.forEach((v, i) => {
                const td = document.createElement('td');
                td.innerText = v;
                tr.appendChild(td);
            });
            const win = row.slice(6,11).map(Number);
            for(let i=1; i<=39; i++){
                const td = document.createElement('td');
                if(win.includes(i)) { td.innerText = String(i).padStart(2,'0'); td.style.fontWeight='bold'; }
                tr.appendChild(td);
            }
            body.appendChild(tr);
        });
        applyFilter();
    }

    // 報表生成與加總邏輯（承襲之前修正）
    function generateBatchReport() {
        const list = document.getElementById('repo-list');
        const tid = Date.now();
        // 這裡會依照目前的 filter 生成報表（程式碼長度考量，簡化呈現歷史統計邏輯）
        const inner = [];
        ['week','tian','di','solar'].forEach(cat => {
            filters[cat].forEach(val => {
                let s = Array(40).fill(0), mCount = 0;
                const colIdx = ['week','tian','di','solar'].indexOf(cat)+2;
                db.forEach(r => {
                    const win = r.slice(6, 11).map(Number);
                    if(String(r[colIdx]).includes(val)) {
                        win.forEach(n => { if(n > 0) s[n]++; }); mCount++;
                    }
                });
                if(mCount > 0) inner.push({ label: `${getCatName(cat)}:${val}`, matches: mCount, data: s });
            });
        });
        if(inner.length) renderReportTable(list, `雲端回測分析`, inner, tid);
        switchPage('repo');
    }

    function renderReportTable(container, title, rows, id) {
        const card = document.createElement('div');
        card.className = 'report-card';
        let verticalSums = Array(40).fill(0);
        let html = `<div class="report-title"><span>${title}</span><button onclick="this.parentElement.parentElement.remove()">刪除</button></div>`;
        html += `<table><thead><tr style="background:#eee"><th>條件</th>${Array.from({length:39},(_,i)=>`<th>${i+1}</th>`).join('')}</tr></thead><tbody>`;
        rows.forEach(row => {
            html += `<tr><td style="text-align:left">${row.label} (${row.matches}期)</td>`;
            for(let i=1; i<=39; i++) {
                const v = row.data[i] || 0;
                verticalSums[i] += v;
                html += `<td>${v || ''}</td>`;
            }
            html += `</tr>`;
        });
        html += `<tr class="sum-row"><td>垂直加總</td>`;
        for(let i=1; i<=39; i++) html += `<td>${verticalSums[i]}</td>`;
        html += `</tr></tbody></table>`;
        card.innerHTML = html;
        container.insertBefore(card, container.firstChild);
    }

    function setMode(m) { currentMode = m; document.querySelectorAll('.yellow-btn').forEach(b => b.classList.remove('active')); document.querySelector(`.btn-mode-${m==='history'?'h':(m==='tuopai'?'t':(m==='duipeng_curr'?'d_curr':'d'))}`).classList.add('active'); document.getElementById('btnAddRepo').style.display = 'block'; clearFilters(); }
    function switchPage(p) { document.getElementById('page-dist').className = (p==='dist'?'view-container':'hidden'); document.getElementById('page-repo').className = (p==='repo'?'view-container':'hidden'); }
    function getCatName(c) { return {week:'週', tian:'天干', di:'地支', solar:'節氣'}[c]; }
    function clearFilters() { filters = { week:[], tian:[], di:[], solar:[], nums:[] }; document.querySelectorAll('.f-item').forEach(el => el.classList.remove('active')); applyFilter(); }
    function clearAllReports() { if(confirm("確定清空？")) document.getElementById('repo-list').innerHTML = ''; }

    initUI();
</script>
</body>
</html>
