<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>å°ˆæ¥­æ¨‚é€çµ±è¨ˆç³»çµ± V2.2 - å ±è¡¨é¡¯ç¤ºè¦æ ¼ç‰ˆï¼ˆç•¶æœŸå°ç¢°/ä¸‹æœŸå°ç¢°ä¿®æ­£ç‰ˆï¼‰</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <style>
    :root{
      --page-bg:#cfe8cf; --panel-bg:#fff8e8; --tab-bg:#ededed;
      --tab-border:#9a9a9a; --blue:#1f73ff; --red:#e51b1b;
      --line:#d0d0d0; --label:#efefef; --btn-border:#7a7a7a;
      --stat-green: #92d050; --stat-light: #e2efda;
      --top5-bg: #ff0000; --top5-text: #ffffff;
      --report-header-bg: #fce4d6;
    }
    *{ box-sizing:border-box; font-family:"Microsoft JhengHei"; }
    body{ margin:0; background:var(--page-bg); color:#111; }
    .tabs{ display:grid; grid-template-columns: repeat(4, 1fr); gap:16px; padding:10px 14px 0; }
    .tab{ height:44px; background:var(--tab-bg); border:1px solid var(--tab-border); display:flex; align-items:center; justify-content:center; font-weight:800; cursor:pointer; }
    .tab.active{ border-bottom:3px solid var(--red); background:#f2f2f2; }
    .container{ margin:10px 14px; border:1px solid var(--blue); border-radius:8px; background:var(--panel-bg); padding:10px; min-height: 80vh; }
    .page { display: none; }
    .page.active { display: block; }
    .filters-box{ border:2px solid var(--red); background:#fff; padding:12px; margin-bottom:10px; }
    .grid{ display:grid; grid-template-columns: 90px 1fr; row-gap:10px; }
    .lbl{ background:var(--label); border:1px solid var(--line); display:flex; align-items:center; justify-content:center; font-weight:900; height:36px; }
    .chips{ display:flex; flex-wrap:wrap; gap:8px; padding-left:10px; align-items:center; }
    .chip{ min-width:44px; height:34px; border:1px solid var(--line); border-radius:4px; display:flex; align-items:center; justify-content:center; cursor:pointer; font-weight:800; background:#fff; user-select:none; }
    .chip.on{ outline:3px solid var(--blue); background:#eef4ff; }
    .breakline{ flex-basis: 100%; height: 0; }
    .btnbar{ display:flex; flex-wrap:wrap; gap:8px; align-items:center; margin-top:10px; }
    .btn{ height:40px; padding:0 15px; border:1px solid var(--btn-border); border-radius:4px; font-weight:900; cursor:pointer; }
    .btn-orange{ background:#ffb300 !important; color:#000; }
    .btn-yellow{ background:#ffeb3b; }
    .btn-green{ background:#78c57a; }
    .btn-purple{ background:#6a44c6; color:#fff; }
    .btn-cyan { background:#00bcd4; color:#fff; }
    .btn-red{ background:#ff3b30; color:#fff; border-color:#b21b12; }

    .stat-title { color: red; font-weight: bold; margin-top: 15px; margin-bottom: 5px; }
    .stat-table { width: 100%; border-collapse: collapse; background: #fff; min-width: 800px; }
    .stat-table th, .stat-table td { border: 1px solid #000; text-align: center; padding: 2px; font-size: 11px; font-weight: bold; }
    .stat-table th { background: var(--stat-green); }
    .top5 { background-color: var(--top5-bg) !important; color: var(--top5-text) !important; }

    .report-item { margin-bottom: 30px; border: 1px solid #000; background: #fff; overflow-x: auto; }
    .report-header { background: var(--report-header-bg); padding: 8px; font-weight: bold; border-bottom: 1px solid #000; display:flex; gap:10px; align-items:center; }
    .report-header .title { flex:1; }
    .report-table { width:100%; border-collapse:collapse; font-size:11px; min-width: 1000px; }
    .report-table td { border:1px solid #000; text-align:center; padding:2px; }
    .cond-col { background:#ffff00; font-weight: bold; width: 420px; text-align: left; padding-left: 6px; }
    .sum-row { background:#ddebf7; font-weight:bold; }
    .hidden { display: none !important; }

    #loadingOverlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); display:none; justify-content:center; align-items:center; z-index:9999; font-weight:900; color:red; }

    /* ä¸»é«”/å‰¯é«” */
    .chip.mainpick{ outline: 4px solid #ff3b30 !important; background: #ffe5e3 !important; }
    .chip.subpick{ outline: 4px solid #00bcd4 !important; background: #e6fbff !important; }

    /* æ‹–ç‰Œ â‘ â‘¡ */
    .chip.drag1{ outline: 4px solid #6a44c6 !important; background:#f0e9ff !important; }
    .chip.drag2{ outline: 4px solid #2e7d32 !important; background:#e7f6e9 !important; }

    .mainSubBox{
      display:flex; flex-wrap:wrap; gap:8px; align-items:center;
      background:#fff7cc; border:1px dashed #b38b00; padding:8px; margin-bottom:10px;
      font-weight:900;
    }
    .mainSubHint{ color:#b21b12; }
  </style>
</head>
<body>

<div id="loadingOverlay">é›²ç«¯å¤§æ•¸æ“šé‹ç®—ä¸­...</div>

<div class="tabs">
  <div class="tab active" data-game="539" data-target="mainPage">ä»Šå½© 539</div>
  <div class="tab" data-game="539" data-target="reportPage">539 å ±è¡¨</div>
  <div class="tab" data-game="Lotto" data-target="mainPage">å¤§æ¨‚é€</div>
  <div class="tab" data-game="Lotto" data-target="reportPage">å¤§æ¨‚é€ å ±è¡¨</div>
</div>

<div class="container">
  <div id="mainPage" class="page active">
    <div id="gameTitle" style="color:red; font-weight:900; margin-bottom:10px;">ç›®å‰æ¨¡å¼ï¼šä»Šå½© 539</div>

    <div class="btnbar" style="margin-bottom:10px;">
      <button class="btn btn-cyan" id="mode-dad" onclick="switchUser('dad')">çˆ¸ä½¿ç”¨æ¨¡å¼</button>
      <button class="btn" id="mode-bro" onclick="switchUser('bro')">å“¥ä½¿ç”¨æ¨¡å¼</button>
    </div>

    <div class="mainSubBox">
      <button class="btn btn-red" id="btnMainArm" onclick="armMainPick()">ä¸»é«”</button>
      <button class="btn btn-cyan" id="btnSubMode" onclick="toggleSubMode()">å‰¯é«”(å¤šé¸)</button>
      <div id="mainSubStatus" class="mainSubHint">ä¸»é«”ï¼šæœªæŒ‡å®šï½œå‰¯é«”ï¼š0 å€‹ï½œæ‹–ç‰Œâ‘ â‘¡ï¼šæœªè¨­å®šï½œç‹€æ…‹ï¼šä¸€èˆ¬</div>
    </div>

    <div class="btnbar">
      <button class="btn btn-orange mode-btn" onclick="changeMode('æ­·å²æ¨¡å¼', this)">æ­·å²æ¨¡å¼</button>
      <button class="btn btn-yellow mode-btn" onclick="changeMode('æ‹–ç‰Œæ¨¡å¼', this)">æ‹–ç‰Œæ¨¡å¼</button>
      <button class="btn btn-yellow mode-btn" onclick="changeMode('ç•¶æœŸå°ç¢°', this)">ç•¶æœŸå°ç¢°</button>
      <button class="btn btn-yellow mode-btn" onclick="changeMode('ä¸‹æœŸå°ç¢°', this)">ä¸‹æœŸå°ç¢°</button>
      <button class="btn btn-green" onclick="addToReport()">ğŸ§ª åŠ å…¥å ±è¡¨</button>
      <button class="btn" onclick="clearFilters()">æ¸…ç©ºç¯©é¸</button>
    </div>

    <div class="filters-box"><div class="grid" id="filterGrid"></div></div>

    <div class="stat-title">å³æ™‚é‹ç®—çµ±è¨ˆ</div>
    <div style="overflow-x:auto">
      <table class="stat-table">
        <thead><tr id="stat-head-1"></tr></thead>
        <tbody><tr id="stat-body-1"></tr></tbody>
      </table>
    </div>

    <div class="stat-title">å…¨åŸŸæœªå‡ºæœŸæ•¸</div>
    <div style="overflow-x:auto">
      <table class="stat-table">
        <thead><tr id="stat-head-2"></tr></thead>
        <tbody><tr id="stat-body-2"></tr></tbody>
      </table>
    </div>
  </div>

  <div id="reportPage" class="page">
    <div id="reportControl" style="background:#ffd966; padding:8px; display:flex; flex-wrap:wrap; gap:10px; align-items:center; margin-bottom:10px; border:1px solid #999;">
      <button class="btn btn-green" onclick="exportToExcel()">åŒ¯å‡º Excel</button>
      <button class="btn" style="margin-left:auto; background:yellow" onclick="clearAllReports()">æ¸…ç©ºå ±è¡¨</button>
    </div>
    <div id="reportContainer"></div>
  </div>
</div>

<script>
let currentMode = "æ­·å²æ¨¡å¼", currentGame = "539", currentUser = "dad", maxNum = 39, cloudData = [];

const reportStorage = { dad: { "539": [], "Lotto": [] }, bro: { "539": [], "Lotto": [] } };

const sheetUrls = {
  "539": "https://docs.google.com/spreadsheets/d/e/2PACX-1vRhDtkfS1lZWSOtI58BCPr1Auwgsv-2SkuWNh9OWY6QnrwlMoNZwJcvs9voSH9wf1EkK53MyRVwNZPd/pub?gid=1316642624&single=true&output=csv",
  "Lotto": "https://docs.google.com/spreadsheets/d/e/2PACX-1vRhDtkfS1lZWSOtI58BCPr1Auwgsv-2SkuWNh9OWY6QnrwlMoNZwJcvs9voSH9wf1EkK53MyRVwNZPd/pub?gid=213544897&single=true&output=csv"
};

/* =========================
   ä¸»é«”/å‰¯é«” ç‹€æ…‹
   ========================= */
let pickState = "normal"; // normal | main_armed | sub
let mainPick = null;      // {cat, val}
let subPicks = [];        // [{cat,val}, ...]
function samePick(a,b){ return !!a && !!b && a.cat===b.cat && a.val===b.val; }

function setPickState(st){
  pickState = st;
  const btnMain = document.getElementById('btnMainArm');
  const btnSub  = document.getElementById('btnSubMode');
  if(btnMain) btnMain.classList.toggle('btn-orange', st === 'main_armed');
  if(btnSub)  btnSub.classList.toggle('btn-orange', st === 'sub');
  renderMainSubStatus();
}
// æŒ‰ä¸‹ä¸»é«”æŒ‰éˆ•æ™‚é€²è¡Œæ›´æ–°
function armMainPick() {
  setPickState("main_armed");

  // åˆ‡æ›æ¨¡å¼é¡¯ç¤ºç‚ºã€Œä¸»é«”æ¨¡å¼ã€
  changeMode("ä¸»é«”æ¨¡å¼", document.querySelector('.mode-btn'));

  // æ›´æ–°ç‹€æ…‹é¡¯ç¤º
  document.getElementById('filterCounter').textContent = `æ¨¡å¼ï¼šä¸»é«”æ¨¡å¼ | æ¢ä»¶æ•¸:${subPicks.length} | åƒèˆ‡çµ±è¨ˆæœŸæ•¸:${cloudData.length} | èµ·ç®—æ—¥:${startKeyByUser()}`;
}

function toggleSubMode(){
  if(!mainPick){ alert("è«‹å…ˆè¨­å®šä¸»é«”"); return; }
  setPickState(pickState === "sub" ? "normal" : "sub");
}
function clearMainSub(){
  mainPick = null;
  subPicks = [];
  document.querySelectorAll('.chip.mainpick').forEach(el=>el.classList.remove('mainpick'));
  document.querySelectorAll('.chip.subpick').forEach(el=>el.classList.remove('subpick'));
  setPickState("normal");
}

/* =========================
   æ‹–ç‰Œ â‘ â‘¡ï¼ˆä¸‹æœŸå°ç¢°ä¹Ÿç”¨ï¼‰
   ========================= */
let dragPick1 = null; // {cat,val}
let dragPick2 = null; // {cat,val}
function clearDragPair(){
  dragPick1 = dragPick2 = null;
  document.querySelectorAll('.chip.drag1').forEach(el=>el.classList.remove('drag1'));
  document.querySelectorAll('.chip.drag2').forEach(el=>el.classList.remove('drag2'));
  renderMainSubStatus();
}
function setDragPick(el, cat, val) {
  if (!dragPick1) {
    dragPick1 = { cat, val };
    el.classList.add('drag1');
    return;
  }
  if (dragPick1 && dragPick1.cat === cat && dragPick1.val === val) {
    dragPick1 = null;
    el.classList.remove('drag1');
    if (dragPick2) {
      const old2 = dragPick2;
      dragPick2 = null;
      document.querySelectorAll('.chip.drag2').forEach(x => x.classList.remove('drag2'));
      dragPick1 = old2;
      const node = document.querySelector(`.chips[data-label="${old2.cat}"] .chip[data-val="${cssEsc(old2.val)}"]`);
      if (node) node.classList.add('drag1');
    }
    return;
  }
  if (!dragPick2) {
    dragPick2 = { cat, val };
    el.classList.add('drag2');
    return;
  }
  const old2 = dragPick2;
  const oldNode2 = document.querySelector(`.chips[data-label="${old2.cat}"] .chip[data-val="${cssEsc(old2.val)}"]`);
  if (oldNode2) oldNode2.classList.remove('drag2');
  dragPick2 = { cat, val };
  el.classList.add('drag2');
}


/* =========================
   è™Ÿç¢¼é»æ“Šé †åºï¼ˆä¿æŒï¼Œä½†æœ¬æ¬¡è¦æ ¼ä¸å†ä¾ base å›ºå®šï¼‰
   ========================= */
let numOrder = [];
function updateNumOrder(num, isOn){
  const n = parseInt(num,10);
  if(!Number.isFinite(n)) return;
  if(isOn){
    numOrder = numOrder.filter(x=>x!==n);
    numOrder.push(n);
  }else{
    numOrder = numOrder.filter(x=>x!==n);
  }
}

function renderMainSubStatus() {
  const el = document.getElementById('mainSubStatus');
  if (!el) return;
  const mainStr = mainPick ? `${mainPick.cat}:${mainPick.val}` : "æœªæŒ‡å®š";
  const subStr = subPicks.length ? subPicks.map(s => `${s.cat}:${s.val}`).join('ã€') : "";
  const dragStr = (dragPick1 && dragPick2) ? `â‘ ${dragPick1.cat}:${dragPick1.val}ï½œâ‘¡${dragPick2.cat}:${dragPick2.val}` :
    (dragPick1 ? `â‘ ${dragPick1.cat}:${dragPick1.val}ï½œâ‘¡æœªè¨­å®š` : "æœªè¨­å®š");
  const stMap = { normal: "ä¸€èˆ¬", main_armed: "ç­‰å¾…ä¸»é«”ç¢ºèª", sub: "å‰¯é«”å¤šé¸ä¸­" };
  el.textContent = `ä¸»é«”ï¼š${mainStr}ï½œå‰¯é«”ï¼š${subPicks.length} å€‹${subPicks.length ? `ï¼ˆ${subStr}ï¼‰` : ``}ï½œæ‹–ç‰Œâ‘ â‘¡ï¼š${dragStr}ï½œç‹€æ…‹ï¼š${stMap[pickState] || pickState}`;
}


/* =========================
   æ—¥æœŸ / å¹²æ”¯
   ========================= */
function parseYMD(dateCell){
  const s = String(dateCell || "").trim();
  if(!s) return {y:"", m:"", d:""};
  const m1 = s.match(/^(\d{4})[\/\-\.](\d{1,2})[\/\-\.](\d{1,2})/);
  if(!m1) return {y:"", m:"", d:""};
  return { y:String(parseInt(m1[1],10)), m:String(parseInt(m1[2],10)), d:String(parseInt(m1[3],10)) };
}
function ymdKey(y,m,d){
  if(!y||!m||!d) return NaN;
  const yy=parseInt(y,10), mm=parseInt(m,10), dd=parseInt(d,10);
  if(!Number.isFinite(yy)||!Number.isFinite(mm)||!Number.isFinite(dd)) return NaN;
  return yy*10000 + mm*100 + dd;
}
function calcWeekday(y,m,d){
  if(!y||!m||!d) return "";
  const dt=new Date(parseInt(y,10), parseInt(m,10)-1, parseInt(d,10));
  if(Number.isNaN(dt.getTime())) return "";
  const map=["æ—¥","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­"];
  return map[dt.getDay()];
}
const STEMS=["ç”²","ä¹™","ä¸™","ä¸","æˆŠ","å·±","åºš","è¾›","å£¬","ç™¸"];
const BRANCHES=["å­","ä¸‘","å¯…","å¯","è¾°","å·³","åˆ","æœª","ç”³","é…‰","æˆŒ","äº¥"];
function jdnFromYMD(y,m,d){
  const Y=parseInt(y,10), M=parseInt(m,10), D=parseInt(d,10);
  if(!Number.isFinite(Y)||!Number.isFinite(M)||!Number.isFinite(D)) return NaN;
  const a=Math.floor((14-M)/12);
  const yy=Y+4800-a;
  const mm=M+12*a-3;
  return D + Math.floor((153*mm+2)/5) + 365*yy + Math.floor(yy/4) - Math.floor(yy/100) + Math.floor(yy/400) - 32045;
}
const BASE_JDN = jdnFromYMD("1984","2","2");
function ganzhiOfDay(y,m,d){
  const jdn=jdnFromYMD(y,m,d);
  if(!Number.isFinite(jdn)||!Number.isFinite(BASE_JDN)) return {stem:"", branch:""};
  let idx=(jdn-BASE_JDN)%60; if(idx<0) idx+=60;
  return { stem: STEMS[idx%10], branch: BRANCHES[idx%12] };
}
function extractJieqiFromRow(row){
  if(currentUser!=="dad") return "";
  const re=/^(S|T)(?:[0-9]|1[0-5])$/i;
  const v=String(row[5]??"").trim();
  if(re.test(v)) return v.toUpperCase();
  for(let i=2;i<=5;i++){
    const vv=String(row[i]??"").trim();
    if(re.test(vv)) return vv.toUpperCase();
  }
  return "";
}
function buildJieqiOptions(){
  const S=Array.from({length:16},(_,i)=>`S${i}`);
  const T=Array.from({length:16},(_,i)=>`T${i}`);
  return [...S,...T];
}
function startKeyByUser(){ return (currentUser==="dad") ? 20200101 : 20060101; }
function startYearByUser(){ return (currentUser==="dad") ? 2020 : 2006; }

/* =========================
   çƒè™Ÿè®€å–
   ========================= */
function requiredBallCount(){ return (currentGame==="539") ? 5 : 6; }
function rowBalls(row){
  let limit=(currentGame==="539") ? 39 : 49;
  let endIdx=(currentGame==="539") ? 11 : 13;
  return row.slice(6,endIdx)
    .map(v=>parseInt(String(v).trim(),10))
    .filter(n=>!isNaN(n) && n>0 && n<=limit);
}
function hasEnoughBalls(row){ return rowBalls(row).length >= requiredBallCount(); }
function getValidRows() {
  const sk = startKeyByUser();
  return cloudData.filter(row => {
    if (!row || row.length < 7) return false;
    const { y, m, d } = parseYMD(row[1]);
    let k = ymdKey(y, m, d);
    if (isNaN(k)) {
      const alt = parseYMD(row[0]);
      k = ymdKey(alt.y, alt.m, alt.d);
    }
    if (!Number.isFinite(k) || k < sk) return false;
    if (!hasEnoughBalls(row)) return false;

    // åœ¨æ­¤è™•é€²è¡Œæ¢ä»¶çš„éæ¿¾
    const selectedFilters = getSelectedFilters();
    let match = true;
    Object.keys(selectedFilters).forEach(filter => {
      if (filter !== "è™Ÿç¢¼" && !selectedFilters[filter].includes(row[filter])) {
        match = false;
      }
    });

    return match;
  });
}



/* =========================
   âœ… Excel å°é½Šï¼šå„ªå…ˆç”¨æ¬„ä½å€¼
   ========================= */
function normWeek(v){
  const s=String(v??"").trim();
  if(!s) return "";
  const m=s.match(/([æ—¥ä¸€äºŒä¸‰å››äº”å…­])$/);
  return m ? m[1] : "";
}
function normJieqi(v){
  const s=String(v??"").trim().toUpperCase();
  return /^(S|T)(?:[0-9]|1[0-5])$/.test(s) ? s : "";
}
function rowMetaFromRow(row){
  let {y,m,d}=parseYMD(row[1]);
  if(!y){ const alt=parseYMD(row[0]); y=alt.y; m=alt.m; d=alt.d; }

  let w=calcWeekday(y,m,d);
  const gz=ganzhiOfDay(y,m,d);
  let stem=gz.stem, branch=gz.branch;
  let jieqi=extractJieqiFromRow(row);

  const w2=normWeek(row[2]); if(w2) w=w2;
  const s2=String(row[3]??"").trim(); if(STEMS.includes(s2)) stem=s2;
  const b2=String(row[4]??"").trim(); if(BRANCHES.includes(b2)) branch=b2;
  const jq2=normJieqi(row[5]); if(jq2) jieqi=jq2;

  return {y,m,d,w,stem,branch,jieqi};
}
function buildRd(meta){
  const rd={"å¹´ä»½":meta.y,"æœˆä»½":meta.m,"æ—¥æœŸ":meta.d,"æ˜ŸæœŸ":meta.w,"å¤©å¹²":meta.stem,"åœ°æ”¯":meta.branch};
  if(currentUser==="dad") rd["ç¯€æ°£"]=meta.jieqi;
  return rd;
}
function matchFilters(rd, filters){
  for(const k in filters){
    if(!filters[k].includes(rd[k])) return false;
  }
  return true;
}

function newGroup(mode, title){
  const gLimit=(currentGame==="539") ? 39 : 49;
  return { id:`${Date.now()}_${Math.random().toString(16).slice(2)}`, mode, title, limit:gLimit, rows:[], sum:Array(gLimit+1).fill(0) };
}
function addRowToGroup(group, label, dataArr){
  group.rows.push({label, data:dataArr});
  for(let i=1;i<=group.limit;i++) group.sum[i]+= (dataArr[i]||0);
}

function getSelectedFilters(){
  const filters = {};
  const keys = (currentUser === "dad") ? ["å¹´ä»½", "æœˆä»½", "æ—¥æœŸ", "æ˜ŸæœŸ", "å¤©å¹²", "åœ°æ”¯", "ç¯€æ°£"] : ["å¹´ä»½", "æœˆä»½", "æ—¥æœŸ", "æ˜ŸæœŸ", "å¤©å¹²", "åœ°æ”¯"];
  keys.forEach(lbl => {
    const sel = Array.from(document.querySelectorAll(`.chips[data-label="${lbl}"] .chip.on`)).map(c => String(c.textContent).trim());
    if (sel.length) filters[lbl] = sel;
  });
  return filters;
}

function getSelectedNums(){
  return Array.from(document.querySelectorAll(`.chips[data-label="è™Ÿç¢¼"] .chip.on`))
    .map(c=>parseInt(c.textContent,10))
    .filter(n=>Number.isFinite(n));
}

/* =========================
   UI init
   ========================= */
function switchUser(role){
  currentUser=role;
  document.getElementById('mode-dad').classList.toggle('btn-cyan', role==='dad');
  document.getElementById('mode-bro').classList.toggle('btn-cyan', role==='bro');
  clearMainSub(); clearDragPair();
  initFilters(); updateStats();
}

function initFilters(){
  maxNum = (currentGame === "539") ? 39 : 49;
  document.getElementById('gameTitle').textContent = `ç›®å‰æ¨¡å¼ï¼š${currentGame} - ${currentMode}`;
  const grid = document.getElementById('filterGrid'); 
  grid.innerHTML = '';  // æ¸…ç©ºä¹‹å‰çš„ç¯©é¸é …

  const yStart = startYearByUser(), yEnd = 2026;
  const years = Array.from({ length: yEnd - yStart + 1 }, (_, i) => yStart + i);

  const sections = [
    { lbl: "å¹´ä»½", d: years },
    { lbl: "æœˆä»½", d: Array.from({ length: 12 }, (_, i) => i + 1) },
    { lbl: "æ—¥æœŸ", d: Array.from({ length: 31 }, (_, i) => i + 1), brk: 18 },
    { lbl: "æ˜ŸæœŸ", d: currentGame === "Lotto" ? ["äºŒ", "äº”"] : ["ä¸€", "äºŒ", "ä¸‰", "å››", "äº”", "å…­", "æ—¥"] },  // åªé¡¯ç¤ºäºŒã€äº”
    { lbl: "å¤©å¹²", d: STEMS },
    { lbl: "åœ°æ”¯", d: BRANCHES },
    { lbl: "ç¯€æ°£", d: buildJieqiOptions(), brk: 16 },
    { lbl: "è™Ÿç¢¼", d: Array.from({ length: maxNum }, (_, i) => String(i + 1).padStart(2, '0')), brk: 25 }
  ];

  sections.forEach(sec => {
    const isSB = (sec.lbl === "å¤©å¹²" || sec.lbl === "åœ°æ”¯");
    const isJQ = (sec.lbl === "ç¯€æ°£");
    const hidden = (currentUser === "bro" && (isSB || isJQ)) ? "hidden" : "";
    grid.innerHTML += `<div class="lbl ${hidden}">${sec.lbl}</div>`;
    let html = `<div class="chips ${hidden}" data-label="${sec.lbl}">`;
    sec.d.forEach((v, i) => {
      if (sec.brk && i === sec.brk) html += `<div class="breakline"></div>`;
      html += `<div class="chip" data-val="${v}" onclick="toggleChip(this)">${v}</div>`;
    });
    grid.innerHTML += html + `</div>`;
  });

  updateStatTableUI();
  syncModeButtons();
  renderMainSubStatus();
}


function updateStatTableUI(){
  const h1=document.getElementById('stat-head-1'), b1=document.getElementById('stat-body-1');
  const h2=document.getElementById('stat-head-2'), b2=document.getElementById('stat-body-2');
  h1.innerHTML=b1.innerHTML=h2.innerHTML=b2.innerHTML='';
  for(let i=1;i<=maxNum;i++){
    h1.innerHTML += `<th>${i}</th>`; b1.innerHTML += `<td id="val1-${i}">0</td>`;
    h2.innerHTML += `<th>${i}</th>`; b2.innerHTML += `<td id="val2-${i}">0</td>`;
  }
}

function toggleChip(el){
  const cat = el?.parentElement?.dataset?.label || "";
  const val = String(el?.dataset?.val ?? el?.textContent ?? "").trim();
  const isNumber = (cat === "è™Ÿç¢¼");

  // æ‹–ç‰Œæ¨¡å¼æˆ–ä¸‹æœŸå°ç¢°æ¨¡å¼ï¼šéè™Ÿç¢¼ chip ç”¨ä¾†è¨­å®š â‘ â‘¡
  if (!isNumber && (currentMode === "æ‹–ç‰Œæ¨¡å¼" || currentMode === "ä¸‹æœŸå°ç¢°") && pickState === "normal") {
    setDragPick(el, cat, val);
    renderMainSubStatus();
    return;
  }

  // ä¸»é«”æ¨¡å¼é¸æ“‡
  if (!isNumber && pickState === "main_armed") {
    const ok = confirm(`è¨­å®šã€Œä¸»é«”ã€ç‚ºï¼š${cat}ï¼š${val} ï¼Ÿ`);
    if (!ok) return;
    document.querySelectorAll('.chip.mainpick').forEach(x => x.classList.remove('mainpick'));
    document.querySelectorAll('.chip.subpick').forEach(x => x.classList.remove('subpick'));
    subPicks = [];
    mainPick = { cat, val };
    el.classList.add('mainpick');

    // ä¸»é«”ä¿æŒé¸ä¸­ç‹€æ…‹
    const box = el.parentElement;
    if (box) box.querySelectorAll('.chip.on').forEach(x => x.classList.remove('on'));
    el.classList.add('on');

    setPickState("sub");
    updateStats();
    return;
  }

  // å‰¯é«”å¤šé¸ï¼ˆä¸å½±éŸ¿ onï¼‰
  if (!isNumber && pickState === "sub") {
    if (!mainPick) { alert("è«‹å…ˆè¨­å®šä¸»é«”"); setPickState("normal"); return; }
    if (samePick(mainPick, { cat, val })) return;
    const idx = subPicks.findIndex(s => samePick(s, { cat, val }));
    if (idx >= 0) { subPicks.splice(idx, 1); el.classList.remove('subpick'); }
    else { subPicks.push({ cat, val }); el.classList.add('subpick'); }
    renderMainSubStatus();
    return;
  }

  // è™Ÿç¢¼é¸æ“‡ï¼šåªåœ¨è™Ÿç¢¼ç¯©é¸æ™‚é€²è¡Œæ“ä½œ
  el.classList.toggle('on');
  if (isNumber) updateNumOrder(val, el.classList.contains('on'));
  updateStats();
}

function fetchSheetData(callback){
  document.getElementById('loadingOverlay').style.display='flex';
  Papa.parse(sheetUrls[currentGame] + "&t=" + Date.now(),{
    download:true, header:false, skipEmptyLines:true,
    complete:function(results){
      document.getElementById('loadingOverlay').style.display='none';
      cloudData=results.data.slice(1);
      if(callback) callback(results.data[results.data.length-1]);
      updateStats();
    }
  });
}

function updateStats(){
  if(!cloudData.length) return;
  const filters=getSelectedFilters();
  const catCount=Object.keys(filters).length;
  const selNums=getSelectedNums();
  const counts=Array(maxNum+1).fill(0);
  const validRows=getValidRows();

  validRows.forEach((row,idx)=>{
    const meta=rowMetaFromRow(row);
    const rd=buildRd(meta);
    if(!matchFilters(rd, filters)) return;

    const nums=rowBalls(row);
    if(currentMode==="æ­·å²æ¨¡å¼"){
      nums.forEach(n=>{ if(n<=maxNum) counts[n]++; });
    }else if(currentMode==="æ‹–ç‰Œæ¨¡å¼" || currentMode==="ä¸‹æœŸå°ç¢°"){
      // é€™è£¡å³æ™‚çµ±è¨ˆç¶­æŒä½ åŸæœ¬ï¼ˆé¸è™Ÿå¸¶ä¸‹ä¸€æœŸï¼‰ï¼›å ±è¡¨æ‰ç”¨æ–°è¦æ ¼
      if(selNums.length>0 && selNums.some(sn=>nums.includes(sn))){
        const nxt=validRows[idx+1];
        if(nxt) rowBalls(nxt).forEach(n=>{ if(n<=maxNum) counts[n]++; });
      }
    }else{ // ç•¶æœŸå°ç¢°
      if(selNums.length>0 && selNums.every(sn=>nums.includes(sn))){
        nums.forEach(n=>{ if(n<=maxNum) counts[n]++; });
      }
    }
  });

  const sorted=[...counts].sort((a,b)=>b-a);
  const threshold=sorted[4]>0 ? sorted[4] : 999;
  const sk=startKeyByUser();
  const skStr=`${String(Math.floor(sk/10000))}/${String(Math.floor((sk%10000)/100)).padStart(2,'0')}/${String(sk%100).padStart(2,'0')}`;
  document.getElementById('filterCounter').textContent =
    `æ¨¡å¼:${currentMode} | æ¢ä»¶æ•¸:${catCount} | åƒèˆ‡çµ±è¨ˆæœŸæ•¸:${validRows.length} | èµ·ç®—æ—¥:${skStr}`;

  for(let i=1;i<=maxNum;i++){
    const td=document.getElementById(`val1-${i}`);
    td.textContent=counts[i]||0;
    td.className=(counts[i]>=threshold && counts[i]>0) ? "top5" : "";
    let gap=0;
    for(let j=validRows.length-1;j>=0;j--){
      if(rowBalls(validRows[j]).includes(i)) break;
      gap++;
    }
    document.getElementById(`val2-${i}`).textContent=gap;
  }
  renderMainSubStatus();
}

/* =========================
   å ±è¡¨è¨ˆç®—å™¨
   ========================= */

// æ­·å²ï¼šå–®æ¢ä»¶
function computeHistorySingle(validRows, cat, val, gameMax){
  const counts=Array(gameMax+1).fill(0);
  validRows.forEach(row=>{
    const rd=buildRd(rowMetaFromRow(row));
    if(String(rd[cat]) !== String(val)) return;
    rowBalls(row).forEach(n=>{ if(n<=gameMax) counts[n]++; });
  });
  return counts;
}

// ä¸»é«”ï¼š2æ¢ä»¶
function computeHistoryTwo(validRows, a, b, gameMax){
  const filters={};
  filters[a.cat]=[String(a.val)];
  filters[b.cat]=[String(b.val)];
  const counts=Array(gameMax+1).fill(0);
  validRows.forEach(row=>{
    const rd=buildRd(rowMetaFromRow(row));
    if(!matchFilters(rd, filters)) return;
    rowBalls(row).forEach(n=>{ if(n<=gameMax) counts[n]++; });
  });
  return counts;
}

// æ‹–ç‰Œï¼šâ‘ æ¢ä»¶ + å‰è™Ÿnum â†’ â‘¡æ¢ä»¶ï¼ˆä¸‹ä¸€æœŸï¼‰
function computeDrag(validRows, cond1, cond2, num, gameMax){
  const f1={}; f1[cond1.cat]=[String(cond1.val)];
  const f2={}; f2[cond2.cat]=[String(cond2.val)];
  const counts=Array(gameMax+1).fill(0);

  for(let i=0;i<validRows.length-1;i++){
    const row=validRows[i];
    const nxt=validRows[i+1];
    const rd1=buildRd(rowMetaFromRow(row));
    const rd2=buildRd(rowMetaFromRow(nxt));
    if(!matchFilters(rd1, f1)) continue;
    if(!matchFilters(rd2, f2)) continue;

    const balls=rowBalls(row);
    if(!balls.includes(num)) continue;

    rowBalls(nxt).forEach(n=>{ if(n<=gameMax) counts[n]++; });
  }
  return counts;
}

// âœ… ä¸‹æœŸå°ç¢°ï¼šâ‘ æ¢ä»¶ + å‰è™Ÿ(a,b åŒæ™‚å‡ºç¾) â†’ â‘¡æ¢ä»¶ï¼ˆä¸‹ä¸€æœŸï¼‰
function computeNextPair(validRows, cond1, cond2, a, b, gameMax){
  const f1={}; f1[cond1.cat]=[String(cond1.val)];
  const f2={}; f2[cond2.cat]=[String(cond2.val)];
  const counts=Array(gameMax+1).fill(0);

  // éæ­·æ¯ä¸€è¡Œè³‡æ–™ï¼Œä¸¦æª¢æŸ¥å‰ä¸€è¡Œæ˜¯å¦ç¬¦åˆæ¢ä»¶
  for(let i=0;i<validRows.length-1;i++){
    const row=validRows[i];
    const nxt=validRows[i+1];
    const rd1=buildRd(rowMetaFromRow(row)); // ç•¶å‰è¡Œ
    const rd2=buildRd(rowMetaFromRow(nxt)); // ä¸‹ä¸€è¡Œ
    if(!matchFilters(rd1, f1)) continue;  // ç¢ºèªç•¶å‰è¡Œç¬¦åˆæ¢ä»¶
    if(!matchFilters(rd2, f2)) continue;  // ç¢ºèªä¸‹ä¸€è¡Œç¬¦åˆæ¢ä»¶

    const balls=rowBalls(row);  // ç²å–ç•¶å‰è¡Œè™Ÿç¢¼
    if(!(balls.includes(a) && balls.includes(b))) continue; // ç¢ºä¿å‰æœŸè™Ÿç¢¼åŒ…å« a å’Œ b

    rowBalls(nxt).forEach(n=>{ if(n<=gameMax) counts[n]++; });  // è¨ˆç®—ç¬¦åˆæ¢ä»¶çš„è™Ÿç¢¼å‡ºç¾æ¬¡æ•¸
  }
  return counts;
}


// âœ… ç•¶æœŸå°ç¢°ï¼šfilters(äº¤é›†) + 2ç¢¼åŒåˆ—å‡ºç¾ â†’ çµ±è¨ˆåŒåˆ—çƒè™Ÿ
function computePairSameRow(validRows, filters, a, b, gameMax){
  const counts=Array(gameMax+1).fill(0);
  validRows.forEach(row=>{
    const rd=buildRd(rowMetaFromRow(row));
    if(!matchFilters(rd, filters)) return; // ç¹¼çºŒç¯©é¸æ¢ä»¶
    const balls=rowBalls(row);
    if(!(balls.includes(a) && balls.includes(b))) return; // ç¢ºä¿å…©å€‹è™Ÿç¢¼åœ¨åŒä¸€åˆ—ä¸­
    balls.forEach(n=>{ if(n<=gameMax) counts[n]++; });  // æ›´æ–°è¨ˆæ•¸
  });
  return counts;
}


// çµ„åˆï¼šå…¨éƒ¨ 2ç¢¼é…å°ï¼ˆä¸å›ºå®š baseï¼‰
function buildAllPairs(nums){
  const arr=[...nums].filter(n=>Number.isFinite(n)).sort((a,b)=>a-b);
  const out=[];
  for(let i=0;i<arr.length;i++){
    for(let j=i+1;j<arr.length;j++){
      out.push([arr[i], arr[j]]);
    }
  }
  return out;
}

/* =========================
   addToReportï¼šæŒ‰ä¸€æ¬¡åªæ–°å¢ 1 å¼µå ±è¡¨ï¼ˆä¾æ¨¡å¼è¦å‰‡ç”¢ç”Ÿå¤šåˆ—ï¼‰
   ========================= */
function addToReport(){
  if(!cloudData.length) return alert("å°šæœªè¼‰å…¥è³‡æ–™");
  const validRows = getValidRows();
  if(!validRows.length) return alert("ç„¡æœ‰æ•ˆè³‡æ–™åˆ—");
  const gameMax = (currentGame === "539") ? 39 : 49;
  const group = newGroup(currentMode, `ã€${currentMode}ã€‘${currentGame}`);

// æ­·å²æ¨¡å¼åŠ åˆ°å ±è¡¨ï¼Œæ‡‰è©²ç¢ºä¿è³‡æ–™æ­£ç¢ºåœ°å‚³éä¸¦ç¯©é¸
if(currentMode === "æ­·å²æ¨¡å¼"){
  const filters = getSelectedFilters();
  const entries = [];
  Object.entries(filters).forEach(([cat, vals]) => vals.forEach(v => entries.push({cat, val:v})));
  if(entries.length === 0) return alert("è«‹å…ˆé¸æ“‡è‡³å°‘ 1 å€‹æ¢ä»¶");

  entries.forEach(e => {
    const counts = computeHistorySingle(validRows, e.cat, e.val, gameMax);
    if(counts.some(count => count > 0)) {  // ç¢ºä¿æœ‰æœ‰æ•ˆçš„è³‡æ–™
      addRowToGroup(group, `${e.cat}:${e.val}`, counts);
    }
  });
  group.title = `ã€æ­·å²æ¨¡å¼ã€‘${entries.map(e => `${e.cat}:${e.val}`).join('ã€')}`;
}


  // 2) ä¸»é«”æ¨¡å¼ï¼šæ¯å€‹ä¸»é«”èˆ‡å‰¯é«”çµ„åˆå„ä¸€åˆ—ï¼ˆ2æ¢ä»¶çµ±è¨ˆï¼‰
  else if(mainPick && subPicks.length > 0){
    subPicks.forEach(s => {
      // è¨ˆç®—ä¸»é«”èˆ‡å‰¯é«”çµ„åˆ
      const counts = computeHistoryTwo(validRows, mainPick, s, gameMax);
      addRowToGroup(group, `${mainPick.cat}:${mainPick.val} + ${s.cat}:${s.val}`, counts);
    });
    group.title = `ã€ä¸»é«”æ¨¡å¼ã€‘ä¸»:${mainPick.cat}:${mainPick.val}ï½œå‰¯:${subPicks.map(s => `${s.cat}:${s.val}`).join('ã€')}`;
  }

  // 3) æ‹–ç‰Œæ¨¡å¼ï¼šâ‘ â‘¡æ¢ä»¶ + æ¯å€‹è™Ÿç¢¼ä¸€åˆ—ï¼ˆåŸæ‹–ç‰Œï¼‰
  else if(currentMode === "æ‹–ç‰Œæ¨¡å¼"){
    if(!dragPick1 || !dragPick2) return alert("æ‹–ç‰Œæ¨¡å¼ï¼šè«‹å…ˆç”¨é»æ“Šé †åºè¨­å®š â‘  å’Œ â‘¡ æ¢ä»¶ï¼ˆéè™Ÿç¢¼å€ï¼‰ã€‚");
    const nums = getSelectedNums();
    if(nums.length === 0) return alert("æ‹–ç‰Œæ¨¡å¼ï¼šè«‹å…ˆåœ¨ã€è™Ÿç¢¼ã€‘å€é¸è‡³å°‘ 1 å€‹å‰æœŸè™Ÿç¢¼ã€‚");
    nums.forEach(n => {
      const counts = computeDrag(validRows, dragPick1, dragPick2, n, gameMax);
      addRowToGroup(group, `â‘ ${dragPick1.cat}:${dragPick1.val} + å‰è™Ÿ:${String(n).padStart(2, '0')} â†’ â‘¡${dragPick2.cat}:${dragPick2.val}`, counts);
    });
    group.title = `ã€æ‹–ç‰Œæ¨¡å¼ã€‘â‘ ${dragPick1.cat}:${dragPick1.val} â†’ â‘¡${dragPick2.cat}:${dragPick2.val}ï½œå‰è™Ÿ:${nums.map(n => String(n).padStart(2, '0')).join(',')}`;
  }

  else if(currentMode === "ç•¶æœŸå°ç¢°"){
  const filters = getSelectedFilters();
  const nums = getSelectedNums();
  const pairs = buildAllPairs(nums);
  if(pairs.length === 0) return alert("ç•¶æœŸå°ç¢°ï¼šè«‹è‡³å°‘é¸ 2 å€‹è™Ÿç¢¼ã€‚");

  const entries = [];
  Object.entries(filters).forEach(([cat, vals]) => vals.forEach(v => entries.push({cat, val:v})));
  if(entries.length === 0) return alert("ç•¶æœŸå°ç¢°ï¼šè«‹è‡³å°‘é¸ 1 å€‹æ¢ä»¶ï¼ˆä¾‹å¦‚æœˆä»½/æ˜ŸæœŸ/å¤©å¹²/åœ°æ”¯/ç¯€æ°£ï¼‰ã€‚");

  entries.forEach(entry => {
    pairs.forEach(([a, b]) => {
      // ç§»é™¤å…¶é¤˜æ¢ä»¶äº¤é›†ï¼Œç›´æ¥çµ±è¨ˆé€™å€‹æ¢ä»¶ä¸‹çš„2å€‹è™Ÿç¢¼
      const counts = computePairSameRow(validRows, { [entry.cat]: [String(entry.val)] }, a, b, gameMax);
      addRowToGroup(group, `${entry.cat}:${entry.val} + è™Ÿç¢¼:${String(a).padStart(2, '0')},${String(b).padStart(2, '0')}`, counts);
    });
  });
  group.title = `ã€ç•¶æœŸå°ç¢°ã€‘æ¢ä»¶æ•¸:${entries.length}ï½œ2ç¢¼çµ„åˆ:${pairs.length}ï¼ˆå…±${entries.length * pairs.length}åˆ—ï¼‰`;
}


  // 5) ä¸‹æœŸå°ç¢°ï¼šåƒæ‹–ç‰Œï¼Œä½†å‰æœŸå¿…é ˆ 2ç¢¼åŒæ™‚å‡ºç¾æ‰å¸¶ä¸‹ä¸€æœŸï¼Œä¸” 5ç¢¼å…¨éƒ¨å…©å…©é…
  else if(currentMode === "ä¸‹æœŸå°ç¢°"){
    if(!dragPick1 || !dragPick2) return alert("ä¸‹æœŸå°ç¢°ï¼šè«‹å…ˆç”¨é»æ“Šé †åºè¨­å®š â‘  å’Œ â‘¡ æ¢ä»¶ï¼ˆéè™Ÿç¢¼å€ï¼‰ã€‚");
    const nums = getSelectedNums();
    const pairs = buildAllPairs(nums);
    if(pairs.length === 0) return alert("ä¸‹æœŸå°ç¢°ï¼šè«‹è‡³å°‘é¸ 2 å€‹å‰æœŸè™Ÿç¢¼ï¼ˆä¾‹å¦‚5ç¢¼ï¼‰ã€‚");

    pairs.forEach(([a, b]) => {
      const counts = computeNextPair(validRows, dragPick1, dragPick2, a, b, gameMax);
      addRowToGroup(group, `â‘ ${dragPick1.cat}:${dragPick1.val} + å‰è™Ÿ:${String(a).padStart(2, '0')},${String(b).padStart(2, '0')} â†’ â‘¡${dragPick2.cat}:${dragPick2.val}`, counts);
    });

    group.title = `ã€ä¸‹æœŸå°ç¢°ã€‘â‘ ${dragPick1.cat}:${dragPick1.val} â†’ â‘¡${dragPick2.cat}:${dragPick2.val}ï½œå‰è™Ÿ:${nums.map(n => String(n).padStart(2, '0')).join(',')}ï½œ2ç¢¼é…å°:${pairs.length}çµ„`;
  }

  // æ¸…é™¤ä¸»å‰¯é«”å’Œæ‹–ç‰Œï¼Œç›´æ¥åœ¨åŠ å…¥å ±è¡¨å¾ŒåŸ·è¡Œ
  clearMainSub();
  clearDragPair();

  reportStorage[currentUser][currentGame].push(group);
  renderCurrentReports();
  const targetTab = document.querySelector(`.tab[data-target="reportPage"][data-game="${currentGame}"]`);
  if(targetTab) targetTab.click();
}


/* =========================
   fmt helperï¼šé¡¯ç¤ºã€Œå…¶é¤˜æ¢ä»¶ã€
   ========================= */
function fmtFilters(filters){
  return Object.entries(filters).map(([k,v])=>`${k}:${(v||[]).join(',')}`).join(' + ') || "ç„¡";
}
function fmtFiltersWithout(filters, excludeCat){
  const out={};
  for(const k in filters){
    if(k===excludeCat) continue;
    if(filters[k] && filters[k].length) out[k]=filters[k];
  }
  return fmtFilters(out);
}

/* =========================
   reports
   ========================= */
function deleteReport(groupId){
  const list=reportStorage[currentUser][currentGame];
  const idx=list.findIndex(g=>g.id===groupId);
  if(idx<0) return;
  if(!confirm("ç¢ºå®šåˆªé™¤é€™å¼µå ±è¡¨ï¼Ÿ")) return;
  list.splice(idx,1);
  renderCurrentReports();
}
function renderCurrentReports(){
  const cont=document.getElementById('reportContainer');
  cont.innerHTML='';
  const groups=reportStorage[currentUser][currentGame];
  if(!groups.length) return;

  let html='';
  groups.forEach((g,gi)=>{
    const L=g.limit;
    html += `<div class="report-item">
      <div class="report-header">
        <div class="title">ã€ç¬¬ ${gi+1} å¼µã€‘${g.title}</div>
        <button class="btn btn-red" onclick="deleteReport('${g.id}')">åˆªé™¤æ­¤å ±è¡¨</button>
      </div>
      <table class="report-table">
        <thead>
          <tr><td class="cond-col">çµ±è¨ˆæ˜ç´°</td>${Array.from({length:M},(_,i)=>`<td>${i+1}</td>`).join('')}</tr>
        </thead>
        <tbody>`;

    g.rows.forEach(r=>{
      const sorted=[...r.data].slice(1).sort((a,b)=>b-a);
      const th=(sorted[4]>0) ? sorted[4] : 999;
      html += `<tr><td class="cond-col">${r.label}</td>${
        r.data.slice(1).map(v=>{
          const vv=v||0;
          const cls=(vv>=th && vv>0) ? 'top5':'';
          return `<td class="${cls}">${vv?vv:''}</td>`;
        }).join('')
      }</tr>`;
    });

    const sumSorted=[...g.sum].slice(1).sort((a,b)=>b-a);
    const sumTh=(sumSorted[4]>0) ? sumSorted[4] : 999;
    html += `</tbody>
      <tfoot>
        <tr class="sum-row"><td class="cond-col">åŠ ç¸½ (Sum)</td>${
          g.sum.slice(1).map(v=>{
            const vv=v||0;
            const cls=(vv>=sumTh && vv>0) ? 'top5':'';
            return `<td class="${cls}">${vv?vv:''}</td>`;
          }).join('')
        }</tr>
      </tfoot>
      </table>
    </div>`;
  });

  cont.innerHTML=html;
}

function exportToExcel(){
  const table=document.querySelector(".report-table");
  if(!table) return alert("ç„¡è³‡æ–™");
  const url='data:application/vnd.ms-excel,' + encodeURIComponent(table.outerHTML);
  const link=document.createElement("a");
  link.download=`åˆ†æ_${Date.now()}.xls`;
  link.href=url; link.click();
}
function clearAllReports(){
  if(confirm("ç¢ºå®šæ¸…ç©ºï¼Ÿ")){
    reportStorage[currentUser][currentGame]=[];
    renderCurrentReports();
  }
}

/* =========================
   modes / misc
   ========================= */
function changeMode(mode, btn){
  currentMode = mode; // Set current mode
  
  // Clear previous 'active' classes and set 'active' to the selected mode
  document.querySelectorAll('.mode-btn').forEach(button => {
    button.classList.remove('btn-orange', 'btn-yellow'); // Remove existing styles
  });
  btn.classList.add('btn-orange'); // Add orange class to the active button

  // Specifically check for "æ­·å²æ¨¡å¼" and set it to yellow
  if (currentMode === "æ­·å²æ¨¡å¼") {
    btn.classList.add('btn-yellow'); // Apply yellow color to the "æ­·å²æ¨¡å¼" button
  }

  // Handle the changes based on the selected mode
  if (currentMode === "ä¸»é«”æ¨¡å¼") {
    document.getElementById('filterCounter').textContent = `æ¨¡å¼ï¼šä¸»é«”æ¨¡å¼ | æ¢ä»¶æ•¸:${subPicks.length} | åƒèˆ‡çµ±è¨ˆæœŸæ•¸:${cloudData.length} | èµ·ç®—æ—¥:${startKeyByUser()}`;
  } else if (currentMode === "æ­·å²æ¨¡å¼") {
    // Make sure cloudData is populated and then update the stats
    const validRows = getValidRows(); // Get valid rows based on filters and data
    document.getElementById('filterCounter').textContent = `æ¨¡å¼ï¼šæ­·å²æ¨¡å¼ | æ¢ä»¶æ•¸:0 | åƒèˆ‡çµ±è¨ˆæœŸæ•¸:${validRows.length} | èµ·ç®—æ—¥:${startKeyByUser()}`;
  }

  // Clear main/sub body when switching from ä¸»é«”æ¨¡å¼
  if (currentMode !== "ä¸»é«”æ¨¡å¼") {
    clearMainSub(); 
  }

  syncModeButtons();
  updateStats();
  renderMainSubStatus();  // Update the display status
}


function syncModeButtons() {
  document.querySelectorAll('.mode-btn').forEach(b => {
    b.classList.toggle('btn-orange', b.textContent.trim() === currentMode);
  });
}

function selectToday(){
  clearFilters();
  fetchSheetData((lastRow)=>{
    const meta=rowMetaFromRow(lastRow);
    if(meta.m) autoClick('æœˆä»½', meta.m);
    if(meta.d) autoClick('æ—¥æœŸ', meta.d);
    if(meta.w) autoClick('æ˜ŸæœŸ', meta.w);
    if(currentUser==='dad'){
      if(meta.stem) autoClick('å¤©å¹²', meta.stem);
      if(meta.branch) autoClick('åœ°æ”¯', meta.branch);
      if(meta.jieqi) autoClick('ç¯€æ°£', meta.jieqi);
    }
    updateStats();
  });
}
function autoClick(label, val){
  const vv=String(val).trim();
  const c=document.querySelector(`.chips[data-label="${label}"] .chip[data-val="${cssEsc(vv)}"]`);
  if(c){
    c.classList.add('on');
    if(label==="è™Ÿç¢¼") updateNumOrder(vv, true);
  }
}
function clearFilters(){
  // æ¸…é™¤æ‰€æœ‰é¸ä¸­çš„ chip
  document.querySelectorAll('.chip.on').forEach(c => c.classList.remove('on'));

  // æ¸…ç©ºè™Ÿç¢¼çš„é¸æ“‡
  numOrder = [];
  
  // æ›´æ–°ç¯©é¸æ¢ä»¶
  updateStats();
  renderMainSubStatus();  // æ›´æ–°ä¸»å‰¯é«”ç‹€æ…‹é¡¯ç¤º
}

document.querySelectorAll('.tab').forEach(tab=>{
  tab.addEventListener('click', ()=>{
    currentGame=tab.dataset.game;
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    tab.classList.add('active');
    document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
    document.getElementById(tab.dataset.target).classList.add('active');
    if(tab.dataset.target==='mainPage'){
      initFilters(); fetchSheetData();
    }else{
      renderCurrentReports();
    }
  });
});

function fetchSheetData(callback){
  document.getElementById('loadingOverlay').style.display='flex';
  Papa.parse(sheetUrls[currentGame] + "&t=" + Date.now(),{
    download:true, header:false, skipEmptyLines:true,
    complete:function(results){
      document.getElementById('loadingOverlay').style.display='none';
      cloudData=results.data.slice(1);
      if(callback) callback(results.data[results.data.length-1]);
      updateStats();
    }
  });
}

function updateStatTableUI(){
  const h1=document.getElementById('stat-head-1'), b1=document.getElementById('stat-body-1');
  const h2=document.getElementById('stat-head-2'), b2=document.getElementById('stat-body-2');
  h1.innerHTML=b1.innerHTML=h2.innerHTML=b2.innerHTML='';
  for(let i=1;i<=maxNum;i++){
    h1.innerHTML += `<th>${i}</th>`; b1.innerHTML += `<td id="val1-${i}">0</td>`;
    h2.innerHTML += `<th>${i}</th>`; b2.innerHTML += `<td id="val2-${i}">0</td>`;
  }
}
function cssEsc(s){ return String(s).replace(/\\/g,'\\\\').replace(/"/g,'\\"'); }
function start(){
  initFilters();
  fetchSheetData();
}
start();
</script>
</body>
</html>













