<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>539 å°ˆæ¥­å›æ¸¬ç³»çµ± - é›²ç«¯è‡ªå‹•åŒæ­¥ç‰ˆ</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <style>
        :root { --bg: #d1e7d1; --blue-t: #2196F3; --red-box: #f44336; --gold: #ffc107; --green-border: #8bc34a; }
        body { background-color: var(--bg); font-family: "Microsoft JhengHei", sans-serif; font-size: 13px; margin: 15px; }
        .main-layout { display: flex; flex-direction: column; gap: 10px; }
        
        /* ç¯©é¸é¢æ¿ */
        .filter-panel { border: 2px solid var(--red-box); background: #fff; padding: 15px; display: grid; grid-template-columns: 60px 1fr; gap: 8px; border-radius: 8px; }
        .f-label { background: #eee; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 1px solid #ccc; }
        .f-btns { display: flex; flex-wrap: wrap; gap: 4px; }
        .f-item { padding: 4px 12px; border: 1px solid #ccc; cursor: pointer; background: #fff; border-radius: 4px; position: relative; }
        .f-item.active { background: var(--blue-t); color: white; }
        .f-item.active::after { content: attr(data-order); position: absolute; top: -8px; right: -5px; background: #333; color: #fff; border-radius: 50%; width: 16px; height: 16px; font-size: 10px; display: flex; align-items: center; justify-content: center; border: 1px solid white; }
        
        /* åŠŸèƒ½åˆ— */
        .action-bar { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; background: rgba(255,255,255,0.5); padding: 10px; border-radius: 8px; }
        .guide-msg { width: 100%; color: #856404; background: #fff3cd; padding: 10px; border-radius: 4px; margin-bottom: 5px; font-weight: bold; display: none; border-left: 5px solid #ffc107; }
        
        .yellow-btn { background: #ffff00; border: 1px solid #000; padding: 8px 15px; font-weight: bold; cursor: pointer; border-radius: 4px; }
        .yellow-btn.active { background: #ff9800 !important; color: white; }
        .filter-btn { background: #607d8b; color: white; border: 1px solid #333; padding: 8px 12px; cursor: pointer; border-radius: 4px; font-weight: bold; }
        .filter-btn.active { background: #263238 !important; }
        .add-btn { background: #4CAF50; color: white; border: 1px solid #000; padding: 8px 20px; font-weight: bold; cursor: pointer; display: none; border-radius: 4px; }
        
        .view-container { background: white; border: 2px solid var(--blue-t); padding: 10px; border-radius: 8px; min-height: 500px; }
        .scroll-area { overflow: auto; max-height: 450px; }
        table { border-collapse: collapse; width: 100%; white-space: nowrap; }
        th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
        
        .condition-display-box { border: 2px solid var(--green-border); background: #f1f8e9; margin: 10px 0; padding: 10px 15px; border-radius: 5px; display: flex; flex-wrap: wrap; gap: 10px; align-items: center; }
        .cond-tag { background: #fff; border: 1px solid var(--green-border); padding: 2px 8px; border-radius: 4px; font-weight: bold; color: #33691e; }

        .report-card { border: 2px solid #333; background: #fff; margin-bottom: 30px; border-radius: 4px; overflow: hidden; }
        .report-title { background: #7da7d8; padding: 10px; font-weight: bold; display: flex; justify-content: space-between; border-bottom: 2px solid #333; }
        
        .matrix-container { display: flex; gap: 20px; padding: 10px; align-items: flex-start; }
        .matrix-wrapper { overflow: auto; max-width: 100%; }
        .matrix-table { font-size: 11px; table-layout: fixed; border-collapse: collapse; }
        .matrix-table td { width: 24px; height: 24px; padding: 0; border: 1px solid #ddd; }
        .matrix-header { background: #eee; font-weight: bold; }
        .m-hit { background: #ffeb3b; font-weight: bold; }
        .m-hot { background: #ff5722; color: white; font-weight: bold; }
        
        .stats-panel { border: 2px solid #f44336; min-width: 260px; padding: 15px; background: #fff; border-radius: 8px; }
        .stats-title { font-weight: bold; color: #c62828; margin-bottom: 10px; border-bottom: 2px solid #f44336; padding-bottom: 5px; font-size: 15px; }
        .stats-item { margin-bottom: 8px; font-size: 14px; }
        .stats-num { font-weight: bold; color: blue; }

        .top-hit { background-color: #ffff00 !important; color: #000; font-weight: bold; }
        .hidden { display: none; }
        .del-btn { background: #333; color: white; border: none; padding: 4px 10px; cursor: pointer; border-radius: 3px; }
    </style>
</head>
<body>

<div class="main-layout">
    <div style="display:flex; gap:5px;">
        <button onclick="switchPage('dist')" style="padding:10px 30px; cursor:pointer; font-weight:bold;">æ•¸æ“šåˆ†ä½ˆåœ–</button>
        <button onclick="switchPage('repo')" style="padding:10px 30px; cursor:pointer; font-weight:bold;">åŒ¯ç¸½å ±è¡¨</button>
    </div>

    <div id="page-dist" class="view-container">
        <div id="modeGuide" class="guide-msg"></div>
        <div class="filter-panel">
            <div class="f-label">é€±</div><div class="f-btns" data-type="week"></div>
            <div class="f-label">å¤©å¹²</div><div class="f-btns" data-type="tian"></div>
            <div class="f-label">åœ°æ”¯</div><div class="f-btns" data-type="di"></div>
            <div class="f-label">ç¯€æ°£</div><div class="f-btns" data-type="solar"></div>
            <div class="f-label" style="color:blue">è™Ÿç¢¼</div><div class="f-btns" data-type="nums"></div>
        </div>
        <div class="action-bar">
            <button class="yellow-btn btn-mode-h" onclick="setMode('history')">æ­·å²çµ±è¨ˆ</button>
            <button class="yellow-btn btn-mode-t" onclick="setMode('tuopai')">æ‹–ç‰Œæ¨¡å¼</button>
            <button class="yellow-btn btn-mode-d_curr" onclick="setMode('duipeng_curr')">ç•¶æœŸå°ç¢°</button>
            <button class="yellow-btn btn-mode-d" onclick="setMode('duipeng')">ä¸‹æœŸå°ç¢°</button>
            <button class="add-btn" id="btnAddRepo" onclick="generateBatchReport()">åŠ å…¥å ±è¡¨</button>
            <button onclick="clearFilters()">æ¸…ç©ºç¯©é¸</button>
            <span id="fileMsg" style="margin-left:auto; font-weight:bold; color:red;">é€£ç·šä¸­...</span>
        </div>
        <div class="scroll-area">
            <table>
                <thead><tr id="thr"><th>æœŸè™Ÿ</th><th>æ—¥æœŸ</th><th>é€±</th><th>å¤©å¹²</th><th>åœ°æ”¯</th><th>ç¯€æ°£</th><th>çƒ1</th><th>çƒ2</th><th>çƒ3</th><th>çƒ4</th><th>çƒ5</th></tr></thead>
                <tbody id="gridBody"></tbody>
            </table>
        </div>
    </div>

    <div id="page-repo" class="view-container hidden">
        <div style="display:flex; flex-wrap:wrap; gap:10px; background:#e0e0e0; padding:12px; border-radius:5px;">
            <span style="font-weight:bold; align-self:center;">å ±è¡¨åˆ†é¡ï¼š</span>
            <button onclick="filterRepoDisplay('all', this)" class="filter-btn active">å…¨éƒ¨</button>
            <button onclick="filterRepoDisplay('history', this)" class="filter-btn">æ­·å²</button>
            <button onclick="filterRepoDisplay('tuopai', this)" class="filter-btn">æ‹–ç‰Œ</button>
            <button onclick="filterRepoDisplay('duipeng_curr', this)" class="filter-btn">ç•¶æœŸå°ç¢°</button>
            <button onclick="filterRepoDisplay('duipeng', this)" class="filter-btn">ä¸‹æœŸå°ç¢°</button>
            <button onclick="clearAllReports()" style="background:red; color:white; border:none; padding:8px 15px; cursor:pointer; font-weight:bold; margin-left:auto;">æ¸…ç©ºå ±è¡¨</button>
        </div>
        <div class="condition-display-box">
            <span style="color: #666; font-weight: bold;">ğŸ“Œ å·²åŠ å…¥å ±è¡¨ä¹‹æ¢ä»¶ï¼š</span>
            <div id="cond-tags-list" style="display: flex; flex-wrap: wrap; gap: 5px;"></div>
        </div>
        <div id="repo-list"></div>
    </div>
</div>

<script>
    // --- é ç«¯é€£çµè¨­å®š ---
    // è«‹æ›´æ›æˆä½ çš„ Google è©¦ç®—è¡¨ Excel åŒ¯å‡ºé€£çµ
    const excelUrl = 'ä½ çš„_EXCEL_ä¸‹è¼‰é€£çµ_æ”¾åœ¨é€™è£¡'; 

    let db = [];
    let currentMode = null;
    let filters = { week:[], tian:[], di:[], solar:[], nums:[] };

    // è‡ªå‹•åˆå§‹åŒ–èˆ‡æŠ“å–è³‡æ–™
    window.onload = async () => {
        initUI();
        await fetchRemoteExcel();
    };

    async function fetchRemoteExcel() {
        const msg = document.getElementById('fileMsg');
        try {
            const response = await fetch(excelUrl);
            const arrayBuffer = await response.arrayBuffer();
            const data = new Uint8Array(arrayBuffer);
            const wb = XLSX.read(data, {type: 'array'});
            db = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header:1}).filter(row => row[0] && !isNaN(row[0]));
            renderGrid();
            msg.innerText = `å·²é€£ç·šæ›´æ–°ï¼š ${db.length} æœŸ`;
            msg.style.color = 'green';
        } catch (e) {
            console.error(e);
            msg.innerText = "é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ URL";
        }
    }

    function initUI() {
        const build = (type, list) => {
            const container = document.querySelector(`[data-type="${type}"]`);
            list.forEach(v => {
                const div = document.createElement('div');
                div.className = 'f-item'; div.innerText = v;
                div.onclick = () => handleItem(div, type, v);
                container.appendChild(div);
            });
        };
        build('week', ['ä¸€','äºŒ','ä¸‰','å››','äº”','å…­','æ—¥']);
        build('tian', ['ç”²','ä¹™','ä¸™','ä¸','æˆŠ','å·±','åºš','è¾›','å£¬','ç™¸']);
        build('di', ['å­','ä¸‘','å¯…','å¯','è¾°','å·³','åˆ','æœª','ç”³','é…‰','æˆŒ','äº¥']);
        let slist = []; for(let i=0; i<=15; i++) { slist.push('T'+i); slist.push('S'+i); }
        build('solar', slist);
        build('nums', Array.from({length:39}, (_,i)=>i+1));
        for(let i=1; i<=39; i++) {
            const th = document.createElement('th'); th.style.background = '#ffc107';
            th.innerHTML = `${i}<br><span id="s-${i}" style="font-size:10px; color:blue">0</span>`;
            document.getElementById('thr').appendChild(th);
        }
    }

    // --- ä»¥ä¸‹ç‚ºåŸæœ¬é‚è¼¯ï¼Œå®Œå…¨ä¿ç•™ä¸æ›´å‹• ---
    function handleItem(el, type, val) {
        if (!currentMode) return alert("è«‹å…ˆé¸æ“‡åˆ†ææ¨¡å¼");
        const arr = filters[type]; const idx = arr.indexOf(val);
        if(idx > -1) { arr.splice(idx, 1); el.classList.remove('active'); el.removeAttribute('data-order'); }
        else {
            if((currentMode === 'tuopai' || currentMode === 'duipeng') && type !== 'nums' && arr.length >= 2) return alert("æ‹–ç‰Œ/ä¸‹æœŸå°ç¢°æ—¥æœŸé …ç›®é™é¸2å€‹");
            arr.push(val); el.classList.add('active');
            if((currentMode === 'tuopai' || currentMode === 'duipeng') && type !== 'nums') el.setAttribute('data-order', arr.length);
        }
        applyFilter();
    }

    function applyFilter() {
        if(!db.length) return;
        const rows = document.querySelectorAll('#gridBody tr');
        let counts = Array(40).fill(0);
        rows.forEach(tr => {
            const data = db[tr.id.split('-')[1]];
            let ok = true;
            ['week','tian','di','solar'].forEach(cat => {
                if(filters[cat].length > 0) ok &= filters[cat].some(v => String(data[['week','tian','di','solar'].indexOf(cat)+2]).includes(v));
            });
            const win = data.slice(6, 11).map(Number);
            if(filters.nums.length > 0) ok &= filters.nums.some(n => win.includes(Number(n)));
            tr.style.display = ok ? '' : 'none';
            if(ok) win.forEach(n => { if(n>0) counts[n]++; });
        });
        for(let i=1; i<=39; i++) document.getElementById(`s-${i}`).innerText = counts[i];
    }

    function generateBatchReport() {
        if (!db.length) return alert("å°šæœªè¼‰å…¥è³‡æ–™");
        const list = document.getElementById('repo-list');
        const tid = Date.now();
        ['week','tian','di','solar'].forEach(c => {
            filters[c].forEach(v => {
                const txt = `${getCatName(c)}:${v}`;
                const tagsList = document.getElementById('cond-tags-list');
                if(!Array.from(tagsList.children).some(s => s.innerText === txt)) {
                    const span = document.createElement('span'); span.className = 'cond-tag';
                    span.innerText = txt; tagsList.appendChild(span);
                }
            });
        });
        if (currentMode === 'duipeng_curr') renderMatrixReport(list, tid);
        else if (currentMode === 'duipeng') generateNextDuiPeng(list, tid);
        else if (currentMode === 'tuopai') generateTuoPai(list, tid);
        else generateHistory(list, tid);
        switchPage('repo');
    }

    function renderMatrixReport(container, tid) {
        let matrix = Array.from({length:40}, () => Array(40).fill(0));
        let matchCount = 0;
        let conds = [];
        ['week','tian','di','solar'].forEach(c => filters[c].forEach(v => conds.push(`${getCatName(c)}:${v}`)));
        db.forEach(row => {
            let ok = true;
            ['week','tian','di','solar'].forEach(cat => {
                if(filters[cat].length > 0) ok &= filters[cat].some(v => String(row[['week','tian','di','solar'].indexOf(cat)+2]).includes(v));
            });
            if(ok) {
                matchCount++;
                const nums = row.slice(6, 11).map(Number);
                for(let i=0; i<nums.length; i++) for(let j=i+1; j<nums.length; j++){
                    matrix[nums[i]][nums[j]]++; matrix[nums[j]][nums[i]]++;
                }
            }
        });
        let pairs = [];
        for(let i=1; i<=39; i++) for(let j=i+1; j<=39; j++) if(matrix[i][j] > 0) pairs.push({ p: `${i}-${j}`, v: matrix[i][j] });
        pairs.sort((a,b) => b.v - a.v);
        const card = document.createElement('div');
        card.className = 'report-card'; card.setAttribute('data-mode', 'duipeng_curr');
        let tableHtml = `<table class="matrix-table"><tr class="matrix-header"><td></td>${Array.from({length:39},(_,i)=>`<td>${i+1}</td>`).join('')}</tr>`;
        for(let i=1; i<=39; i++){
            tableHtml += `<tr><td class="matrix-header">${i}</td>`;
            for(let j=1; j<=39; j++){
                let val = matrix[i][j];
                let cls = val > 5 ? 'm-hot' : (val > 0 ? 'm-hit' : '');
                tableHtml += `<td class="${cls}">${val === 0 ? '' : val}</td>`;
            }
            tableHtml += `</tr>`;
        }
        tableHtml += `</table>`;
        card.innerHTML = `
            <div class="report-title"><span>ã€ç•¶æœŸå°ç¢°ã€‘æ¢ä»¶ï¼š${conds.join('+')} (${matchCount}æœŸ)</span><button class="del-btn" onclick="this.closest('.report-card').remove()">åˆªé™¤</button></div>
            <div class="matrix-container">
                <div class="matrix-wrapper">${tableHtml}</div>
                <div class="stats-panel">
                    <div class="stats-title">å°ç¢°åˆ†æ (è¡Œ+åˆ—)</div>
                    <div style="color:red; font-weight:bold;">ğŸ”¥ TOP 3 ç†±é–€</div>
                    ${pairs.slice(0,3).map((x,idx)=>`<div class="stats-item">${idx+1}. <span class="stats-num">${x.p}</span>ï¼š${x.v}æ¬¡</div>`).join('')}
                    <div style="color:blue; font-weight:bold; margin-top:15px;">â„ï¸ TOP 3 å†·é–€</div>
                    ${pairs.slice(-3).reverse().map((x,idx)=>`<div class="stats-item">${idx+1}. <span class="stats-num">${x.p}</span>ï¼š${x.v}æ¬¡</div>`).join('')}
                </div>
            </div>`;
        container.insertBefore(card, container.firstChild);
    }

    function generateNextDuiPeng(list, tid) {
        if(filters.nums.length < 2) return alert("è«‹è‡³å°‘é¸2å€‹è™Ÿç¢¼");
        const details = [];
        const pairs = [];
        for(let i=0; i<filters.nums.length; i++) for(let j=i+1; j<filters.nums.length; j++) pairs.push([filters.nums[i], filters.nums[j]]);
        ['week','tian','di','solar'].forEach(cat => {
            if(filters[cat].length === 2){
                const [v1, v2] = filters[cat], col = ['week','tian','di','solar'].indexOf(cat)+2;
                pairs.forEach(pair => {
                    let stats = Array(40).fill(0), count = 0;
                    for(let i=1; i<db.length; i++){
                        if(String(db[i-1][col]).includes(v1) && String(db[i][col]).includes(v2) && pair.every(n => db[i-1].slice(6,11).map(Number).includes(Number(n)))){
                            db[i].slice(6,11).map(Number).forEach(n => { if(n>0) stats[n]++; }); count++;
                        }
                    }
                    if(count > 0) details.push({ label: `[ä¸‹ç¢°] ${getCatName(cat)}:${v1}â†’${v2} (${pair[0]},${pair[1]})`, matches: count, data: stats });
                });
            }
        });
        if(details.length) renderCommonCard(list, "ä¸‹æœŸå°ç¢°", details, `rep-dp-${tid}`, 'duipeng');
    }

    function generateTuoPai(list, tid) {
        const pNums = filters.nums.length > 0 ? filters.nums : ["å…¨è™Ÿç¢¼"];
        pNums.forEach(num => {
            const inner = [];
            ['week','tian','di','solar'].forEach(cat => {
                if(filters[cat].length === 2){
                    const [v1, v2] = filters[cat], col = ['week','tian','di','solar'].indexOf(cat)+2;
                    let stats = Array(40).fill(0), count = 0;
                    for(let i=1; i<db.length; i++){
                        const numOk = (num === "å…¨è™Ÿç¢¼") ? true : db[i-1].slice(6,11).map(Number).includes(Number(num));
                        if(String(db[i-1][col]).includes(v1) && String(db[i][col]).includes(v2) && numOk){
                            db[i].slice(6,11).map(Number).forEach(n => { if(n>0) stats[n]++; }); count++;
                        }
                    }
                    if(count > 0) inner.push({ label: `[æ‹–] ${getCatName(cat)}:${v1}â†’${v2} + ${num}`, matches: count, data: stats });
                }
            });
            if(inner.length) renderCommonCard(list, num, inner, `rep-tp-${num}-${tid}`, 'tuopai');
        });
    }

    function generateHistory(list, tid) {
        const pNums = filters.nums.length > 0 ? filters.nums : ["å…¨è™Ÿç¢¼"];
        pNums.forEach(num => {
            const inner = [];
            ['week','tian','di','solar'].forEach(cat => {
                filters[cat].forEach(val => {
                    let stats = Array(40).fill(0), count = 0;
                    const col = ['week','tian','di','solar'].indexOf(cat)+2;
                    db.forEach(row => {
                        if(String(row[col]).includes(val) && (num==="å…¨è™Ÿç¢¼" || row.slice(6,11).map(Number).includes(Number(num)))){
                            row.slice(6,11).map(Number).forEach(n => { if(n>0) stats[n]++; }); count++;
                        }
                    });
                    if(count > 0) inner.push({ label: `${getCatName(cat)}:${val}`, matches: count, data: stats });
                });
            });
            if(inner.length) renderCommonCard(list, num, inner, `rep-hs-${num}-${tid}`, 'history');
        });
    }

    function renderCommonCard(container, titleLabel, detailData, uniqueId, mode) {
        const card = document.createElement('div');
        card.className = 'report-card'; card.setAttribute('data-mode', mode);
        card.innerHTML = `<div class="report-title"><span>ã€${{history:'æ­·å²',tuopai:'æ‹–ç‰Œ',duipeng:'ä¸‹æœŸå°ç¢°'}[mode]}ã€‘${titleLabel}</span><button class="del-btn" onclick="this.closest('.report-card').remove()">åˆªé™¤</button></div>
            <table style="background:#fff"><thead><tr style="background:#eee"><td>æ¢ä»¶çµ„åˆ</td>${Array.from({length:39},(_,i)=>`<td>${i+1}</td>`).join('')}</tr></thead><tbody class="report-body"></tbody><tfoot><tr style="background:#fff9c4; font-weight:bold" class="total-row"></tr></tfoot></table>`;
        container.insertBefore(card, container.firstChild);
        const tbody = card.querySelector('.report-body');
        detailData.forEach(row => {
            const tr = document.createElement('tr');
            tr.setAttribute('data-matches', row.matches); tr.setAttribute('data-stats', JSON.stringify(row.data));
            const top3 = getTop3Indices(row.data);
            tr.innerHTML = `<td style="text-align:left; padding-left:10px;">${row.label} (${row.matches}æ¬¡)</td>` + 
                           row.data.slice(1).map((v, i) => `<td class="${top3.includes(i+1)?'top-hit':''}">${v===0?'':v}</td>`).join('');
            tbody.appendChild(tr);
        });
        recalculateTotal(card);
    }

    function recalculateTotal(card) {
        const rows = card.querySelectorAll('.report-body tr');
        let tStats = Array(40).fill(0), tMatches = 0;
        rows.forEach(tr => {
            const stats = JSON.parse(tr.getAttribute('data-stats'));
            tMatches += parseInt(tr.getAttribute('data-matches'));
            stats.forEach((v, i) => tStats[i] += v);
        });
        const top3 = getTop3Indices(tStats);
        card.querySelector('.total-row').innerHTML = `<td style="text-align:left; padding-left:10px;">æ¢ä»¶åŠ ç¸½ (${tMatches}æ¬¡)</td>` + 
            tStats.slice(1).map((v, i) => `<td class="${top3.includes(i+1)?'top-hit':''}">${v===0?'':v}</td>`).join('');
    }

    function setMode(m) {
        currentMode = m;
        document.querySelectorAll('.yellow-btn').forEach(b => b.classList.remove('active'));
        const sel = m==='history'?'.btn-mode-h':(m==='tuopai'?'.btn-mode-t':(m==='duipeng_curr'?'.btn-mode-d_curr':'.btn-mode-d'));
        document.querySelectorAll(sel).forEach(b => b.classList.add('active'));
        document.getElementById('btnAddRepo').style.display = 'block';
        document.getElementById('modeGuide').style.display = 'block';
        document.getElementById('modeGuide').innerHTML = `ğŸ’¡ ç›®å‰æ¨¡å¼ï¼š<b>${{history:'æ­·å²',tuopai:'æ‹–ç‰Œ',duipeng_curr:'ç•¶æœŸå°ç¢°',duipeng:'ä¸‹æœŸå°ç¢°'}[m]}</b>`;
        clearFilters();
    }
    function filterRepoDisplay(mode, btn) {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        document.querySelectorAll('.report-card').forEach(card => card.style.display = (mode === 'all' || card.getAttribute('data-mode') === mode) ? 'block' : 'none');
    }
    function switchPage(p) {
        document.getElementById('page-dist').className = (p==='dist'?'view-container':'hidden');
        document.getElementById('page-repo').className = (p==='repo'?'view-container':'hidden');
    }
    function clearFilters() { filters = { week:[], tian:[], di:[], solar:[], nums:[] }; document.querySelectorAll('.f-item').forEach(el => { el.classList.remove('active'); el.removeAttribute('data-order'); }); applyFilter(); }
    function getCatName(c) { return {week:'é€±', tian:'å¤©å¹²', di:'åœ°æ”¯', solar:'ç¯€æ°£'}[c]; }
    function clearAllReports() { if(confirm("ç¢ºå®šæ¸…ç©ºå ±è¡¨èˆ‡æ¢ä»¶æ¨™ç±¤ï¼Ÿ")) { document.getElementById('repo-list').innerHTML = ''; document.getElementById('cond-tags-list').innerHTML = ''; } }
    function getTop3Indices(data) {
        const sorted = data.slice(1).map((v, i) => ({v, i: i+1})).sort((a, b) => b.v - a.v);
        const vals = [...new Set(sorted.map(x => x.v))].filter(v => v > 0).slice(0, 3);
        return sorted.filter(x => x.v > 0 && vals.includes(x.v)).map(x => x.i);
    }

    function renderGrid() {
        const body = document.getElementById('gridBody'); body.innerHTML = '';
        db.forEach((row, idx) => {
            const tr = document.createElement('tr'); tr.id = `row-${idx}`;
            for(let i=0; i<11; i++){
                const td = document.createElement('td'); let v = row[i] || '';
                if(i===1 && typeof v === 'number') { const d = new Date((v-25569)*86400*1000); v=`${d.getFullYear()}/${d.getMonth()+1}/${d.getDate()}`; }
                td.innerText = v; tr.appendChild(td);
            }
            const win = row.slice(6,11).map(Number);
            for(let i=1; i<=39; i++){ const td = document.createElement('td'); if(win.includes(i)) { td.innerText = String(i).padStart(2,'0'); td.style.fontWeight='bold'; } tr.appendChild(td); }
            body.appendChild(tr);
        });
        applyFilter();
    }
</script>
</body>
</html>
