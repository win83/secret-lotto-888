<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>539 å°ˆæ¥­å›æ¸¬ - å¹²æ”¯å¹´çµ±è¨ˆé€²éšç‰ˆ</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <style>
        :root { --bg: #d1e7d1; --blue-t: #2196F3; --red-box: #f44336; --gold: #ffc107; --dark-green: #2e7d32; }
        body { background-color: var(--bg); font-family: "Microsoft JhengHei", sans-serif; font-size: 13px; margin: 15px; }
        .main-layout { display: flex; flex-direction: column; gap: 10px; }
        .guide-box { background: #fffde7; border: 1px solid #ddd; border-left: 5px solid var(--gold); padding: 8px 15px; margin-bottom: 5px; border-radius: 4px; min-height: 24px; display: flex; align-items: center; }
        .filter-panel { border: 2px solid var(--red-box); background: #fff; padding: 15px; display: grid; grid-template-columns: 80px 1fr; gap: 8px; border-radius: 8px; }
        .f-label { background: #eee; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 1px solid #ccc; border-radius: 4px; }
        .f-btns { display: flex; flex-wrap: wrap; gap: 4px; }
        .f-item { padding: 4px 10px; border: 1px solid #ccc; cursor: pointer; background: #fff; border-radius: 4px; position: relative; transition: 0.2s; }
        .f-item:hover { background: #f0f0f0; }
        .f-item.active { background: var(--blue-t); color: white; border-color: #0d47a1; }
        .f-item.active::after { content: attr(data-order); position: absolute; top: -8px; right: -5px; background: #333; color: #fff; border-radius: 50%; width: 16px; height: 16px; font-size: 10px; display: flex; align-items: center; justify-content: center; border: 1px solid white; }
        .action-bar { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; background: rgba(255,255,255,0.7); padding: 12px; border-radius: 8px; border: 1px solid #ccc; }
        .yellow-btn { background: #ffff00; border: 1px solid #000; padding: 8px 15px; font-weight: bold; cursor: pointer; border-radius: 4px; }
        .yellow-btn.active { background: #ff9800 !important; color: white; }
        .add-btn { background: var(--dark-green); color: white; border: 1px solid #000; padding: 8px 20px; font-weight: bold; cursor: pointer; border-radius: 4px; }
        .view-container { background: white; border: 2px solid var(--blue-t); padding: 10px; border-radius: 8px; min-height: 500px; }
        .scroll-area { overflow: auto; max-height: 500px; border: 1px solid #eee; margin-top: 10px; }
        table { border-collapse: collapse; width: 100%; white-space: nowrap; }
        th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
        .report-card { border: 2px solid #333; background: #fff; margin-bottom: 25px; border-radius: 4px; box-shadow: 2px 2px 8px rgba(0,0,0,0.1); }
        .report-title { background: #7da7d8; color: white; padding: 10px; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        .top-hit { background-color: #ffff00 !important; font-weight: bold; color: #d32f2f; }
        .hidden { display: none; }
        input[type="number"] { width: 60px; padding: 5px; border: 1px solid #ccc; border-radius: 4px; text-align: center; font-weight: bold; }
    </style>
</head>
<body>

<div class="main-layout">
    <div style="display:flex; gap:5px;">
        <button onclick="switchPage('dist')" style="flex:1; padding:12px; font-weight:bold; cursor:pointer;">ğŸ“Š æ•¸æ“šåˆ†ä½ˆåœ–</button>
        <button onclick="switchPage('repo')" style="flex:1; padding:12px; font-weight:bold; cursor:pointer;">ğŸ“‘ åŒ¯ç¸½å ±è¡¨</button>
    </div>

    <div id="page-dist" class="view-container">
        <div id="modeGuide" class="guide-box">ğŸ’¡ æ¨¡å¼å°å¼•...</div>
        
        <div class="filter-panel">
            <div class="f-label">å¹´ä»½</div><div class="f-btns" data-type="year"></div>
            <div class="f-label">é€±</div><div class="f-btns" data-type="week"></div>
            <div class="f-label">å¤©å¹²</div><div class="f-btns" data-type="tian"></div>
            <div class="f-label">åœ°æ”¯</div><div class="f-btns" data-type="di"></div>
            <div class="f-label" style="background:#e8f5e9">å¹²æ”¯çµ„åˆ</div><div class="f-btns" data-type="ganzhi"></div>
            <div class="f-label">ç¯€æ°£</div><div class="f-btns" data-type="solar"></div>
            <div class="f-label" style="color:blue">è™Ÿç¢¼</div><div class="f-btns" data-type="nums"></div>
        </div>

        <div class="action-bar">
            <span>å–æœ€è¿‘ <input type="number" id="limitCount" value="0" min="0" onchange="applyFilter()"> æœŸ (0=å…¨å–)</span>
            <div style="border-left: 2px solid #ccc; height: 25px; margin: 0 10px;"></div>
            <button class="yellow-btn btn-mode-h" onclick="setMode('history')">æ­·å²çµ±è¨ˆ</button>
            <button class="yellow-btn btn-mode-t" onclick="setMode('tuopai')">æ‹–ç‰Œæ¨¡å¼</button>
            <button class="yellow-btn btn-mode-d_curr" onclick="setMode('duipeng_curr')">ç•¶æœŸå°ç¢°</button>
            <button class="yellow-btn btn-mode-d" onclick="setMode('duipeng')">ä¸‹æœŸå°ç¢°</button>
            <button class="add-btn" onclick="generateBatchReport()">â• åŠ å…¥å ±è¡¨</button>
            <button onclick="clearFilters()" style="padding:8px; cursor:pointer">æ¸…ç©ºç¯©é¸</button>
            <span id="fileMsg" style="margin-left:auto; font-weight:bold; color:red;">é€£ç·šä¸­...</span>
        </div>

        <div class="scroll-area">
            <table>
                <thead><tr id="thr"><th>æœŸè™Ÿ</th><th>æ—¥æœŸ</th><th>é€±</th><th>å¤©å¹²</th><th>åœ°æ”¯</th><th>å¹²æ”¯</th><th>ç¯€æ°£</th><th>çƒ1</th><th>çƒ2</th><th>çƒ3</th><th>çƒ4</th><th>çƒ5</th></tr></thead>
                <tbody id="gridBody"></tbody>
            </table>
        </div>
    </div>

    <div id="page-repo" class="view-container hidden">
        <div style="margin-bottom:10px;"><button onclick="clearAllReports()" style="background:#d32f2f; color:white; padding:8px 15px; cursor:pointer; font-weight:bold;">âš ï¸ æ¸…ç©ºæ‰€æœ‰å ±è¡¨</button></div>
        <div id="repo-list"></div>
    </div>
</div>

<script>
    const GSHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTuGa3v-rwH8Qh-JXF9MfxwUwT0A-iJooRI6ypJTErCsxN9qCjZQrgr70f16ZoehQ/pub?output=csv";
    let db = []; // åŸå§‹æ•¸æ“š
    let processedDb = []; // åŠ å·¥å¾Œå«çµ„åˆå¹²æ”¯èˆ‡å¹´ä»½çš„æ•¸æ“š
    let currentMode = 'history';
    let filters = { year:[], week:[], tian:[], di:[], ganzhi:[], solar:[], nums:[] };
    let savedReports = JSON.parse(localStorage.getItem('539_reports') || "[]");

    function setMode(m) {
        currentMode = m;
        document.querySelectorAll('.yellow-btn').forEach(b => b.classList.remove('active'));
        const btnMap = { history:'.btn-mode-h', tuopai:'.btn-mode-t', duipeng_curr:'.btn-mode-d_curr', duipeng:'.btn-mode-d' };
        if(document.querySelector(btnMap[m])) document.querySelector(btnMap[m]).classList.add('active');
        const guides = {
            history: "ğŸ’¡ <b>æ­·å²çµ±è¨ˆ</b>ï¼šçµ±è¨ˆé¸å®šç¯„åœå…§è™Ÿç¢¼å‡ºç¾è¦å¾‹ã€‚",
            tuopai: "ğŸ’¡ <b>æ‹–ç‰Œæ¨¡å¼</b>ï¼šé …ç›®é¸2å€‹æ‰æˆç«‹ã€‚ä¾‹å¦‚ï¼šç”²â†’ä¹™ï¼Œçœ‹ä¸‹æœŸåˆ†ä½ˆã€‚",
            duipeng_curr: "ğŸ’¡ <b>ç•¶æœŸå°ç¢°</b>ï¼šè™Ÿç¢¼é¸2-5å€‹ã€‚çµ±è¨ˆç•¶å‰çµ„åˆç†±åº¦ã€‚",
            duipeng: "ğŸ’¡ <b>ä¸‹æœŸå°ç¢°</b>ï¼šé …ç›®é¸2å€‹+è™Ÿç¢¼é¸2-5å€‹ã€‚çµ±è¨ˆä¸ŠæœŸé…å°å¾Œçš„ä¸‹æœŸåˆ†ä½ˆã€‚"
        };
        document.getElementById('modeGuide').innerHTML = guides[m];
        clearFilters();
    }

    async function loadCloudData() {
        try {
            const response = await fetch(GSHEET_CSV_URL);
            const csvText = await response.text();
            let raw = XLSX.utils.sheet_to_json(XLSX.read(csvText, { type: 'string' }).Sheets[XLSX.read(csvText, { type: 'string' }).SheetNames[0]], { header: 1 })
                 .filter(row => row[0] && !isNaN(row[0]));
            
            // åŠ å·¥æ•¸æ“šï¼šæ’å…¥å¹´ä»½èˆ‡åˆæˆå¹²æ”¯
            processedDb = raw.map(row => {
                const dateStr = String(row[1]);
                const year = dateStr.substring(0, 4);
                const gan = String(row[3]);
                const zhi = String(row[4]);
                const ganzhi = gan + zhi;
                // rowçµæ§‹: [0æœŸè™Ÿ, 1æ—¥æœŸ, 2é€±, 3å¤©å¹², 4åœ°æ”¯, 5ç¯€æ°£, 6-10çƒ]
                // æ–°çµæ§‹: [0æœŸè™Ÿ, 1æ—¥æœŸ, 2é€±, 3å¤©å¹², 4åœ°æ”¯, 5å¹²æ”¯(æ–°), 6ç¯€æ°£, 7-11çƒ, 12å¹´ä»½(æ–°)]
                return [row[0], row[1], row[2], row[3], row[4], ganzhi, row[5], row[6], row[7], row[8], row[9], row[10], year];
            });
            
            initUIControls();
            renderGrid();
            document.getElementById('fileMsg').innerText = `é€£ç·šæˆåŠŸï¼š${processedDb.length} æœŸ`;
            setMode('history');
            updateReportUI();
        } catch (e) { document.getElementById('fileMsg').innerText = "é€£ç·šå¤±æ•—"; console.error(e); }
    }

    function initUIControls() {
        const build = (type, list) => {
            const container = document.querySelector(`[data-type="${type}"]`);
            container.innerHTML = '';
            list.forEach(v => {
                const div = document.createElement('div');
                div.className = 'f-item'; div.innerText = v;
                div.onclick = () => handleItem(div, type, v);
                container.appendChild(div);
            });
        };

        const years = [...new Set(processedDb.map(r => r[12]))].sort().reverse();
        build('year', years);
        build('week', ['ä¸€','äºŒ','ä¸‰','å››','äº”','å…­','æ—¥']);
        build('tian', ['ç”²','ä¹™','ä¸™','ä¸','æˆŠ','å·±','åºš','è¾›','å£¬','ç™¸']);
        build('di', ['å­','ä¸‘','å¯…','å¯','è¾°','å·³','åˆ','æœª','ç”³','é…‰','æˆŒ','äº¥']);
        
        const ganzhis = [...new Set(processedDb.map(r => r[5]))].sort();
        build('ganzhi', ganzhis);

        let slist = []; for(let i=0; i<=15; i++) { slist.push('T'+i); slist.push('S'+i); }
        build('solar', slist);
        build('nums', Array.from({length:39}, (_,i)=>i+1));

        const thr = document.getElementById('thr');
        thr.querySelectorAll('.num-th').forEach(e => e.remove());
        for(let i=1; i<=39; i++) {
            const th = document.createElement('th'); th.className = 'num-th'; th.style.background = '#ffc107';
            th.innerHTML = `${i}<br><span id="s-${i}" style="font-size:10px; color:blue">0</span>`;
            thr.appendChild(th);
        }
    }

    function handleItem(el, type, val) {
        const arr = filters[type]; const idx = arr.indexOf(val);
        if(idx > -1) { arr.splice(idx, 1); el.classList.remove('active'); el.removeAttribute('data-order'); }
        else {
            if(type === 'nums' && currentMode.includes('duipeng') && arr.length >= 5) return alert("ä¸Šé™ 5 å€‹");
            if((currentMode === 'tuopai' || currentMode === 'duipeng') && type !== 'nums' && type !== 'year' && arr.length >= 2) return;
            arr.push(val); el.classList.add('active');
            if((currentMode === 'tuopai' || currentMode === 'duipeng') && !['nums','year'].includes(type)) el.setAttribute('data-order', arr.length);
        }
        applyFilter();
    }

    function applyFilter() {
        const limit = parseInt(document.getElementById('limitCount').value) || 0;
        let dataToFilter = [...processedDb];
        if(limit > 0) dataToFilter = dataToFilter.slice(-limit);

        const rows = document.querySelectorAll('#gridBody tr');
        let counts = Array(40).fill(0);
        let visibleCount = 0;

        rows.forEach(tr => {
            const idx = parseInt(tr.id.split('-')[1]);
            const rowData = processedDb[idx];
            
            // æ˜¯å¦åœ¨ limit ç¯„åœå…§
            const inRange = limit === 0 || idx >= (processedDb.length - limit);
            
            let ok = inRange;
            if(ok) {
                if(filters.year.length > 0) ok &= filters.year.includes(rowData[12]);
                if(filters.week.length > 0) ok &= filters.week.includes(String(rowData[2]));
                if(filters.tian.length > 0) ok &= filters.tian.includes(String(rowData[3]));
                if(filters.di.length > 0) ok &= filters.di.includes(String(rowData[4]));
                if(filters.ganzhi.length > 0) ok &= filters.ganzhi.includes(String(rowData[5]));
                if(filters.solar.length > 0) ok &= filters.solar.includes(String(rowData[6]));
                
                const wins = rowData.slice(7, 12).map(Number);
                if(filters.nums.length > 0) ok &= filters.nums.every(n => wins.includes(Number(n)));
            }

            tr.style.display = ok ? '' : 'none';
            if(ok) {
                visibleCount++;
                const wins = rowData.slice(7, 12).map(Number);
                const cells = tr.querySelectorAll('.num-cell');
                cells.forEach(td => {
                    const n = parseInt(td.getAttribute('data-n'));
                    if(wins.includes(n)) { td.innerText = n<10?'0'+n:n; counts[n]++; }
                    else td.innerText = '';
                });
            }
        });

        for(let i=1; i<=39; i++) {
            const el = document.getElementById(`s-${i}`);
            if(el) el.innerText = counts[i];
        }
    }

    function generateBatchReport() {
        const limit = parseInt(document.getElementById('limitCount').value) || 0;
        let baseDb = limit > 0 ? processedDb.slice(-limit) : processedDb;
        const selectedNums = filters.nums.map(Number).sort((a,b)=>a-b);
        const catMap = { year:12, week:2, tian:3, di:4, ganzhi:5, solar:6 };
        const results = [];

        if (currentMode.includes('duipeng')) {
            if (selectedNums.length < 2) return alert("å°ç¢°é ˆé¸2å€‹ä»¥ä¸Šè™Ÿç¢¼");
            let matrix = Array.from({length:40}, () => Array(40).fill(0)), mCount = 0;
            
            if (currentMode === 'duipeng') {
                Object.keys(catMap).forEach(cat => {
                    if(filters[cat].length === 2 && cat !== 'year') {
                        const [v1, v2] = filters[cat], col = catMap[cat];
                        for(let i=1; i<baseDb.length; i++) {
                            const prevWins = baseDb[i-1].slice(7, 12).map(Number);
                            const nextWins = baseDb[i].slice(7, 12).map(Number);
                            if(String(baseDb[i-1][col]).includes(v1) && String(baseDb[i][col]).includes(v2) && selectedNums.every(n => prevWins.includes(n))) {
                                mCount++;
                                for(let x=0; x<selectedNums.length; x++) for(let y=x+1; y<selectedNums.length; y++) {
                                    if(nextWins.includes(selectedNums[x]) && nextWins.includes(selectedNums[y])) { matrix[selectedNums[x]][selectedNums[y]]++; matrix[selectedNums[y]][selectedNums[x]]++; }
                                }
                            }
                        }
                    }
                });
            } else {
                baseDb.forEach(row => {
                    let ok = true;
                    Object.keys(filters).forEach(k => { if(filters[k].length > 0 && k!=='nums') ok &= filters[k].includes(String(row[catMap[k]])); });
                    const wins = row.slice(7,12).map(Number);
                    if(ok && selectedNums.every(n => wins.includes(n))) {
                        mCount++;
                        for(let x=0; x<selectedNums.length; x++) for(let y=x+1; y<selectedNums.length; y++) {
                            if(wins.includes(selectedNums[x]) && wins.includes(selectedNums[y])) { matrix[selectedNums[x]][selectedNums[y]]++; matrix[selectedNums[y]][selectedNums[x]]++; }
                        }
                    }
                });
            }
            if(mCount === 0) return alert("ç„¡ç¬¦åˆè³‡æ–™");
            let rows = selectedNums.map(n1 => {
                let s = Array(40).fill(0); selectedNums.forEach(n2 => { if(n1!==n2) s[n2] = matrix[n1][n2]; });
                return { label: `è™Ÿç¢¼ ${n1}`, data: s };
            });
            saveAndRender(`${currentMode==='duipeng'?'ä¸‹æœŸ':'ç•¶æœŸ'}å°ç¢° (${mCount}æœŸ)`, rows, 'pair', selectedNums);
        } else {
            // æ‹–ç‰Œèˆ‡æ­·å²çµ±è¨ˆé‚è¼¯
            Object.keys(catMap).forEach(cat => {
                if(currentMode === 'tuopai' && filters[cat].length === 2 && cat !== 'year') {
                    const [v1, v2] = filters[cat], col = catMap[cat];
                    if(selectedNums.length === 0) {
                        let s = Array(40).fill(0), c = 0;
                        for(let i=1; i<baseDb.length; i++) if(String(baseDb[i-1][col]).includes(v1) && String(baseDb[i][col]).includes(v2)) {
                            baseDb[i].slice(7,12).map(Number).forEach(n => { if(n>0) s[n]++; }); c++;
                        }
                        if(c>0) results.push({ label: `[ç´”é …] ${cat}:${v1}â†’${v2}`, data: s, matches: c });
                    } else {
                        selectedNums.forEach(num => {
                            let s = Array(40).fill(0), c = 0;
                            for(let i=1; i<baseDb.length; i++) if(String(baseDb[i-1][col]).includes(v1) && String(baseDb[i][col]).includes(v2) && baseDb[i-1].slice(7,12).map(Number).includes(num)) {
                                baseDb[i].slice(7,12).map(Number).forEach(n => { if(n>0) s[n]++; }); c++;
                            }
                            if(c>0) results.push({ label: `[æ‹–:${num}] ${cat}:${v1}â†’${v2}`, data: s, matches: c });
                        });
                    }
                } else if(currentMode === 'history' && filters[cat].length > 0) {
                    filters[cat].forEach(val => {
                        let s = Array(40).fill(0), c = 0, col = catMap[cat];
                        baseDb.forEach(row => {
                            let yrMatch = filters.year.length === 0 || filters.year.includes(String(row[12]));
                            if(String(row[col]) === val && yrMatch) { row.slice(7,12).map(Number).forEach(n => { if(n>0) s[n]++; }); c++; }
                        });
                        if(c>0) results.push({ label: `${cat}:${val}`, data: s, matches: c });
                    });
                }
            });
            if(results.length) saveAndRender(`å›æ¸¬å ±è¡¨ (å–æœ€è¿‘${limit||'å…¨'}æœŸ)`, results, 'table');
        }
        switchPage('repo');
    }

    function saveAndRender(title, rows, type, targetNums = []) {
        savedReports.unshift({ title, rows, type, targetNums, id: Date.now() });
        localStorage.setItem('539_reports', JSON.stringify(savedReports));
        updateReportUI();
    }

    function updateReportUI() {
        const list = document.getElementById('repo-list'); list.innerHTML = '';
        savedReports.forEach(report => {
            const card = document.createElement('div'); card.className = 'report-card';
            const isPair = report.type === 'pair';
            let h = `<div class="report-title"><span>ã€${report.title}ã€‘</span><button onclick="deleteReport(${report.id})" style="cursor:pointer">âŒ åˆªé™¤</button></div>`;
            h += `<div class="scroll-area"><table><thead><tr style="background:#f5f5f5"><td>é …ç›®</td>`;
            if(isPair) report.targetNums.forEach(n => h += `<td>${n}</td>`);
            else for(let i=1; i<=39; i++) h += `<td>${i}</td>`;
            h += `</tr></thead><tbody>`;
            report.rows.forEach(r => {
                const top3 = getTop3Indices(r.data);
                h += `<tr><td style="font-weight:bold; background:#fafafa;">${r.label}</td>`;
                if(isPair) report.targetNums.forEach(n => { const v = r.data[n]||0; h += `<td class="${v>0?'top-hit':''}">${v||''}</td>`; });
                else for(let i=1; i<=39; i++) { const v = r.data[i]||0; h += `<td class="${top3.includes(i)?'top-hit':''}">${v||''}</td>`; }
                h += `</tr>`;
            });
            h += `</tbody></table></div>`;
            card.innerHTML = h; list.appendChild(card);
        });
    }

    function deleteReport(id) { savedReports = savedReports.filter(r => r.id !== id); localStorage.setItem('539_reports', JSON.stringify(savedReports)); updateReportUI(); }
    function clearAllReports() { if(confirm("ç¢ºå®šæ¸…ç©ºæ‰€æœ‰å ±è¡¨ï¼Ÿ")) { savedReports=[]; localStorage.removeItem('539_reports'); updateReportUI(); } }
    function switchPage(p) { document.getElementById('page-dist').className = (p==='dist'?'view-container':'hidden'); document.getElementById('page-repo').className = (p==='repo'?'view-container':'hidden'); }
    function clearFilters() { filters = { year:[], week:[], tian:[], di:[], ganzhi:[], solar:[], nums:[] }; document.querySelectorAll('.f-item').forEach(el => el.classList.remove('active')); applyFilter(); }
    
    function renderGrid() {
        const body = document.getElementById('gridBody'); body.innerHTML = '';
        processedDb.forEach((row, idx) => {
            const tr = document.createElement('tr'); tr.id = `row-${idx}`;
            // æœŸè™Ÿ,æ—¥æœŸ,é€±,å¤©å¹²,åœ°æ”¯,å¹²æ”¯,ç¯€æ°£
            for(let i=0; i<7; i++){ const td = document.createElement('td'); td.innerText = row[i]||''; tr.appendChild(td); }
            // 5é¡†é–‹ççƒ (éš±è—ï¼Œç”± num-cell ä»£æ›¿é¡¯ç¤º)
            for(let i=7; i<12; i++){ const td = document.createElement('td'); td.className = 'hidden'; tr.appendChild(td); }
            // 39å€‹è™Ÿç¢¼æ ¼
            for(let n=1; n<=39; n++){ const td = document.createElement('td'); td.className = 'num-cell'; td.setAttribute('data-n', n); tr.appendChild(td); }
            body.appendChild(tr);
        });
        applyFilter();
    }

    function getTop3Indices(data) {
        const sorted = data.slice(1).map((v, i) => ({v, i: i+1})).sort((a, b) => b.v - a.v);
        const vals = [...new Set(sorted.map(x => x.v))].filter(v => v > 0).slice(0, 3);
        return sorted.filter(x => x.v > 0 && vals.includes(x.v)).map(x => x.i);
    }

    loadCloudData();
</script>
</body>
</html>
