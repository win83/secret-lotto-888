<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>å°ˆæ¥­æ¨‚é€çµ±è¨ˆç³»çµ± V2.2 - å ±è¡¨é¡¯ç¤ºè¦æ ¼ç‰ˆï¼ˆç•¶æœŸå°ç¢°/ä¸‹æœŸå°ç¢°ä¿®æ­£ç‰ˆï¼‰</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <style>
    :root{
      --page-bg:#cfe8cf; --panel-bg:#fff8e8; --tab-bg:#ededed;
      --tab-border:#9a9a9a; --blue:#1f73ff; --red:#e51b1b;
      --line:#d0d0d0; --label:#efefef; --btn-border:#7a7a7a;
      --stat-green: #92d050; --stat-light: #e2efda;
      --top5-bg: #ff0000; --top5-text: #ffffff;
      --report-header-bg: #fce4d6;
    }
    *{ box-sizing:border-box; font-family:"Microsoft JhengHei"; }
    body{ margin:0; background:var(--page-bg); color:#111; }
    .tabs{ display:grid; grid-template-columns: repeat(4, 1fr); gap:16px; padding:10px 14px 0; }
    .tab{ height:44px; background:var(--tab-bg); border:1px solid var(--tab-border); display:flex; align-items:center; justify-content:center; font-weight:800; cursor:pointer; }
    .tab.active{ border-bottom:3px solid var(--red); background:#f2f2f2; }
    .container{ margin:10px 14px; border:1px solid var(--blue); border-radius:8px; background:var(--panel-bg); padding:10px; min-height: 80vh; }
    .page { display: none; }
    .page.active { display: block; }
    .filters-box{ border:2px solid var(--red); background:#fff; padding:12px; margin-bottom:10px; }
    .grid{ display:grid; grid-template-columns: 90px 1fr; row-gap:10px; }
    .lbl{ background:var(--label); border:1px solid var(--line); display:flex; align-items:center; justify-content:center; font-weight:900; height:36px; }
    .chips{ display:flex; flex-wrap:wrap; gap:8px; padding-left:10px; align-items:center; }
    .chip{ min-width:44px; height:34px; border:1px solid var(--line); border-radius:4px; display:flex; align-items:center; justify-content:center; cursor:pointer; font-weight:800; background:#fff; user-select:none; }
    .chip.on{ outline:3px solid var(--blue); background:#eef4ff; }
    .breakline{ flex-basis: 100%; height: 0; }
    .btnbar{ display:flex; flex-wrap:wrap; gap:8px; align-items:center; margin-top:10px; }
    .btn{ height:40px; padding:0 15px; border:1px solid var(--btn-border); border-radius:4px; font-weight:900; cursor:pointer; }
    .btn-orange{ background:#ffb300 !important; color:#000; }
    .btn-yellow{ background:#ffeb3b; }
    .btn-green{ background:#78c57a; }
    .btn-purple{ background:#6a44c6; color:#fff; }
    .btn-cyan { background:#00bcd4; color:#fff; }
    .btn-red{ background:#ff3b30; color:#fff; border-color:#b21b12; }

    .stat-title { color: red; font-weight: bold; margin-top: 15px; margin-bottom: 5px; }
    .stat-table { width: 100%; border-collapse: collapse; background: #fff; min-width: 800px; }
    .stat-table th, .stat-table td { border: 1px solid #000; text-align: center; padding: 2px; font-size: 11px; font-weight: bold; }
    .stat-table th { background: var(--stat-green); }
    .top5 { background-color: var(--top5-bg) !important; color: var(--top5-text) !important; }

    .report-item { margin-bottom: 30px; border: 1px solid #000; background: #fff; overflow-x: auto; }
    .report-header { background: var(--report-header-bg); padding: 8px; font-weight: bold; border-bottom: 1px solid #000; display:flex; gap:10px; align-items:center; }
    .report-header .title { flex:1; }
    .report-table { width:100%; border-collapse:collapse; font-size:11px; min-width: 1000px; }
    .report-table td { border:1px solid #000; text-align:center; padding:2px; }
    .cond-col { background:#ffff00; font-weight: bold; width: 420px; text-align: left; padding-left: 6px; }
    .sum-row { background:#ddebf7; font-weight:bold; }
    .hidden { display: none !important; }

    #loadingOverlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); display:none; justify-content:center; align-items:center; z-index:9999; font-weight:900; color:red; }
  </style>
</head>
<body>

<div id="loadingOverlay">é›²ç«¯å¤§æ•¸æ“šé‹ç®—ä¸­...</div>

<div class="tabs">
  <div class="tab active" data-game="539" data-target="mainPage">ä»Šå½© 539</div>
  <div class="tab" data-game="539" data-target="reportPage">539 å ±è¡¨</div>
  <div class="tab" data-game="Lotto" data-target="mainPage">å¤§æ¨‚é€</div>
  <div class="tab" data-game="Lotto" data-target="reportPage">å¤§æ¨‚é€ å ±è¡¨</div>
</div>

<div class="container">
  <div id="mainPage" class="page active">
    <div id="gameTitle" style="color:red; font-weight:900; margin-bottom:10px;">ç›®å‰æ¨¡å¼ï¼šä»Šå½© 539</div>

    <div class="btnbar" style="margin-bottom:10px;">
      <button class="btn btn-cyan" id="mode-dad" onclick="switchUser('dad')">çˆ¸ä½¿ç”¨æ¨¡å¼</button>
      <button class="btn" id="mode-bro" onclick="switchUser('bro')">å“¥ä½¿ç”¨æ¨¡å¼</button>
    </div>

    <div class="mainSubBox">
      <button class="btn btn-red" id="btnMainArm" onclick="armMainPick()">ä¸»é«”</button>
      <button class="btn btn-cyan" id="btnSubMode" onclick="toggleSubMode()">å‰¯é«”(å¤šé¸)</button>
      <button class="btn btn-purple" onclick="clearDragPair()">æ¸…é™¤æ‹–ç‰Œâ‘ â‘¡</button>
      <button class="btn" onclick="clearMainSub()">æ¸…é™¤ä¸»é«”/å‰¯é«”</button>
      <div id="mainSubStatus" class="mainSubHint">ä¸»é«”ï¼šæœªæŒ‡å®šï½œå‰¯é«”ï¼š0 å€‹ï½œæ‹–ç‰Œâ‘ â‘¡ï¼šæœªè¨­å®šï½œç‹€æ…‹ï¼šä¸€èˆ¬</div>
    </div>

    <div class="filters-box"><div class="grid" id="filterGrid"></div></div>

    <div class="btnbar">
      <button class="btn btn-orange mode-btn" onclick="changeMode('æ­·å²æ¨¡å¼', this)">æ­·å²æ¨¡å¼</button>
      <button class="btn btn-yellow mode-btn" onclick="changeMode('æ‹–ç‰Œæ¨¡å¼', this)">æ‹–ç‰Œæ¨¡å¼</button>
      <button class="btn btn-yellow mode-btn" onclick="changeMode('ç•¶æœŸå°ç¢°', this)">ç•¶æœŸå°ç¢°</button>
      <button class="btn btn-yellow mode-btn" onclick="changeMode('ä¸‹æœŸå°ç¢°', this)">ä¸‹æœŸå°ç¢°</button>
      <button class="btn btn-green" onclick="addToReport()">ğŸ§ª åŠ å…¥å ±è¡¨</button>
      <button class="btn" onclick="clearFilters()">æ¸…ç©ºç¯©é¸</button>
    </div>

    <div class="btnbar" style="margin-top:15px; flex-direction: column; align-items: flex-start;">
      <button class="btn btn-purple" onclick="selectToday()">ä¸€éµé¸å–ä»Šæ—¥æ¢ä»¶ & åŒæ­¥é›²ç«¯</button>
      <div id="filterCounter" style="font-weight:bold; font-size:14px; color:red; margin-top:5px; border:1px dashed red; padding:5px; background: #fff;">ç­‰å¾…æ¢ä»¶ä¸­...</div>
    </div>

    <div class="stat-title">å³æ™‚é‹ç®—çµ±è¨ˆ</div>
    <div style="overflow-x:auto">
      <table class="stat-table">
        <thead><tr id="stat-head-1"></tr></thead>
        <tbody><tr id="stat-body-1"></tr></tbody>
      </table>
    </div>

    <div class="stat-title">å…¨åŸŸæœªå‡ºæœŸæ•¸</div>
    <div style="overflow-x:auto">
      <table class="stat-table">
        <thead><tr id="stat-head-2"></tr></thead>
        <tbody><tr id="stat-body-2"></tr></tbody>
      </table>
    </div>
  </div>

  <div id="reportPage" class="page">
    <div id="reportControl" style="background:#ffd966; padding:8px; display:flex; flex-wrap:wrap; gap:10px; align-items:center; margin-bottom:10px; border:1px solid #999;">
      <button class="btn btn-green" onclick="exportToExcel()">åŒ¯å‡º Excel</button>
      <button class="btn" style="margin-left:auto; background:yellow" onclick="clearAllReports()">æ¸…ç©ºå ±è¡¨</button>
    </div>
    <div id="reportContainer"></div>
  </div>
</div>

<script>
// Existing script with added logic for "å°ç¢°" and "ä¸‹æœŸå°ç¢°" mode
// Add the necessary modifications to handle condition + 2 numbers logic

let currentMode = "æ­·å²æ¨¡å¼", currentGame = "539", currentUser = "dad", maxNum = 39, cloudData = [];

const reportStorage = { dad: { "539": [], "Lotto": [] }, bro: { "539": [], "Lotto": [] } };

// Helper function to compute the combinations and match numbers
function computeNextPair(validRows, cond1, cond2, a, b, gameMax) {
  const f1 = {}; f1[cond1.cat] = [String(cond1.val)];
  const f2 = {}; f2[cond2.cat] = [String(cond2.val)];
  const counts = Array(gameMax + 1).fill(0);

  for (let i = 0; i < validRows.length - 1; i++) {
    const row = validRows[i];
    const nxt = validRows[i + 1];
    const rd1 = buildRd(rowMetaFromRow(row));
    const rd2 = buildRd(rowMetaFromRow(nxt));
    if (!matchFilters(rd1, f1)) continue;
    if (!matchFilters(rd2, f2)) continue;

    const balls = rowBalls(row);
    if (!(balls.includes(a) && balls.includes(b))) continue;

    rowBalls(nxt).forEach(n => { if (n <= gameMax) counts[n]++; });
  }
  return counts;
}

// Add to report function for both current and next pair logic
function addToReport() {
  if (!cloudData.length) return alert("å°šæœªè¼‰å…¥è³‡æ–™");
  const validRows = getValidRows();
  if (!validRows.length) return alert("ç„¡æœ‰æ•ˆè³‡æ–™åˆ—");
  const gameMax = (currentGame === "539") ? 39 : 49;

  const group = newGroup(currentMode, `ã€${currentMode}ã€‘${currentGame}`);

  // Handle the logic for each mode as before
  if (currentMode === "æ­·å²æ¨¡å¼") {
    const filters = getSelectedFilters();
    const entries = [];
    Object.entries(filters).forEach(([cat, vals]) => vals.forEach(v => entries.push({ cat, val: v })));
    if (entries.length === 0) return alert("è«‹å…ˆé¸æ“‡è‡³å°‘ 1 å€‹æ¢ä»¶");
    entries.forEach(e => {
      const counts = computeHistorySingle(validRows, e.cat, e.val, gameMax);
      addRowToGroup(group, `${e.cat}:${e.val}`, counts);
    });
    group.title = `ã€æ­·å²æ¨¡å¼ã€‘${entries.map(e => `${e.cat}:${e.val}`).join('ã€')}`;
  }

  // Handle ä¸»é«”æ¨¡å¼
  else if (mainPick && subPicks.length > 0) {
    subPicks.forEach(s => {
      const counts = computeHistoryTwo(validRows, mainPick, s, gameMax);
      addRowToGroup(group, `${mainPick.cat}:${mainPick.val} + ${s.cat}:${s.val}`, counts);
    });
    group.title = `ã€ä¸»é«”æ¨¡å¼ã€‘ä¸»:${mainPick.cat}:${mainPick.val}ï½œå‰¯:${subPicks.map(s => `${s.cat}:${s.val}`).join('ã€')}`;
  }

  // Handle æ‹–ç‰Œæ¨¡å¼
  else if (currentMode === "æ‹–ç‰Œæ¨¡å¼") {
    if (!dragPick1 || !dragPick2) return alert("æ‹–ç‰Œæ¨¡å¼ï¼šè«‹å…ˆç”¨é»æ“Šé †åºè¨­å®š â‘  å’Œ â‘¡ æ¢ä»¶ï¼ˆéè™Ÿç¢¼å€ï¼‰ã€‚");
    const nums = getSelectedNums();
    if (nums.length === 0) return alert("æ‹–ç‰Œæ¨¡å¼ï¼šè«‹å…ˆåœ¨ã€è™Ÿç¢¼ã€‘å€é¸è‡³å°‘ 1 å€‹å‰æœŸè™Ÿç¢¼ã€‚");
    nums.forEach(n => {
      const counts = computeDrag(validRows, dragPick1, dragPick2, n, gameMax);
      addRowToGroup(group, `â‘ ${dragPick1.cat}:${dragPick1.val} + å‰è™Ÿ:${String(n).padStart(2, '0')} â†’ â‘¡${dragPick2.cat}:${dragPick2.val}`, counts);
    });
    group.title = `ã€æ‹–ç‰Œæ¨¡å¼ã€‘â‘ ${dragPick1.cat}:${dragPick1.val} â†’ â‘¡${dragPick2.cat}:${dragPick2.val}ï½œå‰è™Ÿ:${nums.map(n => String(n).padStart(2, '0')).join(',')}`;
  }

  // Handle ç•¶æœŸå°ç¢°
  else if (currentMode === "ç•¶æœŸå°ç¢°") {
    const filters = getSelectedFilters();
    const nums = getSelectedNums();
    const pairs = buildAllPairs(nums);
    if (pairs.length === 0) return alert("ç•¶æœŸå°ç¢°ï¼šè«‹è‡³å°‘é¸ 2 å€‹è™Ÿç¢¼ã€‚");

    entries.forEach(entry => {
      const filters2 = { ...filters };
      filters2[entry.cat] = [String(entry.val)];

      pairs.forEach(([a, b]) => {
        const counts = computePairSameRow(validRows, filters2, a, b, gameMax);
        addRowToGroup(group, `${entry.cat}:${entry.val} + è™Ÿç¢¼:${String(a).padStart(2, '0')},${String(b).padStart(2, '0')}ï½œå…¶é¤˜æ¢ä»¶(äº¤é›†): ${fmtFiltersWithout(filters2, entry.cat)}`, counts);
      });
    });

    group.title = `ã€ç•¶æœŸå°ç¢°ã€‘æ¢ä»¶æ•¸:${entries.length}ï½œ2ç¢¼çµ„åˆ:${pairs.length}ï¼ˆå…±${entries.length * pairs.length}åˆ—ï¼‰`;
  }

  // Handle ä¸‹æœŸå°ç¢°
  else if (currentMode === "ä¸‹æœŸå°ç¢°") {
    if (!dragPick1 || !dragPick2) return alert("ä¸‹æœŸå°ç¢°ï¼šè«‹å…ˆç”¨é»æ“Šé †åºè¨­å®š â‘  å’Œ â‘¡ æ¢ä»¶ï¼ˆéè™Ÿç¢¼å€ï¼‰ã€‚");
    const nums = getSelectedNums();
    const pairs = buildAllPairs(nums);
    if (pairs.length === 0) return alert("ä¸‹æœŸå°ç¢°ï¼šè«‹è‡³å°‘é¸ 2 å€‹å‰æœŸè™Ÿç¢¼ï¼ˆä¾‹å¦‚5ç¢¼ï¼‰ã€‚");

    pairs.forEach(([a, b]) => {
      const counts = computeNextPair(validRows, dragPick1, dragPick2, a, b, gameMax);
      addRowToGroup(group, `â‘ ${dragPick1.cat}:${dragPick1.val} + å‰è™Ÿ:${String(a).padStart(2, '0')},${String(b).padStart(2, '0')} â†’ â‘¡${dragPick2.cat}:${dragPick2.val}`, counts);
    });

    group.title = `ã€ä¸‹æœŸå°ç¢°ã€‘â‘ ${dragPick1.cat}:${dragPick1.val} â†’ â‘¡${dragPick2.cat}:${dragPick2.val}ï½œå‰è™Ÿ:${nums.map(n => String(n).padStart(2, '0')).join(',')}ï½œ2ç¢¼é…å°:${pairs.length}çµ„`;
  }

  reportStorage[currentUser][currentGame].push(group);
  renderCurrentReports();
  const targetTab = document.querySelector(`.tab[data-target="reportPage"][data-game="${currentGame}"]`);
  if (targetTab) targetTab.click();
}

// Add to report helper function
function addRowToGroup(group, label, dataArr){
  group.rows.push({label, data:dataArr});
  for(let i=1; i<=group.limit; i++) group.sum[i] += (dataArr[i] || 0);
}

// Report render helper function
function renderCurrentReports() {
  const cont = document.getElementById('reportContainer');
  cont.innerHTML = '';
  const groups = reportStorage[currentUser][currentGame];
  if (!groups.length) return;

  let html = '';
  groups.forEach((g, gi) => {
    const L = g.limit;
    html += `<div class="report-item">
      <div class="report-header">
        <div class="title">ã€ç¬¬ ${gi+1} å¼µã€‘${g.title}</div>
        <button class="btn btn-red" onclick="deleteReport('${g.id}')">åˆªé™¤æ­¤å ±è¡¨</button>
      </div>
      <table class="report-table">
        <thead>
          <tr><td class="cond-col">çµ±è¨ˆæ˜ç´°</td>${Array.from({length:L},(_,i)=>`<td>${i+1}</td>`).join('')}</tr>
        </thead>
        <tbody>`;
    
    g.rows.forEach(r => {
      const sorted = [...r.data].slice(1).sort((a, b) => b - a);
      const th = (sorted[4] > 0) ? sorted[4] : 999;
      html += `<tr><td class="cond-col">${r.label}</td>${
        r.data.slice(1).map(v => {
          const vv = v || 0;
          const cls = (vv >= th && vv > 0) ? 'top5' : '';
          return `<td class="${cls}">${vv ? vv : ''}</td>`;
        }).join('')
      }</tr>`;
    });

    const sumSorted = [...g.sum].slice(1).sort((a, b) => b - a);
    const sumTh = (sumSorted[4] > 0) ? sumSorted[4] : 999;
    html += `</tbody>
      <tfoot>
        <tr class="sum-row"><td class="cond-col">åŠ ç¸½ (Sum)</td>${
          g.sum.slice(1).map(v => {
            const vv = v || 0;
            const cls = (vv >= sumTh && vv > 0) ? 'top5' : '';
            return `<td class="${cls}">${vv ? vv : ''}</td>`;
          }).join('')
        }</tr>
      </tfoot>
      </table>
    </div>`;
  });

  cont.innerHTML = html;
}

// Report deletion function
function deleteReport(groupId) {
  const list = reportStorage[currentUser][currentGame];
  const idx = list.findIndex(g => g.id === groupId);
  if (idx < 0) return;
  if (!confirm("ç¢ºå®šåˆªé™¤é€™å¼µå ±è¡¨ï¼Ÿ")) return;
  list.splice(idx, 1);
  renderCurrentReports();
}

// Export to Excel function
function exportToExcel() {
  const table = document.querySelector(".report-table");
  if (!table) return alert("ç„¡è³‡æ–™");
  const url = 'data:application/vnd.ms-excel,' + encodeURIComponent(table.outerHTML);
  const link = document.createElement("a");
  link.download = `åˆ†æ_${Date.now()}.xls`;
  link.href = url;
  link.click();
}

// Clear all reports function
function clearAllReports() {
  if (confirm("ç¢ºå®šæ¸…ç©ºï¼Ÿ")) {
    reportStorage[currentUser][currentGame] = [];
    renderCurrentReports();
  }
}

</script>
</body>
</html>
