<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>539 å°ˆæ¥­å›æ¸¬ç³»çµ± - å¹²æ”¯çµ„åˆå¼·åŒ–ç‰ˆ</title>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
  <style>
    :root { --bg: #d1e7d1; --blue-t: #2196F3; --red-box: #f44336; --gold: #ffc107; --total-row: #ffebee; }
    body { background-color: var(--bg); font-family: "Microsoft JhengHei", sans-serif; font-size: 13px; margin: 15px; }
    .main-layout { display: flex; flex-direction: column; gap: 10px; }
    .filter-panel { border: 2px solid var(--red-box); background: #fff; padding: 15px; display: grid; grid-template-columns: 80px 1fr; gap: 8px; border-radius: 8px; }
    .f-label { background: #eee; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 1px solid #ccc; }
    .f-btns { display: flex; flex-wrap: wrap; gap: 4px; }
    .f-item { padding: 4px 12px; border: 1px solid #ccc; cursor: pointer; background: #fff; border-radius: 4px; position: relative; }
    .f-item.active { background: var(--blue-t); color: white; }
    .f-item.active::after { content: attr(data-order); position: absolute; top: -8px; right: -5px; background: #333; color: #fff; border-radius: 50%; width: 16px; height: 16px; font-size: 10px; display: flex; align-items: center; justify-content: center; border: 1px solid white; }
    .action-bar { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; background: rgba(255,255,255,0.5); padding: 10px; border-radius: 8px; }
    .yellow-btn { background: #ffff00; border: 1px solid #000; padding: 8px 15px; font-weight: bold; cursor: pointer; border-radius: 4px; }
    .yellow-btn.active { background: #ff9800 !important; color: white; }
    .add-btn { background: #4CAF50; color: white; border: 1px solid #000; padding: 8px 20px; font-weight: bold; cursor: pointer; border-radius: 4px; }
    .view-container { background: white; border: 2px solid var(--blue-t); padding: 10px; border-radius: 8px; min-height: 500px; }
    .scroll-area { overflow: auto; max-height: 600px; }
    table { border-collapse: collapse; width: 100%; white-space: nowrap; }
    th, td { border: 1px solid #ccc; padding: 5px; text-align: center; }

    .report-card { border: 2px solid #333; background: #fff; margin-bottom: 25px; border-radius: 4px; }
    .report-title { background: #7da7d8; padding: 10px; font-weight: bold; display: flex; justify-content: space-between; align-items: center; gap: 10px; }
    .report-mid { flex: 1; text-align: center; font-weight: bold; color: #0b1b3a; line-height: 1.2; white-space: pre-line; padding: 0 8px; }
    .report-left, .report-right { white-space: nowrap; }

    .top-hit { background-color: #ffff00 !important; font-weight: bold; color: #d32f2f; }
    .total-row { background-color: var(--total-row); font-weight: bold; }
    .hidden { display: none; }

    .today-box{
      margin-left:auto;
      display:flex;
      gap:10px;
      align-items:center;
      padding:6px 10px;
      border:1px solid #ccc;
      background:#fff;
      border-radius:8px;
      font-weight:bold;
      white-space:nowrap;
    }
    .today-pill{
      background:#fffde7;
      border-left:4px solid #ffc107;
      padding:4px 8px;
      border-radius:6px;
    }
    .mini-btn{
      background:#1976d2;
      color:#fff;
      border:1px solid #000;
      padding:6px 10px;
      border-radius:6px;
      cursor:pointer;
      font-weight:bold;
    }
    .mini-btn.gray{ background:#555; }

    .info-bar{
      background:#fffde7;
      padding:8px;
      margin-bottom:5px;
      border-left:5px solid #ffc107;
      display:flex;
      flex-wrap:wrap;
      gap:12px;
      align-items:center;
    }
    .info-bar input{ width:70px; padding:3px 6px; }
    .info-hint{ color:#444; font-weight:bold; }

    /* âœ… ç¯€æ°£ S/T åˆ†è¡Œå®¹å™¨ */
    .solar-rows{ display:flex; flex-direction:column; gap:6px; }
    .solar-row{ display:flex; flex-wrap:wrap; gap:4px; align-items:center; }
  </style>
</head>
<body>

<div class="main-layout">
  <div style="display:flex; gap:5px;">
    <button onclick="switchPage('dist')" style="flex:1; padding:12px; font-weight:bold; cursor:pointer;">æ•¸æ“šåˆ†ä½ˆåœ–</button>
    <button onclick="switchPage('repo')" style="flex:1; padding:12px; font-weight:bold; cursor:pointer;">åŒ¯ç¸½å ±è¡¨</button>
  </div>

  <div id="page-dist" class="view-container">
    <div class="info-bar">
      <div class="info-hint">ğŸ’¡ é¡¯ç¤ºæœ€è¿‘</div>
      <div>
        <input type="number" id="viewN" value="10" min="0" onchange="applyFilter()">
        <span>æœŸï¼ˆ0 ä»£è¡¨å…¨éƒ¨é¡¯ç¤ºï¼›ä»¥ä»Šå¤©æ—¥æœŸç‚ºä¸Šé™å›æ¨ï¼‰</span>
      </div>

      <div class="info-hint">ğŸ“Š çµ±è¨ˆ/å ±è¡¨ç¯„åœ</div>
      <div>
        <input type="number" id="recentN" value="0" min="0" onchange="applyFilter()">
        <span>æœŸï¼ˆ0 ä»£è¡¨çµ±è¨ˆå…¨éƒ¨ï¼›åŒæ¨£åªå–<=ä»Šå¤©çš„è³‡æ–™ï¼‰</span>
      </div>

      <div style="color:#666;">ï¼ˆé¡¯ç¤ºç”¨èˆ‡çµ±è¨ˆç”¨å¯åˆ†é–‹è¨­å®šï¼‰</div>
    </div>

    <div class="filter-panel">
      <div class="f-label">å¹´ä»½</div><div class="f-btns" data-type="year"></div>
      <div class="f-label">é€±</div><div class="f-btns" data-type="week"></div>
      <div class="f-label">å¤©å¹²</div><div class="f-btns" data-type="tian"></div>
      <div class="f-label">åœ°æ”¯</div><div class="f-btns" data-type="di"></div>
      <div class="f-label">ç¯€æ°£</div><div class="f-btns" data-type="solar"></div>
      <div class="f-label" style="color:blue">è™Ÿç¢¼</div><div class="f-btns" data-type="nums"></div>
    </div>

    <div class="action-bar">
      <button class="yellow-btn btn-mode-h" onclick="setMode('history')">æ­·å²çµ±è¨ˆ</button>
      <button class="yellow-btn btn-mode-t" onclick="setMode('tuopai')">æ‹–ç‰Œæ¨¡å¼</button>
      <button class="yellow-btn btn-mode-cur" onclick="setMode('current')">ç•¶æœŸå°ç¢°</button>
      <button class="yellow-btn btn-mode-next" onclick="setMode('next')">ä¸‹æœŸå°ç¢°</button>
      <button class="add-btn" onclick="generateBatchReport()">åŠ å…¥å ±è¡¨</button>
      <button onclick="clearFilters()">æ¸…ç©ºç¯©é¸</button>

      <div class="today-box" id="todayBox">
        <span class="today-pill" id="todayDate">ä»Šæ—¥ï¼š--/--/--</span>
        <span class="today-pill" id="todayGanzhi">å¹²æ”¯ï¼š--</span>
        <button class="mini-btn" onclick="applyTodayGanzhiFilter()">å¥—ç”¨ä»Šæ—¥å¹²æ”¯ç¯©é¸</button>
        <button class="mini-btn gray" onclick="clearTodayGanzhiFilter()">æ¸…é™¤ä»Šæ—¥å¹²æ”¯</button>
      </div>

      <span id="fileMsg" style="margin-left:auto; font-weight:bold; color:red;">é€£ç·šä¸­...</span>
    </div>

    <div class="scroll-area">
      <table>
        <thead>
          <tr id="thr">
            <th>æœŸè™Ÿ</th><th>æ—¥æœŸ</th><th>é€±</th><th>å¤©å¹²</th><th>åœ°æ”¯</th><th>ç¯€æ°£</th>
            <th>çƒ1</th><th>çƒ2</th><th>çƒ3</th><th>çƒ4</th><th>çƒ5</th>
          </tr>
        </thead>
        <tbody id="gridBody"></tbody>
      </table>
    </div>
  </div>

  <div id="page-repo" class="view-container hidden">
    <div style="margin-bottom:10px;">
      <button onclick="clearAllReports()" style="background:#d32f2f; color:white; padding:8px 15px; cursor:pointer; font-weight:bold;">âš ï¸ æ¸…ç©ºæ‰€æœ‰å ±è¡¨</button>
    </div>
    <div id="repo-list"></div>
  </div>
</div>

<script>
  const GSHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTuGa3v-rwH8Qh-JXF9MfxwUwT0A-iJooRI6ypJTErCsxN9qCjZQrgr70f16ZoehQ/pub?output=csv";
  let db = [];
  let currentMode = 'history';
  let filters = { year:[], week:[], tian:[], di:[], solar:[], nums:[] };
  let savedReports = JSON.parse(localStorage.getItem('539_reports') || "[]");

  // âœ… ç”¨ä»Šå¤©æ—¥æœŸåšä¸Šé™ï¼šåªå–æ—¥æœŸ <= today çš„è³‡æ–™
  let eligibleIdxs = []; // db çš„å¯ç”¨ç´¢å¼•ï¼ˆ<=ä»Šå¤©ï¼‰
  let eligibleRows = []; // å¯ç”¨ rowsï¼ˆ<=ä»Šå¤©ï¼‰

  function pad2(n){ return String(n).padStart(2,'0'); }
  function excelSerialToDate(serial){
    const utcDays = serial - 25569;
    const utcMs = utcDays * 86400 * 1000;
    return new Date(utcMs);
  }
  function normalizeDate(val){
    if(val == null || val === '') return { ymd:'', year:'' };

    if(val instanceof Date && !isNaN(val.getTime())){
      const y = val.getFullYear(), m = pad2(val.getMonth()+1), d = pad2(val.getDate());
      return { ymd:`${y}/${m}/${d}`, year:String(y) };
    }

    const num = (typeof val === 'number')
      ? val
      : (String(val).trim().match(/^\d+(\.\d+)?$/) ? Number(val) : NaN);

    if(!isNaN(num) && num > 20000 && num < 80000){
      const dt = excelSerialToDate(num);
      if(!isNaN(dt.getTime())){
        const y = dt.getFullYear(), m = pad2(dt.getMonth()+1), d = pad2(dt.getDate());
        return { ymd:`${y}/${m}/${d}`, year:String(y) };
      }
    }

    let s = String(val).trim();
    s = s.split(' ')[0];

    if(/^\d{8}$/.test(s)){
      const y=s.slice(0,4), m=s.slice(4,6), d=s.slice(6,8);
      return { ymd:`${y}/${m}
