<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>539 å°ˆæ¥­å›æ¸¬ç³»çµ± - å¹²æ”¯çµ„åˆå¼·åŒ–ç‰ˆ</title>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
  <style>
    :root { --bg: #d1e7d1; --blue-t: #2196F3; --red-box: #f44336; --gold: #ffc107; --total-row: #ffebee; }
    body { background-color: var(--bg); font-family: "Microsoft JhengHei", sans-serif; font-size: 13px; margin: 15px; }
    .main-layout { display: flex; flex-direction: column; gap: 10px; }
    .filter-panel { border: 2px solid var(--red-box); background: #fff; padding: 15px; display: grid; grid-template-columns: 80px 1fr; gap: 8px; border-radius: 8px; }
    .f-label { background: #eee; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 1px solid #ccc; }
    .f-btns { display: flex; flex-wrap: wrap; gap: 4px; }
    .f-item { padding: 4px 12px; border: 1px solid #ccc; cursor: pointer; background: #fff; border-radius: 4px; position: relative; }
    .f-item.active { background: var(--blue-t); color: white; }
    .f-item.active::after { content: attr(data-order); position: absolute; top: -8px; right: -5px; background: #333; color: #fff; border-radius: 50%; width: 16px; height: 16px; font-size: 10px; display: flex; align-items: center; justify-content: center; border: 1px solid white; }
    .action-bar { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; background: rgba(255,255,255,0.5); padding: 10px; border-radius: 8px; }
    .yellow-btn { background: #ffff00; border: 1px solid #000; padding: 8px 15px; font-weight: bold; cursor: pointer; border-radius: 4px; }
    .yellow-btn.active { background: #ff9800 !important; color: white; }
    .add-btn { background: #4CAF50; color: white; border: 1px solid #000; padding: 8px 20px; font-weight: bold; cursor: pointer; border-radius: 4px; }
    .view-container { background: white; border: 2px solid var(--blue-t); padding: 10px; border-radius: 8px; min-height: 500px; }
    .scroll-area { overflow: auto; max-height: 600px; }
    table { border-collapse: collapse; width: 100%; white-space: nowrap; }
    th, td { border: 1px solid #ccc; padding: 5px; text-align: center; }

    .report-card { border: 2px solid #333; background: #fff; margin-bottom: 25px; border-radius: 4px; }
    .report-title { background: #7da7d8; padding: 10px; font-weight: bold; display: flex; justify-content: space-between; align-items: center; gap: 10px; }

    /* âœ… æ–°å¢ï¼šè—åº•ä¸­é–“é¡¯ç¤ºç¯©é¸æ¢ä»¶æ‘˜è¦ */
    .report-mid {
      flex: 1;
      text-align: center;
      font-weight: bold;
      color: #0b1b3a;
      line-height: 1.2;
      white-space: pre-line; /* æ”¯æ´æ›è¡Œ */
      padding: 0 8px;
    }
    .report-left { white-space: nowrap; }
    .report-right { white-space: nowrap; }

    .top-hit { background-color: #ffff00 !important; font-weight: bold; color: #d32f2f; }
    .total-row { background-color: var(--total-row); font-weight: bold; }
    .hidden { display: none; }

    .today-box{
      margin-left:auto;
      display:flex;
      gap:10px;
      align-items:center;
      padding:6px 10px;
      border:1px solid #ccc;
      background:#fff;
      border-radius:8px;
      font-weight:bold;
      white-space:nowrap;
    }
    .today-pill{
      background:#fffde7;
      border-left:4px solid #ffc107;
      padding:4px 8px;
      border-radius:6px;
    }
    .mini-btn{
      background:#1976d2;
      color:#fff;
      border:1px solid #000;
      padding:6px 10px;
      border-radius:6px;
      cursor:pointer;
      font-weight:bold;
    }
    .mini-btn.gray{ background:#555; }

    .info-bar{
      background:#fffde7;
      padding:8px;
      margin-bottom:5px;
      border-left:5px solid #ffc107;
      display:flex;
      flex-wrap:wrap;
      gap:12px;
      align-items:center;
    }
    .info-bar input{ width:70px; padding:3px 6px; }
    .info-hint{ color:#444; font-weight:bold; }

    /* âœ… æ–°å¢ï¼šç¯€æ°£åˆ†2è¡Œçš„æ¨£å¼ï¼ˆä¸å½±éŸ¿å…¶å®ƒé¡åˆ¥ï¼‰ */
    .solar-wrap{ display:flex; flex-direction:column; gap:6px; }
    .solar-row{ display:flex; flex-wrap:wrap; gap:4px; }
  </style>
</head>
<body>

<div class="main-layout">
  <div style="display:flex; gap:5px;">
    <button onclick="switchPage('dist')" style="flex:1; padding:12px; font-weight:bold; cursor:pointer;">æ•¸æ“šåˆ†ä½ˆåœ–</button>
    <button onclick="switchPage('repo')" style="flex:1; padding:12px; font-weight:bold; cursor:pointer;">åŒ¯ç¸½å ±è¡¨</button>
  </div>

  <div id="page-dist" class="view-container">
    <div class="info-bar">
      <div class="info-hint">ğŸ’¡ é¡¯ç¤ºæœ€è¿‘</div>
      <div>
        <input type="number" id="viewN" value="10" min="0" onchange="applyFilter()">
        <span>æœŸï¼ˆ0 ä»£è¡¨å…¨éƒ¨é¡¯ç¤ºï¼‰</span>
      </div>

      <div class="info-hint">ğŸ“Š çµ±è¨ˆ/å ±è¡¨ç¯„åœ</div>
      <div>
        <input type="number" id="recentN" value="0" min="0" onchange="applyFilter()">
        <span>æœŸï¼ˆ0 ä»£è¡¨çµ±è¨ˆå…¨éƒ¨ï¼‰</span>
      </div>

      <div style="color:#666;">ï¼ˆé¡¯ç¤ºç”¨èˆ‡çµ±è¨ˆç”¨å¯åˆ†é–‹è¨­å®šï¼‰</div>
    </div>

    <div class="filter-panel">
      <div class="f-label">å¹´ä»½</div><div class="f-btns" data-type="year"></div>
      <div class="f-label">é€±</div><div class="f-btns" data-type="week"></div>
      <div class="f-label">å¤©å¹²</div><div class="f-btns" data-type="tian"></div>
      <div class="f-label">åœ°æ”¯</div><div class="f-btns" data-type="di"></div>
      <div class="f-label">ç¯€æ°£</div><div class="f-btns" data-type="solar"></div>
      <div class="f-label" style="color:blue">è™Ÿç¢¼</div><div class="f-btns" data-type="nums"></div>
    </div>

    <div class="action-bar">
      <button class="yellow-btn btn-mode-h" onclick="setMode('history')">æ­·å²çµ±è¨ˆ</button>
      <button class="yellow-btn btn-mode-t" onclick="setMode('tuopai')">æ‹–ç‰Œæ¨¡å¼</button>
      <button class="yellow-btn btn-mode-cur" onclick="setMode('current')">ç•¶æœŸå°ç¢°</button>
      <button class="yellow-btn btn-mode-next" onclick="setMode('next')">ä¸‹æœŸå°ç¢°</button>
      <button class="add-btn" onclick="generateBatchReport()">åŠ å…¥å ±è¡¨</button>
      <button onclick="clearFilters()">æ¸…ç©ºç¯©é¸</button>

      <div class="today-box" id="todayBox">
        <span class="today-pill" id="todayDate">ä»Šæ—¥ï¼š--/--/--</span>
        <span class="today-pill" id="todayGanzhi">å¹²æ”¯ï¼š--</span>
        <button class="mini-btn" onclick="applyTodayGanzhiFilter()">å¥—ç”¨ä»Šæ—¥å¹²æ”¯ç¯©é¸</button>
        <button class="mini-btn gray" onclick="clearTodayGanzhiFilter()">æ¸…é™¤ä»Šæ—¥å¹²æ”¯</button>
      </div>

      <span id="fileMsg" style="margin-left:auto; font-weight:bold; color:red;">é€£ç·šä¸­...</span>
    </div>

    <div class="scroll-area">
      <table>
        <thead>
          <tr id="thr">
            <th>æœŸè™Ÿ</th><th>æ—¥æœŸ</th><th>é€±</th><th>å¤©å¹²</th><th>åœ°æ”¯</th><th>ç¯€æ°£</th>
            <th>çƒ1</th><th>çƒ2</th><th>çƒ3</th><th>çƒ4</th><th>çƒ5</th>
          </tr>
        </thead>
        <tbody id="gridBody"></tbody>
      </table>
    </div>
  </div>

  <div id="page-repo" class="view-container hidden">
    <div style="margin-bottom:10px;">
      <button onclick="clearAllReports()" style="background:#d32f2f; color:white; padding:8px 15px; cursor:pointer; font-weight:bold;">âš ï¸ æ¸…ç©ºæ‰€æœ‰å ±è¡¨</button>
    </div>
    <div id="repo-list"></div>
  </div>
</div>

<script>
  const GSHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTuGa3v-rwH8Qh-JXF9MfxwUwT0A-iJooRI6ypJTErCsxN9qCjZQrgr70f16ZoehQ/pub?output=csv";
  let db = [];
  let currentMode = 'history';
  let filters = { year:[], week:[], tian:[], di:[], solar:[], nums:[] };
  let savedReports = JSON.parse(localStorage.getItem('539_reports') || "[]");

  function pad2(n){ return String(n).padStart(2,'0'); }
  function excelSerialToDate(serial){
    const utcDays = serial - 25569;
    const utcMs = utcDays * 86400 * 1000;
    return new Date(utcMs);
  }
  function normalizeDate(val){
    if(val == null || val === '') return { ymd:'', year:'' };
    if(val instanceof Date && !isNaN(val.getTime())){
      const y = val.getFullYear(), m = pad2(val.getMonth()+1), d = pad2(val.getDate());
      return { ymd:`${y}/${m}/${d}`, year:String(y) };
    }
    const num = (typeof val === 'number')
      ? val
      : (String(val).trim().match(/^\d+(\.\d+)?$/) ? Number(val) : NaN);
    if(!isNaN(num) && num > 20000 && num < 80000){
      const dt = excelSerialToDate(num);
      if(!isNaN(dt.getTime())){
        const y = dt.getFullYear(), m = pad2(dt.getMonth()+1), d = pad2(dt.getDate());
        return { ymd:`${y}/${m}/${d}`, year:String(y) };
      }
    }
    let s = String(val).trim();
    s = s.split(' ')[0];
    if(/^\d{8}$/.test(s)){
      const y=s.slice(0,4), m=s.slice(4,6), d=s.slice(6,8);
      return { ymd:`${y}/${m}/${d}`, year:y };
    }
    s = s.replace(/\./g,'/').replace(/-/g,'/');
    const m1 = s.match(/^(\d{4})\/(\d{1,2})\/(\d{1,2})$/);
    if(m1){
      const y=m1[1], m=pad2(m1[2]), d=pad2(m1[3]);
      return { ymd:`${y}/${m}/${d}`, year:y };
    }
    const dt2 = new Date(val);
    if(!isNaN(dt2.getTime())){
      const y = dt2.getFullYear(), m = pad2(dt2.getMonth()+1), d = pad2(dt2.getDate());
      return { ymd:`${y}/${m}/${d}`, year:String(y) };
    }
    return { ymd: String(val), year: String(val).slice(0,4) };
  }

  const STEMS = ['ç”²','ä¹™','ä¸™','ä¸','æˆŠ','å·±','åºš','è¾›','å£¬','ç™¸'];
  const BRANCHES = ['å­','ä¸‘','å¯…','å¯','è¾°','å·³','åˆ','æœª','ç”³','é…‰','æˆŒ','äº¥'];
  const GANZHI_BASE = new Date(1984, 1, 2);

  function daysBetweenLocal(d1, d2){
    const a = new Date(d1.getFullYear(), d1.getMonth(), d1.getDate()).getTime();
    const b = new Date(d2.getFullYear(), d2.getMonth(), d2.getDate()).getTime();
    return Math.round((b - a) / 86400000);
  }
  function getGanzhiOfDate(d){
    const diff = daysBetweenLocal(GANZHI_BASE, d);
    const idx60 = ((diff % 60) + 60) % 60;
    const stem = STEMS[idx60 % 10];
    const branch = BRANCHES[idx60 % 12];
    return { stem, branch, text: stem + branch };
  }

  let todayGanzhi = { stem:'', branch:'', text:'' };

  function initTodayUI(){
    const now = new Date();
    const y = now.getFullYear(), m = pad2(now.getMonth()+1), d = pad2(now.getDate());
    document.getElementById('todayDate').innerText = `ä»Šæ—¥ï¼š${y}/${m}/${d}`;
    todayGanzhi = getGanzhiOfDate(now);
    document.getElementById('todayGanzhi').innerText = `å¹²æ”¯ï¼š${todayGanzhi.text}`;
  }

  function addFilterValue(type, val){
    if(!filters[type].includes(val)){
      filters[type].push(val);
      document.querySelectorAll(`[data-type="${type}"] .f-item`).forEach(el=>{
        if(el.innerText === val){
          el.classList.add('active');
          if(currentMode === 'tuopai' && !['nums','year'].includes(type)){
            el.setAttribute('data-order', filters[type].length);
          }
        }
      });
    }
  }
  function removeFilterValue(type, val){
    const idx = filters[type].indexOf(val);
    if(idx > -1) filters[type].splice(idx, 1);
    document.querySelectorAll(`[data-type="${type}"] .f-item`).forEach(el=>{
      if(el.innerText === val){
        el.classList.remove('active');
        el.removeAttribute('data-order');
      }
    });
  }
  function applyTodayGanzhiFilter(){
    if(!todayGanzhi.stem || !todayGanzhi.branch) return;
    addFilterValue('tian', todayGanzhi.stem);
    addFilterValue('di', todayGanzhi.branch);
    applyFilter();
  }
  function clearTodayGanzhiFilter(){
    if(!todayGanzhi.stem || !todayGanzhi.branch) return;
    removeFilterValue('tian', todayGanzhi.stem);
    removeFilterValue('di', todayGanzhi.branch);
    applyFilter();
  }

  async function loadCloudData() {
    try {
      const response = await fetch(GSHEET_CSV_URL, { cache: "no-store" });
      const csvText = await response.text();
      const workbook = XLSX.read(csvText, { type: 'string' });

      db = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { header: 1 })
        .filter(row => row[0] && !isNaN(row[0]));

      const years = [...new Set(db.map(row => normalizeDate(row[1]).year))]
        .filter(y => /^\d{4}$/.test(y))
        .sort((a,b)=>Number(b)-Number(a));
      build('year', years);

      renderGrid();
      document.getElementById('fileMsg').innerText = `æ•¸æ“šï¼š${db.length} æœŸ`;

      setMode('history');
      updateReportUI();
      applyFilter();

    } catch (e) {
      console.error(e);
      document.getElementById('fileMsg').innerText = "è¼‰å…¥å¤±æ•—";
    }
  }

  function build(type, list) {
    const container = document.querySelector(`[data-type="${type}"]`);
    if(!container) return;
    container.innerHTML = '';
    list.forEach(v => {
      const div = document.createElement('div');
      div.className = 'f-item';
      div.innerText = v;
      div.onclick = () => handleItem(div, type, v);
      container.appendChild(div);
    });
  }

  function handleItem(el, type, val) {
    const arr = filters[type];
    const idx = arr.indexOf(val);

    if(idx > -1) {
      arr.splice(idx, 1);
      el.classList.remove('active');
      el.removeAttribute('data-order');
    } else {
      if(currentMode === 'tuopai' && !['nums','year'].includes(type) && arr.length >= 2) return;
      arr.push(val);
      el.classList.add('active');
      if(currentMode === 'tuopai' && !['nums','year'].includes(type)) el.setAttribute('data-order', arr.length);
    }
    applyFilter();
  }

  function getStatDb(){
    const n = parseInt(document.getElementById('recentN').value) || 0;
    return (n > 0) ? db.slice(-n) : db;
  }

  function getFilterSummaryForReport(){
    const viewN = parseInt(document.getElementById('viewN').value) || 0;
    const recentN = parseInt(document.getElementById('recentN').value) || 0;

    const modeMap = { history:'æ­·å²çµ±è¨ˆ', tuopai:'æ‹–ç‰Œå›æ¸¬', current:'ç•¶æœŸå°ç¢°', next:'ä¸‹æœŸå°ç¢°' };
    const modeText = modeMap[currentMode] || currentMode;

    const parts = [];
    const add = (label, arr) => { if(arr && arr.length) parts.push(`${label}:${arr.join(',')}`); };

    add('å¹´ä»½', filters.year);
    add('é€±', filters.week);
    add('å¤©å¹²', filters.tian);
    add('åœ°æ”¯', filters.di);
    add('ç¯€æ°£', filters.solar);
    add('è™Ÿç¢¼', filters.nums);

    const cond = parts.length ? parts.join('ï½œ') : 'ç„¡ç¯©é¸';
    const meta = `é¡¯ç¤º:${viewN===0?'å…¨éƒ¨':viewN+'æœŸ'}ï½œçµ±è¨ˆ:${recentN===0?'å…¨éƒ¨':recentN+'æœŸ'}ï½œæ¨¡å¼:${modeText}`;
    return `${cond}\n${meta}`;
  }

  function generateBatchReport() {
    const activeDb = getStatDb();
    const results = [];
    const catNames = { year:'å¹´ä»½', week:'é€±', tian:'å¤©å¹²', di:'åœ°æ”¯', solar:'ç¯€æ°£' };

    ['year','week','tian','di','solar'].forEach(cat => {
      filters[cat].forEach(val => {
        let s = Array(40).fill(0), c = 0;

        activeDb.forEach(row => {
          let hit = false;
          if(cat === 'year'){
            hit = (normalizeDate(row[1]).year === val);
          } else {
            const colIdx = ['week','tian','di','solar'].indexOf(cat) + 2;
            hit = String(row[colIdx]).includes(val);
          }

          if(hit){
            row.slice(6,11).map(Number).forEach(n => { if(n>0) s[n]++; });
            c++;
          }
        });

        if(c > 0) results.push({ label: `${catNames[cat]}:${val}`, data: s, matches: c });
      });
    });

    if(filters.tian.length > 0 && filters.di.length > 0) {
      filters.tian.forEach(t => {
        filters.di.forEach(d => {
          let s = Array(40).fill(0), c = 0;
          activeDb.forEach(row => {
            if(String(row[3]).includes(t) && String(row[4]).includes(d)) {
              row.slice(6,11).map(Number).forEach(n => { if(n>0) s[n]++; });
              c++;
            }
          });
          if(c > 0) results.push({ label: `çµ„åˆ:${t}${d}`, data: s, matches: c });
        });
      });
    }

    const titleMap = { history: "æ­·å²çµ±è¨ˆ", tuopai: "æ‹–ç‰Œå›æ¸¬", current: "ç•¶æœŸå°ç¢°", next: "ä¸‹æœŸå°ç¢°" };

    if(results.length) {
      const summary = getFilterSummaryForReport();
      saveAndRender(titleMap[currentMode], results, summary);
    }
    switchPage('repo');
  }

  function updateReportUI() {
    const list = document.getElementById('repo-list');
    list.innerHTML = '';

    savedReports.forEach(report => {
      const card = document.createElement('div');
      card.className = 'report-card';
      let totals = Array(40).fill(0);

      let h = `
        <div class="report-title">
          <span class="report-left">ã€${report.title}ã€‘</span>
          <div class="report-mid">${report.summary || ''}</div>
          <span class="report-right"><button onclick="deleteReport(${report.id})">åˆªé™¤</button></span>
        </div>
        <div class="scroll-area">
          <table>
            <thead><tr style="background:#eee"><td>é …ç›®</td>`;

      for(let i=1; i<=39; i++) h += `<td>${i}</td>`;
      h += `</tr></thead><tbody>`;

      report.rows.forEach(r => {
        const top3 = getTop3Indices(r.data);
        h += `<tr><td style="font-weight:bold; background:#f9f9f9;">${r.label} (${r.matches}æœŸ)</td>`;
        for(let i=1; i<=39; i++) {
          const v = r.data[i] || 0;
          totals[i] += v;
          h += `<td class="${top3.includes(i)?'top-hit':''}">${v||''}</td>`;
        }
        h += `</tr>`;
      });

      h += `</tbody><tfoot class="total-row"><tr><td>ç¸½è¨ˆ (SUM)</td>`;
      for(let i=1; i<=39; i++) h += `<td>${totals[i] || ''}</td>`;
      h += `</tr></tfoot></table></div>`;

      card.innerHTML = h;
      list.appendChild(card);
    });
  }

  function getTop3Indices(data) {
    const sorted = data.map((v, i) => ({v, i}))
      .filter(x => x.i > 0 && x.v > 0)
      .sort((a, b) => b.v - a.v);
    const topVals = [...new Set(sorted.map(x => x.v))].slice(0, 3);
    return sorted.filter(x => topVals.includes(x.v)).map(x => x.i);
  }

  function saveAndRender(title, rows, summary) {
    savedReports.unshift({ title, rows, summary, id: Date.now() });
    localStorage.setItem('539_reports', JSON.stringify(savedReports));
    updateReportUI();
  }

  function deleteReport(id) {
    savedReports = savedReports.filter(r => r.id !== id);
    localStorage.setItem('539_reports', JSON.stringify(savedReports));
    updateReportUI();
  }

  function clearAllReports() {
    if(confirm("ç¢ºå®šæ¸…ç©ºï¼Ÿ")) {
      savedReports = [];
      localStorage.removeItem('539_reports');
      updateReportUI();
    }
  }

  function switchPage(p) {
    document.getElementById('page-dist').className = (p==='dist'?'view-container':'hidden');
    document.getElementById('page-repo').className = (p==='repo'?'view-container':'hidden');
  }

  function clearFilters() {
    filters = { year:[], week:[], tian:[], di:[], solar:[], nums:[] };
    document.querySelectorAll('.f-item').forEach(el => { el.classList.remove('active'); el.removeAttribute('data-order'); });
    applyFilter();
  }

  function setMode(m) {
    currentMode = m;
    document.querySelectorAll('.yellow-btn').forEach(b => b.classList.remove('active'));
    document.querySelector(`.btn-mode-${m === 'history' ? 'h' : m === 'tuopai' ? 't' : m === 'current' ? 'cur' : 'next'}`).classList.add('active');
    clearFilters();
  }

  function renderGrid() {
    const body = document.getElementById('gridBody');
    body.innerHTML = '';
    db.forEach((row) => {
      const tr = document.createElement('tr');
      for(let i=0; i<11; i++){
        const td = document.createElement('td');
        let val = row[i] || '';
        if(i === 1) val = normalizeDate(val).ymd;
        td.innerText = val;
        tr.appendChild(td);
      }
      for(let n=1; n<=39; n++){
        const td = document.createElement('td');
        td.className = 'num-cell';
        td.setAttribute('data-n', n);
        tr.appendChild(td);
      }
      body.appendChild(tr);
    });
  }

  function applyFilter() {
    const viewN = parseInt(document.getElementById('viewN').value) || 0;
    const statDb = getStatDb();
    const viewStartIdx = (viewN > 0) ? Math.max(0, db.length - viewN) : 0;

    const rows = document.querySelectorAll('#gridBody tr');
    let counts = Array(40).fill(0);

    rows.forEach((tr, idx) => {
      if(idx < viewStartIdx) { tr.style.display = 'none'; return; }
      const data = db[idx];
      let ok = true;

      if(filters.year.length > 0) ok &= filters.year.includes(normalizeDate(data[1]).year);

      ['week','tian','di','solar'].forEach(cat => {
        if(filters[cat].length > 0) {
          const colIdx = ['week','tian','di','solar'].indexOf(cat)+2;
          ok &= filters[cat].some(v => String(data[colIdx]).includes(v));
        }
      });

      const win = data.slice(6, 11).map(Number);
      if(filters.nums.length > 0) ok &= filters.nums.every(num => win.includes(Number(num)));

      tr.style.display = ok ? '' : 'none';

      if(ok) {
        tr.querySelectorAll('.num-cell').forEach(td => {
          const num = parseInt(td.getAttribute('data-n'));
          td.innerText = win.includes(num) ? num : '';
        });
      } else {
        tr.querySelectorAll('.num-cell').forEach(td => td.innerText = '');
      }
    });

    statDb.forEach(row => {
      let ok = true;

      if(filters.year.length > 0) ok &= filters.year.includes(normalizeDate(row[1]).year);

      ['week','tian','di','solar'].forEach(cat => {
        if(filters[cat].length > 0) {
          const colIdx = ['week','tian','di','solar'].indexOf(cat)+2;
          ok &= filters[cat].some(v => String(row[colIdx]).includes(v));
        }
      });

      const win = row.slice(6, 11).map(Number);
      if(filters.nums.length > 0) ok &= filters.nums.every(num => win.includes(Number(num)));

      if(ok){
        win.forEach(n => { if(n>0) counts[n]++; });
      }
    });

    for(let i=1; i<=39; i++) {
      const el = document.getElementById(`s-${i}`);
      if(el) el.innerText = counts[i];
    }
  }

  function initUI() {
    build('week', ['ä¸€','äºŒ','ä¸‰','å››','äº”','å…­','æ—¥']);
    build('tian', ['ç”²','ä¹™','ä¸™','ä¸','æˆŠ','å·±','åºš','è¾›','å£¬','ç™¸']);
    build('di', ['å­','ä¸‘','å¯…','å¯','è¾°','å·³','åˆ','æœª','ç”³','é…‰','æˆŒ','äº¥']);

    /* âœ… ä¿®æ”¹é»ï¼šç¯€æ°£ S / T åˆ† 2 è¡Œï¼ˆå–ä»£åŸæœ¬ build('solar', slist)ï¼‰ */
    (function buildSolarTwoRows(){
      const container = document.querySelector('[data-type="solar"]');
      if(!container) return;
      container.innerHTML = '';

      const wrap = document.createElement('div');
      wrap.className = 'solar-wrap';

      const rowT = document.createElement('div');
      rowT.className = 'solar-row';

      const rowS = document.createElement('div');
      rowS.className = 'solar-row';

      for(let i=0; i<=15; i++){
        const t = 'T' + i;
        const s = 'S' + i;

        const tDiv = document.createElement('div');
        tDiv.className = 'f-item';
        tDiv.innerText = t;
        tDiv.onclick = () => handleItem(tDiv, 'solar', t);
        rowT.appendChild(tDiv);

        const sDiv = document.createElement('div');
        sDiv.className = 'f-item';
        sDiv.innerText = s;
        sDiv.onclick = () => handleItem(sDiv, 'solar', s);
        rowS.appendChild(sDiv);
      }

      wrap.appendChild(rowT);
      wrap.appendChild(rowS);
      container.appendChild(wrap);
    })();

    build('nums', Array.from({length:39}, (_,i)=>i+1));

    for(let i=1; i<=39; i++) {
      const th = document.createElement('th');
      th.style.background = '#ffc107';
      th.innerHTML = `${i}<br><span id="s-${i}" style="font-size:10px; color:blue">0</span>`;
      document.getElementById('thr').appendChild(th);
    }

    initTodayUI();
    loadCloudData();
  }

  initUI();
</script>
</body>
</html>
