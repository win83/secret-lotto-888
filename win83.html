<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>Êà∞Â†¥Áõ£Êéß Pro - ÊéíÂêçÂ¢ûÂº∑Áâà</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        :root { --defense: #2c3e50; --win: #d93025; --bg: #f8f9fa; --ready: #fff9c4; --dist: #607d8b; --rank: #546e7a; }
        body { font-family: -apple-system, sans-serif; margin: 0; padding: 2px; background: var(--bg); font-size: 11px; overflow-x: hidden; }
        .container { width: 100%; background: white; border-radius: 4px; box-shadow: 0 1px 5px rgba(0,0,0,0.1); position: relative; }
        
        .btn-group { padding: 5px; background: #eee; display: flex; gap: 8px; align-items: center; border-bottom: 1px solid #ddd; flex-wrap: wrap; position: sticky; top: 0; z-index: 100; }
        .btn-game { padding: 4px 10px; border: none; border-radius: 3px; color: white; cursor: pointer; font-weight: bold; }
        .btn-mode { padding: 4px 12px; border: 1px solid #999; border-radius: 3px; background: white; cursor: pointer; font-weight: bold; }
        .btn-mode.active { background: #007bff; color: white; border-color: #0056b3; }
        .btn-report { background: #673ab7; color: white; border: none; padding: 4px 12px; border-radius: 3px; cursor: pointer; font-weight: bold; }
        
        .table-wrapper { width: 100%; overflow: auto; max-height: 88vh; scroll-behavior: smooth; background: white; position: relative; }
        table { border-collapse: collapse; table-layout: fixed; width: 100%; min-width: 1200px; position: relative; }
        th, td { border: 1px solid #ddd; text-align: center; padding: 4px 0; position: relative; }
        
        .sticky-col { width: 85px; background: #eceff1 !important; font-weight: bold; position: sticky; left: 0; z-index: 2000; border-right: 2px solid #bbb; cursor: pointer; }
        .recent-header, .sticky-header, .second-header { position: sticky; z-index: 1000; }
        .recent-header .sticky-col, .sticky-header .sticky-col, .second-header .sticky-col { z-index: 2500; background: #cfd8dc !important; }
        td { background: white; }

        .ready-line { background: var(--ready) !important; color: #0d47a1; height: 25px; font-weight: 900; cursor: pointer; }
        .pos-line { background: var(--defense) !important; color: white; height: 20px; font-size: 9px; }

        .backtest-line { background: #ffebee !important; border-bottom: 3px solid #d32f2f !important; }
        .backtest-line .sticky-col { background: #d32f2f !important; color: white !important; }
        .ignored-row { opacity: 0.3; background: #f5f5f5 !important; pointer-events: none; }
        .col-active { background: rgba(227, 242, 253, 0.8) !important; border-left: 2.5px solid #007bff !important; border-right: 2.5px solid #007bff !important; }
        
        .focus-num-group td { border-top: none !important; border-bottom: none !important; }
        .focus-row-win td { border-top: 3.5px solid #ff0000 !important; }
        .focus-row-rate td { border-bottom: 3.5px solid #ff0000 !important; }
        .focus-num-group td:first-child { border-left: 3.5px solid #ff0000 !important; }
        .focus-num-group td:last-child { border-right: 3.5px solid #ff0000 !important; }

        .row-win { background: #fff5f5; color: var(--win); font-weight: bold; font-size: 13px; }
        .row-fail { color: #555; background: white; font-size: 10px; }
        .row-dist { background: #eceff1; color: var(--dist); font-size: 10px; font-style: italic; }
        .row-rank { background: #f8f9fb; color: var(--rank); font-size: 9px; }
        .row-rate { background: #e8f5e9; color: #2e7d32; font-weight: bold; border-bottom: 2px solid #ccc; font-size: 11px; }

        .top5-mark { background-color: #ffeb3b !important; color: #000 !important; font-weight: 900; border: 1.5px solid #f44336 !important; }

        #pathCanvas { position: absolute; top: 0; left: 0; pointer-events: none; z-index: 45; width: 100%; height: 100%; }
        .soldier-win { background-color: #ff0000 !important; color: #ffffff !important; font-weight: bold; }
        .row-soldier { height: 28px; font-size: 12px; cursor: pointer; }
        .path-active { outline: 3.5px solid #007bff !important; outline-offset: -3px; font-weight: bold; }

        #reportModal { display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: white; z-index: 2000; flex-direction: column; }
        #reportHeader { padding: 8px 15px; background: #673ab7; color: white; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        #reportContent { flex: 1; overflow: hidden; padding: 15px; display: flex; flex-direction: column; }
        .top5-container { display: flex; gap: 8px; padding: 12px; background: #f3e5f5; border-radius: 8px; align-items: center; border: 1px solid #ce93d8; margin-bottom: 15px; flex-shrink: 0; flex-wrap: wrap; }
        .top5-badge { background: #d93025; color: white; padding: 4px 12px; border-radius: 20px; font-weight: bold; }
        .report-table-wrapper { flex: 1; overflow: auto; width: 100%; border: 1px solid #ddd; }
        .report-table { width: 100%; border-collapse: collapse; font-size: 11px; min-width: 1300px; }
        .report-table th { background: #f1f1f1; border: 1px solid #ccc; position: sticky; top: 0; z-index: 20; }
        .report-table td { border: 1px solid #ddd; height: 40px; text-align: center; }
        .row-top5 { background: #ffebee !important; color: #d32f2f; font-weight: bold; }
        .sum-row { background: #fff9c4 !important; font-weight: bold; position: sticky; bottom: 40px; z-index: 20; }
        .sum-top5 { background: #d32f2f !important; color: white !important; font-weight: 900; }
        .highlight-count-row { background: #e8f5e9 !important; font-weight: bold; color: #2e7d32; position: sticky; bottom: 0; z-index: 20; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div class="container">
    <div class="btn-group">
        <button class="btn-game" onclick="init('539', 39)" style="background:#27ae60;">539</button>
        <button class="btn-game" onclick="init('49', 49)" style="background:#c0392b;">49</button>
        <div style="margin-left: 10px; display: flex; gap: 2px;">
            <button id="btnMonitor" class="btn-mode active" onclick="switchMode('monitor')">Áõ£ÊéßÊ®°Âºè</button>
            <button id="btnSoldier" class="btn-mode" onclick="switchMode('soldier')">Â£´ÂÖµ‰ΩçÁΩÆÂúñ</button>
        </div>
        <button class="btn-report" onclick="toggleReport(true)">ÈÖçÂ∞çÂ†±Ë°®</button>
    </div>

    <div class="table-wrapper" id="scrollArea">
        <svg id="pathCanvas"></svg>
        <table id="matrixTable">
            <thead id="mHead"></thead>
            <tbody id="mBodyMonitor"></tbody>
            <tbody id="mBodySoldier" class="hidden"></tbody>
        </table>
    </div>
</div>

<div id="reportModal">
    <div id="reportHeader">
        <strong>Ê∑±Â∫¶ÂàÜÊûêÂ†±Ë°® (‰ΩàÂ±ÄÂÑ™Âåñ)</strong>
        <div style="display:flex; align-items:center;">
            <button style="background:#f44336; color:white; border:none; padding:5px 12px; border-radius:3px; cursor:pointer; font-weight:bold; margin-right:10px;" onclick="g_currentPairsData=[];renderReportTable();">Ê∏ÖÁ©∫Â†±Ë°®</button>
            <button onclick="toggleReport(false)" style="background:white; border:none; padding:5px 15px; cursor:pointer; border-radius:3px; font-weight:bold;">ÈóúÈñâ</button>
        </div>
    </div>
    <div id="reportContent"></div>
</div>

<script>
    let g_max = 39, g_matrix = {}, g_curOrder = [], g_type = '539', g_raw_data = [];
    let g_mode = 'monitor', g_selectedPos = [], g_history = [], g_focusNum = null, g_focusPos = [], g_activePaths = new Map(), g_currentPairsData = [];
    let g_backtestIdx = -1;

    window.onload = () => {
        init('539', 39);
        window.addEventListener('keydown', (e) => { 
            if(e.key === 'Enter' && g_mode === 'soldier' && g_selectedPos.length >= 2) { 
                generatePairsData(); g_selectedPos = []; g_activePaths.clear(); renderSoldierMode();
            } 
        });
    };

    function init(type, max) {
        g_type = type; g_max = max; g_backtestIdx = -1; g_selectedPos = []; g_focusNum = null; g_focusPos = []; g_currentPairsData = []; g_activePaths.clear();
        Papa.parse(`https://raw.githubusercontent.com/win83/secret-lotto-888/main/fine/${type}-all.csv`, {
            download: true, header: true, skipEmptyLines: true,
            complete: (res) => { if(res.data) { g_raw_data = res.data; processData(res.data, max); } }
        });
    }

    function processData(data, max) {
        g_curOrder = Array.from({length: max}, (_, i) => i + 1);
        let tempOrder = Array.from({length: max}, (_, i) => i + 1);
        const bIdx = (max === 39) ? [2,3,4,5,6] : [2,3,4,5,6,7];
        const keys = Object.keys(data[0]);
        g_history = [];
        data.forEach(row => {
            let balls = bIdx.map(idx => parseInt(row[keys[idx]])).filter(v => !isNaN(v));
            if(balls.length < 5) return;
            g_history.push({ sn: row[keys[0]], order: [...tempOrder], balls: balls });
            let winB = tempOrder.filter(n => balls.includes(n));
            tempOrder = [...winB, ...tempOrder.filter(n => !balls.includes(n))];
        });
        g_curOrder = tempOrder;
        updateMatrix(); renderHeader(); renderMonitorMode(); renderSoldierMode();
    }

    function updateMatrix() {
        g_matrix = {}; for(let b=1; b<=g_max; b++) { g_matrix[b] = {}; for(let p=0; p<g_max; p++) g_matrix[b][p] = { win: 0, fail: 0 }; }
        let targetHistory = g_backtestIdx === -1 ? g_history : g_history.slice(0, g_backtestIdx + 1);
        targetHistory.forEach(item => { item.order.forEach((n, i) => { if(item.balls.includes(n)) g_matrix[n][i].win++; else g_matrix[n][i].fail++; }); });
    }

    function renderHeader() {
        let displayOrder = g_backtestIdx === -1 ? g_curOrder : g_history[g_backtestIdx].order;
        let headHtml = "";
        let rowH = 28; 
        
        if (g_mode === 'monitor') {
            let recent = g_history.slice(-5);
            recent.forEach((item, rIdx) => {
                headHtml += `<tr class="recent-header row-soldier" style="top: ${rIdx * rowH}px;">
                                <td class="sticky-col" style="background:#e0e0e0;">${item.sn}</td>
                                ${item.order.map((n, pIdx) => `<td class="${item.balls.includes(n) ? 'soldier-win' : ''}">${n}</td>`).join('')}
                             </tr>`;
            });
            let baseTop = recent.length * rowH;
            headHtml += `<tr class="sticky-header ready-line" style="top: ${baseTop}px;"><th class="sticky-col">Êé®ÊºîÈªû</th>${displayOrder.map((n, idx) => `<th onclick="handleReadyClick(${n}, ${idx})">${n}</th>`).join('')}</tr>
                         <tr class="second-header pos-line" style="top: ${baseTop + 25}px;"><th class="sticky-col">‰ΩçÁΩÆ</th>${Array.from({length:g_max},(_,i)=>`<th>P${i+1}</th>`).join('')}</tr>`;
        } else {
            headHtml += `<tr class="sticky-header ready-line" style="top:0;"><th class="sticky-col">Êé®ÊºîÈªû</th>${displayOrder.map((n, idx) => {
                let isActive = g_selectedPos.some(s => s.ballNum === n && s.rowIdx === (g_backtestIdx === -1 ? g_history.length : g_backtestIdx) && s.posIdx === idx);
                return `<th class="${isActive ? 'path-active' : ''}" onclick="handleReadyClick(${n}, ${idx})">${n}</th>`;
            }).join('')}</tr>
            <tr class="second-header pos-line" style="top:25px;"><th class="sticky-col">‰ΩçÁΩÆ</th>${Array.from({length:g_max},(_,i)=>`<th>P${i+1}</th>`).join('')}</tr>`;
        }
        document.getElementById('mHead').innerHTML = headHtml;
    }

    function handleReadyClick(ballNum, posIdx) {
        if (g_mode === 'monitor') {
            if (g_focusNum === ballNum && g_focusPos.includes(posIdx)) { g_focusNum = null; g_focusPos = []; } 
            else { g_focusNum = ballNum; g_focusPos = [posIdx]; }
            renderMonitorMode(); renderHeader();
            if (g_focusNum) setTimeout(() => {
                const target = document.getElementById(`row-win-${ballNum}`);
                const wrapper = document.getElementById('scrollArea');
                if (target && wrapper) wrapper.scrollTo({ top: target.offsetTop - 200, behavior: 'smooth' });
            }, 30);
        } else { toggleSelection(ballNum, g_backtestIdx === -1 ? g_history.length : g_backtestIdx, posIdx); }
    }

    function getRowTop5(rowArray) {
        return rowArray
            .map((val, idx) => ({ val, idx }))
            .sort((a, b) => b.val - a.val)
            .slice(0, 5)
            .map(item => item.idx);
    }

    function getRowRanks(rowArray) {
        let sorted = [...rowArray].sort((a, b) => b - a);
        return rowArray.map(v => sorted.indexOf(v) + 1);
    }

    function renderMonitorMode() {
        let bHtml = ""; 
        for(let b=1; b<=g_max; b++) {
            let isFocus = g_focusNum === b;
            let groupClass = isFocus ? 'focus-num-group' : '';
            
            let winData = [], failData = [], distData = [], rateData = [];
            for(let p=0; p<g_max; p++) {
                let w = g_matrix[b][p].win || 0;
                let f = g_matrix[b][p].fail || 0;
                let t = w + f;
                winData.push(w);
                failData.push(f);
                distData.push(f - w);
                rateData.push(t > 0 ? Math.round((w / t) * 100) : 0);
            }

            const winTop5 = getRowTop5(winData);
            const failTop5 = getRowTop5(failData);
            const distTop5 = getRowTop5(distData);
            const rateTop5 = getRowTop5(rateData);

            const winRanks = getRowRanks(winData);
            const failRanks = getRowRanks(failData);
            const distRanks = getRowRanks(distData);

            bHtml += `<tr id="row-win-${b}" class="row-win ${groupClass} ${isFocus ? 'focus-row-win' : ''}">
                        <td class="sticky-col" onclick="g_focusNum=${b};renderMonitorMode()">#${b<10?'0'+b:b} Ë¥è</td>
                        ${winData.map((v, p) => `<td class="${g_focusPos.includes(p)?'col-active':''} ${winTop5.includes(p)?'top5-mark':''}">${v || ''}</td>`).join('')}
                      </tr>
                      <tr class="row-fail ${groupClass}">
                        <td class="sticky-col">Ëº∏</td>
                        ${failData.map((v, p) => `<td class="${g_focusPos.includes(p)?'col-active':''} ${failTop5.includes(p)?'top5-mark':''}">${v || ''}</td>`).join('')}
                      </tr>
                      <tr class="row-dist ${groupClass}">
                        <td class="sticky-col">Ë∑ùÈõ¢</td>
                        ${distData.map((v, p) => `<td class="${g_focusPos.includes(p)?'col-active':''} ${distTop5.includes(p)?'top5-mark':''}">${v}</td>`).join('')}
                      </tr>
                      <tr class="row-rank ${groupClass}">
                        <td class="sticky-col">Ë¥èÊéíÂêç</td>
                        ${winRanks.map((v, p) => `<td class="${g_focusPos.includes(p)?'col-active':''} ${v <= 5 ? 'top5-mark' : ''}">${v}</td>`).join('')}
                      </tr>
                      <tr class="row-rank ${groupClass}">
                        <td class="sticky-col">Ëº∏ÊéíÂêç</td>
                        ${failRanks.map((v, p) => `<td class="${g_focusPos.includes(p)?'col-active':''} ${v <= 5 ? 'top5-mark' : ''}">${v}</td>`).join('')}
                      </tr>
                      <tr class="row-rank ${groupClass}">
                        <td class="sticky-col">Ë∑ùÊéíÂêç</td>
                        ${distRanks.map((v, p) => `<td class="${g_focusPos.includes(p)?'col-active':''} ${v <= 5 ? 'top5-mark' : ''}">${v}</td>`).join('')}
                      </tr>
                      <tr class="row-rate ${groupClass} ${isFocus ? 'focus-row-rate' : ''}">
                        <td class="sticky-col">Áéá</td>
                        ${rateData.map((v, p) => `<td class="${g_focusPos.includes(p)?'col-active':''} ${rateTop5.includes(p)?'top5-mark':''}">${v || ''}</td>`).join('')}
                      </tr>`;
        }
        document.getElementById('mBodyMonitor').innerHTML = bHtml;
    }

    function renderSoldierMode() {
        const nLimit = 20; 
        let bHtml = ""; let displayList = g_history.slice(-nLimit);
        let displayOrder = g_backtestIdx === -1 ? g_curOrder : g_history[g_backtestIdx].order;
        displayList.forEach((item, revIdx) => {
            let realIdx = g_history.length - nLimit + revIdx;
            let isTestLine = g_backtestIdx === realIdx;
            let isIgnored = g_backtestIdx !== -1 && realIdx > g_backtestIdx;
            bHtml += `<tr class="row-soldier ${isTestLine ? 'backtest-line' : ''} ${isIgnored ? 'ignored-row' : ''}">
                      <td class="sticky-col" onclick="g_backtestIdx=(g_backtestIdx===${realIdx})?-1:${realIdx};updateMatrix();renderHeader();renderMonitorMode();renderSoldierMode();setTimeout(drawPaths, 30);">${item.sn}${isTestLine ? 'üìå' : ''}</td>`;
            item.order.forEach((n, pIdx) => {
                let isActive = g_selectedPos.some(s => s.ballNum === n && s.rowIdx === realIdx && s.posIdx === pIdx);
                bHtml += `<td class="${item.balls.includes(n) ? 'soldier-win' : ''} ${isActive ? 'path-active' : ''}" onclick="toggleSelection(${n}, ${realIdx}, ${pIdx})" data-ball="${n}">${n}</td>`;
            });
            bHtml += "</tr>";
        });
        
        bHtml += `<tr class="ready-line">
                    <td class="sticky-col">Êé®ÊºîÈªû</td>
                    ${displayOrder.map((n, idx) => {
                        let isActive = (g_selectedPos.some(s => s.ballNum === n && s.rowIdx === (g_backtestIdx === -1 ? g_history.length : g_backtestIdx) && s.posIdx === idx));
                        return `<td class="${isActive ? 'path-active' : ''}" onclick="handleReadyClick(${n}, ${idx})">${n}</td>`;
                    }).join('')}
                  </tr>`;

        document.getElementById('mBodySoldier').innerHTML = bHtml;
        setTimeout(drawPaths, 80);
    }

    function toggleSelection(ballNum, rowIdx, posIdx) {
        const idx = g_selectedPos.findIndex(s => s.ballNum === ballNum && s.rowIdx === rowIdx && s.posIdx === posIdx);
        if (idx > -1) { g_selectedPos.splice(idx, 1); g_activePaths.delete(ballNum); } 
        else {
            g_selectedPos.push({ballNum, rowIdx, posIdx});
            const colors = ['#FF0000', '#007bff', '#28a745', '#6f42c1', '#fd7e14'];
            g_activePaths.set(ballNum, colors[g_activePaths.size % colors.length]);
        }
        renderSoldierMode(); renderHeader();
    }

    function drawPaths() {
        const svg = document.getElementById('pathCanvas'); svg.innerHTML = '';
        if (g_mode !== 'soldier') return;
        const table = document.getElementById('matrixTable');
        if(!table) return;
        svg.setAttribute('width', table.offsetWidth); svg.setAttribute('height', table.offsetHeight);
        g_activePaths.forEach((color, ballNum) => {
            const dots = Array.from(document.querySelectorAll(`td[data-ball="${ballNum}"]`)).filter(td => !td.parentElement.classList.contains('ignored-row'));
            if (dots.length < 2) return;
            let pathD = ""; dots.forEach((dot, i) => {
                const x = dot.offsetLeft + dot.offsetWidth / 2; const y = dot.offsetTop + dot.offsetHeight / 2;
                pathD += (i === 0 ? "M" : "L") + x + "," + y;
                const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                circle.setAttribute("cx", x); circle.setAttribute("cy", y); circle.setAttribute("r", "3.5"); circle.setAttribute("fill", color); svg.appendChild(circle);
            });
            const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
            path.setAttribute("d", pathD); path.setAttribute("stroke", color); path.setAttribute("stroke-width", "2.5"); path.setAttribute("fill", "none"); path.setAttribute("stroke-opacity", "0.8"); svg.appendChild(path);
        });
    }

    function generatePairsData() {
        let limit = g_backtestIdx === -1 ? g_history.length - 1 : g_backtestIdx;
        for (let i = 0; i < g_selectedPos.length; i++) {
            for (let j = i + 1; j < g_selectedPos.length; j++) {
                let s1 = g_selectedPos[i], s2 = g_selectedPos[j];
                let distR = Math.abs(s1.rowIdx - s2.rowIdx);
                let counts = Array(g_max + 1).fill(0), matchCount = 0;
                for (let k = 0; k <= limit - distR - 1; k++) {
                    if (g_history[k].balls.includes(g_history[k].order[s1.posIdx]) && 
                        g_history[k + distR].balls.includes(g_history[k + distR].order[s2.posIdx])) {
                        matchCount++; if(g_history[k + distR + 1]) g_history[k + distR + 1].balls.forEach(b => counts[b]++);
                    }
                }
                g_currentPairsData.push({ label: `${s1.ballNum}(P${s1.posIdx+1}) ‚Üî ${s2.ballNum}(P${s2.posIdx+1}) [Ë∑®${distR}Êúü]`, count: matchCount, data: counts });
            }
        }
    }

    function renderReportTable() {
        let totals = Array(g_max + 1).fill(0); let highlightCounts = Array(g_max + 1).fill(0); let tableRows = "";
        g_currentPairsData.forEach((p, idx) => {
            let rowSorted = []; for(let i=1; i<=g_max; i++) if(p.data[i]>0) rowSorted.push({num:i, val:p.data[i]});
            rowSorted.sort((a,b)=>b.val-a.val); let rTop5 = rowSorted.slice(0, 5).map(it=>it.num);
            tableRows += `<tr><td style="position:sticky;left:0;background:#eee;z-index:10;"><span style="color:red;cursor:pointer" onclick="g_currentPairsData.splice(${idx},1);renderReportTable();">X</span> ${p.label}</td>`;
            for(let i=1; i<=g_max; i++) {
                let isTop = rTop5.includes(i); if(isTop) highlightCounts[i]++;
                tableRows += `<td class="${isTop ? 'row-top5' : ''}">${p.data[i] || ''}</td>`; totals[i] += p.data[i];
            }
            tableRows += `</tr>`;
        });
        let sumSorted = []; for(let i=1; i<=g_max; i++) if(totals[i]>0) sumSorted.push({num:i, val:totals[i]});
        sumSorted.sort((a,b)=>b.val-a.val); let sTop5 = sumSorted.slice(0, 5).map(it=>it.num);
        let top5Html = `<div class="top5-container"><span class="top5-title">üî• Êé®Ëñ¶ TOP 5:</span> ${sumSorted.slice(0,5).map(it=>`<span class="top5-badge">${it.num}(${it.val})</span>`).join('')}</div>`;
        let html = top5Html + `<div class="report-table-wrapper"><table class="report-table"><thead><tr><th style="width:140px;position:sticky;left:0;z-index:30;background:#ddd;">Ë∑ØÂæë</th>${Array.from({length:g_max},(_,i)=>`<th>${i+1}</th>`).join('')}</tr></thead><tbody>${tableRows}`;
        html += `<tr class="sum-row"><td style="position:sticky;left:0;z-index:30;">Á∏ΩË®àÊé®Êºî</td>`;
        for(let i=1; i<=g_max; i++) html += `<td class="${sTop5.includes(i)?'sum-top5':''}">${totals[i]}</td>`;
        html += `</tr><tr class="highlight-count-row"><td style="position:sticky;left:0;z-index:30;">È´ò‰∫ÆÊ¨°Êï∏</td>`;
        for(let i=1; i<=g_max; i++) html += `<td>${highlightCounts[i]||''}</td>`;
        html += `</tr></tbody></table></div>`;
        document.getElementById('reportContent').innerHTML = html;
    }

    function toggleReport(show) { if(show) renderReportTable(); document.getElementById('reportModal').style.display = show ? 'flex' : 'none'; }
    function switchMode(mode) {
        g_mode = mode; if (mode === 'soldier') { g_focusNum = null; g_focusPos = []; }
        document.getElementById('mBodyMonitor').classList.toggle('hidden', mode !== 'monitor');
        document.getElementById('mBodySoldier').classList.toggle('hidden', mode !== 'soldier');
        document.getElementById('pathCanvas').classList.toggle('hidden', mode !== 'soldier');
        renderHeader(); if(mode === 'monitor') renderMonitorMode(); if(mode === 'soldier') { renderSoldierMode(); setTimeout(drawPaths, 150); }
    }
    window.onresize = drawPaths;
</script>
</body>
</html>
