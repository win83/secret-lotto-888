<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¨‚é€æ•¸æ“šå¯¦éš›çµ±è¨ˆç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .filter-row { display: flex; border-bottom: 1px solid #e5e7eb; align-items: stretch; }
        .filter-label { width: 90px; background-color: #f3f4f6; color: #4b5563; font-weight: bold; font-size: 0.9rem; display: flex; align-items: center; justify-content: center; border-right: 1px solid #e5e7eb; flex-shrink: 0; }
        .filter-content { display: flex; flex-wrap: wrap; gap: 6px; padding: 8px; background: white; flex-grow: 1; }
        .btn-sq { border: 1px solid #d1d5db; border-radius: 4px; padding: 2px 8px; min-width: 40px; text-align: center; background: white; cursor: pointer; font-size: 0.85rem; }
        .btn-sq.selected { background-color: #2563eb; color: white; border-color: #1e40af; }
        
        /* å ±è¡¨è¡¨æ ¼ */
        .report-table { width: 100%; border-collapse: collapse; font-size: 12px; text-align: center; }
        .report-table th, .report-table td { border: 1px solid #999; padding: 4px 2px; }
        .bg-yellow { background-color: #ffff00; font-weight: bold; }
        .bg-pink { background-color: #fee2e2; }
        .text-hot { background-color: #ff0000; color: white; font-weight: bold; }
    </style>
</head>
<body class="bg-gray-50 p-2 text-sm">

    <div class="max-w-[1600px] mx-auto bg-white border border-gray-300">
        
        <div class="p-3 border-b space-y-3">
            <div class="flex justify-between items-center">
                <h1 class="text-red-600 font-bold">ç›®å‰æ¨¡å¼ï¼š539 - å¯¦éš›æ•¸æ“šçµ±è¨ˆ</h1>
                <div class="flex gap-2">
                    <button onclick="switchUser('dad')" id="u-dad" class="px-4 py-1 border rounded font-bold">çˆ¸ä½¿ç”¨æ¨¡å¼</button>
                    <button onclick="switchUser('bro')" id="u-bro" class="px-4 py-1 border rounded font-bold">å“¥ä½¿ç”¨æ¨¡å¼</button>
                </div>
            </div>

            <div class="flex gap-2">
                <button onclick="fetchAndAnalyze()" class="px-8 py-2 bg-green-600 text-white font-bold rounded shadow hover:bg-green-700">ğŸ§ª åŸ·è¡Œå¯¦éš›æ•¸æ“šåˆ†æ</button>
                <button onclick="location.reload()" class="px-4 py-2 bg-white border border-gray-300 rounded font-bold">æ¸…ç©ºå ±è¡¨</button>
            </div>
        </div>

        <div class="m-3 border-2 border-red-500">
            <div class="filter-row"><div class="filter-label">å¹´ä»½</div><div id="row-year" class="filter-content"></div></div>
            <div class="filter-row"><div class="filter-label">æœˆä»½</div><div id="row-month" class="filter-content"></div></div>
            <div class="filter-row"><div class="filter-label">æ—¥æœŸ</div><div id="row-day" class="filter-content"></div></div>
        </div>

        <div id="report-area" class="p-3 space-y-6">
            <div id="loading" class="hidden text-center py-10 font-bold text-blue-600">æ­£åœ¨å¾ GitHub æŠ“å–æ•¸æ“šä¸¦è¨ˆç®—ä¸­...</div>
        </div>

        <div class="p-2 bg-gray-100 flex gap-4 text-[10px] font-mono border-t">
            <span id="conn-539">539: é€£çµä¸­...</span>
        </div>
    </div>

    <script>
        const CSV_URL = "https://raw.githubusercontent.com/win83/secret-lotto-888/main/fine/539.csv";
        let cachedData = []; // å­˜å„²æŠ“ä¸‹ä¾†çš„åŸå§‹æ•¸æ“š

        window.onload = () => {
            initUI();
            switchUser('dad');
            checkConn();
        };

        async function checkConn() {
            try {
                const res = await fetch(CSV_URL);
                if(res.ok) document.getElementById('conn-539').innerHTML = "539: <span class='text-green-600 font-bold'>OK</span>";
            } catch(e) { document.getElementById('conn-539').innerHTML = "539: <span class='text-red-600'>FAIL</span>"; }
        }

        function initUI() {
            const mRow = document.getElementById('row-month');
            for(let i=1; i<=12; i++) mRow.innerHTML += `<button onclick="this.classList.toggle('selected')" class="btn-sq" data-val="${i}">${i}</button>`;
            const dRow = document.getElementById('row-day');
            for(let i=1; i<=31; i++) dRow.innerHTML += `<button onclick="this.classList.toggle('selected')" class="btn-sq" data-val="${i}">${i}</button>`;
        }

        function switchUser(user) {
            const isDad = user === 'dad';
            document.getElementById('u-dad').className = `px-4 py-1 border rounded font-bold ${isDad ? 'bg-cyan-400 text-white' : 'bg-gray-100'}`;
            document.getElementById('u-bro').className = `px-4 py-1 border rounded font-bold ${!isDad ? 'bg-cyan-400 text-white' : 'bg-gray-100'}`;
            const start = isDad ? 2020 : 2006;
            const yRow = document.getElementById('row-year');
            yRow.innerHTML = '';
            for(let y=start; y<=2026; y++) yRow.innerHTML += `<button onclick="this.classList.toggle('selected')" class="btn-sq" data-val="${y}">${y}</button>`;
        }

        async function fetchAndAnalyze() {
            const loading = document.getElementById('loading');
            loading.classList.remove('hidden');
            
            // æŠ“å–é¸ä¸­çš„æ¢ä»¶
            const selYears = Array.from(document.querySelectorAll('#row-year .selected')).map(b => b.dataset.val);
            const selMonths = Array.from(document.querySelectorAll('#row-month .selected')).map(b => b.dataset.val);
            const selDays = Array.from(document.querySelectorAll('#row-day .selected')).map(b => b.dataset.val);

            try {
                if (cachedData.length === 0) {
                    const response = await fetch(CSV_URL);
                    const text = await response.text();
                    cachedData = text.split('\n').map(line => line.split(','));
                }

                // æ ¸å¿ƒçµ±è¨ˆé‚è¼¯
                // å‡è¨­ CSV æ ¼å¼: æ—¥æœŸ(0), æœŸåˆ¥(1), è™Ÿç¢¼(2,3,4,5,6), å¤©å¹²åœ°æ”¯(7)...
                const stats = { month: new Array(40).fill(0), day: new Array(40).fill(0), total: new Array(40).fill(0) };
                
                cachedData.forEach(row => {
                    if (row.length < 5) return;
                    const dateStr = row[0]; // 2024/01/01
                    const d = new Date(dateStr);
                    const Y = d.getFullYear().toString();
                    const M = (d.getMonth() + 1).toString();
                    const D = d.getDate().toString();

                    // æª¢æŸ¥æ˜¯å¦ç¬¦åˆé¸ä¸­å¹´ä»½
                    if (selYears.length > 0 && !selYears.includes(Y)) return;

                    const nums = [row[2], row[3], row[4], row[5], row[6]].map(n => parseInt(n));

                    // æœˆä»½ç¬¦åˆ
                    if (selMonths.includes(M)) {
                        nums.forEach(n => { if(n) stats.month[n]++; });
                    }
                    // æ—¥æœŸç¬¦åˆ
                    if (selDays.includes(D)) {
                        nums.forEach(n => { if(n) stats.day[n]++; });
                    }
                });

                for(let i=1; i<=39; i++) stats.total[i] = stats.month[i] + stats.day[i];

                renderReport(stats, selMonths, selDays);
            } catch (err) {
                alert("æ•¸æ“šè®€å–éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ– GitHub æª”æ¡ˆè·¯å¾‘ã€‚");
            } finally {
                loading.classList.add('hidden');
            }
        }

        function renderReport(stats, ms, ds) {
            const area = document.getElementById('report-area');
            const findMax = (arr) => Math.max(...arr.slice(1));
            const maxM = findMax(stats.month);
            const maxD = findMax(stats.day);
            const maxT = findMax(stats.total);

            const html = `
                <div class="border border-gray-400 bg-white">
                    <div class="bg-orange-100 p-2 font-bold border-b">
                        ã€å¯¦éš›çµ±è¨ˆã€‘ æœˆä»½:${ms.join(',')} | æ—¥æœŸ:${ds.join(',')}
                    </div>
                    <table class="report-table">
                        <tr class="bg-yellow">
                            <td class="w-24">çµ±è¨ˆæ˜ç´°</td>
                            ${Array.from({length: 39}, (_, i) => `<td class="w-8">${i+1}</td>`).join('')}
                        </tr>
                        <tr>
                            <td class="bg-yellow">æœˆä»½:${ms.join(',')}</td>
                            ${stats.month.slice(1).map(v => `<td class="${v === maxM && v>0 ? 'text-hot' : ''}">${v}</td>`).join('')}
                        </tr>
                        <tr>
                            <td class="bg-yellow">æ—¥æœŸ:${ds.join(',')}</td>
                            ${stats.day.slice(1).map(v => `<td class="${v === maxD && v>0 ? 'text-hot' : ''}">${v}</td>`).join('')}
                        </tr>
                        <tr class="bg-pink font-bold">
                            <td class="bg-yellow">åŠ ç¸½(Sum)</td>
                            ${stats.total.slice(1).map(v => `<td class="${v === maxT && v>0 ? 'text-hot' : ''}">${v}</td>`).join('')}
                        </tr>
                    </table>
                </div>
            `;
            area.insertAdjacentHTML('afterbegin', html);
        }
    </script>
</body>
</html>
