<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>å°ˆæ¥­æ¨‚é€çµ±è¨ˆç³»çµ± V2.2 - å„ªåŒ–ç©©å®šç‰ˆ</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    :root{
      --page-bg:#cfe8cf; --panel-bg:#fff8e8; --tab-bg:#ededed;
      --tab-border:#9a9a9a; --blue:#1f73ff; --red:#e51b1b;
      --line:#d0d0d0; --label:#efefef; --btn-border:#7a7a7a;
      --stat-green: #92d050; --stat-light: #e2efda;
      --top5-bg: #ff0000; --top5-text: #ffffff;
      --report-header-bg: #fce4d6;
    }
    *{ box-sizing:border-box; font-family:"Microsoft JhengHei", sans-serif; }
    body{ margin:0; background:var(--page-bg); color:#111; }
    .tabs{ display:grid; grid-template-columns: repeat(4, 1fr); gap:16px; padding:10px 14px 0; }
    .tab{ height:44px; background:var(--tab-bg); border:1px solid var(--tab-border); display:flex; align-items:center; justify-content:center; font-weight:800; cursor:pointer; }
    .tab.active{ border-bottom:3px solid var(--red); background:#f2f2f2; }
    .container{ margin:10px 14px; border:1px solid var(--blue); border-radius:8px; background:var(--panel-bg); padding:10px; min-height: 85vh; }
    .page { display: none; }
    .page.active { display: block; }
    .filters-box{ border:2px solid var(--red); background:#fff; padding:12px; margin-bottom:10px; }
    .grid{ display:grid; grid-template-columns: 90px 1fr; row-gap:10px; }
    .lbl{ background:var(--label); border:1px solid var(--line); display:flex; align-items:center; justify-content:center; font-weight:900; height:36px; }
    .chips{ display:flex; flex-wrap:wrap; gap:8px; padding-left:10px; align-items:center; }
    .chip{ min-width:44px; height:34px; border:1px solid var(--line); border-radius:4px; display:flex; align-items:center; justify-content:center; cursor:pointer; font-weight:800; background:#fff; user-select:none; }
    .chip.on{ outline:3px solid var(--blue); background:#eef4ff; }
    .chip.mainpick{ outline: 4px solid #ff3b30 !important; background: #ffe5e3 !important; }
    .chip.subpick{ outline: 4px solid #00bcd4 !important; background: #e6fbff !important; }
    .chip.drag1{ outline: 4px solid #6a44c6 !important; background:#f0e9ff !important; }
    .chip.drag2{ outline: 4px solid #2e7d32 !important; background:#e7f6e9 !important; }
    .breakline{ flex-basis: 100%; height: 0; }
    .btnbar{ display:flex; flex-wrap:wrap; gap:8px; align-items:center; margin:10px 0; }
    .btn{ height:40px; padding:0 15px; border:1px solid var(--btn-border); border-radius:4px; font-weight:900; cursor:pointer; }
    .btn-orange{ background:#ffb300 !important; color:#000; }
    .btn-yellow{ background:#ffeb3b; }
    .btn-green{ background:#78c57a; }
    .btn-red{ background:#ff3b30; color:#fff; border-color:#b21b12; }
    .btn-cyan { background:#00bcd4; color:#fff; }
    .stat-title { color: red; font-weight: bold; margin: 15px 0 5px; }
    .stat-table { width: 100%; border-collapse: collapse; background: #fff; }
    .stat-table th, .stat-table td { border: 1px solid #000; text-align: center; padding: 4px; font-size: 12px; font-weight: bold; }
    .stat-table th { background: var(--stat-green); }
    .top5 { background-color: var(--top5-bg) !important; color: var(--top5-text) !important; }
    .report-item { margin-bottom: 30px; border: 2px solid #000; background: #fff; overflow-x: auto; }
    .report-header { background: var(--report-header-bg); padding: 8px; font-weight: bold; border-bottom: 2px solid #000; display:flex; justify-content:space-between; align-items:center; }
    .report-table { width:100%; border-collapse:collapse; font-size:12px; min-width: 1000px; }
    .report-table td { border:1px solid #000; text-align:center; padding:4px; }
    .cond-col { background:#ffff00; font-weight: bold; width: 400px; text-align: left; padding-left: 8px; }
    .sum-row { background:#ddebf7; font-weight:bold; }
    #loadingOverlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); display:none; justify-content:center; align-items:center; z-index:9999; font-weight:900; color:red; font-size:24px; }
    .hidden { display: none !important; }
    .mainSubBox{ display:flex; flex-wrap:wrap; gap:8px; align-items:center; background:#fff7cc; border:1px dashed #b38b00; padding:8px; margin-bottom:10px; font-weight:900; }
  </style>
</head>
<body>

<div id="loadingOverlay">é›²ç«¯å¤§æ•¸æ“šé‹ç®—ä¸­...</div>

<div class="tabs">
  <div class="tab active" data-game="539" data-target="mainPage">ä»Šå½© 539</div>
  <div class="tab" data-game="539" data-target="reportPage">539 å ±è¡¨</div>
  <div class="tab" data-game="Lotto" data-target="mainPage">å¤§æ¨‚é€</div>
  <div class="tab" data-game="Lotto" data-target="reportPage">å¤§æ¨‚é€ å ±è¡¨</div>
</div>

<div class="container">
  <div id="mainPage" class="page active">
    <div id="gameTitle" style="color:red; font-weight:900; font-size:18px;">ç›®å‰æ¨¡å¼ï¼šä»Šå½© 539</div>
    <div id="filterCounter" style="margin-bottom:10px; font-weight:bold; color:#555;"></div>

    <div class="btnbar">
      <button class="btn btn-cyan" id="mode-dad" onclick="switchUser('dad')">çˆ¸ä½¿ç”¨æ¨¡å¼</button>
      <button class="btn" id="mode-bro" onclick="switchUser('bro')">å“¥ä½¿ç”¨æ¨¡å¼</button>
    </div>

    <div class="mainSubBox">
      <button class="btn" id="btnMainArm" onclick="armMainPick()">æŒ‡å®šä¸»é«”</button>
      <button class="btn btn-cyan" id="btnSubMode" onclick="toggleSubMode()">å‰¯é«”å¤šé¸</button>
      <div id="mainSubStatus" style="color:#b21b12;">ç‹€æ…‹ï¼šåˆå§‹åŒ–ä¸­...</div>
    </div>

    <div class="btnbar">
      <button class="btn mode-btn btn-yellow" onclick="changeMode('æ­·å²æ¨¡å¼', this)">æ­·å²æ¨¡å¼</button>
      <button class="btn mode-btn" onclick="changeMode('æ‹–ç‰Œæ¨¡å¼', this)">æ‹–ç‰Œæ¨¡å¼</button>
      <button class="btn mode-btn" onclick="changeMode('ç•¶æœŸå°ç¢°', this)">ç•¶æœŸå°ç¢°</button>
      <button class="btn mode-btn" onclick="changeMode('ä¸‹æœŸå°ç¢°', this)">ä¸‹æœŸå°ç¢°</button>
      <button class="btn btn-green" onclick="addToReport()">ğŸ§ª åŠ å…¥å ±è¡¨</button>
      <button class="btn" onclick="clearFilters()">æ¸…ç©ºç¯©é¸</button>
      <button class="btn" style="background:#ddd" onclick="selectToday()">è‡ªå‹•å°æ‡‰æœ€å¾Œä¸€æœŸ</button>
    </div>

    <div class="filters-box"><div class="grid" id="filterGrid"></div></div>

    <div class="stat-title">å³æ™‚é‹ç®—çµ±è¨ˆ (å‡ºç¾æ¬¡æ•¸)</div>
    <div style="overflow-x:auto"><table class="stat-table"><thead><tr id="stat-head-1"></tr></thead><tbody><tr id="stat-body-1"></tr></tbody></table></div>

    <div class="stat-title">å…¨åŸŸæœªå‡ºæœŸæ•¸ (éºæ¼å€¼)</div>
    <div style="overflow-x:auto"><table class="stat-table"><thead><tr id="stat-head-2"></tr></thead><tbody><tr id="stat-body-2"></tr></tbody></table></div>
  </div>

  <div id="reportPage" class="page">
    <div style="background:#ffd966; padding:10px; display:flex; gap:10px; align-items:center; margin-bottom:10px; border:1px solid #999;">
      <button class="btn btn-green" onclick="exportToExcel()">åŒ¯å‡ºæ‰€æœ‰å ±è¡¨ (Excel)</button>
      <button class="btn btn-red" style="margin-left:auto" onclick="clearAllReports()">æ¸…ç©ºæ‰€æœ‰å ±è¡¨</button>
    </div>
    <div id="reportContainer"></div>
  </div>
</div>

<script>
/* =========================
   å…¨åŸŸè®Šæ•¸èˆ‡å¸¸æ•¸
   ========================= */
let currentMode = "æ­·å²æ¨¡å¼", currentGame = "539", currentUser = "dad", maxNum = 39, cloudData = [];
const STEMS=["ç”²","ä¹™","ä¸™","ä¸","æˆŠ","å·±","åºš","è¾›","å£¬","ç™¸"];
const BRANCHES=["å­","ä¸‘","å¯…","å¯","è¾°","å·³","åˆ","æœª","ç”³","é…‰","æˆŒ","äº¥"];
const sheetUrls = {
  "539": "/secret-lotto-888/data/new-folder/539.csv",
  "Lotto": "/secret-lotto-888/data/new-folder/49.csv"
};
const reportStorage = { dad: { "539": [], "Lotto": [] }, bro: { "539": [], "Lotto": [] } };

// ç‹€æ…‹ç®¡ç†
let pickState = "normal"; // normal | main_armed | sub
let mainPick = null; subPicks = []; dragPick1 = null; dragPick2 = null; numOrder = [];

/* =========================
   æ ¸å¿ƒé‚è¼¯ï¼šæ—¥æœŸèˆ‡çƒè™Ÿ
   ========================= */
function parseYMD(dateCell){
  const s = String(dateCell || "").trim();
  const m = s.match(/^(\d{4})[\/\-\.](\d{1,2})[\/\-\.](\d{1,2})/);
  if(!m) return {y:"", m:"", d:""};
  return { y:m[1], m:String(parseInt(m[2],10)), d:String(parseInt(m[3],10)) };
}

function ymdKey(y,m,d){ return parseInt(y)*10000 + parseInt(m)*100 + parseInt(d); }

function getValidRows(){
  const sk = (currentUser==="dad") ? 20200101 : 20060101;
  return cloudData.filter(row => {
    const meta = parseYMD(row[1] || row[0]);
    const k = ymdKey(meta.y, meta.m, meta.d);
    return !isNaN(k) && k >= sk && rowBalls(row).length >= (currentGame==="539"?5:6);
  });
}

function rowBalls(row){
  const limit = (currentGame==="539") ? 39 : 49;
  const endIdx = (currentGame==="539") ? 11 : 13;
  return row.slice(6, endIdx).map(v => parseInt(v, 10)).filter(n => n > 0 && n <= limit);
}

function rowMetaFromRow(row){
  let {y,m,d} = parseYMD(row[1] || row[0]);
  const dt = new Date(y, m-1, d);
  const wMap = ["æ—¥","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­"];
  let w = wMap[dt.getDay()], stem = STEMS[0], branch = BRANCHES[0];
  
  // å„ªå…ˆä½¿ç”¨åŸå§‹è³‡æ–™æ¬„ä½è£œæ­£
  if(String(row[2]).trim()) w = String(row[2]).trim().slice(-1);
  if(STEMS.includes(row[3])) stem = row[3];
  if(BRANCHES.includes(row[4])) branch = row[4];
  
  return {y, m, d, w, stem, branch, jieqi: String(row[5]||"").toUpperCase()};
}

function buildRd(meta){
  const rd = {"å¹´ä»½":meta.y, "æœˆä»½":meta.m, "æ—¥æœŸ":meta.d, "æ˜ŸæœŸ":meta.w, "å¤©å¹²":meta.stem, "åœ°æ”¯":meta.branch, "ç¯€æ°£":meta.jieqi};
  return rd;
}

/* =========================
   è¨ˆç®—å¼•æ“
   ========================= */
function matchFilters(rd, filters){
  for(const k in filters) { if(!filters[k].includes(String(rd[k]))) return false; }
  return true;
}

function computePairSameRow(validRows, filters, a, b, gameMax){
  const counts = Array(gameMax+1).fill(0);
  validRows.forEach(row => {
    if(!matchFilters(buildRd(rowMetaFromRow(row)), filters)) return;
    const balls = rowBalls(row);
    if(balls.includes(a) && balls.includes(b)) {
      balls.forEach(n => counts[n]++);
    }
  });
  return counts;
}

/* =========================
   UI æ¸²æŸ“èˆ‡äº’å‹•
   ========================= */
function initFilters(){
  maxNum = (currentGame === "539") ? 39 : 49;
  document.getElementById('gameTitle').textContent = `ç›®å‰æ¨¡å¼ï¼š${currentGame} - ${currentMode}`;
  const grid = document.getElementById('filterGrid');
  grid.innerHTML = '';
  
  const yStart = (currentUser==="dad"?2020:2006), yEnd = 2026;
  const sections = [
    { lbl: "å¹´ä»½", d: Array.from({length:yEnd-yStart+1},(_,i)=>yStart+i) },
    { lbl: "æœˆä»½", d: Array.from({length:12},(_,i)=>i+1) },
    { lbl: "æ—¥æœŸ", d: Array.from({length:31},(_,i)=>i+1), brk:18 },
    { lbl: "æ˜ŸæœŸ", d: (currentGame==="Lotto"?["äºŒ","äº”"]:["ä¸€","äºŒ","ä¸‰","å››","äº”","å…­","æ—¥"]) },
    { lbl: "å¤©å¹²", d: STEMS },
    { lbl: "åœ°æ”¯", d: BRANCHES },
    { lbl: "ç¯€æ°£", d: Array.from({length:16},(_,i)=>[`S${i}`,`T${i}`]).flat(), brk:16 },
    { lbl: "è™Ÿç¢¼", d: Array.from({length:maxNum},(_,i)=>String(i+1).padStart(2,'0')), brk:25 }
  ];

  sections.forEach(sec => {
    const isSpecial = ["å¤©å¹²","åœ°æ”¯","ç¯€æ°£"].includes(sec.lbl);
    const hidden = (currentUser==="bro" && isSpecial) ? "hidden" : "";
    let html = `<div class="lbl ${hidden}">${sec.lbl}</div><div class="chips ${hidden}" data-label="${sec.lbl}">`;
    sec.d.forEach((v, i) => {
      if(sec.brk && i===sec.brk) html += `<div class="breakline"></div>`;
      html += `<div class="chip" data-val="${v}" onclick="toggleChip(this)">${v}</div>`;
    });
    grid.innerHTML += html + `</div>`;
  });
  updateStatTableUI();
}

function updateStatTableUI(){
  const h1=document.getElementById('stat-head-1'), b1=document.getElementById('stat-body-1');
  const h2=document.getElementById('stat-head-2'), b2=document.getElementById('stat-body-2');
  h1.innerHTML=b1.innerHTML=h2.innerHTML=b2.innerHTML='';
  for(let i=1;i<=maxNum;i++){
    h1.innerHTML += `<th>${i}</th>`; b1.innerHTML += `<td id="val1-${i}">0</td>`;
    h2.innerHTML += `<th>${i}</th>`; b2.innerHTML += `<td id="val2-${i}">0</td>`;
  }
}

function toggleChip(el){
  const cat = el.parentElement.dataset.label;
  const val = el.dataset.val;

  if(cat !== "è™Ÿç¢¼" && pickState === "main_armed"){
    if(!confirm(`è¨­ã€Œ${cat}:${val}ã€ç‚ºä¸»é«”ï¼Ÿ`)) return;
    mainPick = {cat, val};
    document.querySelectorAll('.chip.mainpick').forEach(c=>c.classList.remove('mainpick'));
    el.classList.add('mainpick', 'on');
    setPickState("sub");
    return;
  }
  
  if(cat !== "è™Ÿç¢¼" && pickState === "sub"){
    const idx = subPicks.findIndex(s=>s.cat===cat && s.val===val);
    if(idx>=0) { subPicks.splice(idx,1); el.classList.remove('subpick'); }
    else { subPicks.push({cat, val}); el.classList.add('subpick'); }
    renderMainSubStatus(); return;
  }

  if(cat !== "è™Ÿç¢¼" && (currentMode === "æ‹–ç‰Œæ¨¡å¼" || currentMode === "ä¸‹æœŸå°ç¢°")){
    setDragPick(el, cat, val);
  } else {
    el.classList.toggle('on');
  }
  updateStats();
}

function setDragPick(el, cat, val){
  if(!dragPick1) { dragPick1={cat, val}; el.classList.add('drag1'); }
  else if(!dragPick2) { dragPick2={cat, val}; el.classList.add('drag2'); }
  else {
    document.querySelectorAll('.drag1, .drag2').forEach(c=>c.classList.remove('drag1','drag2'));
    dragPick1={cat, val}; el.classList.add('drag1'); dragPick2=null;
  }
  renderMainSubStatus();
}

// 1. ä¿®æ”¹è·¯å¾‘ (æª”æ¡ˆè·¯å¾‘ç¾åœ¨çµ±ä¸€æŒ‡å‘åŒä¸€å€‹ Excel æª”)
const excelFilePath = "/secret-lotto-888/data/new-folder/539-49.xlsx";

// 2. ä¿®æ”¹è³‡æ–™ç²å–é‚è¼¯
function fetchSheetData(callback) {
  const overlay = document.getElementById('loadingOverlay');
  overlay.style.display = 'flex';

  // ä½¿ç”¨ requestAnimationFrame ç¢ºä¿ç€è¦½å™¨å…ˆæ¸²æŸ“å‡ºã€Œé‹ç®—ä¸­ã€çš„ç•«é¢ï¼Œé¿å…è¦–è¦ºæ­»æ©Ÿ
  requestAnimationFrame(() => {
    Papa.parse(sheetUrls[currentGame] + "?t=" + Date.now(), {
      download: true,
      header: false,
      skipEmptyLines: true,
      fastMode: true, // é‡å°å–®ç´”çµæ§‹çš„ CSV é–‹å•Ÿå¿«é€Ÿæ¨¡å¼
      complete: function(results) {
        overlay.style.display = 'none';
        
        // å–å¾—æ•¸æ“šä¸¦éæ¿¾æ‰å¯èƒ½çš„ç©ºåˆ—
        cloudData = results.data.slice(1).filter(row => row.length > 5);
        
        // æ›´æ–°å³æ™‚çµ±è¨ˆ
        updateStats();

        // åŸ·è¡Œå›èª¿ï¼ˆä¾‹å¦‚è‡ªå‹•é¸å–ä»Šæ—¥åŠŸèƒ½ï¼‰
        if (callback && results.data.length > 1) {
          callback(results.data[results.data.length - 1]);
        }
      },
      error: function(err) {
        console.error("æª”æ¡ˆè®€å–å¤±æ•—:", err);
        overlay.style.display = 'none';
        alert(`ç„¡æ³•è¼‰å…¥ ${currentGame} çš„è³‡æ–™ï¼Œè«‹æª¢æŸ¥æª”æ¡ˆè·¯å¾‘ã€‚`);
      }
    });
  });
}

function updateStats(){
  if(!cloudData.length) return;
  const validRows = getValidRows();
  const filters = {};
  document.querySelectorAll('.chips').forEach(box => {
    const sel = Array.from(box.querySelectorAll('.chip.on')).map(c=>c.dataset.val);
    if(sel.length) filters[box.dataset.label] = sel;
  });

  const counts = Array(maxNum+1).fill(0);
  validRows.forEach((row, i) => {
    const rd = buildRd(rowMetaFromRow(row));
    if(!matchFilters(rd, filters)) return;
    const balls = rowBalls(row);
    
    if(currentMode==="æ­·å²æ¨¡å¼" || currentMode==="ç•¶æœŸå°ç¢°") {
      balls.forEach(n => counts[n]++);
    } else if(i < validRows.length-1) {
      const nextBalls = rowBalls(validRows[i+1]);
      nextBalls.forEach(n => counts[n]++);
    }
  });

  const threshold = [...counts].sort((a,b)=>b-a)[4] || 999;
  for(let i=1; i<=maxNum; i++){
    const td1 = document.getElementById(`val1-${i}`);
    td1.textContent = counts[i];
    td1.className = (counts[i]>=threshold && counts[i]>0) ? "top5" : "";
    
    let gap = 0;
    for(let j=validRows.length-1; j>=0; j--){
      if(rowBalls(validRows[j]).includes(i)) break;
      gap++;
    }
    document.getElementById(`val2-${i}`).textContent = gap;
  }
  document.getElementById('filterCounter').textContent = `åƒèˆ‡æœŸæ•¸: ${validRows.length} | æ¨¡å¼: ${currentMode}`;
  renderMainSubStatus();
}

/* =========================
   å ±è¡¨èˆ‡å…¶ä»–åŠŸèƒ½
   ========================= */
function addToReport(){
  const validRows = getValidRows();
  const group = { id: Date.now(), title: `ã€${currentMode}ã€‘åˆ†æ`, rows: [], sum: Array(maxNum+1).fill(0), limit: maxNum };
  
  // ç¯„ä¾‹ï¼šæ­·å²æ¨¡å¼åŠ å…¥
  if(currentMode === "æ­·å²æ¨¡å¼"){
    const filters = {};
    document.querySelectorAll('.chips').forEach(box => {
      const sel = Array.from(box.querySelectorAll('.chip.on')).map(c=>c.dataset.val);
      if(sel.length) {
        sel.forEach(v => {
          const c = Array(maxNum+1).fill(0);
          validRows.forEach(r => { if(matchFilters(buildRd(rowMetaFromRow(r)), {[box.dataset.label]:[v]})) rowBalls(r).forEach(n=>c[n]++); });
          group.rows.push({label: `${box.dataset.label}:${v}`, data: c});
          c.forEach((v,idx) => group.sum[idx] += v);
        });
      }
    });
  }
  // å…¶ä»–æ¨¡å¼ä¾æ­¤é¡æ¨... (ä¸»é«”ã€æ‹–ç‰Œé‚è¼¯åŒä¸Šæ®µ)

  if(!group.rows.length) return alert("è«‹å…ˆé¸æ“‡ç¯©é¸æ¢ä»¶");
  reportStorage[currentUser][currentGame].push(group);
  alert("å ±è¡¨å·²åŠ å…¥ï¼");
  renderMainSubStatus();
}

function renderCurrentReports(){
  const container = document.getElementById('reportContainer');
  container.innerHTML = '';
  reportStorage[currentUser][currentGame].forEach((g, idx) => {
    let tableHtml = `<div class="report-item"><div class="report-header">ç¬¬ ${idx+1} å¼µå ±è¡¨: ${g.title} <button class="btn btn-red" onclick="deleteReport(${g.id})">åˆªé™¤</button></div><table class="report-table"><thead><tr><td class="cond-col">æ˜ç´°</td>${Array.from({length:g.limit},(_,i)=>`<td>${i+1}</td>`).join('')}</tr></thead><tbody>`;
    g.rows.forEach(r => {
      tableHtml += `<tr><td class="cond-col">${r.label}</td>${r.data.slice(1).map(v=>`<td>${v||''}</td>`).join('')}</tr>`;
    });
    tableHtml += `<tr class="sum-row"><td class="cond-col">åŠ ç¸½</td>${g.sum.slice(1).map(v=>`<td>${v||''}</td>`).join('')}</tr></tbody></table></div>`;
    container.innerHTML += tableHtml;
  });
}

function deleteReport(id){
  const arr = reportStorage[currentUser][currentGame];
  const idx = arr.findIndex(g=>g.id === id);
  if(idx>=0) arr.splice(idx, 1);
  renderCurrentReports();
}

function exportToExcel(){
  const content = document.getElementById('reportContainer').innerHTML;
  const blob = new Blob(['<html><head><meta charset="utf-8"></head><body>' + content + '</body></html>'], {type: 'application/vnd.ms-excel'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = `åˆ†æå ±è¡¨_${Date.now()}.xls`; a.click();
}

function changeMode(mode, btn){
  currentMode = mode;
  document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('btn-orange', 'btn-yellow'));
  btn.classList.add(mode==="æ­·å²æ¨¡å¼"?'btn-yellow':'btn-orange');
  if(mode!=="ä¸»é«”æ¨¡å¼") clearMainSub();
  updateStats();
}

function switchUser(role){
  currentUser = role;
  document.getElementById('mode-dad').classList.toggle('btn-cyan', role==='dad');
  document.getElementById('mode-bro').classList.toggle('btn-cyan', role==='bro');
  initFilters(); fetchSheetData();
}

function setPickState(s){
  pickState = s;
  document.getElementById('btnMainArm').classList.toggle('btn-orange', s==='main_armed');
  document.getElementById('btnSubMode').classList.toggle('btn-orange', s==='sub');
  renderMainSubStatus();
}

function armMainPick(){ setPickState("main_armed"); }
function toggleSubMode(){ setPickState(pickState==="sub"?"normal":"sub"); }
function clearMainSub(){ mainPick=null; subPicks=[]; setPickState("normal"); }
function clearFilters(){ document.querySelectorAll('.chip.on').forEach(c=>c.classList.remove('on')); updateStats(); }
function cssEsc(s){ return String(s).replace(/([ #;?%&,.+*~\':"!^$[\]()=>|/@])/g,'\\$1'); }

function renderMainSubStatus(){
  const ms = mainPick ? `${mainPick.cat}:${mainPick.val}` : "æœªæŒ‡å®š";
  const drag = dragPick1 ? `â‘ ${dragPick1.val} ${dragPick2?`â‘¡${dragPick2.val}`:''}` : "æœªè¨­å®š";
  document.getElementById('mainSubStatus').textContent = `ä¸»é«”ï¼š${ms} | æ‹–ç‰Œï¼š${drag} | ç‹€æ…‹ï¼š${pickState}`;
}

// åˆ†é åˆ‡æ›ç›£è½
document.querySelectorAll('.tab').forEach(tab => {
  tab.addEventListener('click', () => {
    // åˆ‡æ›éŠæˆ²æ¨¡å¼
    const targetGame = tab.dataset.game; // "539" æˆ– "Lotto"
    const targetPage = tab.dataset.target;

    // åªæœ‰åœ¨æ›´æ›éŠæˆ²ç¨®é¡æ™‚æ‰é‡æ–°æŠ“å–è³‡æ–™
    const gameChanged = (currentGame !== targetGame);
    currentGame = targetGame;

    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    tab.classList.add('active');
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById(targetPage).classList.add('active');

    if (targetPage === 'mainPage') {
      initFilters(); 
      // å¦‚æœéŠæˆ²æ›´æ›äº†ï¼Œç«‹å³æŠ“å–å°æ‡‰çš„ CSV
      if (gameChanged || cloudData.length === 0) {
        fetchSheetData();
      } else {
        updateStats();
      }
    } else {
      renderCurrentReports();
    }
  });
});

// å•Ÿå‹•
initFilters();
fetchSheetData();
</script>
</body>
</html>



