<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¨‚é€æ•¸æ“šåˆ†æ - å¯¦éš›æ•¸æ“šç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .filter-row { display: flex; border-bottom: 1px solid #e5e7eb; align-items: stretch; }
        .filter-label { width: 90px; background-color: #f3f4f6; color: #4b5563; font-weight: bold; font-size: 0.9rem; display: flex; align-items: center; justify-content: center; border-right: 1px solid #e5e7eb; flex-shrink: 0; }
        .filter-content { display: flex; flex-wrap: wrap; gap: 4px; padding: 6px; background: white; flex-grow: 1; }
        .btn-sq { border: 1px solid #d1d5db; border-radius: 4px; padding: 2px 8px; min-width: 38px; text-align: center; background: white; cursor: pointer; font-size: 0.85rem; }
        .btn-sq.selected { background-color: #2563eb; color: white; border-color: #1e40af; }
        
        .report-table { width: 100%; border-collapse: collapse; font-size: 11px; text-align: center; margin-top: 10px; }
        .report-table th, .report-table td { border: 1px solid #999; padding: 4px 1px; }
        .bg-yellow { background-color: #ffff00; font-weight: bold; }
        .bg-pink { background-color: #fee2e2; }
        .text-hot { background-color: #ff0000 !important; color: white !important; font-weight: bold; }
    </style>
</head>
<body class="bg-gray-50 p-2">

    <div class="max-w-[1600px] mx-auto bg-white border border-gray-300 shadow-lg">
        
        <div class="p-4 border-b space-y-3">
            <h1 class="text-red-600 font-bold text-xl">ç›®å‰æ¨¡å¼ï¼š539 - å¯¦éš›æ•¸æ“šé€£ç·š</h1>
            <div class="flex gap-2">
                <button onclick="switchUser('dad')" id="u-dad" class="px-4 py-1.5 border rounded font-bold shadow-sm">çˆ¸ä½¿ç”¨æ¨¡å¼</button>
                <button onclick="switchUser('bro')" id="u-bro" class="px-4 py-1.5 border rounded font-bold shadow-sm">å“¥ä½¿ç”¨æ¨¡å¼</button>
            </div>
            
            <div class="flex gap-3 items-center">
                <button onclick="runAnalysis()" class="px-10 py-2 bg-green-600 text-white font-bold rounded-lg shadow-md hover:bg-green-700 active:scale-95 transition-all">
                    ğŸ§ª åŸ·è¡Œæ•¸æ“šåˆ†æ (æŠ“å– CSV)
                </button>
                <button onclick="location.reload()" class="px-4 py-2 bg-white border border-gray-300 rounded font-bold text-gray-500">æ¸…ç©º</button>
                <span id="data-count" class="text-sm font-bold text-blue-600"></span>
            </div>
        </div>

        <div class="m-4 border-2 border-red-500 rounded-sm">
            <div class="filter-row"><div class="filter-label">å¹´ä»½</div><div id="row-year" class="filter-content"></div></div>
            <div class="filter-row"><div class="filter-label">æœˆä»½</div><div id="row-month" class="filter-content"></div></div>
            <div class="filter-row"><div class="filter-label">æ—¥æœŸ</div><div id="row-day" class="filter-content"></div></div>
        </div>

        <div id="report-output" class="p-4 space-y-6">
            <div id="status-msg" class="text-center text-gray-400 py-10 italic">è«‹å…ˆé¸æ“‡ä¸Šæ–¹æ¢ä»¶ä¸¦é»æ“ŠåŸ·è¡Œ...</div>
        </div>

        <div class="p-3 bg-slate-800 text-white text-[10px] font-mono flex gap-4">
            <span id="conn-status">æ­£åœ¨é€£ç·š GitHub...</span>
            <span id="csv-debug"></span>
        </div>
    </div>

    <script>
        const CSV_URL = "https://raw.githubusercontent.com/win83/secret-lotto-888/main/fine/539.csv";
        let rawCSVData = [];

        window.onload = () => {
            initFilters();
            switchUser('dad');
            preFetchData();
        };

        async function preFetchData() {
            const status = document.getElementById('conn-status');
            try {
                const response = await fetch(CSV_URL);
                if (!response.ok) throw new Error();
                const text = await response.text();
                // è™•ç† CSV æ›è¡Œï¼Œéæ¿¾æ‰ç©ºè¡Œ
                rawCSVData = text.split(/\r?\n/).filter(line => line.trim() !== "").map(line => line.split(','));
                status.innerHTML = `539 é€£ç·š: <span class="text-green-400">OK</span> | ç¸½å…± ${rawCSVData.length} æœŸæ•¸æ“š`;
            } catch (e) {
                status.innerHTML = `539 é€£ç·š: <span class="text-red-400">FAIL (è«‹ç¢ºèªæª”æ¡ˆè·¯å¾‘)</span>`;
            }
        }

        function initFilters() {
            const mRow = document.getElementById('row-month');
            for(let i=1; i<=12; i++) mRow.innerHTML += `<button onclick="this.classList.toggle('selected')" class="btn-sq" data-val="${i}">${i}</button>`;
            const dRow = document.getElementById('row-day');
            for(let i=1; i<=31; i++) dRow.innerHTML += `<button onclick="this.classList.toggle('selected')" class="btn-sq" data-val="${i}">${i}</button>`;
        }

        function switchUser(user) {
            const isDad = user === 'dad';
            document.getElementById('u-dad').className = `px-6 py-1.5 border rounded font-bold ${isDad ? 'bg-cyan-500 text-white' : 'bg-gray-100'}`;
            document.getElementById('u-bro').className = `px-6 py-1.5 border rounded font-bold ${!isDad ? 'bg-cyan-500 text-white' : 'bg-gray-100'}`;
            
            const start = isDad ? 2020 : 2006;
            const yRow = document.getElementById('row-year');
            yRow.innerHTML = '';
            for(let y=start; y<=2026; y++) yRow.innerHTML += `<button onclick="this.classList.toggle('selected')" class="btn-sq" data-val="${y}">${y}</button>`;
        }

        function runAnalysis() {
            if (rawCSVData.length === 0) { alert("å°šæœªè®€å–åˆ°æ•¸æ“šï¼Œè«‹é‡æ–°æ•´ç†é é¢ã€‚"); return; }
            
            const selY = Array.from(document.querySelectorAll('#row-year .selected')).map(b => b.dataset.val);
            const selM = Array.from(document.querySelectorAll('#row-month .selected')).map(b => b.dataset.val);
            const selD = Array.from(document.querySelectorAll('#row-day .selected')).map(b => b.dataset.val);

            if (selM.length === 0 && selD.length === 0) { alert("è«‹è‡³å°‘é¸æ“‡ä¸€å€‹æœˆä»½æˆ–æ—¥æœŸï¼"); return; }

            const stats = { month: new Array(40).fill(0), day: new Array(40).fill(0), total: new Array(40).fill(0) };
            let matchCount = 0;

            rawCSVData.forEach(row => {
                // æ•¸æ“šæ¸…æ´—ï¼šå°‹æ‰¾ç¬¦åˆæ—¥æœŸæ ¼å¼çš„ç¬¬ä¸€æ¬„ (ä¾‹: 2024/01/01)
                const datePart = row[0].trim();
                if (!datePart.includes('/')) return; 

                const d = new Date(datePart);
                const Y = d.getFullYear().toString();
                const M = (d.getMonth() + 1).toString();
                const D = d.getDate().toString();

                // æª¢æŸ¥å¹´ä»½éæ¿¾
                if (selY.length > 0 && !selY.includes(Y)) return;

                // æŠ“å–è©²åˆ—ä¸­æ‰€æœ‰çš„è™Ÿç¢¼ (éæ¿¾æ‰éæ•¸å­—ï¼Œå– 01-39 ç¯„åœ)
                const rowNums = row.map(cell => parseInt(cell.trim())).filter(n => n >= 1 && n <= 39);
                
                let matched = false;
                if (selM.includes(M)) {
                    rowNums.forEach(n => stats.month[n]++);
                    matched = true;
                }
                if (selD.includes(D)) {
                    rowNums.forEach(n => stats.day[n]++);
                    matched = true;
                }
                if(matched) matchCount++;
            });

            for(let i=1; i<=39; i++) stats.total[i] = stats.month[i] + stats.day[i];
            
            document.getElementById('status-msg').className = "hidden";
            renderReport(stats, selM, selD, matchCount);
        }

        function renderReport(stats, ms, ds, count) {
            const area = document.getElementById('report-output');
            const getHighClass = (val, arr) => {
                const max = Math.max(...arr.slice(1));
                return (val === max && val > 0) ? 'text-hot' : '';
            };

            const html = `
                <div class="border border-gray-400 bg-white">
                    <div class="bg-amber-50 p-2 font-bold flex justify-between text-gray-700">
                        <span>ã€ç¬¬ ${area.children.length} å¼µã€‘ ç¯©é¸ï¼šæœˆä»½(${ms.join(',')}) æ—¥æœŸ(${ds.join(',')})</span>
                        <span class="text-blue-600">ç¬¦åˆæœŸæ•¸ï¼š${count} æœŸ</span>
                    </div>
                    <table class="report-table">
                        <tr class="bg-yellow">
                            <td class="w-20">çµ±è¨ˆæ˜ç´°</td>
                            ${Array.from({length: 39}, (_, i) => `<td class="w-6">${i+1}</td>`).join('')}
                        </tr>
                        <tr>
                            <td class="bg-yellow">æœˆä»½:${ms.length?ms.join(','):'ç„¡'}</td>
                            ${stats.month.slice(1).map(v => `<td class="${getHighClass(v, stats.month)}">${v}</td>`).join('')}
                        </tr>
                        <tr>
                            <td class="bg-yellow">æ—¥æœŸ:${ds.length?ds.join(','):'ç„¡'}</td>
                            ${stats.day.slice(1).map(v => `<td class="${getHighClass(v, stats.day)}">${v}</td>`).join('')}
                        </tr>
                        <tr class="bg-pink font-bold">
                            <td class="bg-yellow">åŠ ç¸½(Sum)</td>
                            ${stats.total.slice(1).map(v => `<td class="${getHighClass(v, stats.total)}">${v}</td>`).join('')}
                        </tr>
                    </table>
                </div>
            `;
            area.insertAdjacentHTML('afterbegin', html);
        }
    </script>
</body>
</html>
