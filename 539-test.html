<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>å°ˆæ¥­æ¨‚é€çµ±è¨ˆç³»çµ± V2.2 - GitHub é«˜é€Ÿç‰ˆ</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <style>
    :root{
      --page-bg:#cfe8cf; --panel-bg:#fff8e8; --tab-bg:#ededed;
      --tab-border:#9a9a9a; --blue:#1f73ff; --red:#e51b1b;
      --line:#d0d0d0; --label:#efefef; --btn-border:#7a7a7a;
      --stat-green: #92d050; --stat-light: #e2efda;
      --top5-bg: #ff0000; --top5-text: #ffffff;
      --report-header-bg: #fce4d6;
    }
    *{ box-sizing:border-box; font-family:"Microsoft JhengHei"; }
    body{ margin:0; background:var(--page-bg); color:#111; }
    .tabs{ display:grid; grid-template-columns: repeat(4, 1fr); gap:16px; padding:10px 14px 0; }
    .tab{ height:44px; background:var(--tab-bg); border:1px solid var(--tab-border); display:flex; align-items:center; justify-content:center; font-weight:800; cursor:pointer; }
    .tab.active{ border-bottom:3px solid var(--red); background:#f2f2f2; }
    .container{ margin:10px 14px; border:1px solid var(--blue); border-radius:8px; background:var(--panel-bg); padding:10px; min-height: 80vh; }
    .page { display: none; }
    .page.active { display: block; }
    .filters-box{ border:2px solid var(--red); background:#fff; padding:12px; margin-bottom:10px; }
    .grid{ display:grid; grid-template-columns: 90px 1fr; row-gap:10px; }
    .lbl{ background:var(--label); border:1px solid var(--line); display:flex; align-items:center; justify-content:center; font-weight:900; height:36px; }
    .chips{ display:flex; flex-wrap:wrap; gap:8px; padding-left:10px; align-items:center; }
    .chip{ min-width:44px; height:34px; border:1px solid var(--line); border-radius:4px; display:flex; align-items:center; justify-content:center; cursor:pointer; font-weight:800; background:#fff; user-select:none; }
    .chip.on{ outline:3px solid var(--blue); background:#eef4ff; }
    .breakline{ flex-basis: 100%; height: 0; }
    .btnbar{ display:flex; flex-wrap:wrap; gap:8px; align-items:center; margin-top:10px; }
    .btn{ height:40px; padding:0 15px; border:1px solid var(--btn-border); border-radius:4px; font-weight:900; cursor:pointer; }
    .btn-orange{ background:#ffb300 !important; color:#000; }
    .btn-yellow{ background:#ffeb3b; }
    .btn-green{ background:#78c57a; }
    .btn-purple{ background:#6a44c6; color:#fff; }
    .btn-cyan { background:#00bcd4; color:#fff; }
    .btn-red{ background:#ff3b30; color:#fff; border-color:#b21b12; }

    .stat-title { color: red; font-weight: bold; margin-top: 15px; margin-bottom: 5px; }
    .stat-table { width: 100%; border-collapse: collapse; background: #fff; min-width: 800px; }
    .stat-table th, .stat-table td { border: 1px solid #000; text-align: center; padding: 2px; font-size: 11px; font-weight: bold; }
    .stat-table th { background: var(--stat-green); }
    .top5 { background-color: var(--top5-bg) !important; color: var(--top5-text) !important; }

    .report-item { margin-bottom: 30px; border: 1px solid #000; background: #fff; overflow-x: auto; }
    .report-header { background: var(--report-header-bg); padding: 8px; font-weight: bold; border-bottom: 1px solid #000; display:flex; gap:10px; align-items:center; }
    .report-header .title { flex:1; }
    .report-table { width:100%; border-collapse:collapse; font-size:11px; min-width: 1000px; }
    .report-table td { border:1px solid #000; text-align:center; padding:2px; }
    .cond-col { background:#ffff00; font-weight: bold; width: 420px; text-align: left; padding-left: 6px; }
    .sum-row { background:#ddebf7; font-weight:bold; }
    .hidden { display: none !important; }

    #loadingOverlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); display:none; justify-content:center; align-items:center; z-index:9999; font-weight:900; color:red; }

    .chip.mainpick{ outline: 4px solid #ff3b30 !important; background: #ffe5e3 !important; }
    .chip.subpick{ outline: 4px solid #00bcd4 !important; background: #e6fbff !important; }
    .chip.drag1{ outline: 4px solid #6a44c6 !important; background:#f0e9ff !important; }
    .chip.drag2{ outline: 4px solid #2e7d32 !important; background:#e7f6e9 !important; }

    .mainSubBox{
      display:flex; flex-wrap:wrap; gap:8px; align-items:center;
      background:#fff7cc; border:1px dashed #b38b00; padding:8px; margin-bottom:10px;
      font-weight:900;
    }
    .mainSubHint{ color:#b21b12; }
  </style>
</head>
<body>

<div id="loadingOverlay">é›²ç«¯å¤§æ•¸æ“šé‹ç®—ä¸­...</div>

<div class="tabs">
  <div class="tab active" data-game="539" data-target="mainPage">ä»Šå½© 539</div>
  <div class="tab" data-game="539" data-target="reportPage">539 å ±è¡¨</div>
  <div class="tab" data-game="Lotto" data-target="mainPage">å¤§æ¨‚é€</div>
  <div class="tab" data-game="Lotto" data-target="reportPage">å¤§æ¨‚é€ å ±è¡¨</div>
</div>

<div class="container">
  <div id="mainPage" class="page active">
    <div id="gameTitle" style="color:red; font-weight:900; margin-bottom:10px;">ç›®å‰æ¨¡å¼ï¼šä»Šå½© 539</div>

    <div class="btnbar" style="margin-bottom:10px;">
      <button class="btn btn-cyan" id="mode-dad" onclick="switchUser('dad')">çˆ¸ä½¿ç”¨æ¨¡å¼</button>
      <button class="btn" id="mode-bro" onclick="switchUser('bro')">å“¥ä½¿ç”¨æ¨¡å¼</button>
    </div>

    <div class="mainSubBox">
      <button class="btn btn-red" id="btnMainArm" onclick="armMainPick()">ä¸»é«”</button>
      <button class="btn btn-cyan" id="btnSubMode" onclick="toggleSubMode()">å‰¯é«”(å¤šé¸)</button>
      <div id="mainSubStatus" class="mainSubHint">ä¸»é«”ï¼šæœªæŒ‡å®šï½œå‰¯é«”ï¼š0 å€‹ï½œæ‹–ç‰Œâ‘ â‘¡ï¼šæœªè¨­å®šï½œç‹€æ…‹ï¼šä¸€èˆ¬</div>
    </div>

    <div class="btnbar">
      <button class="btn btn-orange mode-btn" onclick="changeMode('æ­·å²æ¨¡å¼', this)">æ­·å²æ¨¡å¼</button>
      <button class="btn btn-yellow mode-btn" onclick="changeMode('æ‹–ç‰Œæ¨¡å¼', this)">æ‹–ç‰Œæ¨¡å¼</button>
      <button class="btn btn-yellow mode-btn" onclick="changeMode('ç•¶æœŸå°ç¢°', this)">ç•¶æœŸå°ç¢°</button>
      <button class="btn btn-yellow mode-btn" onclick="changeMode('ä¸‹æœŸå°ç¢°', this)">ä¸‹æœŸå°ç¢°</button>
      <button class="btn btn-green" onclick="addToReport()">ğŸ§ª åŠ å…¥å ±è¡¨</button>
      <button class="btn" onclick="clearFilters()">æ¸…ç©ºç¯©é¸</button>
    </div>

    <div id="filterCounter" style="margin:10px 0; font-weight:800; color:#444;"></div>
    <div class="filters-box"><div class="grid" id="filterGrid"></div></div>

    <div class="stat-title">å³æ™‚é‹ç®—çµ±è¨ˆ</div>
    <div style="overflow-x:auto">
      <table class="stat-table">
        <thead><tr id="stat-head-1"></tr></thead>
        <tbody><tr id="stat-body-1"></tr></tbody>
      </table>
    </div>

    <div class="stat-title">å…¨åŸŸæœªå‡ºæœŸæ•¸</div>
    <div style="overflow-x:auto">
      <table class="stat-table">
        <thead><tr id="stat-head-2"></tr></thead>
        <tbody><tr id="stat-body-2"></tr></tbody>
      </table>
    </div>
  </div>

  <div id="reportPage" class="page">
    <div id="reportControl" style="background:#ffd966; padding:8px; display:flex; flex-wrap:wrap; gap:10px; align-items:center; margin-bottom:10px; border:1px solid #999;">
      <button class="btn btn-green" onclick="exportToExcel()">åŒ¯å‡º Excel</button>
      <button class="btn" style="margin-left:auto; background:yellow" onclick="clearAllReports()">æ¸…ç©ºå ±è¡¨</button>
    </div>
    <div id="reportContainer"></div>
  </div>
</div>

  <script>
/* =========================
   å…¨åŸŸè®Šæ•¸èˆ‡è·¯å¾‘è¨­å®š
   ========================= */
let cloudData = [];
let currentGame = "539";
let currentMode = "æ­·å²æ¨¡å¼";
let currentUser = "dad";
let maxNum = 39;

// GitHub Raw åŸå§‹è³‡æ–™è·¯å¾‘
const sheetUrls = {
  "539": "https://raw.githubusercontent.com/win83/secret-lotto-888/main/data/new-folder/539.csv",
  "Lotto": "https://raw.githubusercontent.com/win83/secret-lotto-888/main/data/new-folder/49.csv"
};

// ç‹€æ…‹è¿½è¹¤
let pickState = "normal"; // normal, main, sub
let mainPick = null;
let subPicks = [];
let dragPick1 = null;
let dragPick2 = null;
let numOrder = [];
let reportStorage = { "dad": { "539": [], "Lotto": [] }, "bro": { "539": [], "Lotto": [] } };

/* =========================
   åˆå§‹åŒ–èˆ‡ç¯©é¸å™¨ç”Ÿæˆ
   ========================= */
function initFilters() {
  maxNum = (currentGame === "539") ? 39 : 49;
  document.getElementById('gameTitle').textContent = `ç›®å‰æ¨¡å¼ï¼š${(currentGame === "539") ? "ä»Šå½© 539" : "å¤§æ¨‚é€"}`;
  
  const grid = document.getElementById('filterGrid');
  grid.innerHTML = '';
  
  const config = [
    { label: "å¹´ä»½", vals: [2020, 2021, 2022, 2023, 2024, 2025, 2026] },
    { label: "æœˆä»½", vals: Array.from({length:12}, (_,i)=>i+1) },
    { label: "æ—¥æœŸ", vals: Array.from({length:31}, (_,i)=>i+1) },
    { label: "æ˜ŸæœŸ", vals: ["ä¸€","äºŒ","ä¸‰","å››","äº”","å…­","æ—¥"] }
  ];

  if (currentUser === "dad") {
    config.push(
      { label: "å¤©å¹²", vals: ["ç”²","ä¹™","ä¸™","ä¸","æˆŠ","å·±","åºš","è¾›","å£¬","ç™¸"] },
      { label: "åœ°æ”¯", vals: ["å­","ä¸‘","å¯…","å¯","è¾°","å·³","åˆ","æœª","ç”³","é…‰","æˆŒ","äº¥"] },
      { label: "ç¯€æ°£", vals: ["ç«‹æ˜¥","é›¨æ°´","é©šèŸ„","æ˜¥åˆ†","æ¸…æ˜","ç©€é›¨","ç«‹å¤","å°æ»¿","èŠ’ç¨®","å¤è‡³","å°æš‘","å¤§æš‘","ç«‹ç§‹","è™•æš‘","ç™½éœ²","ç§‹åˆ†","å¯’éœ²","éœœé™","ç«‹å†¬","å°é›ª","å¤§é›ª","å†¬è‡³","å°å¯’","å¤§å¯’"] }
    );
  }
  
  config.push({ label: "è™Ÿç¢¼", vals: Array.from({length:maxNum}, (_,i)=>i+1) });

  config.forEach(item => {
    grid.innerHTML += `<div class="lbl">${item.label}</div>`;
    let html = `<div class="chips" data-label="${item.label}">`;
    item.vals.forEach(v => {
      html += `<div class="chip" data-val="${v}" onclick="handleChipClick(this, '${item.label}', '${v}')">${v}</div>`;
    });
    html += `</div>`;
    grid.innerHTML += html;
  });
  updateStatTableUI();
}

/* =========================
   è³‡æ–™è®€å–æ ¸å¿ƒ (GitHub CSV)
   ========================= */
function fetchSheetData(callback) {
  const overlay = document.getElementById('loadingOverlay');
  overlay.style.display = 'flex';

  // åŠ å…¥æ™‚é–“æˆ³é˜²æ­¢ GitHub å¿«å–
  const url = sheetUrls[currentGame] + "?t=" + Date.now();

  Papa.parse(url, {
    download: true,
    header: false,
    skipEmptyLines: true,
    complete: function(results) {
      overlay.style.display = 'none';
      if (results.data && results.data.length > 0) {
        // çˆ¸èˆ‡å“¥é€šç”¨é‚è¼¯ï¼šç§»é™¤æ¨™é¡Œåˆ—ä¸¦éæ¿¾æœ‰æ•ˆåˆ—
        cloudData = results.data.slice(1).filter(r => r.length >= 7);
        if (callback) callback(results.data[results.data.length - 1]);
        updateStats();
      }
    },
    error: function(err) {
      overlay.style.display = 'none';
      alert("GitHub è³‡æ–™è®€å–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²éš›ç¶²è·¯æˆ–è·¯å¾‘ã€‚");
    }
  });
}

/* =========================
   æ¨¡å¼åˆ‡æ›èˆ‡é»æ“Šé‚è¼¯
   ========================= */
function handleChipClick(el, cat, val) {
  const isNumber = (cat === "è™Ÿç¢¼");
  val = isNumber ? parseInt(val) : val;

  // ä¸»é«”è¨­å®šæ¨¡å¼
  if (pickState === "main" && !isNumber) {
    mainPick = { cat, val };
    setPickState("normal");
    renderMainSubStatus();
    return;
  }

  // å‰¯é«”è¨­å®šæ¨¡å¼
  if (pickState === "sub" && !isNumber) {
    if (!mainPick) { alert("è«‹å…ˆè¨­å®šä¸»é«”"); setPickState("normal"); return; }
    const idx = subPicks.findIndex(s => s.cat === cat && s.val === val);
    if (idx >= 0) { subPicks.splice(idx, 1); el.classList.remove('subpick'); }
    else { subPicks.push({ cat, val }); el.classList.add('subpick'); }
    renderMainSubStatus();
    return;
  }

  // ä¸€èˆ¬é»æ“Š (å«æ‹–ç‰Œæ¨¡å¼é‚è¼¯)
  el.classList.toggle('on');
  if (isNumber) {
    updateNumOrder(val, el.classList.contains('on'));
  } else if (currentMode === "æ‹–ç‰Œæ¨¡å¼" || currentMode === "ä¸‹æœŸå°ç¢°") {
    // ä¾åºè¨˜éŒ„æ‹–ç‰Œæ¢ä»¶ â‘  èˆ‡ â‘¡
    if (el.classList.contains('on')) {
      if (!dragPick1) dragPick1 = { cat, val };
      else if (!dragPick2) dragPick2 = { cat, val };
    } else {
      if (dragPick1 && dragPick1.cat === cat && dragPick1.val === val) dragPick1 = null;
      else if (dragPick2 && dragPick2.cat === cat && dragPick2.val === val) dragPick2 = null;
    }
  }
  updateStats();
  renderMainSubStatus();
}

function updateNumOrder(n, isAdd) {
  if (isAdd) { if (!numOrder.includes(n)) numOrder.push(n); }
  else { numOrder = numOrder.filter(x => x !== n); }
}

/* =========================
   çµ±è¨ˆèˆ‡é‹ç®— (å¼•ç”¨å‰æ®µé‚è¼¯)
   ========================= */
function updateStats() {
  if (!cloudData.length) return;
  const selNums = numOrder;
  const counts = Array(maxNum + 1).fill(0);
  const filters = getSelectedFilters();

  cloudData.forEach((row, idx) => {
    const rd = buildRd(row);
    if (!matchFilters(rd, filters)) return;

    const nums = rowBalls(row);
    if (currentMode === "æ­·å²æ¨¡å¼") {
      nums.forEach(n => { if (n <= maxNum) counts[n]++; });
    } else if (currentMode === "æ‹–ç‰Œæ¨¡å¼" || currentMode === "ä¸‹æœŸå°ç¢°") {
      if (selNums.length > 0 && selNums.some(sn => nums.includes(sn))) {
        const nxt = cloudData[idx + 1];
        if (nxt) rowBalls(nxt).forEach(n => { if (n <= maxNum) counts[n]++; });
      }
    } else if (currentMode === "ç•¶æœŸå°ç¢°") {
      if (selNums.length >= 2 && selNums.every(sn => nums.includes(sn))) {
        nums.forEach(n => { if (n <= maxNum) counts[n]++; });
      }
    }
  });

  // æ›´æ–° UI æ•¸å­—èˆ‡ Top 5
  const sorted = [...counts].slice(1).sort((a, b) => b - a);
  const threshold = sorted[4] > 0 ? sorted[4] : 999;

  for (let i = 1; i <= maxNum; i++) {
    const td1 = document.getElementById(`val1-${i}`);
    if (td1) {
      td1.textContent = counts[i] || 0;
      td1.className = (counts[i] >= threshold && counts[i] > 0) ? "top5" : "";
    }
    // æœªå‡ºæœŸæ•¸è¨ˆç®—
    let gap = 0;
    for (let j = cloudData.length - 1; j >= 0; j--) {
      if (rowBalls(cloudData[j]).includes(i)) break;
      gap++;
    }
    const td2 = document.getElementById(`val2-${i}`);
    if (td2) td2.textContent = gap;
  }
}

/* =========================
   è¼”åŠ©å‡½æ•¸ (è§£æ Row è³‡æ–™)
   ========================= */
function rowBalls(row) {
  // å‡è¨­ CSV æ ¼å¼ï¼šæ—¥æœŸ, 1, 2, 3, 4, 5, ... 
  return row.slice(1, 7).map(v => parseInt(v));
}

function buildRd(row) {
  // å°æ‡‰éæ¿¾æ¢ä»¶ï¼šå¹´, æœˆ, æ—¥, æ˜ŸæœŸ, å¤©å¹², åœ°æ”¯, ç¯€æ°£
  const d = new Date(row[0]);
  return {
    "å¹´ä»½": d.getFullYear(),
    "æœˆä»½": d.getMonth() + 1,
    "æ—¥æœŸ": d.getDate(),
    "æ˜ŸæœŸ": ["æ—¥","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­"][d.getDay()],
    "å¤©å¹²": row[7] || "",
    "åœ°æ”¯": row[8] || "",
    "ç¯€æ°£": row[9] || ""
  };
}

function getSelectedFilters() {
  const f = {};
  document.querySelectorAll('.chips').forEach(group => {
    const cat = group.dataset.label;
    if (cat === "è™Ÿç¢¼") return;
    const active = Array.from(group.querySelectorAll('.chip.on')).map(c => c.dataset.val);
    if (active.length) f[cat] = active;
  });
  return f;
}

function matchFilters(rd, filters) {
  for (const cat in filters) {
    if (!filters[cat].includes(String(rd[cat]))) return false;
  }
  return true;
}

/* =========================
   ä½¿ç”¨è€…èˆ‡åˆ†é åˆ‡æ›
   ========================= */
function switchUser(u) {
  currentUser = u;
  document.getElementById('mode-dad').classList.toggle('btn-cyan', u === 'dad');
  document.getElementById('mode-bro').classList.toggle('btn-cyan', u === 'bro');
  initFilters();
  updateStats();
}

function changeMode(m, btn) {
  currentMode = m;
  document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('btn-orange'));
  btn.classList.add('btn-orange');
  updateStats();
}

// ç›£è½åˆ†é åˆ‡æ›
document.querySelectorAll('.tab').forEach(tab => {
  tab.addEventListener('click', () => {
    const isGameChanged = (currentGame !== tab.dataset.game);
    currentGame = tab.dataset.game;
    
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    tab.classList.add('active');
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById(tab.dataset.target).classList.add('active');
    
    if (tab.dataset.target === 'mainPage') {
      if (isGameChanged) {
        initFilters();
        fetchSheetData();
      }
    } else {
      renderCurrentReports();
    }
  });
});

function updateStatTableUI() {
  const h1 = document.getElementById('stat-head-1'), b1 = document.getElementById('stat-body-1');
  const h2 = document.getElementById('stat-head-2'), b2 = document.getElementById('stat-body-2');
  h1.innerHTML = b1.innerHTML = h2.innerHTML = b2.innerHTML = '';
  for (let i = 1; i <= maxNum; i++) {
    h1.innerHTML += `<th>${i}</th>`; b1.innerHTML += `<td id="val1-${i}">0</td>`;
    h2.innerHTML += `<th>${i}</th>`; b2.innerHTML += `<td id="val2-${i}">0</td>`;
  }
}

function renderMainSubStatus() {
  const status = document.getElementById('mainSubStatus');
  const mStr = mainPick ? `${mainPick.cat}:${mainPick.val}` : "æœªæŒ‡å®š";
  status.textContent = `ä¸»é«”ï¼š${mStr}ï½œå‰¯é«”ï¼š${subPicks.length} å€‹ï½œç‹€æ…‹ï¼š${pickState}`;
}

function setPickState(s) { pickState = s; renderMainSubStatus(); }
function armMainPick() { setPickState("main"); }
function toggleSubMode() { setPickState(pickState === "sub" ? "normal" : "sub"); }

// å•Ÿå‹•
initFilters();
fetchSheetData();

</script>
</body>
</html>
