<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>專業樂透統計系統 V2.2 - 報表顯示規格版（當期對碰/下期對碰修正版）</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <style>
    :root{
      --page-bg:#cfe8cf; --panel-bg:#fff8e8; --tab-bg:#ededed;
      --tab-border:#9a9a9a; --blue:#1f73ff; --red:#e51b1b;
      --line:#d0d0d0; --label:#efefef; --btn-border:#7a7a7a;
      --stat-green: #92d050; --stat-light: #e2efda;
      --top5-bg: #ff0000; --top5-text: #ffffff;
      --report-header-bg: #fce4d6;
    }
    *{ box-sizing:border-box; font-family:"Microsoft JhengHei"; }
    body{ margin:0; background:var(--page-bg); color:#111; }
    /* 省略其他樣式... */
  </style>
</head>
<body>

<div id="loadingOverlay">雲端大數據運算中...</div>

<!-- Tabs and other HTML content... -->

<script>
let currentMode = "歷史模式", currentGame = "539", currentUser = "dad", maxNum = 39, cloudData = [];

const reportStorage = { dad: { "539": [], "Lotto": [] }, bro: { "539": [], "Lotto": [] } };

const sheetUrls = {
  "539": "https://raw.githubusercontent.com/win83/secret-lotto-888/main/fine/539.csv",  // GitHub 連結
  "Lotto": "https://raw.githubusercontent.com/win83/secret-lotto-888/main/fine/Lotto.csv"  // GitHub 連結
};

/* =========================
   主體/副體 狀態
   ========================= */
let pickState = "normal"; // normal | main_armed | sub
let mainPick = null;      // {cat, val}
let subPicks = [];        // [{cat,val}, ...]
function samePick(a,b){ return !!a && !!b && a.cat===b.cat && a.val===b.val; }

function setPickState(st){
  pickState = st;
  const btnMain = document.getElementById('btnMainArm');
  const btnSub  = document.getElementById('btnSubMode');
  if(btnMain) btnMain.classList.toggle('btn-orange', st === 'main_armed');
  if(btnSub)  btnSub.classList.toggle('btn-orange', st === 'sub');
  renderMainSubStatus();
}
// 按下主體按鈕時進行更新
function armMainPick() {
  setPickState("main_armed");

  // 切換模式顯示為「主體模式」
  changeMode("主體模式", document.querySelector('.mode-btn'));

  // 更新狀態顯示
  document.getElementById('filterCounter').textContent = `模式：主體模式 | 條件數:${subPicks.length} | 參與統計期數:${cloudData.length} | 起算日:${startKeyByUser()}`;
}

function toggleSubMode(){
  if(!mainPick){ alert("請先設定主體"); return; }
  setPickState(pickState === "sub" ? "normal" : "sub");
}
function clearMainSub(){
  mainPick = null;
  subPicks = [];
  document.querySelectorAll('.chip.mainpick').forEach(el=>el.classList.remove('mainpick'));
  document.querySelectorAll('.chip.subpick').forEach(el=>el.classList.remove('subpick'));
  setPickState("normal");
}

/* =========================
   號碼點擊順序（保持，但本次規格不再依 base 固定）
   ========================= */
let numOrder = [];
function updateNumOrder(num, isOn){
  const n = parseInt(num,10);
  if(!Number.isFinite(n)) return;
  if(isOn){
    numOrder = numOrder.filter(x=>x!==n);
    numOrder.push(n);
  }else{
    numOrder = numOrder.filter(x=>x!==n);
  }
}

function renderMainSubStatus(){
  const el = document.getElementById('mainSubStatus');
  if(!el) return;
  const mainStr = mainPick ? `${mainPick.cat}:${mainPick.val}` : "未指定";
  const subStr = subPicks.length ? subPicks.map(s=>`${s.cat}:${s.val}`).join('、') : "";
  const dragStr = (dragPick1 && dragPick2) ? `①${dragPick1.cat}:${dragPick1.val}｜②${dragPick2.cat}:${dragPick2.val}` :
                  (dragPick1 ? `①${dragPick1.cat}:${dragPick1.val}｜②未設定` : "未設定");
  const stMap = { normal:"一般", main_armed:"等待主體確認", sub:"副體多選中" };
  el.textContent = `主體：${mainStr}｜副體：${subPicks.length} 個${subPicks.length?`（${subStr}）`:``}｜拖牌①②：${dragStr}｜狀態：${stMap[pickState] || pickState}`;
}

/* =========================
   讀取 CSV 數據
   ========================= */
function fetchSheetData(callback){
  document.getElementById('loadingOverlay').style.display='flex';
  Papa.parse(sheetUrls[currentGame] + "&t=" + Date.now(),{
    download:true, header:false, skipEmptyLines:true,
    complete:function(results){
      document.getElementById('loadingOverlay').style.display='none';
      if (results.errors.length) {
        console.error('解析錯誤:', results.errors);
        alert('數據解析錯誤');
      } else {
        cloudData = results.data.slice(1);  // 去掉標題行
        updateStats();
        if (callback) callback(results.data[results.data.length-1]);
      }
    },
    error: function(error) {
      console.error('數據讀取錯誤:', error);
      alert('數據讀取失敗');
    }
  });
}

/* =========================
   更新統計
   ========================= */
function updateStats(){
  if (!cloudData.length) return;
  const filters = getSelectedFilters();
  const catCount = Object.keys(filters).length;
  const selNums = getSelectedNums();
  const counts = Array(maxNum + 1).fill(0);
  const validRows = getValidRows();

  validRows.forEach((row, idx) => {
    const meta = rowMetaFromRow(row);
    const rd = buildRd(meta);
    if (!matchFilters(rd, filters)) return;

    const nums = rowBalls(row);
    if (currentMode === "歷史模式") {
      nums.forEach(n => { if (n <= maxNum) counts[n]++; });
    } else if (currentMode === "拖牌模式" || currentMode === "下期對碰") {
      if (selNums.length > 0 && selNums.some(sn => nums.includes(sn))) {
        const nxt = validRows[idx + 1];
        if (nxt) rowBalls(nxt).forEach(n => { if (n <= maxNum) counts[n]++; });
      }
    } else {
      if (selNums.length > 0 && selNums.every(sn => nums.includes(sn))) {
        nums.forEach(n => { if (n <= maxNum) counts[n]++; });
      }
    }
  });

  const sorted = [...counts].sort((a, b) => b - a);
  const threshold = sorted[4] > 0 ? sorted[4] : 999;
  const sk = startKeyByUser();
  const skStr = `${String(Math.floor(sk / 10000))}/${String(Math.floor((sk % 10000) / 100)).padStart(2, '0')}/${String(sk % 100).padStart(2, '0')}`;
  document.getElementById('filterCounter').textContent =
    `模式:${currentMode} | 條件數:${catCount} | 參與統計期數:${validRows.length} | 起算日:${skStr}`;

  for (let i = 1; i <= maxNum; i++) {
    const td = document.getElementById(`val1-${i}`);
    td.textContent = counts[i] || 0;
    td.className = (counts[i] >= threshold && counts[i] > 0) ? "top5" : "";
    let gap = 0;
    for (let j = validRows.length - 1; j >= 0; j--) {
      if (rowBalls(validRows[j]).includes(i)) break;
      gap++;
    }
    document.getElementById(`val2-${i}`).textContent = gap;
  }
  renderMainSubStatus();
}

/* =========================
   報表功能
   ========================= */
// 略過報表相關函數，保持不變

/* =========================
   程式初始化
   ========================= */
function start() {
  initFilters();
  fetchSheetData();
}

start();
</script>

</body>
</html>
